

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>DUTs &mdash; pcdshub/lcls-twincat-vacuum  documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
        <script src="_static/doctr-versions-menu.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Data Types" href="L2SIVacuumLib_L2SIVacuum_epics.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> pcdshub/lcls-twincat-vacuum
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">L2SIVacuumLib</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="L2SIVacuumLib_pragmas.html">Pragmas</a></li>
<li class="toctree-l1"><a class="reference internal" href="L2SIVacuumLib_nc.html">NC Settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="L2SIVacuumLib_boxes.html">Boxes</a></li>
<li class="toctree-l1"><a class="reference internal" href="L2SIVacuumLib_links.html">Links</a></li>
</ul>
<p class="caption"><span class="caption-text">L2SIVacuum</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="L2SIVacuumLib_L2SIVacuum_summary.html">Settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="L2SIVacuumLib_L2SIVacuum_summary.html#pragmas">Pragmas</a></li>
<li class="toctree-l1"><a class="reference internal" href="L2SIVacuumLib_L2SIVacuum_summary.html#symbols">Symbols</a></li>
<li class="toctree-l1"><a class="reference internal" href="L2SIVacuumLib_L2SIVacuum_epics.html">Data Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="L2SIVacuumLib_L2SIVacuum_epics.html#database-records">Database Records</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">DUTs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#e-pressurestate">E_PressureState</a></li>
<li class="toctree-l2"><a class="reference internal" href="#e-pumpstate">E_PumpState</a></li>
<li class="toctree-l2"><a class="reference internal" href="#e-valvepositionstate">E_ValvePositionState</a></li>
<li class="toctree-l2"><a class="reference internal" href="#e-vcn">E_VCN</a></li>
<li class="toctree-l2"><a class="reference internal" href="#e-vgc">E_VGC</a></li>
<li class="toctree-l2"><a class="reference internal" href="#gauge-type">Gauge_Type</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-agilentptm">ST_AgilentPTM</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-ebaradrypump">ST_EbaraDryPump</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-ebaraeva">ST_EbaraEVA</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-ebaraptm">ST_EbaraPTM</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-kashiyamadrypump">ST_KashiyamaDryPump</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-leyboldptm">ST_LeyboldPTM</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-pfeifferptm">ST_PfeifferPTM</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-pip">ST_PIP</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-ptm">ST_PTM</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-roughpump">ST_RoughPump</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-valvebase">ST_ValveBase</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-vcc-no">ST_VCC_NO</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-vcn">ST_VCN</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-vg">ST_VG</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-vgc">ST_VGC</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-vrc">ST_VRC</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-vvc">ST_VVC</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#gvls">GVLs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#constants">Constants</a></li>
<li class="toctree-l2"><a class="reference internal" href="#global-variables">Global_Variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="#global-version">Global_Version</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#pous">POUs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#f-roughpumpinlet-ilk">F_RoughPumpInlet_ILK</a></li>
<li class="toctree-l2"><a class="reference internal" href="#f-turbo-vrc-ilk">F_TURBO_VRC_ILK</a></li>
<li class="toctree-l2"><a class="reference internal" href="#f-turboextilk-no">F_TurboExtILK_NO</a></li>
<li class="toctree-l2"><a class="reference internal" href="#f-turboextilklogic">F_TurboExtILKLogic</a></li>
<li class="toctree-l2"><a class="reference internal" href="#f-turboextilklogic-2">F_TurboExtILKLogic_2</a></li>
<li class="toctree-l2"><a class="reference internal" href="#f-turbogatevalve-ilk">F_TurboGateValve_ILK</a></li>
<li class="toctree-l2"><a class="reference internal" href="#f-turbogatevalve-ilk-1">F_TurboGateValve_ILK_1</a></li>
<li class="toctree-l2"><a class="reference internal" href="#f-turbogatevalve-protection-ilk">F_TurboGateValve_Protection_ILK</a></li>
<li class="toctree-l2"><a class="reference internal" href="#f-valve-rel-ilk">F_VALVE_REL_ILK</a></li>
<li class="toctree-l2"><a class="reference internal" href="#f-vrc-diode-ilk">F_VRC_DIODE_ILK</a></li>
<li class="toctree-l2"><a class="reference internal" href="#f-vrc-diode-ilk-ok">F_VRC_DIODE_ILK_OK</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-972">FB_972</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-9xx">FB_9XX</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-ads-watchdog">FB_ADS_WATCHDOG</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-cmr362">FB_CMR362</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-ebaradrypump">FB_EbaraDryPump</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-ebaraeva">FB_EbaraEVA</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-gauge-interface">FB_Gauge_Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-gaugebase">FB_GaugeBase</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-gcc-test">FB_GCC_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-gcm">FB_GCM</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-gpi-test">FB_GPI_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-itr90">FB_ITR90</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-kashiyama-vrc">FB_Kashiyama_VRC</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-kashiyamapump">FB_KashiyamaPump</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-mks248">FB_MKS248</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-mks275">FB_MKS275</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-mks317">FB_MKS317</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-mks317a">FB_MKS317A</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-mks392">FB_MKS392</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-mks422">FB_MKS422</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-mks500">FB_MKS500</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-mks500-ep">FB_MKS500_EP</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-mks722">FB_MKS722</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-mks909">FB_MKS909</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-mks-937a">FB_MKS_937A</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-mks-937b">FB_MKS_937B</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-pip-gamma">FB_PIP_Gamma</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-pip-test">FB_PIP_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-pressurestate">FB_PressureState</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-ptm-agilent">FB_PTM_Agilent</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-ptm-ebara-010m">FB_PTM_Ebara_010M</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-ptm-ebara-011m">FB_PTM_Ebara_011M</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-ptm-magdrivedigital">FB_PTM_MagDriveDigital</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-ptm-pfeiffer">FB_PTM_Pfeiffer</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-ptm-test">FB_PTM_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-ptm-turbodrive">FB_PTM_TurboDrive</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-ptm-twistorr">FB_PTM_TwisTorr</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-pump">FB_Pump</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-scrollpump">FB_ScrollPump</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-tgcc-ads">FB_TGCC_ADS</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-tpip-ads">FB_TPIP_ADS</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-turboextlogic">FB_TurboExtLogic</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-turbventvalve-no">FB_TurbVentvalve_NO</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-tvgc-ads">FB_TVGC_ADS</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-valve">FB_Valve</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-valve-interface">FB_Valve_Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-vcc">FB_VCC</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-vcc-no">FB_VCC_NO</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-vcn">FB_VCN</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-vfs">FB_VFS</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-vfs-interface">FB_VFS_Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-vgc">FB_VGC</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-vgc-ap">FB_VGC_AP</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-vgc-ebd">FB_VGC_EBD</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-vgc-test">FB_VGC_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-vrc">FB_VRC</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-vrc-ebd">FB_VRC_EBD</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-vrc-no">FB_VRC_NO</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-vrc-ok-cls">FB_VRC_OK_CLS</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-vrc-test">FB_VRC_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-vvc">FB_VVC</a></li>
<li class="toctree-l2"><a class="reference internal" href="#prg-test">PRG_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#v-to-int">V_TO_INT</a></li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">pcdshub/lcls-twincat-vacuum</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>DUTs</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/L2SIVacuumLib_L2SIVacuum_source.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="duts">
<h1>DUTs<a class="headerlink" href="#duts" title="Permalink to this headline">¶</a></h1>
<div class="section" id="e-pressurestate">
<h2>E_PressureState<a class="headerlink" href="#e-pressurestate" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">E_PressureState</span> <span class="p">:</span>
<span class="p">(</span>
    <span class="o">//</span> <span class="n">Invalid</span> <span class="n">states</span>
    <span class="n">PressInvalid</span><span class="p">,</span><span class="o">//</span>  <span class="o">//</span><span class="n">gc_GaugeValidState</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">GaugeDisconnected</span><span class="p">,</span> <span class="o">//</span><span class="n">gc_GaugeValidState</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">OoR</span><span class="p">,</span> <span class="o">//</span><span class="n">gc_GaugeValidState</span> <span class="o">-</span><span class="mi">6</span><span class="p">,</span>
    <span class="o">//</span> <span class="n">Ion</span> <span class="n">gauges</span>
    <span class="n">Off</span><span class="p">,</span> <span class="o">//</span><span class="n">gc_GaugeValidState</span> <span class="o">-</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">Starting</span><span class="p">,</span> <span class="o">//</span><span class="n">gc_GaugeValidState</span> <span class="o">-</span> <span class="mi">4</span>

    <span class="o">//</span><span class="n">Valid</span> <span class="n">States</span> <span class="p">(</span><span class="n">Positive</span><span class="p">)</span>
    <span class="n">Valid</span><span class="p">,</span> <span class="o">//</span> <span class="n">gc_GaugeValidState</span> <span class="nb">set</span> <span class="ow">in</span> <span class="s2">&quot;Global Variable Folder: Constants&quot;</span>
    <span class="n">ValidHi</span><span class="p">,</span> <span class="o">//</span><span class="n">gc_GaugeValidState</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">ValidLo</span> <span class="o">//</span><span class="n">gc_GaugeValidState</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>

<span class="p">)</span> <span class="n">INT</span><span class="p">;</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</div>
<div class="section" id="e-pumpstate">
<h2>E_PumpState<a class="headerlink" href="#e-pumpstate" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">E_PumpState</span> <span class="p">:</span>
<span class="p">(</span>
<span class="n">pumpSTOPPED</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span>
<span class="n">pumpSTARTING</span>        <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span>
<span class="n">pumpRUNNING</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">,</span>
<span class="n">pumpFAULT</span> <span class="o">:=</span> <span class="mi">3</span><span class="p">,</span>
<span class="n">pumpSTOPPING</span> <span class="o">:=</span><span class="mi">4</span>
<span class="p">);</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</div>
<div class="section" id="e-valvepositionstate">
<h2>E_ValvePositionState<a class="headerlink" href="#e-valvepositionstate" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">E_ValvePositionState</span> <span class="p">:</span>
    <span class="p">(</span>
<span class="n">OPEN</span>        <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span>
<span class="n">CLOSED</span>      <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span>
<span class="n">MOVING</span>      <span class="o">:=</span> <span class="mi">2</span><span class="p">,</span>
<span class="n">INVALID</span> <span class="o">:=</span><span class="mi">3</span><span class="p">,</span>
<span class="n">OPEN_F</span> <span class="o">:=</span><span class="mi">4</span>
<span class="p">);</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</div>
<div class="section" id="e-vcn">
<h2>E_VCN<a class="headerlink" href="#e-vcn" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">E_VCN</span> <span class="p">:</span>
    <span class="p">(</span>
<span class="n">CloseValve</span>  <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span>
<span class="n">OpenValve</span>   <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span>
<span class="n">PressureControl</span>     <span class="o">:=</span> <span class="mi">2</span><span class="p">,</span>
<span class="n">ManualControl</span>       <span class="o">:=</span> <span class="mi">3</span>

    <span class="p">);</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</div>
<div class="section" id="e-vgc">
<h2>E_VGC<a class="headerlink" href="#e-vgc" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">E_VGC</span> <span class="p">:</span>
<span class="p">(</span>

    <span class="n">Vented</span><span class="p">,</span>
    <span class="n">AtVacuum</span><span class="p">,</span>
    <span class="n">ERR_DiffPress</span><span class="p">,</span>
    <span class="n">ERR_LostVac</span><span class="p">,</span>
    <span class="n">ERR_ExtFault</span>

<span class="p">);</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</div>
<div class="section" id="gauge-type">
<h2>Gauge_Type<a class="headerlink" href="#gauge-type" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">Gauge_Type</span><span class="p">:</span> <span class="p">(</span>
<span class="n">PG722B</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="o">//</span><span class="n">Baraton</span> <span class="n">Gauge</span>
<span class="n">IG903</span> <span class="o">:=</span> <span class="mi">1</span> <span class="p">,</span> <span class="o">//</span><span class="n">Cold</span> <span class="n">Cathode</span>
<span class="n">PG907</span> <span class="o">:=</span> <span class="mi">2</span> <span class="p">,</span> <span class="o">//</span><span class="n">Pirani</span> <span class="n">Gauge</span>
<span class="n">IG909</span><span class="o">:=</span> <span class="mi">3</span> <span class="p">,</span> <span class="o">//</span><span class="n">Hot</span> <span class="n">Cathode</span>
<span class="n">PG925</span> <span class="o">:=</span> <span class="mi">4</span> <span class="p">);</span> <span class="o">//</span><span class="n">MicroPirani</span> <span class="n">Gauge</span>
<span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">enumeration</span> <span class="n">should</span> <span class="n">match</span> <span class="n">up</span> <span class="k">with</span> <span class="n">the</span> <span class="n">EDM</span> <span class="n">MUX</span> <span class="n">button</span> <span class="n">on</span> <span class="n">the</span> <span class="n">vacuum</span> <span class="n">gauge</span> <span class="n">expert</span> <span class="n">controls</span> <span class="n">screen</span> <span class="o">*</span><span class="p">)</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</div>
<div class="section" id="st-agilentptm">
<h2>ST_AgilentPTM<a class="headerlink" href="#st-agilentptm" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_AgilentPTM</span> <span class="n">EXTENDS</span> <span class="n">ST_PTM</span> <span class="p">:</span>
<span class="n">STRUCT</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Inputs</span> <span class="o">*</span><span class="p">)</span>
    <span class="p">(</span><span class="o">*</span> <span class="mi">24</span><span class="n">V</span> <span class="ow">in</span> <span class="n">Ramp</span> <span class="n">state</span><span class="p">;</span> <span class="mi">0</span><span class="n">V</span> <span class="k">for</span> <span class="n">others</span> <span class="o">*</span><span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">START</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">i_xSTART</span> <span class="p">:</span>      <span class="n">BOOL</span><span class="p">;</span>

    <span class="p">(</span><span class="o">*</span> <span class="n">setpoint</span> <span class="n">related</span> <span class="n">to</span> <span class="n">frequency</span> <span class="o">*</span><span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">R1Status</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">AT</span> <span class="n">SPEED</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">i_xR1</span>   <span class="p">:</span>  <span class="n">BOOL</span><span class="p">;</span>

    <span class="p">(</span><span class="o">*</span> <span class="n">setpoint</span> <span class="n">related</span> <span class="n">to</span> <span class="n">Power</span> <span class="o">*</span><span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">R2Status</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">i_xR2</span>   <span class="p">:</span>  <span class="n">BOOL</span><span class="p">;</span>

    <span class="p">(</span><span class="o">*</span> <span class="n">low</span> <span class="n">speed</span> <span class="n">mode</span> <span class="o">*</span><span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">LSPD</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">i_xLSpd</span> <span class="p">:</span>  <span class="n">BOOL</span><span class="p">;</span>


    <span class="p">(</span><span class="o">*</span> <span class="n">Fault</span> <span class="nb">input</span><span class="o">*</span><span class="p">)</span>
    <span class="o">//</span><span class="n">i_xFault</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>  <span class="n">Inherit</span> <span class="n">ST_PTM</span><span class="o">.</span><span class="n">xFault</span>



<span class="p">(</span><span class="o">*</span> <span class="n">controls</span> <span class="o">*</span><span class="p">)</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">Start</span><span class="o">/</span><span class="n">Stop</span> <span class="o">-</span>
            <span class="n">q_RunDo</span> <span class="p">;</span>   <span class="n">Inherit</span> <span class="n">ST_PTM</span><span class="o">.</span>
     <span class="o">*</span><span class="p">)</span>

    <span class="p">(</span><span class="o">*</span> <span class="n">Low</span> <span class="n">speed</span> <span class="n">control</span> <span class="o">*</span><span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">LSPD_DO</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">q_xLSpd</span>         <span class="p">:</span>  <span class="n">BOOL</span><span class="p">;</span>

    <span class="p">(</span><span class="o">*</span><span class="n">Soft</span> <span class="n">start</span> <span class="o">*</span><span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">XSS_DO</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">q_xSS</span>           <span class="p">:</span>  <span class="n">BOOL</span><span class="p">;</span>

    <span class="p">(</span><span class="o">*</span><span class="n">pump</span> <span class="n">Lock</span><span class="o">*</span><span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">FaultLock</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">xPumpFaultLock</span> <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">i_xPumpLockReset</span><span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span> <span class="n">Inherit</span> <span class="n">ST_PTM</span><span class="o">.</span><span class="n">xReset</span>
    <span class="o">//</span> <span class="n">Error</span> <span class="n">messages</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">ErrorMessage</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">sError</span> <span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">Power_MON</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">PREC</span> <span class="mi">2</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="s2">&quot;W&quot;</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">i_rPowerMon</span> <span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>

<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</div>
<div class="section" id="st-ebaradrypump">
<h2>ST_EbaraDryPump<a class="headerlink" href="#st-ebaradrypump" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_EbaraDryPump</span> <span class="n">EXTENDS</span> <span class="n">ST_RoughPump</span> <span class="p">:</span>
<span class="n">STRUCT</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Extension</span> <span class="n">of</span> <span class="n">the</span> <span class="n">rough</span> <span class="n">pump</span> <span class="n">archetype</span> <span class="k">for</span> <span class="n">ebara</span>
<span class="n">Applicable</span> <span class="n">to</span><span class="p">:</span>
<span class="n">EV</span><span class="o">-</span><span class="n">S20</span>
<span class="n">EV</span><span class="o">-</span><span class="n">S50</span>
<span class="n">EV</span><span class="o">-</span><span class="n">S100</span>
<span class="n">EV</span><span class="o">-</span><span class="n">S200</span>
<span class="o">*</span><span class="p">)</span>

<span class="o">//</span><span class="n">Controls</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">MPStart</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
<span class="n">q_xMPStart</span>  <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">Main</span> <span class="n">Pump</span> <span class="n">start</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">BPStart</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
<span class="n">q_xBPStart</span>  <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Booster</span> <span class="n">Pump</span> <span class="n">start</span> <span class="p">(</span><span class="n">this</span> <span class="n">can</span> <span class="n">be</span> <span class="n">started</span> <span class="n">by</span> <span class="n">the</span> <span class="n">pump</span> <span class="n">automatically</span><span class="p">)</span>

<span class="n">xBPIlk</span>      <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>   <span class="o">//</span><span class="n">Booster</span> <span class="n">pump</span> <span class="n">interlock</span>
<span class="n">rBPIlkSP</span>    <span class="p">:</span>       <span class="n">REAL</span> <span class="o">:=</span> <span class="mi">30</span><span class="p">;</span> <span class="o">//</span><span class="n">Booster</span> <span class="n">pump</span> <span class="n">pressure</span> <span class="n">setpoint</span>
<span class="n">tonBP</span>       <span class="p">:</span>       <span class="n">TON</span> <span class="o">:=</span> <span class="p">(</span><span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#5S); //Timer for pressure and valve stability</span>


<span class="o">//</span><span class="n">Readbacks</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">MPStatus</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
<span class="n">i_xMPStatus</span> <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">MP</span> <span class="n">status</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">BPStatus</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
<span class="n">i_xBPStatus</span> <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">BP</span> <span class="n">status</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">WARN_DI</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
<span class="n">i_xWarning</span>  <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="ne">Warning</span> <span class="n">status</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">ALARM</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
<span class="n">i_xAlarm</span>    <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">Alarm</span><span class="p">,</span> <span class="n">maps</span> <span class="n">to</span> <span class="n">error</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">REMOTE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
<span class="n">i_xRemote</span>   <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">Remote</span> <span class="n">control</span> <span class="n">status</span>


<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</div>
<div class="section" id="st-ebaraeva">
<h2>ST_EbaraEVA<a class="headerlink" href="#st-ebaraeva" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_EbaraEVA</span> <span class="n">EXTENDS</span> <span class="n">ST_RoughPump</span><span class="p">:</span>
<span class="n">STRUCT</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Output</span> <span class="o">*</span><span class="p">)</span>
    <span class="o">//</span><span class="n">q_xRunDO</span>      <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="ow">in</span> <span class="n">Rough</span> <span class="n">PUMP</span>


<span class="p">(</span><span class="o">*</span> <span class="n">Input</span> <span class="o">*</span><span class="p">)</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">REMOTE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">q_xRemote</span>       <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">ALARM_OK</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">i_xAlarmOK</span>      <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">RUN_DI</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">i_xIsRun</span>                <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>



<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</div>
<div class="section" id="st-ebaraptm">
<h2>ST_EbaraPTM<a class="headerlink" href="#st-ebaraptm" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_EbaraPTM</span> <span class="n">EXTENDS</span> <span class="n">ST_PTM</span> <span class="p">:</span>
<span class="n">STRUCT</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Extension</span> <span class="n">of</span> <span class="n">the</span> <span class="n">PTM</span> <span class="n">archetype</span> <span class="k">for</span> <span class="n">Ebara</span> <span class="n">turbo</span> <span class="n">controllers</span>
<span class="n">Applicable</span> <span class="n">to</span><span class="p">:</span>
<span class="n">ETC</span> <span class="n">series</span>
<span class="o">*</span><span class="p">)</span>
<span class="o">//</span><span class="n">Controls</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">START</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
<span class="n">q_xStart</span>   <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">Outputs</span> <span class="o">-</span> <span class="n">FB</span> <span class="n">decides</span> <span class="k">if</span> <span class="n">these</span> <span class="n">are</span> <span class="n">actually</span> <span class="nb">set</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">STOP</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
<span class="n">q_xStop</span>    <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">RESET</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
<span class="n">q_xReset</span>   <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">xReset</span> <span class="ow">is</span> <span class="n">momentary</span> <span class="n">reset</span> <span class="n">switch</span> <span class="o">-</span> <span class="n">resets</span> <span class="n">protection</span> <span class="n">functions</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">PROT</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
<span class="n">q_xProtection</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">NC</span><span class="o">.</span> <span class="n">If</span> <span class="n">opened</span><span class="p">,</span> <span class="n">pump</span> <span class="n">will</span> <span class="n">decelerate</span><span class="o">/</span><span class="ow">not</span> <span class="n">start</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">SETSPEED</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
    <span class="s1">&#39;}</span>
<span class="n">iq_xSpeedSet</span>    <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">Request</span> <span class="n">to</span> <span class="nb">set</span> <span class="n">speed</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">SPEED_REQ</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="s2">&quot;Hz&quot;</span>
    <span class="s1">&#39;}</span>
<span class="n">q_iSpeedSet</span>   <span class="p">:</span> <span class="n">DINT</span><span class="p">;</span> <span class="o">//</span><span class="n">Requested</span> <span class="n">speed</span> <span class="p">(</span><span class="nb">min</span><span class="o">.</span> <span class="mi">100</span><span class="n">Hz</span><span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">OVRD_ON</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">OFF</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">ON</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
    <span class="s1">&#39;}</span>
<span class="n">i_xOverride</span>   <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">Override</span> <span class="n">mode</span> <span class="o">-</span> <span class="n">ignores</span> <span class="n">interlocks</span>

<span class="o">//</span><span class="n">Readbacks</span> <span class="o">-</span> <span class="n">also</span> <span class="n">has</span> <span class="n">Accel</span><span class="o">/</span><span class="n">At</span> <span class="n">speed</span><span class="o">/</span><span class="n">Decel</span><span class="o">/</span><span class="n">Fault</span><span class="o">/</span><span class="n">Cur</span> <span class="n">Speed</span> <span class="p">(</span><span class="nb">min</span> <span class="mi">100</span><span class="n">RPM</span><span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">ROTATE_STATUS</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">ROTATING</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
<span class="n">i_xRotate</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">If</span> <span class="nb">open</span><span class="p">,</span> <span class="n">pump</span> <span class="ow">is</span> <span class="n">rotating</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">DECEL</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">DECELERATING</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
<span class="n">i_xDecel</span>  <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">If</span> <span class="n">closed</span><span class="p">,</span> <span class="n">brake</span> <span class="n">engaged</span> <span class="p">(</span><span class="n">pump</span> <span class="n">decelerating</span><span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">FAULT_OK</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
<span class="n">i_xNCFault</span>  <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">Normally</span> <span class="n">closed</span> <span class="n">fault</span> <span class="n">wiring</span><span class="o">.</span> <span class="n">If</span> <span class="n">false</span><span class="p">,</span> <span class="n">there</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">fault</span><span class="p">,</span> <span class="ow">or</span> <span class="n">cable</span> <span class="ow">is</span> <span class="n">unplugged</span><span class="o">.</span>



<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</div>
<div class="section" id="st-kashiyamadrypump">
<h2>ST_KashiyamaDryPump<a class="headerlink" href="#st-kashiyamadrypump" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_KashiyamaDryPump</span> <span class="n">EXTENDS</span> <span class="n">ST_RoughPump</span><span class="p">:</span>
<span class="n">STRUCT</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Output</span> <span class="o">*</span><span class="p">)</span>
    <span class="o">//</span><span class="n">q_xRunDO</span>      <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="ow">in</span> <span class="n">Rough</span> <span class="n">PUMP</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">RESET_DO</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">q_xResetDo</span>      <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">LSPD_DO</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">q_xLspdDo</span>       <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Input</span> <span class="o">*</span><span class="p">)</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">REMOTE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">i_xLocal</span>        <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">ALARM_OK</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">i_xAlarmOK</span>      <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">WARN_OK</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">i_xWarningOK</span>    <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">RUN_DI</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">i_xIsRun</span>                <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Logic</span> <span class="n">status</span> <span class="o">*</span><span class="p">)</span>

    <span class="n">xLspd_IlkENA</span><span class="p">:</span>   <span class="n">BOOL</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span> <span class="n">EPICS</span> <span class="o">*</span><span class="p">)</span>
    <span class="o">//</span><span class="n">xRunSW</span>                <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="ow">in</span> <span class="n">Rough</span> <span class="n">PUMP</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">RESET_SW</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
    <span class="s1">&#39;}</span>
    <span class="n">xResetSW</span>        <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">For</span> <span class="n">resetting</span> <span class="n">faults</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">LSPD_SW</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
    <span class="s1">&#39;}</span>
    <span class="n">xLspdSW</span>     <span class="p">:</span>   <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">LowSP</span>  <span class="p">:</span>   <span class="n">REAL</span> <span class="o">:=</span> <span class="mf">0.02</span><span class="p">;</span> <span class="o">//</span><span class="n">Torr</span>
    <span class="n">HighSP</span> <span class="p">:</span>   <span class="n">REAL</span><span class="p">;</span> <span class="o">//</span><span class="n">Torr</span>
    <span class="n">RdyTmr</span> <span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</div>
<div class="section" id="st-leyboldptm">
<h2>ST_LeyboldPTM<a class="headerlink" href="#st-leyboldptm" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>TYPE ST_LeyboldPTM EXTENDS ST_PTM :
STRUCT
(* Extension of the PTM archetype for Oerlikon turbo controllers
Applicable to:
Mag Drive Digital
Mag Drive S
More?
*)
//Readbacks
    {attribute &#39;pytmc&#39; := &#39;
    pv: DECEL;
    field: ZNAM FALSE;
    field: ONAM TRUE;
    io: i;
    &#39;}
    i_xDecel        :       BOOL;
    {attribute &#39;pytmc&#39; := &#39;
    pv: TEMP;
    field: EGU &quot;C&quot;;
    io: i;
    &#39;}
    i_diPumpTemp:   DINT;
    {attribute &#39;pytmc&#39; := &#39;
    pv: PWR;
    io: i;
    &#39;}
    i_diPwr         :   DINT;
    i_diElecTemp:   DINT;
    {attribute &#39;pytmc&#39; := &#39;
    pv: OVR_TEMP;
    field: ZNAM FALSE;
    field: ONAM TRUE;
    io: i;
    &#39;}
    i_xTempFault:   BOOL;
    i_xNCError      :       BOOL; //Using normally closed wiring

//Controls
    {attribute &#39;pytmc&#39; := &#39;
    pv: REMOTE;
    field: ZNAM FALSE;
    field: ONAM TRUE;
    io: io;
    &#39;}
    q_xRemote : BOOL; (* Remote control enabled *)
END_STRUCT
END_TYPE
</pre></div>
</div>
</div>
<div class="section" id="st-pfeifferptm">
<h2>ST_PfeifferPTM<a class="headerlink" href="#st-pfeifferptm" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>TYPE ST_PfeifferPTM EXTENDS ST_PTM :
STRUCT
(* Extension of the PTM archetype for Pfeiffer turbos
Applicable to:
HiPace series w/ onboard controllers
More?
*)
    //Readbacks
    {attribute &#39;pytmc&#39; := &#39;
    pv: DrivePower_RBV;
    io: i;
    &#39;}
    i_diPwr         :       DINT;
    {attribute &#39;pytmc&#39; := &#39;
    pv: TempElec_RBV;
    io: i;
    &#39;}
    i_diElecTemp    :       DINT;
    {attribute &#39;pytmc&#39; := &#39;
    pv: TempPump_RBV;
    io: i;
    &#39;}
    i_diBtmTemp:    DINT;
    {attribute &#39;pytmc&#39; := &#39;
    pv: TempBearing_RBV;
    io: i;
    &#39;}
    i_diBrngTemp:   DINT;
    {attribute &#39;pytmc&#39; := &#39;
    pv: TempMotor_RBV;
    io: i;
    &#39;}
    i_diMtrTemp:    DINT;
    {attribute &#39;pytmc&#39; := &#39;
    pv: ErrorCode_RBV;
    io: i;
    &#39;}
    i_iErrorCode    :       INT; //might change these to enumeration someday
    {attribute &#39;pytmc&#39; := &#39;
    pv: WarningCode_RBV;
    io: i;
    &#39;}
    i_iWarningCode  :       INT;
    {attribute &#39;pytmc&#39; := &#39;
    pv: TempFault_RBV;
    field: ZNAM FALSE;
    field: ONAM TRUE;
    io: i;
    &#39;}
    i_xTempFault    :       BOOL;
    {attribute &#39;pytmc&#39; := &#39;
    pv: Power_RBV;
    io: i;
    &#39;}
    i_uiPowerPctRbk :   UINT;

//Controls
    q_uiPowerPct : UINT := 100; //Should normally be 100

END_STRUCT
END_TYPE
</pre></div>
</div>
</div>
<div class="section" id="st-pip">
<h2>ST_PIP<a class="headerlink" href="#st-pip" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_PIP</span> <span class="p">:</span>
<span class="n">STRUCT</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Read</span> <span class="n">back</span> <span class="o">*</span><span class="p">)</span>
<span class="o">//</span>  <span class="n">i_xHVisON</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Interlock</span> <span class="o">*</span><span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">ILK_OK</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">NOT</span> <span class="n">OK</span> <span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">OK</span> <span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">xILKOk</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">ERROR</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span> <span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span> <span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">xError</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">AT_VAC_SP</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">HOPR</span> <span class="mi">1000</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">LOPR</span> <span class="mi">0</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">PREC</span> <span class="mi">2</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="s2">&quot;TORR&quot;</span>
    <span class="s1">&#39;}</span>
    <span class="n">rHVEna_SP</span> <span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mf">1.0E-4</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">ILK_DEVICE</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">o</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">sIlkDeviceName</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="o">//</span><span class="n">Required</span> <span class="k">for</span> <span class="n">other</span> <span class="n">devices</span> <span class="n">using</span> <span class="n">this</span> <span class="n">gauge</span> <span class="k">as</span> <span class="n">interlock</span>
    <span class="n">sPath</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span> <span class="n">EPICS</span> <span class="n">Controls</span> <span class="o">*</span><span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">HV_SW</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">OFF</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">ON</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">xHVEna_SW</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">Auto_On</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span><span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">xAutoOn</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>


    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">FORCE_START</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">FORCE</span> <span class="n">START</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">pv_xOvrdStart</span>   <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>


    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">SP_HYS</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">HOPR</span> <span class="mi">1000</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">LOPR</span> <span class="mi">0</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">PREC</span> <span class="mi">2</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="s2">&quot;TORR&quot;</span>
    <span class="s1">&#39;}</span>
    <span class="o">///</span> <span class="n">Protection</span> <span class="n">setpoint</span> <span class="n">hysteresis</span>
    <span class="n">rHYS_PR</span><span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mf">0.001</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">AI_Offset</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">iOffset</span><span class="p">:</span> <span class="n">INT</span><span class="o">:=</span><span class="mi">13</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">Inverted</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">NORMAL</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">INVERTED</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">bOutputInverted</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="p">(</span><span class="o">*</span> <span class="n">IO</span> <span class="n">Controls</span> <span class="o">*</span><span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">HV_DO</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">OFF</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">ON</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">q_xHVEna_DO</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>     <span class="o">//</span> <span class="n">Enable</span> <span class="n">High</span> <span class="n">Voltage</span> <span class="n">when</span> <span class="kc">True</span> <span class="o">//</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="p">(</span><span class="n">EL1124</span><span class="p">)</span> <span class="o">^</span><span class="n">Input</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">PRESS</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">HOPR</span> <span class="mi">1000</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">LOPR</span> <span class="mi">0</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">PREC</span> <span class="mi">2</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="s2">&quot;TORR&quot;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">rPRESS</span><span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>  <span class="o">//</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">PRESS_AI</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">i_iPRESS</span><span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>  <span class="o">//</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">HV_DI</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span><span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">i_xHV_DI</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">NO</span> <span class="n">contact</span> <span class="o">//</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="p">(</span><span class="n">EL1004</span><span class="p">)</span> <span class="o">^</span><span class="n">Input</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">STATE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZRST</span> <span class="n">STOPPED</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONST</span> <span class="n">STARTING</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">TWST</span> <span class="n">RUNNING</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">THST</span> <span class="n">FAULT</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">FRST</span> <span class="n">STOPPING</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>

    <span class="n">eState</span>  <span class="p">:</span>       <span class="n">E_PumpState</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">LOGGER</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">OFF</span> <span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">ON</span> <span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">xLog</span> <span class="p">:</span> <span class="n">BOOL</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</div>
<div class="section" id="st-ptm">
<h2>ST_PTM<a class="headerlink" href="#st-ptm" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_PTM</span> <span class="p">:</span>
<span class="n">STRUCT</span>
<span class="p">(</span><span class="o">*</span> <span class="n">General</span> <span class="n">PTM</span> <span class="n">Structure</span>
<span class="n">Each</span> <span class="n">PTM</span> <span class="n">might</span> <span class="n">have</span> <span class="n">a</span> <span class="n">serial</span> <span class="n">control</span> <span class="n">structure</span><span class="p">,</span> <span class="n">but</span> <span class="nb">all</span> <span class="n">will</span> <span class="n">have</span> <span class="n">a</span> <span class="n">general</span> <span class="n">supervisory</span> <span class="n">control</span> <span class="n">structure</span>

<span class="n">NOTE</span><span class="p">:</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">an</span> <span class="n">archetype</span><span class="p">,</span> <span class="n">use</span> <span class="n">an</span> <span class="n">extension</span> <span class="n">of</span> <span class="n">this</span> <span class="n">structure</span> <span class="k">for</span> <span class="n">a</span> <span class="n">specific</span> <span class="n">pump</span> <span class="p">(</span><span class="ow">or</span> <span class="n">make</span> <span class="n">one</span><span class="p">)</span><span class="o">.</span>

<span class="o">*</span><span class="p">)</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Controls</span> <span class="o">*</span><span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">RUN_SW</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">STOP</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">RUN</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">xRunSW</span>  <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">RST_SW</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">xResetSW</span>        <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">For</span> <span class="n">resetting</span> <span class="n">faults</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">RUN_DO</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">q_RunDO</span>         <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Readbacks</span> <span class="o">*</span><span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">ILK_OK</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">ILK</span> <span class="n">ACTIVE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">ILK</span> <span class="n">OK</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">xExtRunOk</span>       <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span> <span class="n">also</span> <span class="n">a</span> <span class="n">control</span> <span class="o">*</span><span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">ACCEL</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">i_xAccel</span>        <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">AT_SPD</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">AT</span> <span class="n">SPEED</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">i_xAtSpd</span>        <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">SPEED</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="s2">&quot;Hz&quot;</span>
    <span class="s1">&#39;}</span>
    <span class="n">i_diCurSpd</span>      <span class="p">:</span>       <span class="n">DINT</span><span class="p">;</span>

    <span class="n">xCommTimeout</span>    <span class="p">:</span>       <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>  <span class="p">(</span><span class="o">*</span> <span class="n">Initialized</span> <span class="n">true</span> <span class="n">since</span> <span class="n">we</span> <span class="n">haven</span><span class="s1">&#39;t talked to pump yet *)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Alarm</span> <span class="n">Outputs</span> <span class="o">*</span><span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">FAULT</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">i_xFault</span>                <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span><span class="n">FAULT</span><span class="o">*</span><span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">WARN</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">i_xWarn</span>         <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span> <span class="n">warning</span> <span class="o">*</span><span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">ALARM</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">i_xALARM</span>        <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span> <span class="n">ALARM</span> <span class="o">*</span><span class="p">)</span>

<span class="p">(</span><span class="o">*</span> <span class="n">IWS</span> <span class="n">instructions</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">xActive</span> <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">this</span> <span class="n">bit</span> <span class="ow">is</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">add</span> <span class="n">the</span> <span class="n">pump</span> <span class="n">to</span> <span class="n">the</span> <span class="n">system</span>
    <span class="n">iPumpGrp</span>        <span class="p">:</span>       <span class="n">INT</span><span class="p">;</span> <span class="o">//</span> <span class="nb">all</span> <span class="n">members</span> <span class="n">of</span> <span class="n">a</span> <span class="n">pump</span> <span class="n">group</span> <span class="n">start</span> <span class="n">at</span> <span class="n">the</span> <span class="n">same</span> <span class="n">time</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Operational</span> <span class="n">Setpoints</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">rForelineSP</span>     <span class="p">:</span>       <span class="n">REAL</span> <span class="o">:=</span> <span class="mf">0.5</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">BP_SP</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">HOPR</span> <span class="mi">1000</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">LOPR</span> <span class="mi">0</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">PREC</span> <span class="mi">2</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="s2">&quot;TORR&quot;</span>
    <span class="s1">&#39;}</span>
    <span class="n">rBackingPressureSP</span> <span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mf">0.01</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">IP_SP</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">HOPR</span> <span class="mi">1000</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">LOPR</span> <span class="mi">0</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">PREC</span> <span class="mi">2</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="s2">&quot;TORR&quot;</span>
    <span class="s1">&#39;}</span>
    <span class="n">rInletPressureSP</span> <span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mf">0.02</span><span class="p">;</span> <span class="o">//</span><span class="mi">20</span><span class="n">mTorr</span>
<span class="p">(</span><span class="o">*</span><span class="n">State</span><span class="o">*</span><span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">STATE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZRST</span> <span class="n">STOPPED</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONST</span> <span class="n">STARTING</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">TWST</span> <span class="n">RUNNING</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">THST</span> <span class="n">FAULT</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">FRST</span> <span class="n">STOPPING</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>

    <span class="n">eState</span>  <span class="p">:</span>       <span class="n">E_PumpState</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">CURR_MON</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">PREC</span> <span class="mi">2</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="s2">&quot;A&quot;</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">i_rCurrentMon</span> <span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">TEMP_MON</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">PREC</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="s2">&quot;C&quot;</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">i_rTempMon</span>      <span class="p">:</span>       <span class="n">REAL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">LOGGER</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">OFF</span> <span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">ON</span> <span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">xLog</span> <span class="p">:</span> <span class="n">BOOL</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>


<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</div>
<div class="section" id="st-roughpump">
<h2>ST_RoughPump<a class="headerlink" href="#st-roughpump" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_RoughPump</span> <span class="p">:</span>
<span class="n">STRUCT</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Generic</span> <span class="n">roughing</span> <span class="n">pump</span> <span class="n">controls</span>

<span class="n">NOTE</span><span class="p">:</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">an</span> <span class="n">archetype</span><span class="p">,</span> <span class="n">use</span> <span class="n">an</span> <span class="n">extension</span> <span class="n">of</span> <span class="n">this</span> <span class="n">structure</span> <span class="k">for</span> <span class="n">a</span> <span class="n">specific</span> <span class="n">pump</span> <span class="p">(</span><span class="ow">or</span> <span class="n">make</span> <span class="n">one</span><span class="p">)</span><span class="o">.</span>

<span class="o">*</span><span class="p">)</span>

<span class="o">//</span><span class="n">Controls</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">RUN_SW</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">Stop</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">Start</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
<span class="n">pv_xRunSW</span>   <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">epics</span><span class="o">/</span> <span class="n">software</span> <span class="n">control</span> <span class="n">switch</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">RUN_DO</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
<span class="n">q_xRunDo</span>    <span class="p">:</span>   <span class="n">BOOL</span><span class="p">;</span>

<span class="o">//</span><span class="n">Status</span> <span class="ow">and</span> <span class="n">Readback</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">ILK_OK</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">NOT</span> <span class="n">OK</span> <span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">OK</span> <span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
<span class="n">xIlkOK</span>      <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">Interlock</span> <span class="n">bit</span><span class="p">,</span> <span class="n">true</span> <span class="n">means</span> <span class="n">OK</span> <span class="n">to</span> <span class="n">run</span>
<span class="n">xExtIlk</span>     <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">External</span> <span class="n">interlock</span><span class="p">,</span> <span class="n">this</span> <span class="ow">is</span> <span class="n">where</span> <span class="n">the</span> <span class="n">logic</span> <span class="n">goes</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">AT_SPD</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
<span class="n">xAtSpd</span>      <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">Pump</span> <span class="n">at</span> <span class="n">speed</span> <span class="n">setpoint</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">WARN</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
<span class="n">xWrn</span>        <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">Pump</span> <span class="n">warning</span>
<span class="n">iWrn</span>        <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="ne">Warning</span> <span class="n">state</span><span class="o">/</span><span class="n">code</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">ERROR</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
<span class="n">xErr</span>        <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">Error</span> <span class="n">summary</span>
<span class="n">iErr</span>        <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">Error</span> <span class="n">state</span><span class="o">/</span><span class="n">code</span>

<span class="p">(</span><span class="o">*</span><span class="n">State</span><span class="o">*</span><span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">STATE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZRST</span> <span class="n">STOPPED</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONST</span> <span class="n">STARTING</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">TWST</span> <span class="n">RUNNING</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">THST</span> <span class="n">FAULT</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">FRST</span> <span class="n">STOPPING</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>

    <span class="n">eState</span>  <span class="p">:</span>       <span class="n">E_PumpState</span><span class="p">;</span>

<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</div>
<div class="section" id="st-valvebase">
<h2>ST_ValveBase<a class="headerlink" href="#st-valvebase" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_ValveBase</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">EPICS</span> <span class="n">Controls</span> <span class="o">*</span><span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">OPN_SW</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">CLOSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">OPEN</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span> <span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">pv_xOPN_SW</span>      <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">ALM_RST</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">pv_xAlmRst</span>      <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">FORCE_OPN</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">FORCE</span> <span class="n">OPEN</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">pv_xOvrdOpn</span>     <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">OVRD_ON</span> <span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">Override</span> <span class="n">OFF</span> <span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">Override</span> <span class="n">ON</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">xOverrideMode</span>   <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span> <span class="n">Shows</span> <span class="n">the</span> <span class="n">override</span> <span class="n">status</span> <span class="n">of</span> <span class="n">this</span> <span class="n">valve</span> <span class="o">*</span><span class="p">)</span>

<span class="p">(</span><span class="o">*</span> <span class="n">I</span><span class="o">/</span><span class="n">Os</span><span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Readbacks</span> <span class="o">*</span><span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">OPN_DI</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">OPEN</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">i_xOpnLS</span>        <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">CLS_DI</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">CLOSE</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">i_xClsLS</span>        <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Controls</span> <span class="o">*</span><span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">OPN_DO</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">q_xOPN_DO</span>       <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Interlocks</span> <span class="o">*</span><span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">EXT_ILK_OK</span> <span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">NOT</span> <span class="n">OK</span> <span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">OK</span> <span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span> <span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">xEXT_OK</span> <span class="p">:</span>       <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>  <span class="p">(</span><span class="o">*</span> <span class="n">External</span> <span class="n">interlock</span> <span class="k">for</span> <span class="n">custom</span> <span class="n">interlocking</span> <span class="ow">in</span> <span class="n">addition</span> <span class="n">to</span> <span class="n">regular</span> <span class="n">DP</span> <span class="n">ilk</span><span class="p">,</span> <span class="n">this</span> <span class="n">must</span> <span class="n">be</span> <span class="nb">set</span> <span class="n">true</span><span class="p">,</span> <span class="ow">or</span> <span class="n">the</span> <span class="n">interlock</span> <span class="n">condition</span> <span class="n">before</span> <span class="n">calling</span> <span class="n">the</span> <span class="n">FB_VGC</span> <span class="o">*</span><span class="p">)</span>


    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">OPN_OK</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">OPN</span> <span class="n">ILK</span> <span class="n">NOT</span> <span class="n">OK</span> <span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">OPN</span> <span class="n">ILK</span> <span class="n">OK</span> <span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">xOPN_OK</span> <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>   <span class="p">(</span><span class="o">*</span> <span class="n">Final</span> <span class="n">SUM</span> <span class="n">of</span> <span class="n">DP_OK</span> <span class="ow">and</span> <span class="n">EXT_OK</span><span class="p">,</span> <span class="n">needed</span> <span class="n">because</span> <span class="n">it</span> <span class="n">allows</span> <span class="n">the</span> <span class="n">DP</span> <span class="n">ilk</span> <span class="n">to</span> <span class="n">be</span> <span class="n">switched</span> <span class="n">off</span><span class="p">,</span> <span class="n">see</span> <span class="n">FB_VGC</span><span class="o">.</span><span class="n">Dis_DPIlk</span> <span class="o">*</span><span class="p">)</span>

<span class="p">(</span><span class="o">*</span> <span class="n">States</span> <span class="o">*</span><span class="p">)</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">POS_STATE</span><span class="p">;</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">mbbi</span> <span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZRST</span> <span class="n">OPEN</span> <span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONST</span> <span class="n">CLOSED</span> <span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">TWST</span> <span class="n">MOVING</span> <span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">THST</span> <span class="n">INVALID</span> <span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">FRST</span> <span class="n">OPEN_F</span> <span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">eState</span>  <span class="p">:</span>       <span class="n">E_ValvePositionState</span> <span class="o">:=</span> <span class="n">INVALID</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">STATE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZRST</span> <span class="n">Vented</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONST</span> <span class="n">At</span> <span class="n">Vacuum</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">TWST</span> <span class="n">Differential</span> <span class="n">Pressure</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">THST</span> <span class="n">Lost</span> <span class="n">Vacuum</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">FRST</span> <span class="n">Ext</span> <span class="n">Fault</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">eVGC_State</span> <span class="p">:</span> <span class="n">E_VGC</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Error</span> <span class="o">*</span><span class="p">)</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">ERROR</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">NO</span> <span class="n">ERROR</span> <span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">ERROR</span> <span class="n">PRESENT</span> <span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">o</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">bErrorPresent</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">iErrorCode</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">ErrMsg</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">o</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">sErrorMessage</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">LOGGER</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">OFF</span> <span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">ON</span> <span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">xLog</span> <span class="p">:</span> <span class="n">BOOL</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>

<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</div>
<div class="section" id="st-vcc-no">
<h2>ST_VCC_NO<a class="headerlink" href="#st-vcc-no" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>TYPE ST_VCC_NO:
STRUCT

(* A normally open valve needs permission to close! *)
(* Inputs *)
    {attribute &#39;pytmc&#39; := &#39;
    pv: CLS_SW ;
    field: ONAM CLOSE;
    field: ZNAM OPEN;
    io: io ;
    &#39;}
    pv_xCLS_SW      : BOOL;
    {attribute &#39;pytmc&#39; := &#39;
    pv: FORCE_CLS;
    field: ZNAM FALSE;
    field: ONAM FORCE CLOSE;
    io: io;
    &#39;}
    pv_xOvrdCls     :       BOOL;
    {attribute &#39;pytmc&#39; := &#39;
    pv: CLS_OK;
    field: ZNAM FALSE;
    field: ONAM CLS_OK;
    io: i;
    &#39;}
    xCLS_OK : BOOL;

    {attribute &#39;pytmc&#39; := &#39;
    pv: OVRD_ON;
    field: ZNAM Override OFF ;
    field: ONAM Override ON;
    io: io
    &#39;}
    xOverrideMode   :       BOOL; (* Shows the override status of this valve *)

(* Outputs *)
    {attribute &#39;pytmc&#39; := &#39;
    pv: CLS_DO;
            field: ZNAM FALSE;
    field: ONAM TRUE;
    io: i;
    &#39;}
    xCLS_DO : BOOL;

END_STRUCT
END_TYPE
</pre></div>
</div>
</div>
<div class="section" id="st-vcn">
<h2>ST_VCN<a class="headerlink" href="#st-vcn" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_VCN</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">VCN</span> <span class="o">-</span> <span class="n">Valve</span> <span class="n">Controlled</span> <span class="n">Needle</span>
    <span class="n">Used</span> <span class="k">for</span> <span class="n">Pfeiffer</span> <span class="n">EVR</span> <span class="mi">116</span> <span class="n">needle</span> <span class="n">valves</span> <span class="o">*</span><span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">OPN_SW</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">CLOSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">OPEN</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span> <span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">xOPN_SW</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">POS_RDBK</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="o">//</span> <span class="n">Inputs</span>
    <span class="n">i_iPosition</span>     <span class="p">:</span>       <span class="n">REAL</span><span class="p">;</span> <span class="o">//</span><span class="n">Position</span> <span class="n">readback</span> <span class="p">(</span><span class="k">if</span> <span class="n">it</span> <span class="n">exists</span><span class="p">)</span>

    <span class="o">//</span> <span class="n">Outputs</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">POS_AO_R</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span> <span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">q_iRawPosition</span>  <span class="p">:</span>       <span class="n">INT</span><span class="p">;</span> <span class="o">//</span><span class="n">Position</span> <span class="n">control</span>
    <span class="o">//</span><span class="n">For</span> <span class="n">the</span> <span class="n">EVR</span> <span class="mi">116</span> <span class="n">this</span> <span class="ow">is</span> <span class="mi">0</span><span class="o">-</span><span class="mi">10</span><span class="n">V</span> <span class="n">analog</span> <span class="mf">0.4</span> <span class="n">closed</span> <span class="n">to</span> <span class="mf">9.1</span> <span class="n">Closed</span>

    <span class="o">//</span><span class="n">Softvariables</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">ILK_OK</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">NOT</span> <span class="n">OK</span> <span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">OK</span> <span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">xIlkOK</span>  <span class="p">:</span>       <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span> <span class="o">//</span> <span class="n">Interlock</span> <span class="n">Bit</span>

    <span class="n">rUpperLimit</span>     <span class="p">:</span>       <span class="n">REAL</span><span class="o">:=</span><span class="mi">100</span><span class="p">;</span> <span class="o">//</span> <span class="n">Percentage9</span><span class="o">.</span><span class="mi">1</span><span class="p">;</span>    <span class="o">//</span><span class="n">Upper</span> <span class="n">limit</span> <span class="n">on</span> <span class="n">valve</span> <span class="nb">open</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">POS_REQ</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">rReqPosition</span>    <span class="p">:</span>       <span class="n">REAL</span><span class="p">;</span> <span class="o">//</span><span class="n">Requested</span> <span class="n">position</span> <span class="p">(</span><span class="mf">0.0</span><span class="o">-</span><span class="mf">100.0</span><span class="o">%</span><span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span>  <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">STATE</span> <span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZRST</span> <span class="n">Close</span> <span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONST</span> <span class="n">Open</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">TWST</span> <span class="n">PressureControl</span> <span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">THST</span> <span class="n">ManualControl</span> <span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
    <span class="s1">&#39;}</span>
    <span class="n">eValveControl</span>   <span class="p">:</span>       <span class="n">E_VCN</span> <span class="o">:=</span> <span class="n">CloseValve</span><span class="p">;</span> <span class="o">//</span> <span class="n">Valve</span> <span class="n">control</span> <span class="n">state</span>

    <span class="n">ftIlk</span>   <span class="p">:</span>       <span class="n">F_TRIG</span><span class="p">;</span>

<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</div>
<div class="section" id="st-vg">
<h2>ST_VG<a class="headerlink" href="#st-vg" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_VG</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="o">///</span> <span class="n">A</span> <span class="n">general</span> <span class="n">gauge</span> <span class="n">structure</span> <span class="ow">is</span> <span class="n">used</span> <span class="n">to</span> <span class="n">make</span> <span class="n">the</span> <span class="n">rest</span> <span class="n">of</span> <span class="n">the</span> <span class="n">interlocking</span> <span class="n">simpler</span><span class="o">.</span> <span class="n">There</span> <span class="n">are</span> <span class="n">some</span> <span class="n">parameters</span> <span class="k">for</span> <span class="n">cold</span> <span class="n">cathodes</span> <span class="n">that</span> <span class="n">are</span> <span class="ow">not</span> <span class="n">used</span> <span class="n">by</span> <span class="n">pirani</span><span class="o">.</span>
    <span class="o">///</span><span class="n">These</span> <span class="n">features</span> <span class="n">aren</span><span class="s1">&#39;t disabled, they just aren&#39;</span><span class="n">t</span> <span class="n">used</span><span class="p">,</span> <span class="n">think</span> <span class="n">child</span><span class="o">/</span><span class="n">parent</span> <span class="n">classes</span><span class="o">.</span>
    <span class="o">///</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">PRESS</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">HOPR</span> <span class="mi">1000</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">LOPR</span> <span class="mi">0</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">PREC</span> <span class="mi">2</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="s2">&quot;TORR&quot;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">rPRESS</span><span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>  <span class="o">//</span><span class="n">This</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">human</span><span class="o">-</span><span class="n">readable</span> <span class="n">pressure</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">AT_VAC</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">xAT_VAC</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">PRESS_OK</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">OFF</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">ON</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">xPRESS_OK</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">STATE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZRST</span> <span class="n">PressInvalid</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONST</span> <span class="n">GaugeDisconnected</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">TWST</span> <span class="n">OoR</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">THST</span> <span class="n">Off</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">FRST</span> <span class="n">Starting</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">FVST</span> <span class="n">Valid</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">SXST</span> <span class="n">ValidHi</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">SVST</span> <span class="n">ValidLo</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">eState</span>  <span class="p">:</span>       <span class="n">E_PressureState</span><span class="p">;</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">EPICS</span> <span class="n">Controls</span> <span class="o">*</span><span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">HV_SW</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">OFF</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">ON</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">xHV_SW</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">High</span> <span class="n">Voltage</span> <span class="n">Switch</span> <span class="kn">from</span> <span class="nn">epics</span>

    <span class="o">///</span> <span class="n">Controls</span> <span class="ow">and</span> <span class="n">I</span><span class="o">/</span><span class="n">Os</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">PRESS_AI</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">i_iPRESS_R</span>  <span class="p">:</span><span class="n">INT</span><span class="p">;</span> <span class="o">//</span> <span class="nb">input</span> <span class="n">Pressure</span> <span class="o">//</span> <span class="n">Link</span> <span class="n">to</span> <span class="n">analog</span> <span class="n">Input</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">HV_ON</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">i_xHV_ON</span>        <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span>  <span class="kc">True</span> <span class="n">when</span> <span class="n">High</span> <span class="n">Voltage</span> <span class="ow">is</span> <span class="n">on</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">DISC_ACTIVE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">NO</span> <span class="n">DISC</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">DISC</span> <span class="n">ACTIVE</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">i_xDisc_Active</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span><span class="o">//</span> <span class="n">Discharge</span> <span class="n">Current</span> <span class="n">Active</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">HV_DIS_DO</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span> <span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span> <span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">q_xHV_DIS</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Enable</span> <span class="n">High</span> <span class="n">Voltage</span> <span class="n">when</span> <span class="kc">True</span>
    <span class="o">//</span>
    <span class="n">wHV_RO</span><span class="p">:</span> <span class="n">WORD</span><span class="p">;</span>

    <span class="o">///</span> <span class="n">Bakeout</span> <span class="n">bit</span>
    <span class="n">xBAKEOUT</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="o">//</span><span class="n">enum</span> <span class="k">for</span> <span class="n">gauge</span> <span class="nb">type</span> <span class="o">-</span> <span class="n">will</span> <span class="n">replace</span> <span class="n">iType</span>
    <span class="n">eTYPE</span><span class="p">:</span> <span class="n">Gauge_Type</span> <span class="o">:=</span> <span class="n">PG907</span><span class="p">;</span>
    <span class="o">//</span><span class="n">Gauge</span> <span class="nb">type</span><span class="p">,</span> <span class="n">deprecated</span> <span class="p">(</span><span class="n">default</span> <span class="n">to</span> <span class="n">pirani</span><span class="p">)</span>
    <span class="n">iTYPE</span><span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Index</span> <span class="n">location</span> <span class="n">of</span> <span class="n">the</span> <span class="n">associated</span> <span class="n">Pirani</span> <span class="n">Gauge</span>
    <span class="n">wPG</span><span class="p">:</span> <span class="n">WORD</span><span class="p">;</span>


    <span class="n">xTurnOnTime</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span><span class="o">///</span> <span class="n">Turn</span> <span class="n">on</span> <span class="n">Timers</span> <span class="k">for</span> <span class="n">cold</span> <span class="n">cathode</span> <span class="n">warmup</span>

    <span class="n">iVacSp</span>  <span class="p">:</span>       <span class="n">INT</span><span class="p">;</span><span class="o">///</span> <span class="n">At</span> <span class="n">vacuum</span> <span class="n">setpoint</span> <span class="k">for</span> <span class="nb">all</span> <span class="n">gauges</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">VAC_SP</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span><span class="n">io</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">HOPR</span> <span class="mi">1000</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">LOPR</span> <span class="mi">0</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">PREC</span> <span class="mi">2</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="s2">&quot;TORR&quot;</span>
    <span class="s1">&#39;}</span>
    <span class="n">rVAC_SP</span><span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mf">0.001</span><span class="p">;</span> <span class="o">///</span> <span class="n">At</span> <span class="n">vacuum</span> <span class="n">setpoint</span> <span class="k">for</span> <span class="nb">all</span> <span class="n">gauges</span>
    <span class="o">///</span> <span class="n">Protection</span> <span class="n">setpoint</span> <span class="k">for</span> <span class="n">ion</span> <span class="n">gauges</span> <span class="n">at</span> <span class="n">which</span> <span class="n">the</span> <span class="n">gauge</span> <span class="n">turns</span> <span class="n">off</span><span class="p">,</span> <span class="ow">not</span> <span class="n">used</span> <span class="k">for</span> <span class="n">pirani</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">PRO_SP</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">HOPR</span> <span class="mi">1000</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">LOPR</span> <span class="mi">0</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">PREC</span> <span class="mi">2</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="s2">&quot;TORR&quot;</span>
    <span class="s1">&#39;}</span>
    <span class="n">rPRO_SP</span><span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mf">0.001</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">SP_HYS</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">HOPR</span> <span class="mi">1000</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">LOPR</span> <span class="mi">0</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">PREC</span> <span class="mi">2</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="s2">&quot;TORR&quot;</span>
    <span class="s1">&#39;}</span>
    <span class="o">///</span> <span class="n">Protection</span> <span class="n">setpoint</span> <span class="n">hysteresis</span>
    <span class="n">rHYS_PR</span><span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mf">0.001</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">ILK_OK</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">NOT</span> <span class="n">OK</span> <span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">OK</span> <span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">xILKOk</span>  <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span> <span class="n">also</span> <span class="n">a</span> <span class="n">control</span> <span class="o">*</span><span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">LOGGER</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">OFF</span> <span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">ON</span> <span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">xLog</span> <span class="p">:</span> <span class="n">BOOL</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="o">//</span><span class="n">Required</span> <span class="k">for</span> <span class="n">other</span> <span class="n">devices</span> <span class="n">using</span> <span class="n">this</span> <span class="n">gauge</span> <span class="k">as</span> <span class="n">interlock</span>
    <span class="n">sPath</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>

    <span class="o">///</span> <span class="n">Full</span> <span class="n">scale</span> <span class="n">pressure</span> <span class="ow">in</span> <span class="n">Torr</span> <span class="k">for</span> <span class="n">baratron</span> <span class="n">pressure</span> <span class="n">conversion</span>
    <span class="n">rFULL_SCALE</span><span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mi">1000</span><span class="p">;</span>

<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</div>
<div class="section" id="st-vgc">
<h2>ST_VGC<a class="headerlink" href="#st-vgc" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_VGC</span> <span class="n">EXTENDS</span> <span class="n">ST_ValveBase</span><span class="p">:</span>
<span class="n">STRUCT</span>


<span class="p">(</span><span class="o">*</span> <span class="n">Interlocks</span> <span class="o">*</span><span class="p">)</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">DP_OK</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">DP</span> <span class="n">NOT</span> <span class="n">OK</span> <span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">DP</span> <span class="n">OK</span> <span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">xDP_OK</span>  <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>   <span class="p">(</span><span class="o">*</span> <span class="n">Managed</span> <span class="n">by</span> <span class="n">the</span> <span class="n">VGC</span> <span class="n">function</span> <span class="p">(</span><span class="n">FB_VGC</span><span class="p">)</span> <span class="o">*</span><span class="p">)</span><span class="o">//</span> <span class="n">Indicates</span> <span class="n">the</span> <span class="n">valve</span> <span class="n">can</span> <span class="n">be</span> <span class="n">opened</span> <span class="n">because</span> <span class="n">the</span> <span class="n">differential</span> <span class="n">pressure</span> <span class="ow">is</span> <span class="n">low</span> <span class="n">enough</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">AT_VAC_SP</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">o</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">HOPR</span> <span class="mi">1000</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">LOPR</span> <span class="mi">0</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">PREC</span> <span class="mi">2</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="s2">&quot;TORR&quot;</span>
    <span class="s1">&#39;}</span>
    <span class="n">rAT_VAC_SP</span>      <span class="p">:</span>       <span class="n">REAL</span> <span class="o">:=</span> <span class="mf">0.000001</span><span class="p">;</span>       <span class="o">//</span> <span class="n">Interlock</span> <span class="n">setpoint</span> <span class="k">for</span> <span class="n">gauges</span> <span class="n">on</span> <span class="n">both</span> <span class="n">sides</span> <span class="n">of</span> <span class="n">valve</span>
    <span class="n">rAT_VAC_SP_LAST</span> <span class="p">:</span>       <span class="n">REAL</span> <span class="o">:=</span><span class="mf">0.000001</span> <span class="p">;</span>       <span class="o">//</span> <span class="n">Interlock</span> <span class="n">setpoint</span> <span class="k">for</span> <span class="n">gauges</span> <span class="n">on</span> <span class="n">both</span> <span class="n">sides</span> <span class="n">of</span> <span class="n">valve</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">AT_VAC_HYS</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">o</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">HOPR</span> <span class="mi">1000</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">LOPR</span> <span class="mi">0</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">PREC</span> <span class="mi">2</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="s2">&quot;TORR&quot;</span>
    <span class="s1">&#39;}</span>
    <span class="n">rAT_VAC_HYS</span>     <span class="p">:</span>       <span class="n">REAL</span> <span class="o">:=</span><span class="mf">0.000001</span><span class="p">;</span>        <span class="o">//</span> <span class="n">Hysteresis</span> <span class="n">of</span> <span class="n">the</span> <span class="n">vacuum</span> <span class="n">sp</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">HYST_PERC</span> <span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">o</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">rHYST_PERC</span>      <span class="p">:</span>       <span class="n">REAL</span> <span class="o">:=</span> <span class="mf">0.80</span><span class="p">;</span>   <span class="o">//</span> <span class="n">Hysteresis</span> <span class="n">percentage</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">AT_VAC</span> <span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">NOT</span> <span class="n">AT</span> <span class="n">VAC</span> <span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">AT</span> <span class="n">VAC</span> <span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">xAT_VAC</span> <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>   <span class="o">//</span><span class="n">At</span> <span class="n">vacuum</span> <span class="n">setpoint</span>


<span class="p">(</span><span class="o">*</span> <span class="n">Alarm</span> <span class="n">Outputs</span> <span class="o">*</span><span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">ERR_DifPres</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">NO</span> <span class="n">ERROR</span> <span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">Diffrential</span> <span class="n">error</span> <span class="n">present</span> <span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">o</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">xERR_DifPres</span>            <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">ERR_SP</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">NO</span> <span class="n">ERROR</span> <span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">Setpoint</span> <span class="n">error</span> <span class="n">present</span> <span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">o</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">xERR_SP</span>                 <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">ERR_Ext</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">NO</span> <span class="n">ERROR</span> <span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">External</span> <span class="n">error</span> <span class="n">present</span> <span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">o</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">xERR_ExtFault</span>           <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">xAlmSum</span>                 <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span><span class="n">ILK</span> <span class="n">Devices</span><span class="o">*</span><span class="p">)</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">ILK_DEVICE_US</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">o</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">sIlkUSDeviceName</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">ILK_DEVICE_DS</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">o</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">sIlkDSDeviceName</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>

<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</div>
<div class="section" id="st-vrc">
<h2>ST_VRC<a class="headerlink" href="#st-vrc" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_VRC</span> <span class="n">EXTENDS</span> <span class="n">ST_ValveBase</span><span class="p">:</span>
<span class="n">STRUCT</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Readbacks</span> <span class="o">*</span><span class="p">)</span>
    <span class="o">//</span><span class="n">In</span> <span class="n">case</span> <span class="n">VRC</span> <span class="ow">is</span> <span class="n">normally</span> <span class="nb">open</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">CLS_OK</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">xCLS_OK</span> <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</div>
<div class="section" id="st-vvc">
<h2>ST_VVC<a class="headerlink" href="#st-vvc" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_VVC</span> <span class="p">:</span>
<span class="n">STRUCT</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Inputs</span> <span class="o">*</span><span class="p">)</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">OPN_SW</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">CLOSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">OPEN</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">pv_xOPN_SW</span>      <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span><span class="n">FORCE_OPN</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">OPEN</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">xOvrdOpn</span>        <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">OVRD_ON</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">Override</span> <span class="n">ON</span> <span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">Override</span> <span class="n">OFF</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">xOverrideMode</span>   <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span> <span class="n">Shows</span> <span class="n">the</span> <span class="n">override</span> <span class="n">status</span> <span class="n">of</span> <span class="n">this</span> <span class="n">valve</span> <span class="o">*</span><span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">OPN_OK</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">OPN</span> <span class="n">ILK</span> <span class="n">NOT</span> <span class="n">OK</span> <span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">OPN</span> <span class="n">ILK</span> <span class="n">OK</span> <span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">xOPN_OK</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Outputs</span> <span class="o">*</span><span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">OPN_DO</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">CLOSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">OPEN</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">q_xOPN_DO</span>       <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="gvls">
<h1>GVLs<a class="headerlink" href="#gvls" title="Permalink to this headline">¶</a></h1>
<div class="section" id="constants">
<h2>Constants<a class="headerlink" href="#constants" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">VAR_GLOBAL</span> <span class="n">CONSTANT</span>
    <span class="n">gc_iSizeOfGGOArray</span> <span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">50</span><span class="p">;</span>
    <span class="n">gc_GaugeValidState</span> <span class="p">:</span>    <span class="n">INT</span> <span class="o">:=</span> <span class="mi">4</span><span class="p">;</span>
<span class="n">END_VAR</span>
</pre></div>
</div>
</div>
<div class="section" id="global-variables">
<h2>Global_Variables<a class="headerlink" href="#global-variables" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">VAR_GLOBAL</span>
    <span class="n">g_iSizeOfGGOArray</span> <span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">50</span><span class="p">;</span>

    <span class="n">g_stSystem</span>      <span class="p">:</span>       <span class="n">ST_System</span><span class="p">(</span><span class="o">*</span><span class="n">System_Struct</span><span class="o">*</span><span class="p">)</span><span class="o">:=</span> <span class="p">(</span>
            <span class="n">xFirstScan</span> <span class="o">:=</span> <span class="n">TRUE</span>
    <span class="p">);</span>

    <span class="n">g_DummyVG</span>       <span class="p">:</span>       <span class="n">ST_VG</span><span class="p">;</span>


     <span class="n">fbGetCurTaskIdx</span> <span class="p">:</span> <span class="n">GETCURTASKINDEX</span><span class="p">;</span>



<span class="n">END_VAR</span>
</pre></div>
</div>
</div>
<div class="section" id="global-version">
<h2>Global_Version<a class="headerlink" href="#global-version" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcGenerated&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;no-analysis&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;linkalways&#39;</span><span class="p">}</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">function</span> <span class="n">has</span> <span class="n">been</span> <span class="n">automatically</span> <span class="n">generated</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">project</span> <span class="n">information</span><span class="o">.</span>
<span class="n">VAR_GLOBAL</span> <span class="n">CONSTANT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;const_non_replaced&#39;</span><span class="p">}</span>
    <span class="n">stLibVersion_LCLS_Vacuum</span> <span class="p">:</span> <span class="n">ST_LibVersion</span> <span class="o">:=</span> <span class="p">(</span><span class="n">iMajor</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">iMinor</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">iBuild</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">iRevision</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nFlags</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sVersion</span> <span class="o">:=</span> <span class="s1">&#39;0.0.0&#39;</span><span class="p">);</span>
<span class="n">END_VAR</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="pous">
<h1>POUs<a class="headerlink" href="#pous" title="Permalink to this headline">¶</a></h1>
<div class="section" id="f-roughpumpinlet-ilk">
<h2>F_RoughPumpInlet_ILK<a class="headerlink" href="#f-roughpumpinlet-ilk" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span>
    <span class="n">Determine</span> <span class="n">whether</span> <span class="n">a</span> <span class="n">pump</span> <span class="n">attached</span> <span class="n">to</span> <span class="n">the</span> <span class="n">inlet</span> <span class="n">of</span> <span class="n">a</span> <span class="n">roughing</span> <span class="n">pump</span> <span class="ow">is</span> <span class="n">safe</span> <span class="n">to</span> <span class="nb">open</span><span class="o">.</span>

    <span class="n">Return</span> <span class="n">true</span><span class="p">,</span> <span class="n">signaling</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">safe</span> <span class="n">to</span> <span class="nb">open</span> <span class="n">when</span> <span class="n">the</span> <span class="n">roughing</span> <span class="n">pump</span> <span class="ow">is</span> <span class="n">confirmed</span> <span class="n">to</span> <span class="n">be</span> <span class="n">working</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>

<span class="n">FUNCTION</span> <span class="n">F_RoughPumpInlet_ILK</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">ScrollPump</span>      <span class="p">:</span>       <span class="n">ST_RoughPump</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">F_RoughPumpInlet_ILK</span> <span class="o">:=</span> <span class="p">(</span><span class="n">ScrollPump</span><span class="o">.</span><span class="n">eState</span> <span class="o">=</span> <span class="n">pumpRUNNING</span><span class="p">);</span> <span class="p">(</span><span class="o">*</span> <span class="n">Confirm</span> <span class="n">that</span> <span class="n">the</span> <span class="n">roughing</span> <span class="n">pump</span> <span class="ow">is</span> <span class="n">running</span> <span class="n">before</span> <span class="n">opening</span> <span class="n">the</span> <span class="n">valve</span> <span class="o">*</span><span class="p">)</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
</div>
<div class="section" id="f-turbo-vrc-ilk">
<h2>F_TURBO_VRC_ILK<a class="headerlink" href="#f-turbo-vrc-ilk" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span> <span class="n">Close</span> <span class="n">the</span> <span class="n">vic</span> <span class="k">if</span> <span class="n">the</span> <span class="n">roughing</span> <span class="n">pump</span> <span class="n">pirani</span> <span class="n">loses</span> <span class="n">its</span> <span class="n">at</span><span class="o">-</span><span class="n">vac</span> <span class="n">setpoint</span> <span class="k">while</span> <span class="n">the</span> <span class="n">turbo</span> <span class="ow">is</span> <span class="n">pumping</span> <span class="o">*</span><span class="p">)</span>
<span class="n">FUNCTION</span> <span class="n">F_TURBO_VRC_ILK</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>

    <span class="n">i_xHiVac</span>        <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">i_xRunPTM</span>       <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">i_xFLVac</span>        <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

<span class="n">END_VAR</span>
<span class="n">VAR</span>

    <span class="n">rHysterisis</span> <span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">xInterlock</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">rTolerance</span><span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mi">20</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Close</span> <span class="n">the</span> <span class="n">vic</span> <span class="k">if</span> <span class="n">the</span> <span class="n">roughing</span> <span class="n">pump</span> <span class="n">pirani</span> <span class="n">loses</span> <span class="n">its</span> <span class="n">at</span><span class="o">-</span><span class="n">vac</span> <span class="n">setpoint</span> <span class="k">while</span> <span class="n">the</span> <span class="n">turbo</span> <span class="ow">is</span> <span class="n">pumping</span> <span class="o">*</span><span class="p">)</span>
<span class="n">F_TURBO_VRC_ILK</span> <span class="o">:=</span> <span class="p">(</span><span class="n">NOT</span> <span class="n">i_xHiVac</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">i_xRunPTM</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">i_xFLVac</span><span class="p">)</span> <span class="n">OR</span>
                                    <span class="p">(</span><span class="n">NOT</span> <span class="n">i_xRunPTM</span> <span class="n">AND</span> <span class="n">i_xFLVac</span><span class="p">)</span> <span class="n">OR</span>
                                    <span class="p">(</span><span class="n">i_xRunPTM</span> <span class="n">AND</span> <span class="n">i_xFLVac</span><span class="p">);</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
</div>
<div class="section" id="f-turboextilk-no">
<h2>F_TurboExtILK_NO<a class="headerlink" href="#f-turboextilk-no" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">function</span> <span class="n">Block</span> <span class="n">interfaces</span> <span class="k">with</span> <span class="n">a</span> <span class="n">NO</span> <span class="n">turbo</span> <span class="n">valve</span><span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Mainly</span> <span class="n">used</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">FEE</span> <span class="n">HXR</span> <span class="n">GATT</span><span class="o">*</span><span class="p">)</span>
<span class="n">FUNCTION</span> <span class="n">F_TurboExtILK_NO</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">Turbo</span>           <span class="p">:</span>       <span class="n">ST_PTM</span><span class="p">;</span>
    <span class="n">BackingGauge</span><span class="p">:</span>   <span class="n">ST_VG</span><span class="p">;</span>
    <span class="n">InletGauge</span>      <span class="p">:</span>       <span class="n">ST_VG</span><span class="p">;</span>
    <span class="n">VentValve</span>       <span class="p">:</span>       <span class="n">ST_VCC_NO</span><span class="p">;</span> <span class="o">//</span><span class="n">NO</span> <span class="nb">type</span> <span class="n">turbo</span> <span class="n">valve</span>
    <span class="n">ScrollPump</span>      <span class="p">:</span>       <span class="n">ST_RoughPump</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span>
<span class="n">END_VAR</span>


<span class="n">END_FUNCTION</span>
</pre></div>
</div>
</div>
<div class="section" id="f-turboextilklogic">
<h2>F_TurboExtILKLogic<a class="headerlink" href="#f-turboextilklogic" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">function</span> <span class="n">evaluates</span> <span class="n">the</span> <span class="n">Turbo</span> <span class="n">ILK</span> <span class="n">logic</span><span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">The</span> <span class="n">Turbo</span> <span class="n">shall</span> <span class="ow">not</span> <span class="n">Run</span> <span class="k">if</span> <span class="n">the</span> <span class="n">vent</span> <span class="n">valve</span> <span class="ow">is</span> <span class="nb">open</span><span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">The</span> <span class="n">function</span> <span class="n">also</span> <span class="n">switches</span> <span class="n">off</span> <span class="n">the</span> <span class="n">Turbo</span> <span class="k">if</span> <span class="n">the</span> <span class="n">Inlet</span> <span class="n">pressure</span> <span class="ow">or</span> <span class="n">the</span> <span class="n">backing</span> <span class="n">Pressure</span><span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">are</span> <span class="n">higher</span> <span class="n">than</span> <span class="n">the</span> <span class="n">configured</span> <span class="nb">set</span> <span class="n">point</span><span class="o">*</span><span class="p">)</span>
<span class="n">FUNCTION</span> <span class="n">F_TurboExtILKLogic</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">Turbo</span>           <span class="p">:</span>       <span class="n">ST_PTM</span><span class="p">;</span>
    <span class="n">BackingGauge</span><span class="p">:</span>   <span class="n">ST_VG</span><span class="p">;</span>
    <span class="n">InletGauge</span>      <span class="p">:</span>       <span class="n">ST_VG</span><span class="p">;</span>
    <span class="n">VentValve</span>       <span class="p">:</span>       <span class="n">ST_VVC</span><span class="p">;</span>
    <span class="n">ScrollPump</span>      <span class="p">:</span>       <span class="n">ST_RoughPump</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span>
<span class="n">END_VAR</span>


<span class="n">END_FUNCTION</span>
</pre></div>
</div>
</div>
<div class="section" id="f-turboextilklogic-2">
<h2>F_TurboExtILKLogic_2<a class="headerlink" href="#f-turboextilklogic-2" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">function</span> <span class="n">evaluates</span> <span class="n">the</span> <span class="n">Turbo</span> <span class="n">ILK</span> <span class="n">logic</span><span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">The</span> <span class="n">function</span> <span class="n">switches</span> <span class="n">off</span> <span class="n">the</span> <span class="n">Turbo</span> <span class="k">if</span> <span class="n">the</span> <span class="n">Inlet</span> <span class="n">pressure</span> <span class="ow">or</span> <span class="n">the</span> <span class="n">backing</span> <span class="n">Pressure</span><span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">are</span> <span class="n">higher</span> <span class="n">than</span> <span class="n">the</span> <span class="n">configured</span> <span class="nb">set</span> <span class="n">point</span><span class="o">*</span><span class="p">)</span>
<span class="n">FUNCTION</span> <span class="n">F_TurboExtILKLogic_2</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">Turbo</span>           <span class="p">:</span>       <span class="n">ST_PTM</span><span class="p">;</span>
    <span class="n">BackingGauge</span><span class="p">:</span>   <span class="n">ST_VG</span><span class="p">;</span>
    <span class="n">InletGauge</span>      <span class="p">:</span>       <span class="n">ST_VG</span><span class="p">;</span>
    <span class="n">ScrollPump</span>      <span class="p">:</span>       <span class="n">ST_RoughPump</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>


<span class="n">END_FUNCTION</span>
</pre></div>
</div>
</div>
<div class="section" id="f-turbogatevalve-ilk">
<h2>F_TurboGateValve_ILK<a class="headerlink" href="#f-turbogatevalve-ilk" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">Function</span> <span class="n">Block</span> <span class="n">evaluates</span> <span class="n">the</span> <span class="n">ILK</span> <span class="n">condition</span> <span class="n">of</span> <span class="n">the</span> <span class="n">Turbo</span> <span class="n">Gate</span> <span class="n">valve</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">The</span> <span class="n">logic</span> <span class="n">Protects</span> <span class="n">the</span> <span class="n">Turbo</span> <span class="n">pump</span> <span class="kn">from</span> <span class="nn">inlet</span> <span class="n">pressure</span> <span class="n">above</span> <span class="n">the</span> <span class="n">SP</span><span class="o">*</span><span class="p">)</span>

<span class="n">FUNCTION</span> <span class="n">F_TurboGateValve_ILK</span> <span class="p">:</span> <span class="n">BOOL</span> <span class="p">(</span><span class="o">*</span> <span class="n">function</span> <span class="k">return</span> <span class="n">TRUE</span> <span class="n">when</span> <span class="n">ILK</span> <span class="ow">is</span> <span class="n">OK</span><span class="o">*</span><span class="p">)</span>
<span class="n">VAR_INPUT</span>
    <span class="n">i_Turbo</span> <span class="p">:</span> <span class="n">ST_PTM</span><span class="p">;</span> <span class="o">//</span> <span class="n">Turbo</span> <span class="n">Pump</span>
    <span class="n">i_stISG</span> <span class="p">:</span> <span class="n">ST_VG</span><span class="p">;</span> <span class="o">//</span><span class="n">Gauge</span> <span class="n">measuring</span> <span class="n">inlet</span> <span class="n">Pressure</span> <span class="n">e</span><span class="o">.</span><span class="n">g</span> <span class="n">Pirani</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">Function</span> <span class="n">Block</span> <span class="n">evaluates</span> <span class="n">the</span> <span class="n">ILK</span> <span class="n">condition</span> <span class="n">of</span> <span class="n">the</span> <span class="n">Turbo</span> <span class="n">Gate</span> <span class="n">valve</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">The</span> <span class="n">logic</span> <span class="n">Protects</span> <span class="n">the</span> <span class="n">Turbo</span> <span class="n">pump</span> <span class="kn">from</span> <span class="nn">inlet</span> <span class="n">pressure</span> <span class="n">above</span> <span class="n">the</span> <span class="n">SP</span><span class="o">*</span><span class="p">)</span>
<span class="n">F_TurboGateValve_ILK</span> <span class="o">:=</span> <span class="p">(</span><span class="n">NOT</span> <span class="p">(</span><span class="n">i_Turbo</span><span class="o">.</span><span class="n">eState</span> <span class="o">=</span> <span class="n">pumpSTOPPED</span><span class="p">)</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="p">(</span><span class="n">i_Turbo</span><span class="o">.</span><span class="n">eState</span> <span class="o">=</span> <span class="n">pumpSTOPPING</span><span class="p">)</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="p">(</span><span class="n">i_Turbo</span><span class="o">.</span><span class="n">eState</span> <span class="o">=</span> <span class="n">pumpFAULT</span><span class="p">))</span>
                                            <span class="n">AND</span> <span class="p">(</span><span class="n">i_stISG</span><span class="o">.</span><span class="n">xPRESS_OK</span> <span class="n">AND</span> <span class="n">i_stISG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">&lt;</span> <span class="n">i_Turbo</span><span class="o">.</span><span class="n">rInletPressureSP</span><span class="p">);</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
</div>
<div class="section" id="f-turbogatevalve-ilk-1">
<h2>F_TurboGateValve_ILK_1<a class="headerlink" href="#f-turbogatevalve-ilk-1" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">Function</span> <span class="n">Block</span> <span class="n">evaluates</span> <span class="n">the</span> <span class="n">ILK</span> <span class="n">condition</span> <span class="n">of</span> <span class="n">the</span> <span class="n">Turbo</span> <span class="n">Gate</span> <span class="n">valve</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">The</span> <span class="n">logic</span> <span class="n">Protects</span> <span class="n">the</span> <span class="n">Turbo</span> <span class="n">pump</span> <span class="kn">from</span> <span class="nn">inlet</span> <span class="n">pressure</span> <span class="n">above</span> <span class="n">the</span> <span class="n">SP</span><span class="o">*</span><span class="p">)</span>

<span class="n">FUNCTION</span> <span class="n">F_TurboGateValve_ILK_1</span> <span class="p">:</span> <span class="n">BOOL</span> <span class="p">(</span><span class="o">*</span> <span class="n">function</span> <span class="k">return</span> <span class="n">TRUE</span> <span class="n">when</span> <span class="n">ILK</span> <span class="ow">is</span> <span class="n">OK</span><span class="o">*</span><span class="p">)</span>
<span class="n">VAR_INPUT</span>
    <span class="n">i_Turbo</span> <span class="p">:</span> <span class="n">ST_PTM</span><span class="p">;</span> <span class="o">//</span> <span class="n">Turbo</span> <span class="n">Pump</span>
    <span class="n">i_stISG</span> <span class="p">:</span> <span class="n">ST_VG</span><span class="p">;</span> <span class="o">//</span><span class="n">Gauge</span> <span class="n">measuring</span> <span class="n">inlet</span> <span class="n">Pressure</span> <span class="n">e</span><span class="o">.</span><span class="n">g</span> <span class="n">Pirani</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">Function</span> <span class="n">Block</span> <span class="n">evaluates</span> <span class="n">the</span> <span class="n">ILK</span> <span class="n">condition</span> <span class="n">of</span> <span class="n">the</span> <span class="n">Turbo</span> <span class="n">Gate</span> <span class="n">valve</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">The</span> <span class="n">logic</span> <span class="n">Protects</span> <span class="n">the</span> <span class="n">Turbo</span> <span class="n">pump</span> <span class="kn">from</span> <span class="nn">inlet</span> <span class="n">pressure</span> <span class="n">above</span> <span class="n">the</span> <span class="n">SP</span><span class="o">*</span><span class="p">)</span>
<span class="n">F_TurboGateValve_ILK_1</span> <span class="o">:=</span> <span class="p">(</span><span class="n">NOT</span> <span class="p">(</span><span class="n">i_Turbo</span><span class="o">.</span><span class="n">eState</span> <span class="o">=</span> <span class="n">pumpSTOPPED</span><span class="p">)</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="p">(</span><span class="n">i_Turbo</span><span class="o">.</span><span class="n">eState</span> <span class="o">=</span> <span class="n">pumpFAULT</span><span class="p">))</span>
                                            <span class="n">AND</span> <span class="p">(</span><span class="n">i_stISG</span><span class="o">.</span><span class="n">xPRESS_OK</span> <span class="n">AND</span> <span class="n">i_stISG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">&lt;</span> <span class="n">i_Turbo</span><span class="o">.</span><span class="n">rInletPressureSP</span><span class="p">);</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
</div>
<div class="section" id="f-turbogatevalve-protection-ilk">
<h2>F_TurboGateValve_Protection_ILK<a class="headerlink" href="#f-turbogatevalve-protection-ilk" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">Function</span> <span class="n">Block</span> <span class="n">evaluates</span> <span class="n">the</span> <span class="n">ILK</span> <span class="n">condition</span> <span class="n">of</span> <span class="n">the</span> <span class="n">Turbo</span> <span class="n">Gate</span> <span class="n">valve</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">The</span> <span class="n">logic</span> <span class="n">Protects</span> <span class="n">the</span> <span class="n">Turbo</span> <span class="n">pump</span> <span class="kn">from</span> <span class="nn">inlet</span> <span class="n">pressure</span> <span class="n">above</span> <span class="n">the</span> <span class="n">SP</span><span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">And</span> <span class="n">Protects</span> <span class="n">the</span> <span class="n">Turbo</span> <span class="n">pump</span> <span class="kn">from</span> <span class="nn">backing</span> <span class="n">pressure</span> <span class="n">above</span> <span class="n">the</span> <span class="n">SP</span><span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">And</span> <span class="n">Protects</span> <span class="n">the</span> <span class="n">Turbo</span> <span class="n">pump</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">case</span> <span class="n">of</span> <span class="n">backing</span> <span class="n">pump</span> <span class="ow">not</span> <span class="n">running</span><span class="o">*</span><span class="p">)</span>

<span class="n">FUNCTION</span> <span class="n">F_TurboGateValve_Protection_ILK</span> <span class="p">:</span> <span class="n">BOOL</span> <span class="p">(</span><span class="o">*</span> <span class="n">function</span> <span class="k">return</span> <span class="n">TRUE</span> <span class="n">when</span> <span class="n">ILK</span> <span class="ow">is</span> <span class="n">OK</span><span class="o">*</span><span class="p">)</span>
<span class="n">VAR_INPUT</span>
    <span class="n">i_Turbo</span> <span class="p">:</span> <span class="n">ST_PTM</span><span class="p">;</span> <span class="o">//</span> <span class="n">Turbo</span> <span class="n">Pump</span>
    <span class="n">i_stISG</span> <span class="p">:</span> <span class="n">ST_VG</span><span class="p">;</span> <span class="o">//</span><span class="n">Gauge</span> <span class="n">measuring</span> <span class="n">inlet</span> <span class="n">Pressure</span> <span class="n">e</span><span class="o">.</span><span class="n">g</span> <span class="n">Pirani</span>
    <span class="n">i_stBSG</span> <span class="p">:</span> <span class="n">ST_VG</span><span class="p">;</span> <span class="o">//</span><span class="n">Gauge</span> <span class="n">measuring</span> <span class="n">backing</span> <span class="n">Pressure</span> <span class="n">e</span><span class="o">.</span><span class="n">g</span> <span class="n">Pirani</span>
    <span class="n">ScrollPump</span>      <span class="p">:</span>       <span class="n">ST_RoughPump</span><span class="p">;</span> <span class="o">//</span> <span class="n">Roughing</span> <span class="n">pump</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">Function</span> <span class="n">Block</span> <span class="n">evaluates</span> <span class="n">the</span> <span class="n">ILK</span> <span class="n">condition</span> <span class="n">of</span> <span class="n">the</span> <span class="n">Turbo</span> <span class="n">Gate</span> <span class="n">valve</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">The</span> <span class="n">logic</span> <span class="n">Protects</span> <span class="n">the</span> <span class="n">Turbo</span> <span class="n">pump</span> <span class="kn">from</span> <span class="nn">inlet</span> <span class="n">pressure</span> <span class="n">above</span> <span class="n">the</span> <span class="n">SP</span><span class="o">*</span><span class="p">)</span>
<span class="n">F_TurboGateValve_Protection_ILK</span> <span class="o">:=</span> <span class="p">(</span><span class="n">NOT</span> <span class="p">(</span><span class="n">i_Turbo</span><span class="o">.</span><span class="n">eState</span> <span class="o">=</span> <span class="n">pumpSTOPPED</span><span class="p">)</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="p">(</span><span class="n">i_Turbo</span><span class="o">.</span><span class="n">eState</span> <span class="o">=</span> <span class="n">pumpSTOPPING</span><span class="p">)</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="p">(</span><span class="n">i_Turbo</span><span class="o">.</span><span class="n">eState</span> <span class="o">=</span> <span class="n">pumpFAULT</span><span class="p">))</span>
                                            <span class="n">AND</span> <span class="p">(</span><span class="n">i_stISG</span><span class="o">.</span><span class="n">xPRESS_OK</span> <span class="n">AND</span> <span class="n">i_stISG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">&lt;</span> <span class="n">i_Turbo</span><span class="o">.</span><span class="n">rInletPressureSP</span><span class="p">)</span>
                                            <span class="n">AND</span> <span class="p">(</span><span class="n">i_stBSG</span><span class="o">.</span><span class="n">xPRESS_OK</span> <span class="n">AND</span> <span class="n">i_stBSG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">&lt;</span> <span class="n">i_Turbo</span><span class="o">.</span><span class="n">rBackingPressureSP</span><span class="p">)</span>
                                            <span class="n">AND</span> <span class="p">(</span><span class="n">ScrollPump</span><span class="o">.</span><span class="n">eState</span> <span class="o">=</span> <span class="n">pumpRUNNING</span><span class="p">);</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
</div>
<div class="section" id="f-valve-rel-ilk">
<h2>F_VALVE_REL_ILK<a class="headerlink" href="#f-valve-rel-ilk" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(* OK, this is going to be a general-use function that will return whether the ratio of the pressures given is less than x orders of magnitude.
True iff 10^(-x) &lt; a/b &lt; 10^x.  Simple, right?  Just make sure it gets a positive order of magnitude and the pressures aren&#39;t 0. ~Scott *)
{attribute &#39;no_check&#39;}
FUNCTION F_VALVE_REL_ILK : BOOL
VAR_INPUT
    i_stUSG :       ST_VG; // Upstream Gague
    i_stDSG :       ST_VG; // Downstream Gague
    //Orders of magnitude allowed between up/downstream pressures for valve to open. Must be real positive integer.
    i_iOrdersMagnitude: INT;
END_VAR
VAR
    rPressRatio : REAL;
    rMaxRatioAllowed        :       LREAL := EXPT(10,i_iOrdersMagnitude);
    rMinRatioAllowed        :       LREAL := EXPT(10,(-i_iOrdersMagnitude));
END_VAR
(* S. Stubbs 11/2015 *)

(* OK, this is going to be a general-use function that will return whether the ratio of the pressures given is less than x orders of magnitude.
True iff 10^(-x) &lt; a/b &lt; 10^x.  Simple, right?  Just make sure it gets a positive order of magnitude and the pressures aren&#39;t 0. ~Scott *)

(* Find ratio *)

IF i_stDSG.rPRESS &lt;&gt; 0 THEN
    rPressRatio := i_stUSG.rPRESS / i_stDSG.rPRESS;

    F_VALVE_REL_ILK := rPressRatio &lt; rMaxRatioAllowed AND rMinRatioAllowed &lt; rPressRatio;
ELSE
    F_VALVE_REL_ILK := FALSE;
END_IF

END_FUNCTION
</pre></div>
</div>
</div>
<div class="section" id="f-vrc-diode-ilk">
<h2>F_VRC_DIODE_ILK<a class="headerlink" href="#f-vrc-diode-ilk" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span> <span class="n">The</span> <span class="n">principle</span> <span class="ow">is</span> <span class="n">simple</span><span class="p">,</span> <span class="n">a</span> <span class="n">VRC</span> <span class="n">should</span> <span class="n">never</span> <span class="nb">open</span> <span class="n">when</span> <span class="n">B</span> <span class="n">side</span> <span class="n">pressure</span> <span class="ow">is</span> <span class="n">greater</span> <span class="n">than</span>
<span class="n">the</span> <span class="n">A</span> <span class="n">side</span> <span class="n">pressure</span><span class="o">.</span> <span class="o">*</span><span class="p">)</span>

<span class="n">FUNCTION</span> <span class="n">F_VRC_DIODE_ILK</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>

    <span class="n">i_stPGA</span> <span class="p">:</span> <span class="n">ST_VG</span><span class="p">;</span> <span class="o">//</span> <span class="n">A</span> <span class="n">side</span> <span class="n">pressure</span> <span class="n">gauge</span>
    <span class="n">i_stPGB</span> <span class="p">:</span> <span class="n">ST_VG</span><span class="p">;</span> <span class="o">//</span> <span class="n">B</span> <span class="n">side</span> <span class="n">pressure</span> <span class="n">gauge</span>

<span class="n">END_VAR</span>
<span class="n">VAR</span>

    <span class="n">rHysterisis</span> <span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">xInterlock</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">rTolerance</span><span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mi">20</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">The</span> <span class="n">principle</span> <span class="ow">is</span> <span class="n">simple</span><span class="p">,</span> <span class="n">a</span> <span class="n">VRC</span> <span class="n">should</span> <span class="n">never</span> <span class="nb">open</span> <span class="n">when</span> <span class="n">B</span> <span class="n">side</span> <span class="n">pressure</span> <span class="ow">is</span> <span class="n">greater</span> <span class="n">than</span> <span class="n">the</span> <span class="n">A</span> <span class="n">side</span> <span class="n">pressure</span><span class="o">.</span> <span class="o">*</span><span class="p">)</span>
<span class="n">rTolerance</span> <span class="o">:=</span> <span class="mi">20</span><span class="p">;</span>
<span class="n">F_VRC_DIODE_ILK</span> <span class="o">:=</span> <span class="p">((</span><span class="n">i_stPGA</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">+</span> <span class="n">rTolerance</span> <span class="o">&gt;=</span> <span class="n">i_stPGB</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">+</span> <span class="n">rHysterisis</span><span class="p">)</span> <span class="n">OR</span> <span class="n">i_stPGA</span><span class="o">.</span><span class="n">xBAKEOUT</span><span class="p">)</span> <span class="n">AND</span> <span class="n">i_stPGA</span><span class="o">.</span><span class="n">xPRESS_OK</span> <span class="n">AND</span> <span class="n">i_stPGB</span><span class="o">.</span><span class="n">xPRESS_OK</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span> <span class="n">OK</span> <span class="n">it</span> <span class="n">gets</span> <span class="n">a</span> <span class="n">bit</span> <span class="n">more</span> <span class="n">complicated</span> <span class="k">with</span> <span class="n">hysterisis</span><span class="p">,</span>

<span class="n">Now</span><span class="p">,</span> <span class="k">if</span> <span class="n">the</span> <span class="n">F_VIC_DIODE_ILK</span> <span class="ow">is</span> <span class="n">FALSE</span> <span class="n">then</span> <span class="n">some</span> <span class="n">hysterisis</span> <span class="ow">is</span> <span class="n">added</span> <span class="n">to</span> <span class="n">the</span> <span class="n">B</span> <span class="n">side</span><span class="o">.</span> <span class="n">But</span> <span class="k">if</span> <span class="n">it</span><span class="s1">&#39;s OK then we just stick with making sure that the A side is greater than the B side</span>

<span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">F_VIC_DIODE_ILK</span> <span class="n">THEN</span>
<span class="n">Hysterisis</span> <span class="o">:=</span> <span class="mi">40</span><span class="p">;</span>
<span class="n">ELSE</span>
<span class="n">Hysterisis</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="o">*</span><span class="p">)</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
</div>
<div class="section" id="f-vrc-diode-ilk-ok">
<h2>F_VRC_DIODE_ILK_OK<a class="headerlink" href="#f-vrc-diode-ilk-ok" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span><span class="n">The</span> <span class="n">function</span> <span class="n">returns</span> <span class="n">TRUE</span> <span class="n">i</span><span class="o">.</span><span class="n">e</span><span class="o">.</span> <span class="n">ILK_OK</span> <span class="n">when</span> <span class="n">pressure</span> <span class="n">on</span> <span class="n">A</span> <span class="n">side</span> <span class="ow">is</span> <span class="n">greater</span> <span class="n">than</span> <span class="ow">or</span> <span class="n">equal</span> <span class="n">to</span> <span class="n">the</span> <span class="n">pressure</span> <span class="n">on</span> <span class="n">B</span> <span class="n">side</span><span class="o">*</span><span class="p">)</span>
<span class="n">FUNCTION</span> <span class="n">F_VRC_DIODE_ILK_OK</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>

    <span class="n">i_stPGA</span> <span class="p">:</span> <span class="n">ST_VG</span><span class="p">;</span> <span class="o">//</span> <span class="n">A</span> <span class="n">side</span> <span class="n">pressure</span> <span class="n">gauge</span>
    <span class="n">i_stPGB</span> <span class="p">:</span> <span class="n">ST_VG</span><span class="p">;</span> <span class="o">//</span> <span class="n">B</span> <span class="n">side</span> <span class="n">pressure</span> <span class="n">gauge</span>

<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">rHysterisis</span> <span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">xInterlock</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">rTolerance</span><span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">The</span> <span class="n">principle</span> <span class="ow">is</span> <span class="n">simple</span><span class="p">,</span> <span class="n">a</span> <span class="n">VRC</span> <span class="n">should</span> <span class="n">never</span> <span class="nb">open</span> <span class="n">when</span> <span class="n">B</span> <span class="n">side</span> <span class="n">pressure</span> <span class="ow">is</span> <span class="n">greater</span> <span class="n">than</span> <span class="n">the</span> <span class="n">A</span> <span class="n">side</span> <span class="n">pressure</span><span class="o">.</span> <span class="o">*</span><span class="p">)</span>
<span class="n">F_VRC_DIODE_ILK_OK</span> <span class="o">:=</span> <span class="p">(</span><span class="n">i_stPGA</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">+</span> <span class="n">rTolerance</span> <span class="o">&gt;=</span> <span class="n">i_stPGB</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">+</span> <span class="n">rHysterisis</span><span class="p">)</span> <span class="n">AND</span> <span class="n">i_stPGA</span><span class="o">.</span><span class="n">xPRESS_OK</span> <span class="n">AND</span> <span class="n">i_stPGB</span><span class="o">.</span><span class="n">xPRESS_OK</span><span class="p">;</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
</div>
<div class="section" id="fb-972">
<h2>FB_972<a class="headerlink" href="#fb-972" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;no_check&#39;</span><span class="p">}</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_972</span>  <span class="n">EXTENDS</span> <span class="n">FB_GaugeBase</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span>
    <span class="s1">&#39;}</span>
    <span class="n">PG</span>      <span class="p">:</span> <span class="n">ST_VG</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>

<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">rV</span> <span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
    <span class="n">iTermBits</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">32767</span> <span class="p">;</span> <span class="o">//</span> <span class="n">The</span> <span class="n">terminal</span><span class="s1">&#39;s maximum value in bits</span>
    <span class="p">(</span><span class="o">*</span><span class="n">IO</span><span class="o">*</span><span class="p">)</span>
    <span class="n">i_iPRESS_R</span> <span class="n">AT</span><span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span><span class="n">INT</span><span class="p">;</span> <span class="o">//</span> <span class="nb">input</span> <span class="n">Pressure</span> <span class="o">//</span> <span class="n">Link</span> <span class="n">to</span> <span class="n">analog</span> <span class="n">Input</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Standard</span> <span class="n">MKS</span> <span class="mi">9</span><span class="n">XX</span> <span class="n">series</span> <span class="n">conversion</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">works</span> <span class="k">for</span> <span class="mi">972</span> <span class="ow">and</span> <span class="mi">925</span> <span class="o">*</span><span class="p">)</span>
<span class="o">//</span> <span class="n">no</span> <span class="n">div</span> <span class="n">by</span> <span class="n">zero</span>
<span class="n">If</span> <span class="p">(</span><span class="n">iTermBits</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="n">THEN</span> <span class="n">iTermBits</span> <span class="o">:=</span> <span class="mi">32767</span><span class="p">;</span><span class="n">END_IF</span>
<span class="n">rV</span> <span class="o">:=</span> <span class="mi">10</span><span class="o">*</span><span class="n">INT_TO_REAL</span><span class="p">(</span><span class="n">PG</span><span class="o">.</span><span class="n">i_iPRESS_R</span><span class="p">)</span><span class="o">/</span><span class="n">iTermBits</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">rV</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="n">THEN</span>
    <span class="n">PG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">:=</span> <span class="n">LREAL_TO_REAL</span><span class="p">(</span><span class="n">EXPT</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">rV</span><span class="o">-</span><span class="mi">11</span><span class="p">));</span>
    <span class="n">PG</span><span class="o">.</span><span class="n">xPRESS_OK</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">PG</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">Valid</span><span class="p">;</span> <span class="o">//</span><span class="n">Press</span> <span class="n">OK</span>
<span class="n">ELSE</span>
    <span class="n">PG</span><span class="o">.</span><span class="n">xPRESS_OK</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">PG</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">OoR</span><span class="p">;</span>
<span class="n">END_IF</span>



<span class="p">(</span><span class="o">*</span> <span class="n">Soft</span> <span class="n">IO</span> <span class="n">Mapping</span><span class="o">*</span><span class="p">)</span>
<span class="n">ACT_IO</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>
<span class="n">ACTION</span> <span class="n">ACT_IO</span><span class="p">:</span>
<span class="n">PG</span><span class="o">.</span><span class="n">i_iPRESS_R</span> <span class="o">:=</span><span class="n">i_iPRESS_R</span><span class="p">;</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
</div>
<div class="section" id="fb-9xx">
<h2>FB_9XX<a class="headerlink" href="#fb-9xx" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span> <span class="n">Standard</span> <span class="n">MKS</span> <span class="mi">9</span><span class="n">XX</span> <span class="n">series</span> <span class="n">conversion</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">works</span> <span class="k">for</span> <span class="mi">925</span> <span class="o">*</span><span class="p">)</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_9XX</span> <span class="n">EXTENDS</span> <span class="n">FB_GaugeBAse</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span>
    <span class="s1">&#39;}</span>
    <span class="n">PG</span>      <span class="p">:</span> <span class="n">ST_VG</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">rV</span> <span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
    <span class="n">fbGaugeState</span> <span class="p">:</span> <span class="n">FB_PressureState</span><span class="p">;</span>
    <span class="n">rMaxPressure</span>    <span class="p">:</span>       <span class="n">REAL</span> <span class="o">:=</span> <span class="mi">760</span><span class="p">;</span> <span class="o">//</span><span class="n">Torr</span>
    <span class="n">rMinPressure</span>    <span class="p">:</span>       <span class="n">REAL</span> <span class="o">:=</span> <span class="mf">1E-5</span><span class="p">;</span> <span class="o">//</span><span class="n">Torr</span>
    <span class="p">(</span><span class="o">*</span><span class="n">Default</span> <span class="nb">set</span> <span class="n">point</span> <span class="mi">50</span> <span class="n">mT</span><span class="o">*</span><span class="p">)</span>
    <span class="n">rVAC_SP</span><span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mf">5E-2</span><span class="p">;</span>
    <span class="n">iTermBits</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">30518</span> <span class="p">;</span> <span class="o">//</span> <span class="n">The</span> <span class="n">terminal</span><span class="s1">&#39;s maximum value in bits default el3174 as per vacuum architecture</span>
    <span class="p">(</span><span class="o">*</span><span class="n">IO</span><span class="o">*</span><span class="p">)</span>
    <span class="n">i_iPRESS_R</span> <span class="n">AT</span><span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span><span class="n">INT</span><span class="p">;</span> <span class="o">//</span> <span class="nb">input</span> <span class="n">Pressure</span> <span class="o">//</span> <span class="n">Link</span> <span class="n">to</span> <span class="n">analog</span> <span class="n">Input</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Standard</span> <span class="n">MKS</span> <span class="mi">9</span><span class="n">XX</span> <span class="n">series</span> <span class="n">conversion</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">works</span> <span class="k">for</span> <span class="mi">972</span> <span class="ow">and</span> <span class="mi">925</span> <span class="o">*</span><span class="p">)</span>

<span class="o">//</span><span class="n">Default</span> <span class="n">setpoint</span> <span class="mi">50</span> <span class="n">mT</span>
<span class="n">IF</span> <span class="n">PG</span><span class="o">.</span><span class="n">rVAC_SP</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">PG</span><span class="o">.</span><span class="n">rVAC_SP</span> <span class="o">:=</span> <span class="n">rVAC_SP</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="o">//</span> <span class="n">check</span> <span class="n">no</span> <span class="n">div</span> <span class="n">by</span> <span class="n">zero</span>
<span class="n">If</span> <span class="p">(</span><span class="n">iTermBits</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="n">THEN</span> <span class="n">iTermBits</span> <span class="o">:=</span> <span class="mi">30518</span><span class="p">;</span><span class="n">END_IF</span>
<span class="n">rV</span> <span class="o">:=</span> <span class="mi">10</span><span class="o">*</span><span class="n">INT_TO_REAL</span><span class="p">(</span><span class="n">PG</span><span class="o">.</span><span class="n">i_iPRESS_R</span><span class="p">)</span><span class="o">/</span><span class="n">iTermBits</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">rV</span> <span class="o">&gt;=</span> <span class="mf">0.99</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">rV</span> <span class="o">&gt;=</span> <span class="mf">0.99</span> <span class="n">AND</span> <span class="n">rV</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="n">THEN</span>
            <span class="n">PG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">:=</span> <span class="mf">1E-5</span><span class="p">;</span>
    <span class="n">ELSE</span>
            <span class="n">PG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">:=</span> <span class="n">LREAL_TO_REAL</span><span class="p">(</span><span class="n">EXPT</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">rV</span><span class="o">-</span><span class="mi">6</span><span class="p">));</span>
    <span class="n">END_IF</span>
    <span class="n">PG</span><span class="o">.</span><span class="n">xPRESS_OK</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">PG</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">Valid</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">PG</span><span class="o">.</span><span class="n">xPRESS_OK</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">IF</span> <span class="p">(</span><span class="n">rV</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">THEN</span> <span class="n">PG</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">GaugeDisconnected</span><span class="p">;</span>
            <span class="n">ELSE</span>  <span class="n">PG</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">PressInvalid</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Setpoint</span> <span class="n">evaluation</span> <span class="o">*</span><span class="p">)</span>
<span class="n">PG</span><span class="o">.</span><span class="n">xAT_VAC</span> <span class="o">:=</span> <span class="n">PG</span><span class="o">.</span><span class="n">xPRESS_OK</span> <span class="n">AND</span> <span class="p">(</span><span class="n">PG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">&lt;</span> <span class="n">PG</span><span class="o">.</span><span class="n">rVAC_SP</span><span class="p">);</span>


<span class="p">(</span><span class="o">*</span><span class="n">Logger</span><span class="o">*</span><span class="p">)</span>
<span class="n">ACT_Logger</span><span class="p">();</span>
<span class="p">(</span><span class="o">*</span><span class="n">Soft</span> <span class="n">IO</span> <span class="n">Mapping</span><span class="o">*</span><span class="p">)</span>
<span class="n">ACT_IO</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>
<span class="n">ACTION</span> <span class="n">ACT_IO</span><span class="p">:</span>
<span class="n">PG</span><span class="o">.</span><span class="n">i_iPRESS_R</span> <span class="o">:=</span><span class="n">i_iPRESS_R</span><span class="p">;</span>
<span class="n">END_ACTION</span>
<span class="n">ACTION</span> <span class="n">ACT_Logger</span><span class="p">:</span>
<span class="o">//</span> <span class="n">ILK</span> <span class="n">logger</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">PG</span><span class="o">.</span><span class="n">xILKOk</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">PG</span><span class="o">.</span><span class="n">q_xHV_DIS</span> <span class="n">THEN</span>
            <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Lost external interlock while gauge was on.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span>
<span class="n">END_IF</span>


<span class="o">//</span><span class="n">STATE</span> <span class="n">Logger</span>
<span class="n">IF</span> <span class="n">ePrevState</span> <span class="o">&lt;&gt;</span> <span class="n">PG</span><span class="o">.</span><span class="n">eState</span> <span class="n">THEN</span>
      <span class="n">CASE</span> <span class="n">PG</span><span class="o">.</span><span class="n">eState</span> <span class="n">OF</span>
            <span class="n">ValidHi</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Gauge pressure valid high.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span>
            <span class="n">ValidLo</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Gauge pressure valid low.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span>
            <span class="n">Valid</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Gauge pressure valid.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span>
            <span class="n">GaugeDisconnected</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Gauge Disconnected.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span>
            <span class="n">PressInvalid</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Gauge pressure invalid.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Warning</span><span class="p">);</span>
            <span class="n">OoR</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Gauge pressure out of range.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Warning</span><span class="p">);</span>
            <span class="n">Starting</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Gauge starting.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span>
      <span class="n">END_CASE</span>
      <span class="n">ePrevState</span> <span class="o">:=</span> <span class="n">PG</span><span class="o">.</span><span class="n">eState</span><span class="p">;</span>
  <span class="n">END_IF</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
</div>
<div class="section" id="fb-ads-watchdog">
<h2>FB_ADS_WATCHDOG<a class="headerlink" href="#fb-ads-watchdog" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span><span class="n">This</span> <span class="n">function</span> <span class="n">block</span> <span class="ow">is</span> <span class="n">to</span> <span class="n">be</span> <span class="n">used</span> <span class="n">whenever</span> <span class="n">deivce</span> <span class="n">data</span> <span class="n">going</span> <span class="n">to</span> <span class="n">be</span> <span class="n">read</span> <span class="n">over</span> <span class="n">ADS</span><span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span><span class="n">The</span> <span class="n">remote</span> <span class="n">plc</span> <span class="n">has</span> <span class="n">to</span> <span class="n">instantiate</span> <span class="n">this</span> <span class="n">function</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">order</span> <span class="n">to</span> <span class="n">write</span> <span class="n">a</span> <span class="n">watchdog</span> <span class="n">variable</span><span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span><span class="n">that</span> <span class="n">the</span> <span class="n">ADS</span> <span class="n">read</span> <span class="n">function</span> <span class="n">expects</span> <span class="n">to</span> <span class="n">keep</span> <span class="n">checking</span><span class="o">*</span><span class="p">)</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_ADS_WATCHDOG</span>
<span class="n">VAR_INPUT</span>
    <span class="n">sNetId</span> <span class="p">:</span> <span class="n">String</span><span class="p">;</span> <span class="o">//</span><span class="n">NetID</span> <span class="n">of</span> <span class="n">the</span> <span class="n">Destination</span> <span class="n">PLC</span> <span class="n">controller</span>
    <span class="n">nPort</span> <span class="p">:</span> <span class="n">uint</span><span class="p">;</span> <span class="o">//</span> <span class="n">port</span> <span class="n">number</span>
    <span class="n">sVarName</span> <span class="p">:</span> <span class="n">string</span><span class="p">;</span><span class="o">//</span> <span class="n">the</span> <span class="n">variable</span> <span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">watchdog</span> <span class="n">on</span> <span class="n">the</span> <span class="n">remote</span> <span class="n">plc</span><span class="o">.</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">bError</span><span class="p">:</span><span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>

    <span class="n">fb_WriteWatchdog</span><span class="p">:</span><span class="n">FB_WriteWatchdog</span><span class="p">;</span>
    <span class="n">ftReset_Watchdog</span><span class="p">:</span> <span class="n">F_TRIG</span><span class="p">;</span>
    <span class="n">xFirstPass</span><span class="p">:</span> <span class="n">BOOL</span><span class="o">:=</span> <span class="n">true</span><span class="p">;</span>

<span class="n">END_VAR</span>
<span class="n">ftReset_Watchdog</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span> <span class="n">fb_WriteWatchdog</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">OR</span> <span class="n">xFirstPass</span><span class="p">);</span>
<span class="n">xFirstPass</span> <span class="o">:=</span> <span class="n">false</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span><span class="n">calling</span> <span class="n">ADS</span> <span class="n">Watchdog</span> <span class="n">function</span><span class="o">*</span><span class="p">)</span>
<span class="n">fb_WriteWatchdog</span><span class="p">(</span>
    <span class="n">bEnable</span><span class="o">:=</span> <span class="n">TRUE</span> <span class="p">,</span>
    <span class="n">sNetId</span><span class="o">:=</span> <span class="n">sNetId</span><span class="p">,</span>
    <span class="n">nPort</span><span class="o">:=</span> <span class="n">nPort</span><span class="p">,</span>
    <span class="n">nIdxGrp</span><span class="o">:=</span> <span class="p">,</span>
    <span class="n">nIdxOffs</span><span class="o">:=</span> <span class="p">,</span>
    <span class="n">sVarName</span><span class="o">:=</span> <span class="n">sVarName</span><span class="p">,</span>
    <span class="n">tWatchdogTime</span><span class="o">:=</span> <span class="n">t</span><span class="c1">#30ms,</span>
    <span class="n">bSendNow</span><span class="o">:=</span> <span class="n">ftReset_Watchdog</span><span class="o">.</span><span class="n">Q</span> <span class="p">,</span>
    <span class="n">bBusy</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">nLastCnt</span><span class="o">=&gt;</span>  <span class="p">,</span>
    <span class="n">bError</span><span class="o">=&gt;</span> <span class="n">bError</span><span class="p">,</span>
    <span class="n">nErrorId</span><span class="o">=&gt;</span> <span class="p">);</span>


<span class="p">(</span><span class="o">*</span><span class="n">Error</span><span class="o">*</span><span class="p">)</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</div>
<div class="section" id="fb-cmr362">
<h2>FB_CMR362<a class="headerlink" href="#fb-cmr362" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(* For Pfeiffer CMR 362 *)
FUNCTION_BLOCK FB_CMR362
VAR_INPUT
END_VAR
VAR_OUTPUT
            {attribute &#39;pytmc&#39; := &#39;pv:&#39;}
            PG : ST_VG;
END_VAR
VAR
    MinPressure: REAL := 7.5E-3; //Torr
    FullScale : REAL := 75.0 ; //Torr
    V : REAL;
    iTermBits: UINT := 32767 ; // The terminal&#39;s maximum value in bits
    (*IO*)
    i_iPRESS_R AT%I* :INT; // input Pressure // Link to analog Input
END_VAR
(* For Pfeiffer CMR 362 *)
(*Soft IO Mapping*)
ACT_IO();

(* Real-value calculation *)
If (iTermBits=0) THEN iTermBits := 32767;END_IF
V := 10*INT_TO_REAL(PG.i_iPRESS_R)/iTermBits;


IF V &lt; 0.4 THEN

    PG.eState := GaugeDisconnected; //Most likely not connected

ELSIF V &gt;= 0.4 AND V &lt;= 1.0 THEN
    PG.rPRESS := MinPressure;
    PG.eState := ValidLo;

ELSIF V &gt; 1 AND V &lt;= 9.8 THEN

    PG.rPRESS := LREAL_TO_REAL((V-1)*0.125*FullScale);
    PG.eState := Valid;

ELSE

PG.eState := OoR; //Larger voltage, probably out of range?

END_IF


(* Pressure OK check *)
PG.xPRESS_OK := (PG.rPRESS &gt;= MinPressure);

(*Soft IO Mapping*)
ACT_IO();

END_FUNCTION_BLOCK
ACTION ACT_IO:
PG.i_iPRESS_R :=i_iPRESS_R;
END_ACTION
</pre></div>
</div>
</div>
<div class="section" id="fb-ebaradrypump">
<h2>FB_EbaraDryPump<a class="headerlink" href="#fb-ebaradrypump" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(*This function block does basic controls for the Ebara EV-S Dry pump. Starts booster pump when appropriate. Turns off pump
in the event of errors/ warnings. Provides interlocking interface.*)
FUNCTION_BLOCK FB_EbaraDryPump EXTENDS FB_Pump
VAR_INPUT
    i_stBPGauge     :       ST_VG; //booster pump interlock gauge
    i_xVlvOpn       :       BOOL; //valve(s) to main system load are open
    i_xExtIlkOK     :       BOOL;

END_VAR
VAR_OUTPUT
    {attribute &#39;pytmc&#39; := &#39;
    pv:
    &#39;}
    stPump  :       ST_EbaraDryPump; //Ebara dry pump structure
END_VAR
VAR_IN_OUT

END_VAR
VAR
    (*IO*)
    q_xMPStart      AT%Q*:  BOOL; //Main Pump start
    q_xBPStart      AT%Q*:  BOOL; // Booster Pump start (this can be started by the pump automatically)
    //Readbacks
    i_xMPStatus     AT%I*:  BOOL; //MP status
    i_xBPStatus     AT%I*:  BOOL; //BP status
    i_xWarning      AT%I*:  BOOL; //Warning status
    i_xAlarmOK      AT%I*:  BOOL; //Alarm, maps to error
    i_xRemote       AT%I*:  BOOL; //Remote control status
END_VAR
(* Ebara Dry Pump Control Routine
A. Wallace
2016-4-29
Applicable to:
EV-S20
EV-S50
EV-S100
EV-S200

Does basic controls for the pump. Starts booster pump when appropriate. Turns off pump
in the event of errors/ warnings. Provides interlocking interface.

Main Pump Operational Note:
Ebara recommends that the pump be exposed to the full system load after the main pump is running.

Booster Pump Operational Note:
The booster pump can either be started automatically by the pump itself (probably based on a timer?)
or it can be started by the PLC. The pressure setpoint is by default 30T. It may be wise to make
sure the pump was exposed to the full system load before starting the booster.

*)

//Mapping
ACT_IO();
stPump.xExtIlk := NOT i_xExtIlkOK;

//Interlock and error/warning
stPump.xIlkOK :=  NOT stPump.xExtIlk AND NOT (stpump.xErr);// OR stpump.xWrn);

//Start/ Stop the pump
IF stpump.xIlkOK THEN
    stpump.q_xMPStart := stpump.pv_xRunSW;
ELSE
    stpump.q_xMPStart := stpump.pv_xRunSW := FALSE;
END_IF

//Booster pump
stpump.xBPIlk := i_xVlvOpn AND stpump.i_xMPStatus AND (i_stBPGauge.rPRESS &lt; stpump.rBPIlkSP) AND i_stbpgauge.xPRESS_OK;
stpump.tonBP(IN:=stpump.xBPIlk);
stpump.q_xBPStart := stpump.tonBP.Q;

(*State evaluation*)
IF stPump.i_xAlarm THEN
    stpump.eState := pumpFAULT;
ELSIF NOT stpump.q_xMPStart AND stPump.i_xAlarm THEN
            stpump.eState := pumpSTOPPED;
ELSIF stpump.q_xMPStart AND NOT stPump.i_xMPStatus THEN
            stpump.eState := pumpSTARTING;
ELSIF stPump.i_xMPStatus OR stPump.i_xBPStatus THEN
            stpump.eState := pumpRUNNING;
ELSIF NOT stPump.i_xMPStatus AND NOT stPump.i_xBPStatus THEN
            stpump.eState := pumpSTOPPED;
ELSE
    stpump.eState := pumpFAULT;
END_IF


//Mapping
ACT_IO();
// Log States and triggers
ACT_Logger();

END_FUNCTION_BLOCK
ACTION ACT_IO:
(*Outputs*)
q_xMPStart  := stPump.q_xMPStart;
q_xBPStart  := stPump.q_xBPStart;
stPump.q_xRunDo := stPump.q_xMPStart;
(*Inputs*)
stPump.i_xMPStatus:=        i_xMPStatus;
stPump.i_xBPStatus:=        i_xBPStatus;
stPump.i_xWarning:= NOT i_xWarning;
// These are normally closed inputs
stPump.xWrn := NOT i_xWarning;
stPump.i_xAlarm:=   NOT(i_xAlarmOK);
StPump.xErr := NOT(i_xAlarmOK);
stPump.i_xRemote:= i_xRemote;
END_ACTION
ACTION ACT_Logger:
// ILK logger
IF NOT i_xExtIlkOK AND ePrevState = pumpRUNNING THEN
            fbLogger(sMsg:=&#39;Lost external interlock while pump was running.&#39;, eSevr:=TcEventSeverity.Critical);
END_IF
//STATE Logger

IF ePrevState &lt;&gt; stpump.eState THEN
      CASE stpump.eState OF
            pumpFAULT:
                    fbLogger(sMsg:=&#39;Pump Fault.&#39;, eSevr:=TcEventSeverity.Critical);
            pumpSTOPPED:
                    fbLogger(sMsg:=&#39;Pump stopped.&#39;, eSevr:=TcEventSeverity.Critical);
            pumpSTARTING:
                    fbLogger(sMsg:=&#39;Pump starting.&#39;, eSevr:=TcEventSeverity.Info);
            pumpRUNNING:
                    fbLogger(sMsg:=&#39;Pump running.&#39;, eSevr:=TcEventSeverity.Info);
      END_CASE
      ePrevState := stpump.eState;
  END_IF


// Log Action
tAction(CLK:=  stPump.q_xRunDo);
IF tAction.Q THEN fbLogger(sMsg:=&#39;Pump commanded to start&#39;, eSevr:=TcEventSeverity.Info); END_IF


// Log FAULT
tFault(CLK:= NOT stPump.i_xAlarm);
IF tFault.Q THEN fbLogger(sMsg:=&#39;Pump Lost Alarm OK bit&#39;, eSevr:=TcEventSeverity.Critical); END_IF
END_ACTION
</pre></div>
</div>
</div>
<div class="section" id="fb-ebaraeva">
<h2>FB_EbaraEVA<a class="headerlink" href="#fb-ebaraeva" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span><span class="n">This</span> <span class="n">function</span> <span class="n">block</span> <span class="n">does</span> <span class="n">basic</span> <span class="n">controls</span> <span class="k">for</span> <span class="n">the</span> <span class="n">Ebara</span> <span class="n">EV</span><span class="o">-</span><span class="n">A</span>  <span class="n">pump</span><span class="o">.</span> <span class="n">Turns</span> <span class="n">off</span> <span class="n">pump</span>
<span class="ow">in</span> <span class="n">the</span> <span class="n">event</span> <span class="n">of</span> <span class="n">errors</span><span class="o">/</span> <span class="n">warnings</span><span class="o">.</span> <span class="n">Provides</span> <span class="n">interlocking</span> <span class="n">interface</span><span class="o">.*</span><span class="p">)</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_EbaraEVA</span> <span class="n">EXTENDS</span> <span class="n">FB_Pump</span>
<span class="n">VAR_INPUT</span>
    <span class="n">i_xExtIlkOK</span>     <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span>
    <span class="s1">&#39;}</span>
    <span class="n">stPump</span>  <span class="p">:</span>       <span class="n">ST_EbaraEVA</span><span class="p">;</span> <span class="o">//</span><span class="n">Ebara</span> <span class="n">dry</span> <span class="n">pump</span> <span class="n">structure</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
  <span class="o">//</span> <span class="n">For</span> <span class="n">logging</span>
  <span class="p">(</span><span class="o">*</span>  <span class="n">fbLogger</span> <span class="p">:</span> <span class="n">FB_LogMessage</span> <span class="o">:=</span> <span class="p">(</span><span class="n">eSubsystem</span><span class="o">:=</span><span class="n">E_SubSystem</span><span class="o">.</span><span class="n">VACUUM</span><span class="p">);</span>
    <span class="n">ePrevState</span> <span class="p">:</span> <span class="n">E_PumpState</span><span class="p">;</span>
    <span class="n">tErrorPresent</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">tAction</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span> <span class="o">//</span> <span class="n">Primary</span> <span class="n">action</span> <span class="n">of</span> <span class="n">this</span> <span class="n">device</span> <span class="p">(</span><span class="n">OPN_DO</span><span class="p">,</span> <span class="n">PUMP_RUN</span><span class="p">,</span> <span class="n">etc</span><span class="o">.</span><span class="p">)</span>
    <span class="n">tFault</span> <span class="p">:</span> <span class="n">F_TRIG</span><span class="p">;</span><span class="o">*</span><span class="p">)</span>

<span class="p">(</span><span class="o">*</span><span class="n">IO</span><span class="o">*</span><span class="p">)</span>
    <span class="n">q_xRunDo</span> <span class="n">AT</span><span class="o">%</span><span class="n">Q</span><span class="o">*</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Output</span> <span class="n">signal</span>
    <span class="n">q_xRemote</span> <span class="n">At</span><span class="o">%</span><span class="n">Q</span><span class="o">*</span> <span class="p">:</span><span class="n">BOOL</span><span class="p">;</span><span class="o">//</span> <span class="n">Remote</span><span class="o">/</span><span class="n">Local</span> <span class="n">Control</span>
    <span class="n">q_xResetAlarm</span> <span class="n">At</span><span class="o">%</span><span class="n">Q</span><span class="o">*</span> <span class="p">:</span><span class="n">BOOL</span><span class="p">;</span><span class="o">//</span> <span class="n">Remote</span><span class="o">/</span><span class="n">Local</span> <span class="n">Control</span>
    <span class="n">i_xAlarmOK</span> <span class="n">AT</span><span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span><span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Normally</span> <span class="n">closed</span> <span class="n">Alarm</span> <span class="n">bit</span>
    <span class="n">i_xIsRun</span>   <span class="n">AT</span><span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span><span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Input</span> <span class="n">status</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span><span class="n">MG</span> <span class="mi">2019</span><span class="o">*</span><span class="p">)</span>
<span class="n">stPump</span><span class="o">.</span><span class="n">xIlkOK</span> <span class="o">:=</span> <span class="n">i_xExtIlkOK</span> <span class="n">AND</span> <span class="n">stPump</span><span class="o">.</span><span class="n">i_xAlarmOK</span> <span class="p">;</span>
<span class="o">//</span> <span class="n">Enable</span> <span class="n">the</span> <span class="n">remote</span> <span class="n">signal</span> <span class="n">when</span> <span class="n">the</span> <span class="n">interlock</span> <span class="n">evaluation</span> <span class="ow">is</span> <span class="n">ok</span>
<span class="o">//</span><span class="n">stPump</span><span class="o">.</span><span class="n">q_xRemote</span> <span class="o">:=</span> <span class="n">stPump</span><span class="o">.</span><span class="n">xIlkOK</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">stPump</span><span class="o">.</span><span class="n">xIlkOK</span> <span class="n">THEN</span>
    <span class="n">stPump</span><span class="o">.</span><span class="n">q_xRunDO</span> <span class="o">:=</span> <span class="n">stPump</span><span class="o">.</span><span class="n">pv_xRunSW</span><span class="p">;</span>
<span class="n">ELSE</span>
            <span class="n">stPump</span><span class="o">.</span><span class="n">PV_xRunSW</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">stPump</span><span class="o">.</span><span class="n">q_xRunDO</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="p">(</span><span class="o">*</span><span class="n">State</span> <span class="n">evaluation</span><span class="o">*</span><span class="p">)</span>
<span class="n">IF</span> <span class="n">NOT</span><span class="p">(</span><span class="n">stPump</span><span class="o">.</span><span class="n">i_xAlarmOK</span> <span class="p">)</span> <span class="n">THEN</span>
     <span class="n">ePrevState</span> <span class="o">:=</span> <span class="n">stpump</span><span class="o">.</span><span class="n">eState</span><span class="p">;</span>
    <span class="n">stpump</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">pumpFAULT</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">NOT</span> <span class="n">stpump</span><span class="o">.</span><span class="n">q_xRunDo</span> <span class="n">AND</span> <span class="n">stPump</span><span class="o">.</span><span class="n">i_xAlarmOK</span> <span class="n">THEN</span>
            <span class="n">stpump</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">pumpSTOPPED</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">NOT</span> <span class="n">stpump</span><span class="o">.</span><span class="n">q_xRunDo</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">stPump</span><span class="o">.</span><span class="n">i_xIsRun</span> <span class="n">THEN</span>
            <span class="n">stpump</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">pumpSTARTING</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">stPump</span><span class="o">.</span><span class="n">i_xIsRun</span> <span class="n">THEN</span>
            <span class="n">stpump</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">pumpRUNNING</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">stpump</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">pumpFAULT</span><span class="p">;</span>
<span class="n">END_IF</span>


<span class="o">//</span><span class="n">Soft</span> <span class="n">IO</span> <span class="n">Mapping</span>
<span class="n">ACT_IO</span><span class="p">();</span>

<span class="o">//</span> <span class="n">Log</span> <span class="n">States</span> <span class="ow">and</span> <span class="n">triggers</span>
<span class="n">ACT_Logger</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>
<span class="n">ACTION</span> <span class="n">ACT_IO</span><span class="p">:</span>
<span class="n">stPump</span><span class="o">.</span><span class="n">i_xAlarmOK</span><span class="o">:=</span> <span class="n">i_xAlarmOK</span><span class="p">;</span>
<span class="n">stPump</span><span class="o">.</span><span class="n">xErr</span><span class="o">:=</span>       <span class="n">NOT</span><span class="p">(</span><span class="n">i_xAlarmOK</span><span class="p">);</span>
<span class="n">stPump</span><span class="o">.</span><span class="n">i_xIsRun</span> <span class="o">:=</span> <span class="n">i_xIsRun</span><span class="p">;</span>
<span class="p">(</span><span class="o">*</span><span class="n">outputs</span><span class="o">*</span><span class="p">)</span>
<span class="n">q_xRunDo</span><span class="o">:=</span><span class="n">stPump</span><span class="o">.</span><span class="n">q_xRunDo</span><span class="p">;</span>
<span class="n">q_xRemote</span><span class="o">:=</span> <span class="n">stPump</span><span class="o">.</span><span class="n">q_xRemote</span><span class="p">;</span>
<span class="n">END_ACTION</span>
<span class="n">ACTION</span> <span class="n">ACT_Logger</span><span class="p">:</span>
<span class="o">//</span> <span class="n">ILK</span> <span class="n">logger</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">i_xExtIlkOK</span> <span class="n">AND</span> <span class="n">ePrevState</span> <span class="o">=</span> <span class="n">pumpRUNNING</span> <span class="n">THEN</span>
            <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Lost external interlock while pump was running.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span>
<span class="n">END_IF</span>

<span class="o">//</span><span class="n">STATE</span> <span class="n">Logger</span>
<span class="n">IF</span> <span class="n">ePrevState</span> <span class="o">&lt;&gt;</span> <span class="n">stpump</span><span class="o">.</span><span class="n">eState</span> <span class="n">THEN</span>
      <span class="n">CASE</span> <span class="n">stpump</span><span class="o">.</span><span class="n">eState</span> <span class="n">OF</span>
            <span class="n">pumpFAULT</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Pump Fault.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span>
            <span class="n">pumpSTOPPED</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Pump stopped.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span>
            <span class="n">pumpSTARTING</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Pump starting.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span>
            <span class="n">pumpRUNNING</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Pump running.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span>
      <span class="n">END_CASE</span>
      <span class="n">ePrevState</span> <span class="o">:=</span> <span class="n">stpump</span><span class="o">.</span><span class="n">eState</span><span class="p">;</span>
  <span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Log</span> <span class="n">Action</span>
<span class="n">tAction</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span>  <span class="n">stPump</span><span class="o">.</span><span class="n">q_xRunDo</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">tAction</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span> <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Pump commanded to start&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span> <span class="n">END_IF</span>


<span class="o">//</span> <span class="n">Log</span> <span class="n">FAULT</span>
<span class="n">tFault</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span> <span class="n">stPump</span><span class="o">.</span><span class="n">i_xAlarmOK</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">tFault</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span> <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Pump Lost Alarm OK bit&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span> <span class="n">END_IF</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
</div>
<div class="section" id="fb-gauge-interface">
<h2>FB_Gauge_Interface<a class="headerlink" href="#fb-gauge-interface" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">function</span> <span class="n">block</span> <span class="ow">is</span> <span class="n">created</span> <span class="k">for</span> <span class="n">interface</span> <span class="n">devices</span> <span class="n">between</span> <span class="n">different</span> <span class="n">PLC</span><span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Not</span> <span class="nb">all</span> <span class="n">the</span> <span class="n">Variables</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">original</span> <span class="n">structure</span> <span class="ow">is</span> <span class="n">required</span><span class="p">,</span> <span class="n">just</span> <span class="n">few</span> <span class="n">signals</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">They</span> <span class="n">have</span> <span class="n">to</span> <span class="n">be</span> <span class="n">linked</span> <span class="n">to</span> <span class="n">the</span> <span class="n">custom</span> <span class="n">created</span> <span class="n">variables</span> <span class="n">on</span> <span class="n">the</span> <span class="n">EL6692</span><span class="o">/</span><span class="mi">5</span> <span class="n">primary</span> <span class="n">side</span><span class="o">*</span><span class="p">)</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_Gauge_Interface</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv:&#39;</span><span class="p">}</span>
    <span class="n">VG</span> <span class="p">:</span> <span class="n">ST_VG</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">i_rPRESS</span> <span class="n">AT</span><span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>  <span class="o">//</span><span class="n">This</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">human</span><span class="o">-</span><span class="n">readable</span> <span class="n">pressure</span>
    <span class="n">i_xAT_VAC</span> <span class="n">AT</span><span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">i_xPRESS_OK</span> <span class="n">AT</span><span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">function</span> <span class="n">block</span> <span class="ow">is</span> <span class="n">created</span> <span class="k">for</span> <span class="n">interface</span> <span class="n">devices</span> <span class="n">between</span> <span class="n">different</span> <span class="n">PLC</span><span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Not</span> <span class="nb">all</span> <span class="n">the</span> <span class="n">Variables</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">original</span> <span class="n">structure</span> <span class="ow">is</span> <span class="n">required</span><span class="p">,</span> <span class="n">just</span> <span class="n">few</span> <span class="n">signals</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">They</span> <span class="n">have</span> <span class="n">to</span> <span class="n">be</span> <span class="n">linked</span> <span class="n">to</span> <span class="n">the</span> <span class="n">custom</span> <span class="n">created</span> <span class="n">variables</span> <span class="n">on</span> <span class="n">the</span> <span class="n">EL6692</span><span class="o">/</span><span class="mi">5</span> <span class="n">primary</span> <span class="n">side</span><span class="o">*</span><span class="p">)</span>

<span class="n">VG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">:=</span> <span class="n">i_rPRESS</span><span class="p">;</span>
<span class="n">VG</span><span class="o">.</span><span class="n">xAT_VAC</span> <span class="o">:=</span> <span class="n">i_xAT_VAC</span><span class="p">;</span>
<span class="n">VG</span><span class="o">.</span><span class="n">xPRESS_OK</span> <span class="o">:=</span> <span class="n">i_xPRESS_OK</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</div>
<div class="section" id="fb-gaugebase">
<h2>FB_GaugeBase<a class="headerlink" href="#fb-gaugebase" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_GaugeBase</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>

<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="o">//</span><span class="n">Logging</span>
    <span class="n">fbLogger</span> <span class="p">:</span> <span class="n">FB_LogMessage</span> <span class="o">:=</span> <span class="p">(</span><span class="n">eSubsystem</span><span class="o">:=</span><span class="n">E_SubSystem</span><span class="o">.</span><span class="n">VACUUM</span><span class="p">);</span>
    <span class="n">ePrevState</span> <span class="p">:</span> <span class="n">E_PressureState</span><span class="p">;</span>
    <span class="n">tErrorPresent</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">tAction</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span> <span class="o">//</span> <span class="n">Primary</span> <span class="n">action</span> <span class="n">of</span> <span class="n">this</span> <span class="n">device</span> <span class="p">(</span><span class="n">OPN_DO</span><span class="p">,</span> <span class="n">etc</span><span class="o">.</span><span class="p">)</span>
    <span class="n">tOverrideActivated</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;instance-path&#39;</span><span class="p">}</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;noinit&#39;</span><span class="p">}</span>
    <span class="n">sPath</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
<span class="n">END_VAR</span>


<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</div>
<div class="section" id="fb-gcc-test">
<h2>FB_GCC_Test<a class="headerlink" href="#fb-gcc-test" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_GCC_Test</span> <span class="n">EXTENDS</span> <span class="n">TcUnit</span><span class="o">.</span><span class="n">FB_TestSuite</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">PG</span> <span class="p">:</span> <span class="n">ST_VG</span><span class="p">;</span>
    <span class="n">fb_MKS422</span><span class="p">:</span> <span class="n">FB_MKS422</span><span class="p">;</span>
    <span class="o">//</span><span class="n">fb_MKS500</span><span class="p">:</span> <span class="n">FB_MKS500</span><span class="p">;</span>
    <span class="n">i_iPRESS_R</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span> <span class="p">:</span><span class="n">INT</span><span class="p">;</span>
    <span class="n">cycle</span><span class="p">:</span><span class="n">INT</span> <span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">M_INIT</span><span class="p">();</span>
<span class="n">M_Interlock</span><span class="p">();</span>
<span class="n">M_CheckRange</span><span class="p">();</span>
<span class="o">//</span><span class="n">M_SelfProtection</span><span class="p">();</span>
<span class="n">cycle</span><span class="o">:=</span><span class="n">cycle</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</div>
<div class="section" id="fb-gcm">
<h2>FB_GCM<a class="headerlink" href="#fb-gcm" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span> <span class="n">For</span> <span class="n">Baratron</span> <span class="n">Pressure</span> <span class="n">Gauge</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span><span class="n">The</span> <span class="n">full</span><span class="o">-</span><span class="n">scale</span> <span class="n">pressure</span> <span class="n">times</span> <span class="n">the</span> <span class="n">ratio</span> <span class="n">of</span> <span class="n">the</span> <span class="n">meas</span><span class="o">.</span>
<span class="n">voltage</span> <span class="n">to</span> <span class="n">full</span><span class="o">-</span><span class="n">scale</span> <span class="n">voltage</span> <span class="p">(</span><span class="mi">10</span><span class="n">V</span><span class="p">)</span><span class="o">.</span>
<span class="n">The</span> <span class="n">minimum</span> <span class="n">pressure</span> <span class="ow">is</span> <span class="n">always</span> <span class="n">going</span> <span class="n">to</span> <span class="n">be</span> <span class="mf">5e-4</span> <span class="o">*</span> <span class="n">F</span><span class="o">.</span><span class="n">S</span><span class="o">.</span><span class="n">V</span><span class="o">.*</span><span class="p">)</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_GCM</span>
<span class="n">VAR_IN_OUT</span>

<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv:&#39;</span><span class="p">}</span>
    <span class="n">PG</span>      <span class="p">:</span>       <span class="n">ST_VG</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">i_rFULL_SCALE</span> <span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">rMinPressure</span><span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
    <span class="n">rHYST_PERC</span>      <span class="p">:</span>       <span class="n">REAL</span> <span class="o">:=</span> <span class="mf">0.80</span><span class="p">;</span>   <span class="o">//</span> <span class="n">Hysteresis</span> <span class="n">percentage</span>
    <span class="n">rV</span>      <span class="p">:</span><span class="n">REAL</span><span class="p">;</span>
    <span class="n">iTermBits</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">32767</span> <span class="p">;</span> <span class="o">//</span> <span class="n">The</span> <span class="n">terminal</span><span class="s1">&#39;s maximum value in bits</span>
    <span class="p">(</span><span class="o">*</span><span class="n">IO</span><span class="o">*</span><span class="p">)</span>
    <span class="n">i_iPRESS_R</span> <span class="n">AT</span><span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span><span class="n">INT</span><span class="p">;</span> <span class="o">//</span> <span class="nb">input</span> <span class="n">Pressure</span> <span class="o">//</span> <span class="n">Link</span> <span class="n">to</span> <span class="n">analog</span> <span class="n">Input</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Baratron</span> <span class="n">Pressure</span> <span class="n">Calc</span>
<span class="n">A</span><span class="o">.</span> <span class="n">Wallace</span>
<span class="mi">2016</span><span class="o">-</span><span class="mi">6</span><span class="o">-</span><span class="mi">16</span>
<span class="n">The</span> <span class="n">full</span><span class="o">-</span><span class="n">scale</span> <span class="n">pressure</span> <span class="n">times</span> <span class="n">the</span> <span class="n">ratio</span> <span class="n">of</span> <span class="n">the</span> <span class="n">meas</span><span class="o">.</span>
<span class="n">voltage</span> <span class="n">to</span> <span class="n">full</span><span class="o">-</span><span class="n">scale</span> <span class="n">voltage</span> <span class="p">(</span><span class="mi">10</span><span class="n">V</span><span class="p">)</span><span class="o">.</span>
<span class="n">The</span> <span class="n">minimum</span> <span class="n">pressure</span> <span class="ow">is</span> <span class="n">always</span> <span class="n">going</span> <span class="n">to</span> <span class="n">be</span> <span class="mf">5e-4</span> <span class="o">*</span> <span class="n">F</span><span class="o">.</span><span class="n">S</span><span class="o">.</span><span class="n">V</span><span class="o">.*</span><span class="p">)</span>
<span class="n">PG</span><span class="o">.</span><span class="n">rFULL_SCALE</span> <span class="o">:=</span> <span class="n">i_rFULL_SCALE</span><span class="p">;</span>
<span class="n">rMinPressure</span> <span class="o">:=</span> <span class="n">PG</span><span class="o">.</span><span class="n">rFULL_SCALE</span> <span class="o">*</span> <span class="mf">5E-4</span><span class="p">;</span>

<span class="n">If</span> <span class="p">(</span><span class="n">iTermBits</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="n">THEN</span> <span class="n">iTermBits</span> <span class="o">:=</span> <span class="mi">32767</span><span class="p">;</span><span class="n">END_IF</span>
<span class="n">rV</span> <span class="o">:=</span><span class="n">MAX</span><span class="p">((</span><span class="mi">10</span><span class="o">*</span><span class="n">INT_TO_REAL</span><span class="p">(</span><span class="n">PG</span><span class="o">.</span><span class="n">i_iPRESS_R</span><span class="p">)</span><span class="o">/</span><span class="n">iTermBits</span><span class="p">),</span><span class="mi">0</span><span class="p">);</span>

<span class="n">PG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">:=</span> <span class="p">(</span><span class="n">PG</span><span class="o">.</span><span class="n">rFULL_SCALE</span><span class="o">/</span><span class="mi">10</span><span class="p">)</span><span class="o">*</span><span class="n">rV</span><span class="p">;</span>
<span class="n">IF</span> <span class="n">PG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">rMinPressure</span><span class="p">)</span><span class="n">THEN</span>
    <span class="n">PG</span><span class="o">.</span><span class="n">xPRESS_OK</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">PG</span><span class="o">.</span><span class="n">xPRESS_OK</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="p">(</span><span class="o">*</span><span class="n">IO</span> <span class="n">soft</span> <span class="n">linking</span><span class="o">*</span><span class="p">)</span>
<span class="n">ACT_IO</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>
<span class="n">ACTION</span> <span class="n">ACT_IO</span><span class="p">:</span>
<span class="n">PG</span><span class="o">.</span><span class="n">i_iPRESS_R</span> <span class="o">:=</span><span class="n">i_iPRESS_R</span><span class="p">;</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
</div>
<div class="section" id="fb-gpi-test">
<h2>FB_GPI_Test<a class="headerlink" href="#fb-gpi-test" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_GPI_Test</span> <span class="n">EXTENDS</span> <span class="n">TcUnit</span><span class="o">.</span><span class="n">FB_TestSuite</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fb_MKS275</span><span class="p">:</span> <span class="n">FB_MKS275</span><span class="p">;</span>
    <span class="n">fb_MKS317</span><span class="p">:</span> <span class="n">FB_MKS317</span><span class="p">;</span>
    <span class="n">i_iPRESS_R</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span> <span class="p">:</span><span class="n">INT</span><span class="p">;</span>
    <span class="n">cycle</span><span class="p">:</span><span class="n">INT</span> <span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">M_INIT</span><span class="p">();</span>
<span class="n">M_CheckRange</span><span class="p">();</span>
<span class="n">cycle</span><span class="o">:=</span><span class="n">cycle</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</div>
<div class="section" id="fb-itr90">
<h2>FB_ITR90<a class="headerlink" href="#fb-itr90" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">function</span> <span class="n">block</span> <span class="n">implements</span> <span class="n">the</span> <span class="n">Oerlikon</span> <span class="n">Leybold</span> <span class="n">IONVAC</span> <span class="n">Hot</span> <span class="n">Cathode</span> <span class="n">ITR</span> <span class="mi">90</span><span class="o">*</span><span class="p">)</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_ITR90</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span>
    <span class="s1">&#39;}</span>
    <span class="n">PG</span> <span class="p">:</span> <span class="n">ST_VG</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">rV</span> <span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>      <span class="o">//</span> <span class="nb">input</span> <span class="n">voltage</span>
    <span class="n">rC</span><span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="o">-</span><span class="mf">0.125</span><span class="p">;</span> <span class="o">//</span> <span class="n">a</span> <span class="n">constant</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">manual</span> <span class="p">(</span><span class="n">pressure</span> <span class="n">unit</span> <span class="n">dependent</span><span class="p">)</span>
    <span class="n">rK</span><span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mf">1.0</span><span class="p">;</span><span class="o">//</span> <span class="n">Calibration</span> <span class="n">factor</span> <span class="n">C</span> <span class="p">(</span><span class="n">gas</span> <span class="nb">type</span> <span class="n">dependent</span><span class="p">)</span>
    <span class="n">iTermBits</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">32767</span> <span class="p">;</span> <span class="o">//</span> <span class="n">The</span> <span class="n">terminal</span><span class="s1">&#39;s maximum value in bits</span>
    <span class="p">(</span><span class="o">*</span><span class="n">IO</span><span class="o">*</span><span class="p">)</span>
    <span class="n">i_iPRESS_R</span> <span class="n">AT</span><span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span><span class="n">INT</span><span class="p">;</span> <span class="o">//</span> <span class="nb">input</span> <span class="n">Pressure</span> <span class="o">//</span> <span class="n">Link</span> <span class="n">to</span> <span class="n">analog</span> <span class="n">Input</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">function</span> <span class="n">block</span> <span class="n">implements</span> <span class="n">the</span> <span class="n">Oerlikon</span> <span class="n">Leybold</span> <span class="n">IONVAC</span> <span class="n">Hot</span> <span class="n">Cathode</span> <span class="n">ITR</span> <span class="mi">90</span><span class="o">*</span><span class="p">)</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Real</span><span class="o">-</span><span class="n">value</span> <span class="n">calculation</span> <span class="o">*</span><span class="p">)</span>

<span class="n">rV</span> <span class="o">:=</span> <span class="mi">10</span><span class="o">*</span><span class="n">INT_TO_REAL</span><span class="p">(</span><span class="n">PG</span><span class="o">.</span><span class="n">i_iPRESS_R</span><span class="p">)</span><span class="o">/</span><span class="n">iTermBits</span><span class="p">;</span>
<span class="n">PG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">:=</span> <span class="p">(</span><span class="n">LREAL_TO_REAL</span><span class="p">(</span><span class="n">EXPT</span><span class="p">(</span><span class="mi">10</span><span class="p">,(</span><span class="n">rV</span><span class="o">-</span><span class="mf">7.75</span><span class="p">)</span><span class="o">/</span><span class="mf">0.75</span><span class="o">+</span><span class="n">rC</span><span class="p">)))</span> <span class="o">*</span> <span class="n">rK</span><span class="p">;</span>


<span class="p">(</span><span class="o">*</span> <span class="n">Pressure</span> <span class="n">gauge</span> <span class="n">State</span> <span class="n">checks</span> <span class="o">*</span><span class="p">)</span>

<span class="o">//</span><span class="n">IF</span> <span class="p">(</span><span class="n">rV</span> <span class="o">&lt;=</span><span class="mf">9.7</span> <span class="p">)</span> <span class="n">AND</span> <span class="p">(</span><span class="n">rV</span><span class="o">&gt;=</span><span class="mi">1</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="o">//</span><span class="n">PG</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">Valid</span><span class="p">;</span> <span class="o">//</span> <span class="n">normal</span>
<span class="n">IF</span> <span class="n">rV</span> <span class="o">&gt;=</span> <span class="mf">0.5</span> <span class="n">AND</span> <span class="n">rV</span> <span class="o">&lt;=</span> <span class="mf">4.5</span> <span class="n">THEN</span>
    <span class="n">PG</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">ValidLo</span><span class="p">;</span> <span class="o">//</span><span class="n">LO</span>
<span class="n">ELSIF</span> <span class="n">rV</span> <span class="o">&gt;</span> <span class="mf">4.5</span> <span class="n">AND</span> <span class="n">rV</span><span class="o">&lt;=</span> <span class="mf">9.9</span> <span class="n">THEN</span>
    <span class="n">PG</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">ValidHi</span><span class="p">;</span> <span class="o">//</span><span class="n">HIGH</span>
<span class="n">ELSIF</span> <span class="n">rV</span> <span class="o">&lt;</span> <span class="mf">0.5</span> <span class="n">THEN</span>
    <span class="n">PG</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">GaugeDisconnected</span><span class="p">;</span> <span class="o">//</span><span class="ow">not</span> <span class="n">on</span>
<span class="n">ELSE</span>
    <span class="n">PG</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">PressInvalid</span><span class="p">;</span> <span class="o">//</span><span class="n">other</span> <span class="n">fault</span> <span class="o">-</span> <span class="n">could</span> <span class="n">be</span> <span class="n">no</span> <span class="n">gauge</span><span class="p">,</span> <span class="n">controller</span> <span class="n">powering</span> <span class="n">up</span> <span class="n">etc</span>
<span class="n">END_IF</span>



<span class="p">(</span><span class="o">*</span> <span class="n">Pressure</span> <span class="n">gauge</span> <span class="n">OK</span> <span class="n">checks</span> <span class="o">*</span><span class="p">)</span>
<span class="n">PG</span><span class="o">.</span><span class="n">xPRESS_OK</span> <span class="o">:=</span> <span class="p">(</span><span class="n">rV</span> <span class="o">&lt;=</span><span class="mf">9.9</span> <span class="p">)</span> <span class="n">AND</span> <span class="p">(</span><span class="n">rV</span><span class="o">&gt;=</span><span class="mf">0.5</span><span class="p">);</span>


<span class="p">(</span><span class="o">*</span> <span class="n">Setpoint</span> <span class="n">evaluation</span> <span class="o">*</span><span class="p">)</span>
<span class="n">PG</span><span class="o">.</span><span class="n">xAT_VAC</span> <span class="o">:=</span> <span class="n">PG</span><span class="o">.</span><span class="n">xPRESS_OK</span> <span class="n">AND</span> <span class="n">PG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">&lt;</span> <span class="n">PG</span><span class="o">.</span><span class="n">rVAC_SP</span><span class="p">;</span>


<span class="p">(</span><span class="o">*</span><span class="n">Soft</span> <span class="n">IO</span> <span class="n">Linking</span><span class="o">*</span><span class="p">)</span>
<span class="n">ACT_IO</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>
<span class="n">ACTION</span> <span class="n">ACT_IO</span><span class="p">:</span>
<span class="n">PG</span><span class="o">.</span><span class="n">i_iPRESS_R</span> <span class="o">:=</span><span class="n">i_iPRESS_R</span><span class="p">;</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
</div>
<div class="section" id="fb-kashiyama-vrc">
<h2>FB_Kashiyama_VRC<a class="headerlink" href="#fb-kashiyama-vrc" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span> <span class="n">Main</span> <span class="n">Kashiyama</span> <span class="n">gate</span> <span class="n">valve</span> <span class="n">permit</span> <span class="n">to</span> <span class="n">be</span> <span class="nb">open</span> <span class="n">when</span><span class="p">:</span>
            <span class="mf">1.</span> <span class="n">pump</span> <span class="ow">is</span> <span class="n">NORMAL</span> <span class="n">operating</span> <span class="n">status</span><span class="p">,</span> <span class="ow">and</span>
        <span class="mf">2.</span> <span class="n">chamber</span> <span class="n">pressure</span> <span class="ow">is</span> <span class="n">below</span> <span class="n">HighSP</span> <span class="ow">or</span> <span class="n">pump</span> <span class="ow">is</span> <span class="n">at</span> <span class="n">LowSpeed</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">it</span> <span class="n">will</span> <span class="n">close</span> <span class="k">if</span> <span class="n">chamber</span> <span class="n">pressure</span> <span class="ow">is</span> <span class="n">below</span> <span class="n">than</span> <span class="n">lowSP</span> <span class="k">for</span> <span class="mi">180</span><span class="n">s</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_Kashiyama_VRC</span>
<span class="n">VAR_IN_OUT</span>

<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39; pv:&#39;</span><span class="p">}</span>
    <span class="n">q_stValve</span> <span class="p">:</span> <span class="n">ST_VRC</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">Pump</span> <span class="p">:</span> <span class="n">ST_KashiyamaDryPump</span><span class="p">;</span><span class="o">//</span><span class="n">Kashyiama</span> <span class="n">pump</span>
    <span class="n">i_xExtILK_OK</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">Connect</span> <span class="n">to</span> <span class="n">Interlock</span> <span class="n">logic</span> <span class="n">condition</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">g</span> <span class="n">F_TURBO_VRC_ILK</span> <span class="n">Function</span><span class="p">),</span> <span class="n">otherwise</span><span class="p">,</span> <span class="n">Set</span> <span class="n">to</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">the</span> <span class="n">valve</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">interlocked</span>
    <span class="n">Gauge</span> <span class="p">:</span> <span class="n">ST_VG</span><span class="p">;</span><span class="o">//</span> <span class="n">Pressure</span> <span class="n">Gauge</span>
    <span class="n">i_xOverrideMode</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">At_HiVac</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">tmrTP</span> <span class="p">:</span> <span class="n">TP</span><span class="p">;</span>
    <span class="n">tmrPT</span><span class="p">:</span> <span class="n">TIME</span> <span class="o">:=</span> <span class="n">T</span><span class="c1">#180S;</span>
    <span class="n">v1</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">tonOvrd</span> <span class="p">:</span>       <span class="n">TON</span><span class="p">;</span>
    <span class="n">tonDelOK</span> <span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">rtOK</span>    <span class="p">:</span>       <span class="n">R_TRIG</span><span class="p">;</span>

    <span class="p">(</span><span class="o">*</span><span class="n">IO</span><span class="o">*</span><span class="p">)</span>
    <span class="n">i_xOpnLS</span>        <span class="n">AT</span><span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">i_xClsLS</span>        <span class="n">AT</span><span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">q_xOPN_DO</span>       <span class="n">AT</span><span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Main</span> <span class="n">Kashiyama</span> <span class="n">gate</span> <span class="n">valve</span> <span class="n">permit</span> <span class="n">to</span> <span class="n">be</span> <span class="nb">open</span> <span class="n">when</span><span class="p">:</span>
            <span class="mf">1.</span> <span class="n">pump</span> <span class="ow">is</span> <span class="n">NORMAL</span> <span class="n">operating</span> <span class="n">status</span><span class="p">,</span> <span class="ow">and</span>
        <span class="mf">2.</span> <span class="n">chamber</span> <span class="n">pressure</span> <span class="ow">is</span> <span class="n">below</span> <span class="n">HighSP</span> <span class="ow">or</span> <span class="n">pump</span> <span class="ow">is</span> <span class="n">at</span> <span class="n">LowSpeed</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">it</span> <span class="n">will</span> <span class="n">close</span> <span class="k">if</span> <span class="n">chamber</span> <span class="n">pressure</span> <span class="ow">is</span> <span class="n">below</span> <span class="n">than</span> <span class="n">lowSP</span> <span class="k">for</span> <span class="mi">60</span><span class="n">s</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span>
      <span class="n">For</span> <span class="n">main</span> <span class="n">Kayshiyama</span> <span class="n">pump</span><span class="s1">&#39;s gate valve:</span>
            <span class="n">Pump</span> <span class="n">LowSP</span> <span class="ow">is</span> <span class="n">MU100</span> <span class="n">base</span> <span class="n">pressure</span> <span class="p">(</span><span class="mi">20</span> <span class="n">mTorr</span><span class="p">)</span>
            <span class="n">Pump</span> <span class="n">HighSP</span> <span class="ow">is</span> <span class="mi">600</span> <span class="n">Torr</span><span class="p">;</span>
      <span class="n">Second</span> <span class="n">Kayshiyama</span> <span class="n">pump</span> <span class="n">allow</span> <span class="n">Gas</span> <span class="n">Attenuator</span> <span class="n">operating</span> <span class="n">at</span> <span class="n">higher</span> <span class="n">pressure</span><span class="p">,</span>
      <span class="n">it</span><span class="s1">&#39;s gate valve is to be open when Gas Attenuator chamber pressure is above lowSP.</span>
<span class="o">*</span><span class="p">)</span>


<span class="o">///</span><span class="n">Check</span> <span class="n">valve</span> <span class="n">postion</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">q_stValve</span><span class="o">.</span><span class="n">i_xClsLS</span> <span class="n">AND</span> <span class="n">q_stValve</span><span class="o">.</span><span class="n">i_xOpnLS</span> <span class="n">THEN</span>
    <span class="n">q_stValve</span><span class="o">.</span><span class="n">eState</span><span class="o">:=</span><span class="n">OPEN</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">q_stValve</span><span class="o">.</span><span class="n">i_xClsLS</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">q_stValve</span><span class="o">.</span><span class="n">i_xOpnLS</span> <span class="n">THEN</span>
    <span class="n">q_stValve</span><span class="o">.</span><span class="n">eState</span><span class="o">:=</span><span class="n">CLOSED</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">NOT</span> <span class="n">q_stValve</span><span class="o">.</span><span class="n">i_xClsLS</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">q_stValve</span><span class="o">.</span><span class="n">i_xOpnLS</span> <span class="n">THEN</span>
    <span class="n">q_stValve</span><span class="o">.</span><span class="n">eState</span><span class="o">:=</span><span class="n">MOVING</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">q_stValve</span><span class="o">.</span><span class="n">eState</span><span class="o">:=</span><span class="n">INVALID</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span><span class="n">valve</span> <span class="nb">open</span> <span class="n">interlock</span>
<span class="n">q_stValve</span><span class="o">.</span><span class="n">xOPN_OK</span> <span class="o">:=</span> <span class="n">Pump</span><span class="o">.</span><span class="n">i_xIsRun</span> <span class="n">AND</span> <span class="n">Pump</span><span class="o">.</span><span class="n">RdyTmr</span> <span class="o">&lt;=</span> <span class="mf">0.0</span> <span class="n">AND</span> <span class="p">(</span><span class="n">Gauge</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">&lt;</span> <span class="n">Pump</span><span class="o">.</span><span class="n">HighSP</span> <span class="n">OR</span> <span class="n">Pump</span><span class="o">.</span><span class="n">q_xLspdDo</span><span class="p">)</span> <span class="n">AND</span> <span class="n">i_xExtILK_OK</span><span class="p">;</span>


<span class="p">(</span><span class="o">*</span> <span class="n">Override</span> <span class="n">logic</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Goal</span><span class="p">:</span> <span class="n">give</span> <span class="n">ability</span> <span class="n">to</span> <span class="n">override</span><span class="p">,</span> <span class="n">but</span> <span class="n">do</span> <span class="n">so</span> <span class="ow">in</span> <span class="n">a</span> <span class="n">way</span> <span class="n">that</span> <span class="n">people</span> <span class="n">won</span><span class="s1">&#39;t forget it.</span>
<span class="n">Solution</span><span class="p">:</span> <span class="n">Override</span> <span class="n">only</span> <span class="n">after</span> <span class="n">ten</span> <span class="n">seconds</span> <span class="n">of</span> <span class="n">override</span><span class="p">,</span> <span class="n">protect</span> <span class="n">against</span> <span class="n">blips</span><span class="p">,</span>
<span class="n">when</span> <span class="n">the</span> <span class="n">valve</span> <span class="n">permission</span> <span class="n">goes</span> <span class="n">true</span> <span class="k">for</span> <span class="n">more</span> <span class="n">than</span> <span class="n">ten</span> <span class="n">seconds</span> <span class="n">consistently</span><span class="p">,</span> <span class="n">remove</span> <span class="n">override</span>
<span class="o">*</span><span class="p">)</span>

<span class="n">tonDelOK</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">q_stValve</span><span class="o">.</span><span class="n">xOPN_OK</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#10S);</span>
<span class="n">rtOK</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">tonDelOK</span><span class="o">.</span><span class="n">Q</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">rtOK</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span> <span class="n">q_stValve</span><span class="o">.</span><span class="n">pv_xOvrdOpn</span> <span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span> <span class="n">END_IF</span>

<span class="o">//</span><span class="n">Override</span> <span class="n">timer</span>
<span class="n">tonOvrd</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">q_stValve</span><span class="o">.</span><span class="n">pv_xOvrdOpn</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#10S);</span>


<span class="p">(</span><span class="o">*</span> <span class="n">Here</span><span class="s1">&#39;s where the valve closes *)</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">q_stValve</span><span class="o">.</span><span class="n">xOPN_OK</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">tonOvrd</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
<span class="n">q_stValve</span><span class="o">.</span><span class="n">pv_xOPN_SW</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">At_HiVac</span> <span class="o">:=</span> <span class="n">Gauge</span><span class="o">.</span><span class="n">xPRESS_OK</span> <span class="n">AND</span> <span class="n">Gauge</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">&lt;</span> <span class="n">Pump</span><span class="o">.</span><span class="n">LowSP</span><span class="p">;</span>
<span class="n">tmrTP</span> <span class="p">(</span><span class="n">IN</span> <span class="o">:=</span> <span class="n">At_HiVac</span> <span class="n">AND</span> <span class="n">q_stValve</span><span class="o">.</span><span class="n">q_xOPN_DO</span> <span class="p">,</span> <span class="n">PT</span> <span class="o">:=</span> <span class="n">tmrPT</span><span class="p">);</span>

<span class="n">IF</span> <span class="n">At_HiVac</span> <span class="n">AND</span> <span class="n">q_stValve</span><span class="o">.</span><span class="n">q_xOPN_DO</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">tmrTP</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">q_stValve</span><span class="o">.</span><span class="n">pv_xOPN_SW</span> <span class="o">:=</span> <span class="n">FALSE</span> <span class="p">;</span>
<span class="n">END_IF</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Here</span><span class="s1">&#39;s where the valve opens *)</span>
<span class="n">q_stValve</span><span class="o">.</span><span class="n">q_xOPN_DO</span> <span class="o">:=</span> <span class="p">(</span><span class="n">q_stValve</span><span class="o">.</span><span class="n">pv_xOPN_SW</span> <span class="n">AND</span> <span class="n">q_stValve</span><span class="o">.</span><span class="n">xOPN_OK</span><span class="p">)</span> <span class="n">OR</span> <span class="p">(</span><span class="n">tonOvrd</span><span class="o">.</span><span class="n">Q</span> <span class="n">AND</span> <span class="n">i_xOverrideMode</span><span class="p">);</span>

<span class="p">(</span><span class="o">*</span><span class="n">Soft</span> <span class="n">IO</span> <span class="n">Mapping</span><span class="o">*</span><span class="p">)</span>
<span class="n">ACT_IO</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>
<span class="n">ACTION</span> <span class="n">ACT_IO</span><span class="p">:</span>
<span class="p">(</span><span class="o">*</span><span class="n">inputs</span><span class="o">*</span><span class="p">)</span>
<span class="n">q_stValve</span><span class="o">.</span><span class="n">i_xOpnLS</span> <span class="o">:=</span>       <span class="n">i_xOpnLS</span><span class="p">;</span>
<span class="n">q_stValve</span><span class="o">.</span><span class="n">i_xClsLS</span><span class="o">:=</span>        <span class="n">i_xClsLS</span><span class="p">;</span>
<span class="p">(</span><span class="o">*</span><span class="n">outputs</span><span class="o">*</span><span class="p">)</span>
<span class="n">q_xOPN_DO</span><span class="o">:=</span> <span class="n">q_stValve</span><span class="o">.</span><span class="n">q_xOPN_DO</span><span class="p">;</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
</div>
<div class="section" id="fb-kashiyamapump">
<h2>FB_KashiyamaPump<a class="headerlink" href="#fb-kashiyamapump" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">function</span> <span class="n">block</span> <span class="n">does</span> <span class="n">basic</span> <span class="n">controls</span> <span class="n">FOR</span> <span class="n">the</span> <span class="n">Kashiyama</span> <span class="n">pump</span><span class="o">.</span> <span class="n">Turns</span> <span class="n">off</span> <span class="n">pump</span>
<span class="ow">in</span> <span class="n">the</span> <span class="n">event</span> <span class="n">of</span> <span class="n">errors</span><span class="o">/</span> <span class="n">warnings</span><span class="o">.</span> <span class="n">Provides</span> <span class="n">interlocking</span> <span class="n">interface</span><span class="o">.*</span><span class="p">)</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_KashiyamaPump</span>
<span class="n">VAR_IN_OUT</span>

<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>

<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv:&#39;</span><span class="p">}</span>
    <span class="n">q_stPump</span> <span class="p">:</span> <span class="n">ST_KashiyamaDryPump</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">TONtmr</span> <span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">resetTmr</span> <span class="p">:</span> <span class="n">TON</span><span class="p">;</span>

    <span class="p">(</span><span class="o">*</span> <span class="n">Output</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">q_xRunDO</span>        <span class="n">AT</span><span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span>  <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">q_xResetDo</span>      <span class="n">AT</span><span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span>  <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">q_xLspdDo</span>       <span class="n">AT</span><span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span>  <span class="n">BOOL</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Input</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">i_xLocal</span>        <span class="n">AT</span><span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span>  <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">i_xAlarm</span>        <span class="n">AT</span><span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span>  <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">i_xWarning</span>      <span class="n">AT</span><span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span>  <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">i_xIsRun</span>        <span class="n">AT</span><span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span>  <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span><span class="n">Kashiyama</span> <span class="n">Dry</span> <span class="n">pump</span> <span class="n">outputs</span> <span class="n">at</span> <span class="n">high</span> <span class="n">level</span> <span class="n">indicate</span> <span class="n">no</span> <span class="n">warning</span><span class="p">,</span> <span class="n">no</span> <span class="n">alarm</span> <span class="ow">and</span> <span class="n">remotely</span>
<span class="n">q_stPump</span><span class="o">.</span><span class="n">xIlkOK</span> <span class="o">:=</span> <span class="n">q_stPump</span><span class="o">.</span><span class="n">i_xLocal</span> <span class="n">AND</span> <span class="n">q_stPump</span><span class="o">.</span><span class="n">i_xWarningOK</span> <span class="n">AND</span> <span class="n">q_stPump</span><span class="o">.</span><span class="n">i_xAlarmOK</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">q_stPump</span><span class="o">.</span><span class="n">xIlkOK</span> <span class="n">THEN</span>
    <span class="n">q_stPump</span><span class="o">.</span><span class="n">q_xRunDO</span> <span class="o">:=</span> <span class="n">q_stPump</span><span class="o">.</span><span class="n">pv_xRunSW</span><span class="p">;</span>
    <span class="n">ELSE</span>
            <span class="n">q_stPump</span><span class="o">.</span><span class="n">PV_xRunSW</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">q_stPump</span><span class="o">.</span><span class="n">q_xRunDO</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">q_stPump</span><span class="o">.</span><span class="n">xLspd_IlkENA</span> <span class="o">:=</span> <span class="n">q_stPump</span><span class="o">.</span><span class="n">q_xRunDO</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">q_stPump</span><span class="o">.</span><span class="n">xLspd_IlkENA</span> <span class="n">THEN</span>
    <span class="n">q_stPump</span><span class="o">.</span><span class="n">q_xLspdDo</span> <span class="o">:=</span> <span class="n">q_stPump</span><span class="o">.</span><span class="n">xLspdSW</span><span class="p">;</span>
    <span class="n">ELSE</span>
            <span class="n">q_stPump</span><span class="o">.</span><span class="n">xLspdSW</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">q_stPump</span><span class="o">.</span><span class="n">q_xLspdDo</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span><span class="n">resetTmr</span> <span class="p">(</span><span class="n">In</span> <span class="o">:=</span> <span class="n">iq_stPump</span><span class="o">.</span><span class="n">xResetSW</span><span class="p">,</span> <span class="n">PT</span> <span class="o">:=</span> <span class="n">T</span><span class="c1">#2S);</span>
<span class="o">//</span><span class="n">IF</span> <span class="n">resetTmr</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
<span class="o">//</span>  <span class="n">iq_stPump</span><span class="o">.</span><span class="n">xResetSW</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="o">//</span><span class="n">END_IF</span>

<span class="n">q_stPump</span><span class="o">.</span><span class="n">q_xResetDo</span> <span class="o">:=</span> <span class="n">NOT</span> <span class="n">q_stPump</span><span class="o">.</span><span class="n">i_xIsRun</span> <span class="n">AND</span> <span class="n">q_stPump</span><span class="o">.</span><span class="n">xResetSW</span><span class="p">;</span>

<span class="o">//</span><span class="n">countdown</span> <span class="n">Timer</span>
<span class="n">TONtmr</span> <span class="p">(</span><span class="n">IN</span> <span class="o">:=</span> <span class="n">q_stPump</span><span class="o">.</span><span class="n">i_xIsRun</span><span class="p">,</span> <span class="n">PT</span> <span class="o">:=</span> <span class="n">T</span><span class="c1">#20S);</span>
<span class="n">q_stPump</span><span class="o">.</span><span class="n">RdyTmr</span> <span class="o">:=</span> <span class="n">TO_REAL</span><span class="p">(</span><span class="n">TONtmr</span><span class="o">.</span><span class="n">PT</span><span class="p">)</span> <span class="o">-</span> <span class="n">TO_REAL</span><span class="p">(</span><span class="n">TONtmr</span><span class="o">.</span><span class="n">ET</span><span class="p">);</span>

<span class="p">(</span><span class="o">*</span><span class="n">State</span> <span class="n">evaluation</span><span class="o">*</span><span class="p">)</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">q_stPump</span><span class="o">.</span><span class="n">i_xAlarmOK</span> <span class="n">THEN</span>
    <span class="n">q_stPump</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">pumpFAULT</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">NOT</span> <span class="n">q_stPump</span><span class="o">.</span><span class="n">q_xRunDo</span> <span class="n">AND</span> <span class="n">q_stPump</span><span class="o">.</span><span class="n">i_xAlarmOK</span> <span class="n">THEN</span>
            <span class="n">q_stPump</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">pumpSTOPPED</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">NOT</span> <span class="n">q_stPump</span><span class="o">.</span><span class="n">q_xRunDo</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">q_stPump</span><span class="o">.</span><span class="n">i_xIsRun</span> <span class="n">THEN</span>
            <span class="n">q_stPump</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">pumpSTARTING</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">q_stPump</span><span class="o">.</span><span class="n">i_xIsRun</span> <span class="n">THEN</span>
            <span class="n">q_stPump</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">pumpRUNNING</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">q_stPump</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">pumpFAULT</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span><span class="n">Mapping</span>
<span class="n">ACT_IO</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>
<span class="n">ACTION</span> <span class="n">ACT_IO</span><span class="p">:</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Output</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">q_xRunDO</span>        <span class="o">:=</span> <span class="n">q_stPump</span><span class="o">.</span><span class="n">q_xRunDO</span><span class="p">;</span>
    <span class="n">q_xResetDo</span> <span class="o">:=</span> <span class="n">q_stPump</span><span class="o">.</span><span class="n">q_xResetDo</span><span class="p">;;</span>
    <span class="n">q_xLspdDo</span> <span class="o">:=</span> <span class="n">q_stPump</span><span class="o">.</span><span class="n">q_xLspdDo</span><span class="p">;;</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Input</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">q_stPump</span><span class="o">.</span><span class="n">i_xLocal</span> <span class="o">:=</span> <span class="n">i_xLocal</span><span class="p">;</span>
    <span class="n">q_stPump</span><span class="o">.</span><span class="n">i_xAlarmOK</span> <span class="o">:=</span>  <span class="n">i_xAlarm</span><span class="p">;</span>
    <span class="n">q_stPump</span><span class="o">.</span><span class="n">i_xWarningOK</span> <span class="o">:=</span>        <span class="n">i_xWarning</span><span class="p">;</span>
    <span class="n">q_stPump</span><span class="o">.</span><span class="n">i_xIsRun</span> <span class="o">:=</span>    <span class="n">i_xIsRun</span><span class="p">;</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
</div>
<div class="section" id="fb-mks248">
<h2>FB_MKS248<a class="headerlink" href="#fb-mks248" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span> <span class="n">MKS248</span> <span class="n">valve</span> <span class="n">using</span> <span class="n">MKS1249</span> <span class="n">Drive</span> <span class="n">Module</span> <span class="o">*</span><span class="p">)</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_MKS248</span>
<span class="n">VAR_INPUT</span>
    <span class="n">i_xExtIlkOK</span>     <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">External</span> <span class="n">Interlock</span><span class="p">,</span> <span class="n">SET</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">used</span>
    <span class="n">i_rReqPos</span>       <span class="p">:</span>       <span class="n">REAL</span><span class="p">;</span> <span class="o">//</span><span class="n">Requested</span> <span class="n">position</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv:&#39;</span><span class="p">}</span>
    <span class="n">iq_stVFN</span>        <span class="p">:</span>       <span class="n">ST_VCN</span><span class="p">;</span> <span class="o">//</span><span class="n">Needle</span> <span class="n">valve</span> <span class="n">structure</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span> <span class="n">CONSTANT</span>
    <span class="n">rOpenVoltage</span>    <span class="p">:</span>       <span class="n">REAL</span> <span class="o">:=</span> <span class="mf">9.8</span><span class="p">;</span>
    <span class="n">rCloseVoltage</span>   <span class="p">:</span>       <span class="n">REAL</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="o">//</span> <span class="n">Requested</span> <span class="n">voltage</span>
    <span class="n">rReqVoltage</span><span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">(</span><span class="o">*</span><span class="n">IO</span><span class="o">*</span><span class="p">)</span>
    <span class="n">q_iRawPosition</span> <span class="n">AT</span><span class="o">%</span><span class="n">Q</span><span class="o">*</span> <span class="p">:</span><span class="n">INT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">MKS248</span> <span class="n">valve</span> <span class="n">using</span> <span class="n">MKS1249</span> <span class="n">Drive</span> <span class="n">Module</span> <span class="o">*</span><span class="p">)</span>


<span class="o">//</span> <span class="n">Interlocking</span>
<span class="n">iq_stVFN</span><span class="o">.</span><span class="n">xIlkOK</span> <span class="o">:=</span> <span class="n">i_xExtIlkOK</span><span class="p">;</span>
<span class="p">(</span><span class="o">*</span><span class="n">Checking</span> <span class="n">which</span> <span class="n">Control</span> <span class="n">mode</span> <span class="ow">is</span> <span class="n">selected</span><span class="o">*</span><span class="p">)</span>
<span class="n">IF</span> <span class="n">iq_stVFN</span><span class="o">.</span><span class="n">xIlkOK</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">iq_stVFN</span><span class="o">.</span><span class="n">eValveControl</span> <span class="o">=</span> <span class="n">OpenValve</span> <span class="n">THEN</span>
            <span class="n">iq_stVFN</span><span class="o">.</span><span class="n">rReqPosition</span> <span class="o">:=</span> <span class="n">iq_stVFN</span><span class="o">.</span><span class="n">rUpperLimit</span><span class="p">;(</span><span class="o">*</span><span class="n">Percentage</span><span class="o">*</span><span class="p">)</span><span class="o">//</span> <span class="n">iq_stVCN</span><span class="o">.</span><span class="n">rUpperLimit</span><span class="p">;</span>
    <span class="n">ELSIF</span> <span class="n">iq_stVFN</span><span class="o">.</span><span class="n">eValveControl</span> <span class="o">=</span> <span class="n">CloseValve</span> <span class="n">THEN</span>
            <span class="n">iq_stVFN</span><span class="o">.</span><span class="n">rReqPosition</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span><span class="n">Percentage</span><span class="o">*</span><span class="p">)</span>
    <span class="n">ELSIF</span> <span class="n">iq_stVFN</span><span class="o">.</span><span class="n">eValveControl</span> <span class="o">=</span> <span class="n">ManualControl</span> <span class="n">THEN</span>
            <span class="n">iq_stVFN</span><span class="o">.</span><span class="n">rReqPosition</span> <span class="o">:=</span> <span class="n">LIMIT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">iq_stVFN</span><span class="o">.</span><span class="n">rReqPosition</span><span class="p">,</span> <span class="n">iq_stVFN</span><span class="o">.</span><span class="n">rUpperLimit</span><span class="p">);</span>
    <span class="n">ELSIF</span> <span class="n">iq_stVFN</span><span class="o">.</span><span class="n">eValveControl</span> <span class="o">=</span> <span class="n">PressureControl</span> <span class="n">THEN</span>
            <span class="n">iq_stVFN</span><span class="o">.</span><span class="n">rReqPosition</span> <span class="o">:=</span> <span class="n">LIMIT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i_rReqPos</span><span class="p">,</span> <span class="n">iq_stVFN</span><span class="o">.</span><span class="n">rUpperLimit</span><span class="p">);</span>
    <span class="n">END_IF</span>
<span class="n">ELSE</span>
    <span class="n">iq_stVFN</span><span class="o">.</span><span class="n">rReqPosition</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">iq_stVFN</span><span class="o">.</span><span class="n">eValveControl</span> <span class="o">:=</span> <span class="n">CloseValve</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Requested</span> <span class="n">Voltage</span> <span class="n">calculation</span>
<span class="n">rReqVoltage</span> <span class="o">:=</span> <span class="n">iq_stVFN</span><span class="o">.</span><span class="n">rReqPosition</span> <span class="o">*</span> <span class="p">(</span><span class="n">rOpenVoltage</span><span class="o">-</span><span class="n">rCloseVoltage</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span> <span class="o">+</span> <span class="n">rCloseVoltage</span><span class="p">;</span>
<span class="n">rReqVoltage</span> <span class="o">:=</span> <span class="n">LIMIT</span><span class="p">(</span><span class="n">rCloseVoltage</span><span class="p">,</span> <span class="n">rReqVoltage</span><span class="p">,</span> <span class="n">rOpenVoltage</span><span class="p">);</span> <span class="o">//</span><span class="n">The</span> <span class="n">requested</span> <span class="n">voltage</span> <span class="n">should</span> <span class="n">remain</span> <span class="n">within</span> <span class="n">this</span> <span class="nb">range</span>
<span class="o">//</span><span class="n">Raw</span> <span class="n">position</span> <span class="n">calc</span>
<span class="n">iq_stVFN</span><span class="o">.</span><span class="n">q_iRawPosition</span> <span class="o">:=</span> <span class="n">REAL_TO_INT</span><span class="p">(</span> <span class="mi">32767</span><span class="o">/</span><span class="mi">10</span> <span class="o">*</span> <span class="n">rReqVoltage</span><span class="p">);</span>
<span class="p">(</span><span class="o">*</span><span class="n">IO</span> <span class="n">Mapping</span><span class="o">*</span><span class="p">)</span>
<span class="n">ACT_IO</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>
<span class="n">ACTION</span> <span class="n">ACT_IO</span><span class="p">:</span>
<span class="p">(</span><span class="o">*</span><span class="n">outputs</span><span class="o">*</span><span class="p">)</span>
<span class="n">q_iRawPosition</span> <span class="o">:=</span> <span class="n">iq_stVFN</span><span class="o">.</span><span class="n">q_iRawPosition</span><span class="p">;</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
</div>
<div class="section" id="fb-mks275">
<h2>FB_MKS275<a class="headerlink" href="#fb-mks275" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(* This function block is used to provide protection and automatic turn on of ion gauges,
 it also manages the turn on of the AT_VAC boolean, and checks to make sure the pressure is good *)
(* For MKS 275 mini-convectron *)
{attribute &#39;no_check&#39;}
FUNCTION_BLOCK FB_MKS275 EXTENDS FB_GaugeBase
VAR_IN_OUT

END_VAR
VAR_INPUT
END_VAR

VAR_OUTPUT
    {attribute &#39;pytmc&#39; := &#39;
    pv:
    &#39;}
    PG : ST_VG;
END_VAR
VAR
    V : REAL;
    iTermBits: UINT := 32767 ; // The terminal&#39;s maximum value in bits
    Vlowest: REAL := 10;
    (*IO*)
    i_iPRESS_R AT%I* :INT; // input Pressure // Link to analog Input
END_VAR

VAR CONSTANT
    MinPressure: REAL := 1E-4;
    rDeadband : REAL :=0.02;
    rValidLoBoundary        :       REAL := 0.375; //  0.375V as per manual page 27
    rValidHiBoundary        :       REAL := 5.659;// 5.534; // manual page 27
    rDisconnectedBoundary   :       REAL := 0.3;
END_VAR
(* This function block is used to provide protection and automatic turn on of ion gauges,
 it also manages the turn on of the AT_VAC boolean, and checks to make sure the pressure is good *)
(* For MKS 275 mini-convectron *)

//Default setpoint 50 mT
IF PG.rVAC_SP = 0 THEN
    PG.rVAC_SP := 5E-2;
END_IF

(* Real-value calculation *)
If (iTermBits=0) THEN iTermBits := 32767;END_IF
V := 10*INT_TO_REAL(PG.i_iPRESS_R)/iTermBits;

Vlowest := MIN(V, Vlowest);

IF V &gt; rDisconnectedBoundary AND V &lt; rValidLoBoundary +rDeadband  THEN
    PG.rPRESS := MinPressure;
    PG.eState := ValidLo;

ELSIF V &gt;= rValidLoBoundary AND V &lt; 2.842 THEN
    PG.rPRESS := MAX( MinPressure, LREAL_TO_REAL( -0.02585 + 0.03767*V + 0.04563*EXPT(V,2)+ 0.1151*EXPT(V,3) - 0.04158*EXPT(V,4)+ 0.008737*EXPT(V,5)) );
    PG.eState := Valid;

ELSIF V &gt;= 2.842 AND V &lt; 4.945 THEN
    PG.rPRESS := LREAL_TO_REAL((0.1031-0.02322*V+0.07229*EXPT(V,2))/(1-0.3986*V+0.07438*EXPT(V,2)-0.006866*EXPT(V,3)));
    PG.eState := Valid;

ELSIF V &gt;= 4.945 AND V &lt; rValidHiBoundary THEN
    PG.rPRESS := LREAL_TO_REAL((100.624-20.5623*V)/(1-0.37679*V+0.0348656*EXPT(V,2)));
    PG.eState := Valid;

ELSIF V &lt;= rDisconnectedBoundary THEN
    PG.eState := GaugeDisconnected; //Most likely not connected
    PG.rPRESS := -1;

ELSE
    PG.eState := OoR; //Larger voltage, probably out of range?
    PG.rPRESS := -1;
END_IF

(* Protection Functions *)
(* If the PG pressure is greater than the IG.PRO_SP then the gauge is disabled *)
(* If the PG pressure is less than the IG.PRO_SP then the gauge is enabled *)
(* This FB also implements some hysteresis so the gauge doesn&#39;t have rapid power cycling while near the turn on boundary *)

(* Pressure OK check *)
PG.xPRESS_OK := (PG.rPRESS &gt;= MinPressure);

(* Setpoint evaluation *)
PG.xAT_VAC := PG.xPRESS_OK AND (PG.rPRESS&lt;=PG.rVAC_SP);

(*Logger*)
ACT_Logger();

(*Soft IO Mapping *)
IO();

END_FUNCTION_BLOCK
ACTION ACT_Logger:
//STATE Logger
if (PG.xLog) THEN
    IF ePrevState &lt;&gt; PG.eState THEN
      CASE PG.eState OF
            ValidHi:
                    fbLogger(sMsg:=&#39;Gauge pressure valid high.&#39;, eSevr:=TcEventSeverity.Info);
            ValidLo:
                    fbLogger(sMsg:=&#39;Gauge pressure valid low.&#39;, eSevr:=TcEventSeverity.Info);
            Valid:
                    fbLogger(sMsg:=&#39;Gauge pressure valid.&#39;, eSevr:=TcEventSeverity.Info);
            GaugeDisconnected:
                    fbLogger(sMsg:=&#39;Gauge Disconnected.&#39;, eSevr:=TcEventSeverity.Critical);
            PressInvalid:
                    fbLogger(sMsg:=&#39;Gauge pressure invalid.&#39;, eSevr:=TcEventSeverity.Warning);
            OoR:
                    fbLogger(sMsg:=&#39;Gauge pressure out of range.&#39;, eSevr:=TcEventSeverity.Warning);
            Starting:
                    fbLogger(sMsg:=&#39;Gauge starting.&#39;, eSevr:=TcEventSeverity.Info);
      END_CASE
      ePrevState := PG.eState;
  END_IF
END_IF
END_ACTION
ACTION IO:
PG.i_iPRESS_R :=i_iPRESS_R;
PG.sPath := sPath;
END_ACTION
</pre></div>
</div>
</div>
<div class="section" id="fb-mks317">
<h2>FB_MKS317<a class="headerlink" href="#fb-mks317" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">function</span> <span class="ow">is</span> <span class="k">for</span> <span class="n">the</span> <span class="n">Pirani</span> <span class="n">MKS</span> <span class="mi">317</span> <span class="n">connected</span> <span class="n">to</span> <span class="n">a</span> <span class="mi">937</span><span class="n">A</span><span class="o">/</span><span class="n">B</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">function</span> <span class="n">block</span> <span class="ow">is</span> <span class="n">used</span> <span class="n">to</span> <span class="n">provide</span> <span class="n">protection</span> <span class="ow">and</span> <span class="n">automatic</span> <span class="n">turn</span> <span class="n">on</span> <span class="n">of</span> <span class="n">ion</span> <span class="n">gauges</span><span class="p">,</span>
 <span class="n">it</span> <span class="n">also</span> <span class="n">manages</span> <span class="n">the</span> <span class="n">turn</span> <span class="n">on</span> <span class="n">of</span> <span class="n">the</span> <span class="n">AT_VAC</span> <span class="n">boolean</span><span class="p">,</span> <span class="ow">and</span> <span class="n">checks</span> <span class="n">to</span> <span class="n">make</span> <span class="n">sure</span> <span class="n">the</span> <span class="n">pressure</span> <span class="ow">is</span> <span class="n">good</span> <span class="o">*</span><span class="p">)</span>

<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_MKS317</span> <span class="n">Extends</span> <span class="n">FB_GaugeBase</span>
<span class="n">VAR_IN_OUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">b937A</span> <span class="p">:</span><span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span> <span class="o">//</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">this</span> <span class="n">gauge</span> <span class="ow">is</span> <span class="n">connected</span> <span class="n">to</span> <span class="n">MKS937A</span> <span class="n">controller</span><span class="p">,</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">connected</span> <span class="n">to</span> <span class="n">MKS937B</span> <span class="n">controller</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span>
    <span class="s1">&#39;}</span>
    <span class="n">PG</span> <span class="p">:</span> <span class="n">ST_VG</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">rV</span>      <span class="p">:</span>       <span class="n">REAL</span><span class="p">;</span>

    <span class="p">(</span><span class="o">*</span><span class="n">IO</span><span class="o">*</span><span class="p">)</span>
    <span class="n">i_iPRESS_R</span> <span class="n">AT</span><span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span><span class="n">INT</span><span class="p">;</span> <span class="o">//</span> <span class="nb">input</span> <span class="n">Pressure</span> <span class="o">//</span> <span class="n">Link</span> <span class="n">to</span> <span class="n">analog</span> <span class="n">Input</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span> <span class="n">CONSTANT</span>
    <span class="n">rMinPressure</span><span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mf">1E-4</span><span class="p">;</span>
    <span class="n">rDefaultVAC_SP</span><span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span><span class="mf">5E-2</span><span class="p">;</span> <span class="o">//</span> <span class="n">Default</span> <span class="mi">50</span> <span class="n">mT</span>
    <span class="n">rDisconnectedBoundary</span>   <span class="p">:</span>       <span class="n">REAL</span> <span class="o">:=</span> <span class="mf">0.10</span><span class="p">;</span>
    <span class="n">rValidLoBoundary</span>        <span class="p">:</span>       <span class="n">REAL</span> <span class="o">:=</span> <span class="mf">0.22</span><span class="p">;</span>
    <span class="n">rValidBoundaryMin</span>       <span class="p">:</span>       <span class="n">REAL</span> <span class="o">:=</span> <span class="mf">0.6</span><span class="p">;</span>
    <span class="n">rValidHiBoundary</span>        <span class="p">:</span>       <span class="n">REAL</span> <span class="o">:=</span> <span class="mf">9.7</span><span class="p">;</span>
    <span class="n">rValidHiBoundaryMax</span>     <span class="p">:</span>       <span class="n">REAL</span> <span class="o">:=</span> <span class="mf">9.9</span><span class="p">;</span>
    <span class="n">rNoSensorBoundary</span>       <span class="p">:</span>       <span class="n">REAL</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="mi">937</span><span class="n">B</span> <span class="n">Logarithmic</span> <span class="n">Output</span> <span class="n">Conversion</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="mi">5</span><span class="o">-</span><span class="mi">20</span><span class="o">-</span><span class="mi">2016</span><span class="p">,</span> <span class="n">Alex</span> <span class="n">Wallace</span> <span class="ow">and</span> <span class="n">Scott</span> <span class="n">Stubbs</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="mi">09</span><span class="o">-</span><span class="mi">28</span><span class="o">-</span><span class="mi">2018</span><span class="p">,</span> <span class="n">Margaret</span> <span class="n">Ghaly</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">function</span> <span class="n">will</span> <span class="n">read</span> <span class="n">the</span> <span class="n">pressure</span> <span class="kn">from</span> <span class="nn">any</span> <span class="n">gauge</span> <span class="n">on</span> <span class="n">a</span> <span class="mi">937</span><span class="n">B</span><span class="o">.</span> <span class="o">*</span><span class="p">)</span>

<span class="n">rV</span> <span class="o">:=</span> <span class="mi">10</span><span class="o">*</span><span class="n">INT_TO_REAL</span><span class="p">(</span><span class="n">PG</span><span class="o">.</span><span class="n">i_iPRESS_R</span><span class="p">)</span><span class="o">/</span><span class="mi">32767</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">b937A</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">PG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">:=</span> <span class="n">LREAL_TO_REAL</span><span class="p">(</span><span class="n">EXPT</span><span class="p">(</span><span class="mi">10</span><span class="p">,((</span><span class="n">rV</span><span class="p">)</span><span class="o">/</span><span class="mf">0.6</span><span class="p">)</span><span class="o">-</span><span class="mi">12</span><span class="p">));</span> <span class="o">//</span><span class="n">manual</span> <span class="n">page</span> <span class="mi">61</span> <span class="n">MKS937A</span>
    <span class="n">ELSE</span>
    <span class="n">PG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">:=</span> <span class="n">LREAL_TO_REAL</span><span class="p">(</span><span class="n">EXPT</span><span class="p">(</span><span class="mi">10</span><span class="p">,(</span><span class="n">rV</span><span class="o">-</span><span class="mf">7.2</span><span class="p">)</span><span class="o">/</span><span class="mf">0.6</span><span class="p">));</span>      <span class="o">//</span><span class="n">manual</span> <span class="n">page</span> <span class="mi">73</span> <span class="n">MKS937B</span>
<span class="n">END_IF</span>


<span class="o">//</span><span class="n">Default</span> <span class="n">setpoint</span>
<span class="n">IF</span> <span class="n">PG</span><span class="o">.</span><span class="n">rVAC_SP</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">PG</span><span class="o">.</span><span class="n">rVAC_SP</span> <span class="o">:=</span> <span class="n">rDefaultVAC_SP</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="p">(</span><span class="n">rV</span> <span class="o">&lt;=</span><span class="n">rValidHiBoundary</span> <span class="p">)</span> <span class="n">AND</span> <span class="p">(</span><span class="n">rV</span><span class="o">&gt;=</span><span class="n">rValidBoundaryMin</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">PG</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">Valid</span><span class="p">;</span> <span class="o">//</span> <span class="n">normal</span>
<span class="n">ELSIF</span> <span class="n">rV</span> <span class="o">&gt;=</span> <span class="n">rDisconnectedBoundary</span> <span class="n">AND</span> <span class="n">rV</span> <span class="o">&lt;=</span> <span class="n">rValidLoBoundary</span> <span class="n">THEN</span>
    <span class="n">PG</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">ValidLo</span><span class="p">;</span> <span class="o">//</span><span class="n">LO</span>
    <span class="n">PG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">:=</span> <span class="n">rMinPressure</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">rV</span> <span class="o">&gt;</span> <span class="n">rValidHiBoundary</span> <span class="n">AND</span> <span class="n">rV</span><span class="o">&lt;=</span> <span class="n">rValidHiBoundaryMax</span> <span class="n">THEN</span>
    <span class="n">PG</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">ValidHi</span><span class="p">;</span> <span class="o">//</span><span class="n">HIGH</span>
<span class="n">ELSIF</span> <span class="n">rV</span> <span class="o">&lt;</span> <span class="n">rDisconnectedBoundary</span> <span class="n">THEN</span>
    <span class="n">PG</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">GaugeDisconnected</span><span class="p">;</span> <span class="o">//</span><span class="ow">not</span> <span class="n">on</span>
    <span class="n">PG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">:=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">PG</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">PressInvalid</span><span class="p">;</span> <span class="o">//</span><span class="n">other</span> <span class="n">fault</span> <span class="o">-</span> <span class="n">could</span> <span class="n">be</span> <span class="n">no</span> <span class="n">gauge</span><span class="p">,</span> <span class="n">controller</span> <span class="n">powering</span> <span class="n">up</span> <span class="n">etc</span>
    <span class="n">PG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">:=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Pressure</span> <span class="n">OK</span> <span class="n">check</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Pressure</span> <span class="n">gauge</span> <span class="n">OK</span> <span class="n">checks</span> <span class="o">*</span><span class="p">)</span>
<span class="n">PG</span><span class="o">.</span><span class="n">xPRESS_OK</span> <span class="o">:=</span> <span class="p">(</span><span class="n">rV</span> <span class="o">&lt;=</span><span class="n">rValidHiBoundary</span> <span class="p">)</span> <span class="n">AND</span> <span class="p">(</span><span class="n">rV</span><span class="o">&gt;=</span><span class="n">rDisconnectedBoundary</span><span class="p">);</span>
<span class="o">//</span><span class="n">PG</span><span class="o">.</span><span class="n">xPRESS_OK</span> <span class="o">:=</span> <span class="p">(</span><span class="n">PG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">&gt;=</span> <span class="n">rMinPressure</span><span class="p">);</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Setpoint</span> <span class="n">evaluation</span> <span class="o">*</span><span class="p">)</span>
<span class="n">PG</span><span class="o">.</span><span class="n">xAT_VAC</span> <span class="o">:=</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">PG</span><span class="o">.</span><span class="n">eState</span> <span class="o">=</span><span class="n">Valid</span><span class="p">)</span><span class="o">*</span><span class="p">)</span> <span class="n">PG</span><span class="o">.</span><span class="n">xPRESS_OK</span> <span class="n">AND</span> <span class="n">PG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">&lt;=</span> <span class="n">PG</span><span class="o">.</span><span class="n">rVAC_SP</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span><span class="n">Logger</span><span class="o">*</span><span class="p">)</span>
<span class="n">ACT_Logger</span><span class="p">();</span>

<span class="p">(</span><span class="o">*</span><span class="n">soft</span> <span class="n">io</span><span class="o">*</span><span class="p">)</span>
<span class="n">IO</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>
<span class="n">ACTION</span> <span class="n">ACT_Logger</span><span class="p">:</span>
<span class="o">//</span><span class="n">STATE</span> <span class="n">Logger</span>
<span class="n">IF</span> <span class="p">(</span><span class="n">PG</span><span class="o">.</span><span class="n">xLog</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">ePrevState</span> <span class="o">&lt;&gt;</span> <span class="n">PG</span><span class="o">.</span><span class="n">eState</span> <span class="n">THEN</span>
              <span class="n">CASE</span> <span class="n">PG</span><span class="o">.</span><span class="n">eState</span> <span class="n">OF</span>
                    <span class="n">ValidHi</span><span class="p">:</span>
                            <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Gauge pressure valid high.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span>
                    <span class="n">ValidLo</span><span class="p">:</span>
                            <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Gauge pressure valid low.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span>
                    <span class="n">Valid</span><span class="p">:</span>
                            <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Gauge pressure valid.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span>
                    <span class="n">GaugeDisconnected</span><span class="p">:</span>
                            <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Gauge Disconnected.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span>
                    <span class="n">PressInvalid</span><span class="p">:</span>
                            <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Gauge pressure invalid.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Warning</span><span class="p">);</span>
                    <span class="n">OoR</span><span class="p">:</span>
                            <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Gauge pressure out of range.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Warning</span><span class="p">);</span>
                    <span class="n">Starting</span><span class="p">:</span>
                            <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Gauge starting.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span>
              <span class="n">END_CASE</span>
              <span class="n">ePrevState</span> <span class="o">:=</span> <span class="n">PG</span><span class="o">.</span><span class="n">eState</span><span class="p">;</span>
      <span class="n">END_IF</span>
 <span class="n">END_IF</span>
<span class="n">END_ACTION</span>
<span class="n">ACTION</span> <span class="n">IO</span><span class="p">:</span>
<span class="n">PG</span><span class="o">.</span><span class="n">i_iPRESS_R</span> <span class="o">:=</span><span class="n">i_iPRESS_R</span><span class="p">;</span>

<span class="n">PG</span><span class="o">.</span><span class="n">sPath</span> <span class="o">:=</span> <span class="n">sPath</span><span class="p">;</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
</div>
<div class="section" id="fb-mks317a">
<h2>FB_MKS317A<a class="headerlink" href="#fb-mks317a" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span><span class="n">Deprecated</span><span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">function</span> <span class="ow">is</span> <span class="k">for</span> <span class="n">the</span> <span class="n">Pirani</span> <span class="n">MKS</span> <span class="mi">317</span> <span class="n">connected</span> <span class="n">to</span> <span class="n">a</span> <span class="mi">937</span><span class="n">A</span><span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">function</span> <span class="n">block</span> <span class="ow">is</span> <span class="n">used</span> <span class="n">to</span> <span class="n">provide</span> <span class="n">protection</span> <span class="ow">and</span> <span class="n">automatic</span> <span class="n">turn</span> <span class="n">on</span> <span class="n">of</span> <span class="n">ion</span> <span class="n">gauges</span><span class="p">,</span>
 <span class="n">it</span> <span class="n">also</span> <span class="n">manages</span> <span class="n">the</span> <span class="n">turn</span> <span class="n">on</span> <span class="n">of</span> <span class="n">the</span> <span class="n">AT_VAC</span> <span class="n">boolean</span><span class="p">,</span> <span class="ow">and</span> <span class="n">checks</span> <span class="n">to</span> <span class="n">make</span> <span class="n">sure</span> <span class="n">the</span> <span class="n">pressure</span> <span class="ow">is</span> <span class="n">good</span> <span class="o">*</span><span class="p">)</span>

<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_MKS317A</span>  <span class="n">Extends</span> <span class="n">FB_GaugeBase</span>
<span class="n">VAR_IN_OUT</span>

<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>

<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span>
    <span class="s1">&#39;}</span>
    <span class="n">PG</span> <span class="p">:</span> <span class="n">ST_VG</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">rV</span>      <span class="p">:</span>       <span class="n">REAL</span><span class="p">;</span>
    <span class="n">rMinPressure</span><span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mf">1E-3</span><span class="p">;</span>
    <span class="n">rDefaultVAC_SP</span><span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span><span class="mf">5E-2</span><span class="p">;</span> <span class="o">//</span> <span class="n">Default</span> <span class="mi">50</span> <span class="n">mT</span>
    <span class="n">rValidLoBoundary</span>        <span class="p">:</span>       <span class="n">REAL</span> <span class="o">:=</span> <span class="mf">0.2</span><span class="p">;</span><span class="o">//</span><span class="n">Manual</span> <span class="n">page</span> <span class="mi">61</span>
    <span class="n">rValidHiBoundary</span>        <span class="p">:</span>       <span class="n">REAL</span> <span class="o">:=</span> <span class="mf">9.7</span><span class="p">;</span> <span class="o">//</span><span class="n">manual</span> <span class="n">oage</span> <span class="mi">61</span>
    <span class="n">rDisconnectedBoundary</span>   <span class="p">:</span>       <span class="n">REAL</span> <span class="o">:=</span> <span class="mf">0.17</span><span class="p">;</span>
    <span class="n">rNoSensorBoundary</span>       <span class="p">:</span>       <span class="n">REAL</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="p">(</span><span class="o">*</span><span class="n">IO</span><span class="o">*</span><span class="p">)</span>
    <span class="n">i_iPRESS_R</span> <span class="n">AT</span><span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span><span class="n">INT</span><span class="p">;</span> <span class="o">//</span> <span class="nb">input</span> <span class="n">Pressure</span> <span class="o">//</span> <span class="n">Link</span> <span class="n">to</span> <span class="n">analog</span> <span class="n">Input</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="mi">937</span><span class="n">B</span> <span class="n">Logarithmic</span> <span class="n">Output</span> <span class="n">Conversion</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="mi">5</span><span class="o">-</span><span class="mi">20</span><span class="o">-</span><span class="mi">2016</span><span class="p">,</span> <span class="n">Alex</span> <span class="n">Wallace</span> <span class="ow">and</span> <span class="n">Scott</span> <span class="n">Stubbs</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="mi">09</span><span class="o">-</span><span class="mi">28</span><span class="o">-</span><span class="mi">2018</span><span class="p">,</span> <span class="n">Margaret</span> <span class="n">Ghaly</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">function</span> <span class="n">will</span> <span class="n">read</span> <span class="n">the</span> <span class="n">pressure</span> <span class="kn">from</span> <span class="nn">any</span> <span class="n">gauge</span> <span class="n">on</span> <span class="n">a</span> <span class="mi">937</span><span class="n">A</span><span class="o">.</span> <span class="o">*</span><span class="p">)</span>

<span class="n">rV</span> <span class="o">:=</span> <span class="mi">10</span><span class="o">*</span><span class="n">INT_TO_REAL</span><span class="p">(</span><span class="n">PG</span><span class="o">.</span><span class="n">i_iPRESS_R</span><span class="p">)</span><span class="o">/</span><span class="mi">32767</span><span class="p">;</span>
<span class="n">PG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">:=</span> <span class="n">LREAL_TO_REAL</span><span class="p">(</span><span class="n">EXPT</span><span class="p">(</span><span class="mi">10</span><span class="p">,((</span><span class="n">rV</span><span class="p">)</span><span class="o">/</span><span class="mf">0.6</span><span class="p">)</span><span class="o">-</span><span class="mi">12</span><span class="p">));</span> <span class="o">//</span><span class="n">manual</span> <span class="n">page</span> <span class="mi">61</span> <span class="mi">937</span><span class="n">A</span>


<span class="o">//</span><span class="n">Default</span> <span class="n">setpoint</span>
<span class="n">IF</span> <span class="n">PG</span><span class="o">.</span><span class="n">rVAC_SP</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">PG</span><span class="o">.</span><span class="n">rVAC_SP</span> <span class="o">:=</span> <span class="n">rDefaultVAC_SP</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="p">(</span><span class="n">rV</span> <span class="o">&lt;=</span><span class="mf">9.7</span> <span class="p">)</span> <span class="n">AND</span> <span class="p">(</span><span class="n">rV</span><span class="o">&gt;=</span><span class="mf">0.6</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">PG</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">Valid</span><span class="p">;</span> <span class="o">//</span> <span class="n">normal</span>
<span class="n">ELSIF</span> <span class="n">rV</span> <span class="o">&gt;=</span> <span class="mf">0.18</span> <span class="n">AND</span> <span class="n">rV</span> <span class="o">&lt;=</span> <span class="mf">0.22</span> <span class="n">THEN</span>
    <span class="n">PG</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">ValidLo</span><span class="p">;</span> <span class="o">//</span><span class="n">LO</span>
    <span class="n">PG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">:=</span> <span class="n">rMinPressure</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">rV</span> <span class="o">&gt;</span> <span class="mf">9.7</span> <span class="n">AND</span> <span class="n">rV</span><span class="o">&lt;=</span> <span class="mf">9.9</span> <span class="n">THEN</span>
    <span class="n">PG</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">ValidHi</span><span class="p">;</span> <span class="o">//</span><span class="n">HIGH</span>
<span class="n">ELSIF</span> <span class="n">rV</span> <span class="o">&lt;</span> <span class="mf">0.18</span> <span class="n">THEN</span>
    <span class="n">PG</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">GaugeDisconnected</span><span class="p">;</span> <span class="o">//</span><span class="ow">not</span> <span class="n">on</span>
    <span class="n">PG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">:=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">PG</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">PressInvalid</span><span class="p">;</span> <span class="o">//</span><span class="n">other</span> <span class="n">fault</span> <span class="o">-</span> <span class="n">could</span> <span class="n">be</span> <span class="n">no</span> <span class="n">gauge</span><span class="p">,</span> <span class="n">controller</span> <span class="n">powering</span> <span class="n">up</span> <span class="n">etc</span>
    <span class="n">PG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">:=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Pressure</span> <span class="n">OK</span> <span class="n">check</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Pressure</span> <span class="n">gauge</span> <span class="n">OK</span> <span class="n">checks</span> <span class="o">*</span><span class="p">)</span>
<span class="n">PG</span><span class="o">.</span><span class="n">xPRESS_OK</span> <span class="o">:=</span> <span class="p">(</span><span class="n">rV</span> <span class="o">&lt;=</span><span class="n">rValidHiBoundary</span> <span class="p">)</span> <span class="n">AND</span> <span class="p">(</span><span class="n">rV</span><span class="o">&gt;=</span><span class="n">rDisconnectedBoundary</span><span class="p">);</span>
<span class="o">//</span><span class="n">PG</span><span class="o">.</span><span class="n">xPRESS_OK</span> <span class="o">:=</span> <span class="p">(</span><span class="n">PG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">&gt;=</span> <span class="n">rMinPressure</span><span class="p">);</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Setpoint</span> <span class="n">evaluation</span> <span class="o">*</span><span class="p">)</span>
<span class="n">PG</span><span class="o">.</span><span class="n">xAT_VAC</span> <span class="o">:=</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">PG</span><span class="o">.</span><span class="n">eState</span> <span class="o">=</span><span class="n">Valid</span><span class="p">)</span><span class="o">*</span><span class="p">)</span> <span class="n">PG</span><span class="o">.</span><span class="n">xPRESS_OK</span> <span class="n">AND</span> <span class="n">PG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">&lt;=</span> <span class="n">PG</span><span class="o">.</span><span class="n">rVAC_SP</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span><span class="n">Logger</span><span class="o">*</span><span class="p">)</span>
<span class="n">ACT_Logger</span><span class="p">();</span>
<span class="p">(</span><span class="o">*</span><span class="n">soft</span> <span class="n">io</span><span class="o">*</span><span class="p">)</span>
<span class="n">IO</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>
<span class="n">ACTION</span> <span class="n">ACT_Logger</span><span class="p">:</span>
<span class="n">IF</span> <span class="p">(</span><span class="n">PG</span><span class="o">.</span><span class="n">xLog</span><span class="p">)</span> <span class="n">THEN</span>
<span class="o">//</span><span class="n">STATE</span> <span class="n">Logger</span>
<span class="n">IF</span> <span class="n">ePrevState</span> <span class="o">&lt;&gt;</span> <span class="n">PG</span><span class="o">.</span><span class="n">eState</span> <span class="n">THEN</span>
      <span class="n">CASE</span> <span class="n">PG</span><span class="o">.</span><span class="n">eState</span> <span class="n">OF</span>
            <span class="n">ValidHi</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Gauge pressure valid high.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span>
            <span class="n">ValidLo</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Gauge pressure valid low.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span>
            <span class="n">Valid</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Gauge pressure valid.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span>
            <span class="n">GaugeDisconnected</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Gauge Disconnected.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span>
            <span class="n">PressInvalid</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Gauge pressure invalid.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Warning</span><span class="p">);</span>
            <span class="n">OoR</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Gauge pressure out of range.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Warning</span><span class="p">);</span>
            <span class="n">Starting</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Gauge starting.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span>
      <span class="n">END_CASE</span>
      <span class="n">ePrevState</span> <span class="o">:=</span> <span class="n">PG</span><span class="o">.</span><span class="n">eState</span><span class="p">;</span>
  <span class="n">END_IF</span>
 <span class="n">END_IF</span>
<span class="n">END_ACTION</span>
<span class="n">ACTION</span> <span class="n">IO</span><span class="p">:</span>
<span class="n">PG</span><span class="o">.</span><span class="n">i_iPRESS_R</span> <span class="o">:=</span><span class="n">i_iPRESS_R</span><span class="p">;</span>
<span class="n">PG</span><span class="o">.</span><span class="n">sPath</span> <span class="o">:=</span> <span class="n">sPath</span><span class="p">;</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
</div>
<div class="section" id="fb-mks392">
<h2>FB_MKS392<a class="headerlink" href="#fb-mks392" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">function</span> <span class="n">block</span> <span class="n">implements</span> <span class="n">the</span> <span class="n">MKS392</span> <span class="n">gauge</span><span class="o">*</span><span class="p">)</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_MKS392</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span>
    <span class="s1">&#39;}</span>
    <span class="n">PG</span> <span class="p">:</span> <span class="n">ST_VG</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">rV</span> <span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>      <span class="o">//</span> <span class="nb">input</span> <span class="n">voltage</span>
    <span class="n">iTermBits</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">32767</span> <span class="p">;</span> <span class="o">//</span> <span class="n">The</span> <span class="n">terminal</span><span class="s1">&#39;s maximum value in bits</span>
    <span class="p">(</span><span class="o">*</span><span class="n">IO</span><span class="o">*</span><span class="p">)</span>
    <span class="n">i_iPRESS_R</span> <span class="n">AT</span><span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span><span class="n">INT</span><span class="p">;</span> <span class="o">//</span> <span class="nb">input</span> <span class="n">Pressure</span> <span class="o">//</span> <span class="n">Link</span> <span class="n">to</span> <span class="n">analog</span> <span class="n">Input</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Real</span><span class="o">-</span><span class="n">value</span> <span class="n">calculation</span> <span class="o">*</span><span class="p">)</span>
<span class="n">rV</span> <span class="o">:=</span> <span class="mi">10</span><span class="o">*</span><span class="n">INT_TO_REAL</span><span class="p">(</span><span class="n">PG</span><span class="o">.</span><span class="n">i_iPRESS_R</span><span class="p">)</span><span class="o">/</span><span class="n">iTermBits</span><span class="p">;</span>
<span class="n">PG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">:=</span> <span class="p">(</span><span class="n">LREAL_TO_REAL</span><span class="p">(</span><span class="n">EXPT</span><span class="p">(</span><span class="mi">10</span><span class="p">,(</span><span class="mi">2</span><span class="o">*</span><span class="n">rV</span><span class="p">)</span><span class="o">-</span><span class="mi">11</span><span class="p">)));</span>


<span class="p">(</span><span class="o">*</span> <span class="n">Pressure</span> <span class="n">gauge</span> <span class="n">State</span> <span class="n">checks</span> <span class="o">*</span><span class="p">)</span>

<span class="n">IF</span> <span class="n">rV</span> <span class="o">&gt;=</span> <span class="mf">0.5</span> <span class="n">AND</span> <span class="n">rV</span> <span class="o">&lt;=</span> <span class="mf">3.5</span> <span class="n">THEN</span>
    <span class="n">PG</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">ValidLo</span><span class="p">;</span> <span class="o">//</span><span class="n">LO</span>
<span class="n">ELSIF</span> <span class="n">rV</span> <span class="o">&gt;</span> <span class="mf">3.5</span> <span class="n">AND</span> <span class="n">rV</span><span class="o">&lt;=</span> <span class="mf">6.5</span> <span class="n">THEN</span>
    <span class="n">PG</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">ValidHi</span><span class="p">;</span> <span class="o">//</span><span class="n">HIGH</span>
<span class="n">ELSIF</span> <span class="n">rV</span> <span class="o">&lt;</span> <span class="mf">0.5</span> <span class="n">THEN</span>
    <span class="n">PG</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">GaugeDisconnected</span><span class="p">;</span> <span class="o">//</span><span class="ow">not</span> <span class="n">on</span>
<span class="n">ELSE</span>
    <span class="n">PG</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">PressInvalid</span><span class="p">;</span> <span class="o">//</span><span class="n">other</span> <span class="n">fault</span> <span class="o">-</span> <span class="n">could</span> <span class="n">be</span> <span class="n">no</span> <span class="n">gauge</span><span class="p">,</span> <span class="n">controller</span> <span class="n">powering</span> <span class="n">up</span> <span class="n">etc</span>
<span class="n">END_IF</span>



<span class="p">(</span><span class="o">*</span> <span class="n">Pressure</span> <span class="n">gauge</span> <span class="n">OK</span> <span class="n">checks</span> <span class="o">*</span><span class="p">)</span>
<span class="n">PG</span><span class="o">.</span><span class="n">xPRESS_OK</span> <span class="o">:=</span> <span class="p">(</span><span class="n">rV</span> <span class="o">&lt;=</span><span class="mf">6.5</span> <span class="p">)</span> <span class="n">AND</span> <span class="p">(</span><span class="n">rV</span><span class="o">&gt;=</span><span class="mf">0.5</span><span class="p">);</span>


<span class="p">(</span><span class="o">*</span> <span class="n">Setpoint</span> <span class="n">evaluation</span> <span class="o">*</span><span class="p">)</span>
<span class="n">PG</span><span class="o">.</span><span class="n">xAT_VAC</span> <span class="o">:=</span> <span class="n">PG</span><span class="o">.</span><span class="n">xPRESS_OK</span> <span class="n">AND</span> <span class="n">PG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">&lt;</span> <span class="n">PG</span><span class="o">.</span><span class="n">rVAC_SP</span><span class="p">;</span>


<span class="p">(</span><span class="o">*</span><span class="n">Soft</span> <span class="n">IO</span> <span class="n">Linking</span><span class="o">*</span><span class="p">)</span>
<span class="n">ACT_IO</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>
<span class="n">ACTION</span> <span class="n">ACT_IO</span><span class="p">:</span>
<span class="n">PG</span><span class="o">.</span><span class="n">i_iPRESS_R</span> <span class="o">:=</span><span class="n">i_iPRESS_R</span><span class="p">;</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
</div>
<div class="section" id="fb-mks422">
<h2>FB_MKS422<a class="headerlink" href="#fb-mks422" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">function</span> <span class="ow">is</span> <span class="k">for</span> <span class="n">the</span> <span class="n">Cold</span> <span class="n">Cathode</span> <span class="n">MKS</span> <span class="mi">422</span> <span class="n">connected</span> <span class="n">to</span> <span class="n">a</span> <span class="mi">937</span><span class="n">A</span><span class="o">/</span><span class="n">B</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span><span class="n">This</span> <span class="n">function</span> <span class="n">provides</span> <span class="n">ILK</span> <span class="ow">and</span> <span class="n">Set</span> <span class="n">Point</span> <span class="n">Protection</span> <span class="k">for</span> <span class="n">the</span> <span class="n">Cold</span> <span class="n">Cathode</span><span class="o">*</span><span class="p">)</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_MKS422</span> <span class="n">EXTENDS</span> <span class="n">FB_GaugeBase</span>
<span class="n">VAR_IN_OUT</span>

<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
            <span class="n">PG</span>      <span class="p">:</span>       <span class="n">ST_VG</span><span class="p">;</span> <span class="o">//</span> <span class="n">Pirani</span> <span class="n">Gauge</span> <span class="n">Structure</span> <span class="n">used</span> <span class="n">to</span> <span class="n">Interlock</span> <span class="n">the</span> <span class="n">Cold</span> <span class="n">Cathode</span>
            <span class="n">b937A</span> <span class="p">:</span><span class="n">BOOL</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span> <span class="o">//</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">this</span> <span class="n">gauge</span> <span class="ow">is</span> <span class="n">connected</span> <span class="n">to</span> <span class="n">MKS937A</span> <span class="n">controller</span><span class="p">,</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">connected</span> <span class="n">to</span> <span class="n">MKS937B</span> <span class="n">controller</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span>
    <span class="s1">&#39;}</span>
    <span class="n">IG</span> <span class="p">:</span> <span class="n">ST_VG</span><span class="p">;</span> <span class="o">//</span> <span class="n">The</span> <span class="n">Cold</span> <span class="n">Cathode</span> <span class="n">Data</span> <span class="n">Structure</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">rV</span>      <span class="p">:</span>       <span class="n">REAL</span><span class="p">;</span>

    <span class="n">timer</span><span class="p">:</span><span class="n">TON</span><span class="p">;</span>
    <span class="p">(</span><span class="o">*</span><span class="n">IOs</span> <span class="n">to</span> <span class="n">be</span> <span class="n">linked</span><span class="o">*</span><span class="p">)</span>
    <span class="o">///</span> <span class="n">Controls</span> <span class="ow">and</span> <span class="n">I</span><span class="o">/</span><span class="n">Os</span>
    <span class="n">i_iPRESS_R</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span><span class="n">INT</span><span class="p">;</span> <span class="o">//</span> <span class="nb">input</span> <span class="n">Pressure</span> <span class="o">//</span> <span class="n">Link</span> <span class="n">to</span> <span class="n">analog</span> <span class="n">Input</span>
    <span class="n">q_xHV_DIS</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span> <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="kc">True</span><span class="p">;</span> <span class="o">//</span> <span class="n">Disable</span> <span class="n">Gauge</span> <span class="n">High</span> <span class="n">Voltage</span> <span class="n">when</span> <span class="kc">True</span> <span class="o">//</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="p">(</span><span class="n">EL2794</span><span class="p">)</span> <span class="o">^</span><span class="n">Output</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span> <span class="n">CONSTANT</span>
    <span class="n">MinPressure</span><span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mf">1E-10</span><span class="p">;</span>
    <span class="n">cDefaultPressure</span> <span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="mi">937</span><span class="n">B</span> <span class="n">Logarithmic</span> <span class="n">Output</span> <span class="n">Conversion</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="mi">5</span><span class="o">-</span><span class="mi">20</span><span class="o">-</span><span class="mi">2016</span><span class="p">,</span> <span class="n">Alex</span> <span class="n">Wallace</span> <span class="ow">and</span> <span class="n">Scott</span> <span class="n">Stubbs</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="mi">09</span><span class="o">-</span><span class="mi">28</span><span class="o">-</span><span class="mi">2018</span><span class="p">,</span> <span class="n">Margaret</span> <span class="n">Ghaly</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">function</span> <span class="n">will</span> <span class="n">read</span> <span class="n">the</span> <span class="n">pressure</span> <span class="kn">from</span> <span class="nn">any</span> <span class="n">gauge</span> <span class="n">on</span> <span class="n">a</span> <span class="mi">937</span><span class="n">B</span><span class="o">.</span> <span class="o">*</span><span class="p">)</span>

<span class="p">(</span><span class="o">*</span><span class="n">Soft</span> <span class="n">IO</span> <span class="n">Linking</span><span class="o">*</span><span class="p">)</span>
<span class="n">IO</span><span class="p">();</span>

<span class="p">(</span><span class="o">*</span><span class="n">Pressure</span> <span class="n">readbacks</span><span class="o">*</span><span class="p">)</span>
<span class="n">rV</span> <span class="o">:=</span> <span class="mi">10</span><span class="o">*</span><span class="n">INT_TO_REAL</span><span class="p">(</span><span class="n">IG</span><span class="o">.</span><span class="n">i_iPRESS_R</span><span class="p">)</span><span class="o">/</span><span class="mi">32767</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">b937A</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">IG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">:=</span> <span class="n">LREAL_TO_REAL</span><span class="p">(</span><span class="n">EXPT</span><span class="p">(</span><span class="mi">10</span><span class="p">,((</span><span class="n">rV</span><span class="p">)</span><span class="o">/</span><span class="mf">0.6</span><span class="p">)</span><span class="o">-</span><span class="mi">12</span><span class="p">));</span> <span class="o">//</span><span class="n">manual</span> <span class="n">page</span> <span class="mi">61</span> <span class="n">MKS937A</span>
    <span class="n">ELSE</span>
    <span class="n">IG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">:=</span> <span class="n">LREAL_TO_REAL</span><span class="p">(</span><span class="n">EXPT</span><span class="p">(</span><span class="mi">10</span><span class="p">,(</span><span class="n">rV</span><span class="o">-</span><span class="mf">7.2</span><span class="p">)</span><span class="o">/</span><span class="mf">0.6</span><span class="p">));</span>      <span class="o">//</span><span class="n">manual</span> <span class="n">page</span> <span class="mi">73</span> <span class="n">MKS937B</span>
<span class="n">END_IF</span>



<span class="p">(</span><span class="o">*</span> <span class="n">Pressure</span> <span class="n">gauge</span> <span class="n">State</span> <span class="n">checks</span> <span class="o">*</span><span class="p">)</span>
<span class="n">IF</span> <span class="p">(</span><span class="n">rV</span> <span class="o">&lt;=</span><span class="mf">9.6</span> <span class="p">)</span> <span class="n">AND</span> <span class="p">(</span><span class="n">rV</span><span class="o">&gt;=</span><span class="mf">0.6</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">IG</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">Valid</span><span class="p">;</span> <span class="o">//</span> <span class="n">normal</span>
<span class="n">ELSIF</span> <span class="n">rV</span> <span class="o">&gt;=</span> <span class="mf">0.18</span> <span class="n">AND</span> <span class="n">rV</span> <span class="o">&lt;=</span> <span class="mf">0.22</span> <span class="n">THEN</span>
    <span class="n">IG</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">ValidLo</span><span class="p">;</span> <span class="o">//</span><span class="n">LO</span>
<span class="n">ELSIF</span> <span class="n">rV</span> <span class="o">&gt;</span> <span class="mf">9.6</span> <span class="n">AND</span> <span class="n">rV</span><span class="o">&lt;=</span> <span class="mf">9.9</span> <span class="n">THEN</span>
    <span class="n">IG</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">ValidHi</span><span class="p">;</span> <span class="o">//</span><span class="n">HIGH</span>
<span class="n">ELSIF</span> <span class="n">rV</span> <span class="o">&lt;</span> <span class="mf">0.18</span> <span class="n">THEN</span> <span class="o">//</span>
    <span class="n">IG</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">GaugeDisconnected</span><span class="p">;</span> <span class="o">//</span><span class="ow">not</span> <span class="n">on</span>
    <span class="n">IG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">:=</span><span class="n">cDefaultPressure</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">IG</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">PressInvalid</span><span class="p">;</span> <span class="o">//</span><span class="n">other</span> <span class="n">fault</span> <span class="o">-</span> <span class="n">could</span> <span class="n">be</span> <span class="n">no</span> <span class="n">gauge</span><span class="p">,</span> <span class="n">controller</span> <span class="n">powering</span> <span class="n">up</span> <span class="n">etc</span>
    <span class="n">IG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">:=</span><span class="n">cDefaultPressure</span><span class="p">;</span>
<span class="n">END_IF</span>


<span class="p">(</span><span class="o">*</span> <span class="n">Ion</span> <span class="n">Gauge</span> <span class="n">Protection</span> <span class="n">Functions</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">If</span> <span class="n">the</span> <span class="n">PG</span> <span class="n">pressure</span> <span class="ow">is</span> <span class="n">greater</span> <span class="n">than</span> <span class="n">the</span> <span class="n">VG</span><span class="o">.</span><span class="n">PRO_SP</span> <span class="n">then</span> <span class="n">the</span> <span class="n">gauge</span> <span class="ow">is</span> <span class="n">disabled</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">If</span> <span class="n">the</span> <span class="n">PG</span> <span class="n">pressure</span> <span class="ow">is</span> <span class="n">less</span> <span class="n">than</span> <span class="n">the</span> <span class="n">VG</span><span class="o">.</span><span class="n">PRO_SP</span> <span class="n">then</span> <span class="n">the</span> <span class="n">gauge</span> <span class="ow">is</span> <span class="n">enabled</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">FB</span> <span class="n">also</span> <span class="n">implements</span> <span class="n">some</span> <span class="n">hysteresis</span> <span class="n">so</span> <span class="n">the</span> <span class="n">gauge</span> <span class="n">doesn</span><span class="s1">&#39;t have rapid power cycling while near the turn on boundary *)</span>

    <span class="n">IF</span> <span class="p">(</span><span class="n">PG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">&lt;=</span> <span class="n">IG</span><span class="o">.</span><span class="n">rPRO_SP</span><span class="p">)</span> <span class="n">THEN</span>
             <span class="n">IG</span><span class="o">.</span><span class="n">q_xHV_DIS</span> <span class="o">:=</span> <span class="n">NOT</span> <span class="n">IG</span><span class="o">.</span><span class="n">xHV_SW</span><span class="p">;</span>
             <span class="n">IG</span><span class="o">.</span><span class="n">xILKOk</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">ELSIF</span> <span class="n">NOT</span> <span class="n">IG</span><span class="o">.</span><span class="n">q_xHV_DIS</span> <span class="n">AND</span> <span class="n">timer</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
            <span class="n">IF</span> <span class="n">IG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">IG</span><span class="o">.</span><span class="n">rPRO_SP</span> <span class="o">+</span> <span class="n">IG</span><span class="o">.</span><span class="n">rHYS_PR</span><span class="p">)</span> <span class="n">OR</span> <span class="n">PG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">IG</span><span class="o">.</span><span class="n">rPRO_SP</span> <span class="o">+</span> <span class="n">IG</span><span class="o">.</span><span class="n">rHYS_PR</span><span class="p">)</span> <span class="n">THEN</span>
            <span class="n">IG</span><span class="o">.</span><span class="n">q_xHV_DIS</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
            <span class="n">IG</span><span class="o">.</span><span class="n">xHV_SW</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="n">END_IF</span>
    <span class="n">ELSE</span>
            <span class="n">IG</span><span class="o">.</span><span class="n">q_xHV_DIS</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
            <span class="n">IG</span><span class="o">.</span><span class="n">xHV_SW</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="n">IG</span><span class="o">.</span><span class="n">xILKOk</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">END_IF</span>




<span class="p">(</span><span class="o">*</span> <span class="n">Pressure</span> <span class="n">gauge</span> <span class="n">OK</span> <span class="n">checks</span> <span class="o">*</span><span class="p">)</span>
<span class="n">IG</span><span class="o">.</span><span class="n">xPRESS_OK</span> <span class="o">:=</span> <span class="p">(</span><span class="n">rV</span> <span class="o">&lt;=</span><span class="mf">9.6</span> <span class="p">)</span> <span class="n">AND</span> <span class="p">(</span><span class="n">rV</span><span class="o">&gt;=</span><span class="mf">0.6</span><span class="p">);</span>


<span class="p">(</span><span class="o">*</span> <span class="n">Setpoint</span> <span class="n">evaluation</span> <span class="o">*</span><span class="p">)</span>
<span class="n">IG</span><span class="o">.</span><span class="n">xAT_VAC</span> <span class="o">:=</span> <span class="n">IG</span><span class="o">.</span><span class="n">xPRESS_OK</span> <span class="n">AND</span> <span class="n">IG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">&lt;</span> <span class="n">IG</span><span class="o">.</span><span class="n">rVAC_SP</span><span class="p">;</span>


<span class="p">(</span><span class="o">*</span><span class="n">Logger</span><span class="o">*</span><span class="p">)</span>
<span class="n">ACT_Logger</span><span class="p">();</span>
<span class="p">(</span><span class="o">*</span><span class="n">Soft</span> <span class="n">IO</span> <span class="n">Linking</span><span class="o">*</span><span class="p">)</span>
<span class="o">//</span> <span class="n">check</span> <span class="n">ethercat</span> <span class="n">Diagnostics</span>
<span class="n">IO</span><span class="p">();</span>

<span class="n">timer</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span> <span class="n">NOT</span> <span class="n">IG</span><span class="o">.</span><span class="n">q_xHV_DIS</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span> <span class="n">T</span><span class="c1">#2s);</span>

<span class="n">END_FUNCTION_BLOCK</span>
<span class="n">ACTION</span> <span class="n">ACT_Logger</span><span class="p">:</span>
<span class="o">//</span> <span class="n">ILK</span> <span class="n">logger</span>
<span class="n">IF</span> <span class="p">(</span><span class="n">IG</span><span class="o">.</span><span class="n">xLog</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">IG</span><span class="o">.</span><span class="n">xILKOk</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">IG</span><span class="o">.</span><span class="n">q_xHV_DIS</span> <span class="n">THEN</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Lost external interlock while gauge was on.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span>
    <span class="n">END_IF</span>


    <span class="o">//</span> <span class="n">Log</span> <span class="n">Action</span>
    <span class="n">tAction</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span>  <span class="n">IG</span><span class="o">.</span><span class="n">xHV_SW</span><span class="p">);</span>
    <span class="n">IF</span> <span class="n">tAction</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span> <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Ion gauge commanded to switch on&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span> <span class="n">END_IF</span>



    <span class="o">//</span><span class="n">STATE</span> <span class="n">Logger</span>
    <span class="n">IF</span> <span class="n">ePrevState</span> <span class="o">&lt;&gt;</span> <span class="n">IG</span><span class="o">.</span><span class="n">eState</span> <span class="n">THEN</span>
              <span class="n">CASE</span> <span class="n">IG</span><span class="o">.</span><span class="n">eState</span> <span class="n">OF</span>
                    <span class="n">ValidHi</span><span class="p">:</span>
                            <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Gauge pressure valid high.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span>
                    <span class="n">ValidLo</span><span class="p">:</span>
                            <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Gauge pressure valid low.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span>
                    <span class="n">Valid</span><span class="p">:</span>
                            <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Gauge pressure valid.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span>
                    <span class="n">GaugeDisconnected</span><span class="p">:</span>
                            <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Gauge Disconnected.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span>
                    <span class="n">PressInvalid</span><span class="p">:</span>
                            <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Gauge pressure invalid.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Warning</span><span class="p">);</span>
                    <span class="n">OoR</span><span class="p">:</span>
                            <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Gauge pressure out of range.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Warning</span><span class="p">);</span>
                    <span class="n">Starting</span><span class="p">:</span>
                            <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Gauge starting.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span>
              <span class="n">END_CASE</span>
              <span class="n">ePrevState</span> <span class="o">:=</span> <span class="n">IG</span><span class="o">.</span><span class="n">eState</span><span class="p">;</span>
      <span class="n">END_IF</span>
<span class="n">END_IF</span>
<span class="n">END_ACTION</span>
<span class="n">ACTION</span> <span class="n">IO</span><span class="p">:</span>
<span class="p">(</span><span class="o">*</span><span class="n">soft</span> <span class="n">link</span> <span class="n">inputs</span><span class="o">*</span><span class="p">)</span>
<span class="n">IG</span><span class="o">.</span><span class="n">i_iPRESS_R</span><span class="o">:=</span>     <span class="n">i_iPRESS_R</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span><span class="n">soft</span> <span class="n">link</span> <span class="n">outputs</span><span class="o">*</span><span class="p">)</span>
<span class="n">q_xHV_DIS</span> <span class="o">:=</span> <span class="n">IG</span><span class="o">.</span><span class="n">q_xHV_DIS</span><span class="p">;</span>

<span class="n">IG</span><span class="o">.</span><span class="n">sPath</span> <span class="o">:=</span> <span class="n">sPath</span><span class="p">;</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
</div>
<div class="section" id="fb-mks500">
<h2>FB_MKS500<a class="headerlink" href="#fb-mks500" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">function</span> <span class="ow">is</span> <span class="k">for</span> <span class="n">the</span> <span class="n">Cold</span> <span class="n">Cathode</span> <span class="n">MKS</span> <span class="mf">500.</span> <span class="n">If</span> <span class="n">connected</span> <span class="n">to</span> <span class="n">Beckhoff</span> <span class="n">EP</span> <span class="n">boxes</span><span class="o">.</span>
<span class="n">Set</span> <span class="n">the</span> <span class="n">EP</span> <span class="n">bit</span> <span class="n">to</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">this</span> <span class="ow">is</span> <span class="n">necessary</span> <span class="k">for</span> <span class="n">the</span> <span class="n">MKS500</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">EP</span> <span class="n">box</span> <span class="n">interface</span> <span class="n">beacuse</span> <span class="n">the</span> <span class="n">EP</span>
<span class="n">boxes</span> <span class="n">do</span> <span class="ow">not</span> <span class="n">natively</span> <span class="n">support</span> <span class="n">the</span> <span class="mi">5</span><span class="n">v</span> <span class="n">IO</span> <span class="n">signals</span> <span class="n">on</span> <span class="n">the</span> <span class="n">MKS500</span> <span class="n">gauge</span><span class="o">.*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span><span class="n">This</span> <span class="n">function</span> <span class="n">provides</span> <span class="n">ILK</span> <span class="ow">and</span> <span class="n">Set</span> <span class="n">Point</span> <span class="n">Protection</span> <span class="k">for</span> <span class="n">the</span> <span class="n">Cold</span> <span class="n">Cathode</span><span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="mi">500</span> <span class="n">Logarithmic</span> <span class="n">Output</span> <span class="n">Conversion</span><span class="p">,</span> <span class="n">factory</span> <span class="n">default</span> <span class="n">configuration</span> <span class="o">*</span><span class="p">)</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_MKS500</span> <span class="n">EXTENDS</span> <span class="n">FB_GaugeBase</span>
<span class="n">VAR_IN_OUT</span>

<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">PG</span>      <span class="p">:</span>       <span class="n">ST_VG</span><span class="p">;</span>
    <span class="n">bEP</span> <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span> <span class="o">//</span> <span class="n">Set</span> <span class="n">to</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">This</span> <span class="n">Gauge</span> <span class="ow">is</span> <span class="n">connected</span> <span class="n">to</span> <span class="n">EP</span> <span class="n">BOX</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">EL</span> <span class="n">Terminals</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span>
    <span class="s1">&#39;}</span>
    <span class="n">IG</span> <span class="p">:</span> <span class="n">ST_VG</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">rV</span> <span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
    <span class="n">GaugeTurnOnTmr</span> <span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">iTermBits</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">32767</span> <span class="p">;</span> <span class="o">//</span> <span class="n">The</span> <span class="n">terminal</span><span class="s1">&#39;s maximum value in bits</span>
    <span class="p">(</span><span class="o">*</span><span class="n">IOs</span> <span class="n">to</span> <span class="n">be</span> <span class="n">linked</span><span class="o">*</span><span class="p">)</span>
    <span class="o">///</span> <span class="n">Controls</span> <span class="ow">and</span> <span class="n">I</span><span class="o">/</span><span class="n">Os</span>
    <span class="n">i_iPRESS_R</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span><span class="n">INT</span><span class="p">;</span> <span class="o">//</span> <span class="nb">input</span> <span class="n">Pressure</span> <span class="o">//</span> <span class="n">Link</span> <span class="n">to</span> <span class="n">analog</span> <span class="n">Input</span>
    <span class="n">q_xHV_DIS</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Enable</span> <span class="n">High</span> <span class="n">Voltage</span> <span class="n">when</span> <span class="kc">True</span> <span class="o">//</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="p">(</span><span class="n">EP2624</span><span class="p">)</span> <span class="o">^</span><span class="n">Output</span>
    <span class="o">//</span> <span class="n">only</span> <span class="k">for</span> <span class="n">EL</span> <span class="ow">and</span> <span class="n">ES</span> <span class="n">terminal</span>
    <span class="n">i_xHV_ON</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span>  <span class="kc">True</span> <span class="n">when</span> <span class="n">High</span> <span class="n">Voltage</span> <span class="ow">is</span> <span class="n">on</span>  <span class="o">//</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="p">(</span><span class="n">EL1124</span><span class="p">)</span> <span class="o">^</span><span class="n">Input</span>
    <span class="n">i_xDisc_Active</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span><span class="o">//</span> <span class="n">Discharge</span> <span class="n">Current</span> <span class="n">Active</span> <span class="o">//</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="p">(</span><span class="n">EL1124</span><span class="p">)</span> <span class="o">^</span><span class="n">Input</span>

<span class="n">END_VAR</span>

<span class="n">VAR</span> <span class="n">CONSTANT</span>
    <span class="o">//</span> <span class="n">Ranges</span> <span class="n">has</span> <span class="n">to</span> <span class="n">match</span> <span class="n">the</span> <span class="n">configurator</span> <span class="n">software</span>
    <span class="n">pBase</span> <span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span><span class="mf">1.0E-10</span><span class="p">;</span><span class="o">//</span><span class="n">default</span> <span class="n">curve</span> <span class="n">base</span> <span class="n">pressure</span> <span class="ow">is</span> <span class="mf">1E-10</span><span class="o">.</span> <span class="n">Confusing</span> <span class="n">since</span> <span class="n">can</span><span class="s1">&#39;t actually read that low using analog out.</span>
    <span class="n">vBase</span> <span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">vDisconnected</span> <span class="p">:</span> <span class="n">REAL</span><span class="o">:=</span> <span class="mf">0.5</span><span class="p">;</span>
    <span class="n">vSlope</span> <span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mf">1.0</span><span class="p">;</span>
    <span class="n">vGaugeOff</span><span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mf">9.8</span><span class="p">;</span>
    <span class="n">vNoDischarge</span><span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mf">9.3</span><span class="p">;</span>
    <span class="n">MinPressure</span><span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mf">1E-10</span><span class="p">;</span>
    <span class="n">cDefaultPressure</span> <span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">rDeadband</span> <span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span><span class="mf">0.3</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="mi">500</span> <span class="n">Logarithmic</span> <span class="n">Output</span> <span class="n">Conversion</span><span class="p">,</span> <span class="n">factory</span> <span class="n">default</span> <span class="n">configuration</span> <span class="o">*</span><span class="p">)</span>
<span class="n">If</span> <span class="p">(</span><span class="n">iTermBits</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="n">THEN</span> <span class="n">iTermBits</span> <span class="o">:=</span> <span class="mi">32767</span><span class="p">;</span><span class="n">END_IF</span>
<span class="n">rV</span> <span class="o">:=</span> <span class="mi">10</span><span class="o">*</span><span class="n">INT_TO_REAL</span><span class="p">(</span><span class="n">IG</span><span class="o">.</span><span class="n">i_iPRESS_R</span><span class="p">)</span><span class="o">/</span><span class="n">iTermBits</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Set</span> <span class="n">Guage</span> <span class="n">State</span> <span class="n">based</span> <span class="n">on</span> <span class="n">the</span> <span class="n">Analog</span> <span class="n">voltage</span><span class="o">*</span><span class="p">)</span>
<span class="n">IF</span> <span class="n">rV</span> <span class="o">&lt;</span> <span class="n">vDisconnected</span> <span class="n">THEN</span>
    <span class="n">IG</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">GaugeDisconnected</span><span class="p">;</span>
    <span class="n">IG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">:=</span> <span class="n">cDefaultPressure</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">rV</span> <span class="o">&gt;=</span> <span class="n">vDisconnected</span> <span class="n">AND</span> <span class="n">rV</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">vNoDischarge</span> <span class="o">-</span><span class="n">rDeadband</span><span class="p">)</span>  <span class="n">THEN</span>
    <span class="n">IG</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">Valid</span><span class="p">;</span>
    <span class="n">IG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">:=</span> <span class="n">LREAL_TO_REAL</span><span class="p">(</span><span class="n">EXPT</span><span class="p">(</span><span class="mi">10</span><span class="p">,((</span><span class="n">rV</span><span class="o">-</span><span class="n">vBase</span><span class="p">)</span><span class="o">/</span><span class="n">vSlope</span><span class="o">+</span><span class="n">LOG</span><span class="p">(</span><span class="n">pBase</span><span class="p">))));</span>
<span class="n">ELSIF</span> <span class="n">rV</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">vNoDischarge</span> <span class="o">-</span><span class="n">rDeadband</span><span class="p">)</span> <span class="n">AND</span> <span class="n">rV</span> <span class="o">&lt;</span><span class="p">(</span><span class="n">vGaugeOff</span> <span class="o">-</span><span class="n">rDeadband</span><span class="p">)</span>   <span class="n">THEN</span>
    <span class="n">IG</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">Starting</span><span class="p">;</span>
    <span class="n">IG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">:=</span> <span class="n">LREAL_TO_REAL</span><span class="p">(</span><span class="n">EXPT</span><span class="p">(</span><span class="mi">10</span><span class="p">,((</span><span class="n">rV</span><span class="o">-</span><span class="n">vBase</span><span class="p">)</span><span class="o">/</span><span class="n">vSlope</span><span class="o">+</span><span class="n">LOG</span><span class="p">(</span><span class="n">pBase</span><span class="p">))));</span>
<span class="n">ELSIF</span> <span class="n">rV</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">vGaugeOff</span> <span class="o">-</span><span class="n">rDeadband</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">IG</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">Off</span><span class="p">;</span>
    <span class="o">//</span><span class="n">IG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">:=</span> <span class="n">LREAL_TO_REAL</span><span class="p">(</span><span class="n">EXPT</span><span class="p">(</span><span class="mi">10</span><span class="p">,((</span><span class="n">rV</span><span class="o">-</span><span class="n">vBase</span><span class="p">)</span><span class="o">/</span><span class="n">vSlope</span><span class="o">+</span><span class="n">LOG</span><span class="p">(</span><span class="n">pBase</span><span class="p">))));</span>
    <span class="n">IG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">:=</span> <span class="n">cDefaultPressure</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">IG</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">OoR</span><span class="p">;</span>
    <span class="o">//</span><span class="n">IG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">:=</span> <span class="n">LREAL_TO_REAL</span><span class="p">(</span><span class="n">EXPT</span><span class="p">(</span><span class="mi">10</span><span class="p">,((</span><span class="n">rV</span><span class="o">-</span><span class="n">vBase</span><span class="p">)</span><span class="o">/</span><span class="n">vSlope</span><span class="o">+</span><span class="n">LOG</span><span class="p">(</span><span class="n">pBase</span><span class="p">))));</span>
    <span class="n">IG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">:=</span> <span class="n">cDefaultPressure</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Set</span> <span class="n">Guage</span> <span class="n">State</span> <span class="n">based</span> <span class="n">on</span> <span class="n">the</span> <span class="n">inputs</span> <span class="n">HV</span> <span class="n">ON</span> <span class="ow">and</span> <span class="n">Discharge</span> <span class="n">current</span><span class="o">*</span><span class="p">)</span>
<span class="n">If</span> <span class="p">(</span><span class="n">NOT</span> <span class="n">bEP</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">IG</span><span class="o">.</span><span class="n">i_xHV_ON</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">IG</span><span class="o">.</span><span class="n">i_xDisc_Active</span> <span class="n">THEN</span>
            <span class="n">IG</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">Starting</span><span class="p">;</span>
            <span class="n">IG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">:=</span> <span class="n">LREAL_TO_REAL</span><span class="p">(</span><span class="n">EXPT</span><span class="p">(</span><span class="mi">10</span><span class="p">,((</span><span class="n">rV</span><span class="o">-</span><span class="n">vBase</span><span class="p">)</span><span class="o">/</span><span class="n">vSlope</span><span class="o">+</span><span class="n">LOG</span><span class="p">(</span><span class="n">pBase</span><span class="p">))));</span>
    <span class="n">ELSIF</span> <span class="n">IG</span><span class="o">.</span><span class="n">i_xHV_ON</span> <span class="n">AND</span> <span class="n">IG</span><span class="o">.</span><span class="n">i_xDisc_Active</span> <span class="n">THEN</span>
            <span class="n">IG</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">Valid</span><span class="p">;</span>
            <span class="n">IG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">:=</span> <span class="n">LREAL_TO_REAL</span><span class="p">(</span><span class="n">EXPT</span><span class="p">(</span><span class="mi">10</span><span class="p">,((</span><span class="n">rV</span><span class="o">-</span><span class="n">vBase</span><span class="p">)</span><span class="o">/</span><span class="n">vSlope</span><span class="o">+</span><span class="n">LOG</span><span class="p">(</span><span class="n">pBase</span><span class="p">))));</span>
    <span class="n">ELSIF</span> <span class="n">NOT</span> <span class="n">IG</span><span class="o">.</span><span class="n">i_xHV_ON</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">IG</span><span class="o">.</span><span class="n">i_xDisc_Active</span> <span class="n">THEN</span>
            <span class="n">IG</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">Off</span><span class="p">;</span>
            <span class="n">IG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">:=</span> <span class="n">cDefaultPressure</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Ion</span> <span class="n">Gauge</span> <span class="n">Protection</span> <span class="n">Functions</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">If</span> <span class="n">the</span> <span class="n">PG</span> <span class="n">pressure</span> <span class="ow">is</span> <span class="n">greater</span> <span class="n">than</span> <span class="n">the</span> <span class="n">VG</span><span class="o">.</span><span class="n">PRO_SP</span> <span class="n">then</span> <span class="n">the</span> <span class="n">gauge</span> <span class="ow">is</span> <span class="n">disabled</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">If</span> <span class="n">the</span> <span class="n">PG</span> <span class="n">pressure</span> <span class="ow">is</span> <span class="n">less</span> <span class="n">than</span> <span class="n">the</span> <span class="n">VG</span><span class="o">.</span><span class="n">PRO_SP</span> <span class="n">then</span> <span class="n">the</span> <span class="n">gauge</span> <span class="ow">is</span> <span class="n">enabled</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">FB</span> <span class="n">also</span> <span class="n">implements</span> <span class="n">some</span> <span class="n">hysteresis</span> <span class="n">so</span> <span class="n">the</span> <span class="n">gauge</span> <span class="n">doesn</span><span class="s1">&#39;t have rapid power cycling while near the turn on boundary *)</span>


<span class="n">IF</span> <span class="n">PG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">&lt;=</span> <span class="n">IG</span><span class="o">.</span><span class="n">rPRO_SP</span> <span class="n">AND</span> <span class="n">PG</span><span class="o">.</span><span class="n">xPRESS_OK</span> <span class="n">THEN</span>
    <span class="n">IG</span><span class="o">.</span><span class="n">q_xHV_DIS</span> <span class="o">:=</span> <span class="n">IG</span><span class="o">.</span><span class="n">xHV_SW</span><span class="p">;</span>
    <span class="n">IG</span><span class="o">.</span><span class="n">xILKOk</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">IG</span><span class="o">.</span><span class="n">q_xHV_DIS</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">IG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">IG</span><span class="o">.</span><span class="n">rPRO_SP</span> <span class="o">+</span> <span class="n">IG</span><span class="o">.</span><span class="n">rHYS_PR</span><span class="p">)</span>  <span class="n">OR</span> <span class="n">PG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">IG</span><span class="o">.</span><span class="n">rPRO_SP</span> <span class="o">+</span> <span class="n">IG</span><span class="o">.</span><span class="n">rHYS_PR</span><span class="p">)</span> <span class="n">THEN</span>
            <span class="n">IG</span><span class="o">.</span><span class="n">q_xHV_DIS</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="n">IG</span><span class="o">.</span><span class="n">xHV_SW</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">ELSE</span>
    <span class="n">IG</span><span class="o">.</span><span class="n">q_xHV_DIS</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">IG</span><span class="o">.</span><span class="n">xHV_SW</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">IG</span><span class="o">.</span><span class="n">xILKOk</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Pressure</span> <span class="n">gauge</span> <span class="n">OK</span> <span class="n">checks</span> <span class="o">*</span><span class="p">)</span>

<span class="n">GaugeTurnOnTmr</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">IG</span><span class="o">.</span><span class="n">q_xHV_DIS</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#10S, Q=&gt;IG.xTurnOnTime);</span>


<span class="o">//</span><span class="n">Backwards</span> <span class="n">compatibility</span>
<span class="n">IG</span><span class="o">.</span><span class="n">xPRESS_OK</span> <span class="o">:=</span> <span class="p">(</span><span class="n">IG</span><span class="o">.</span><span class="n">eState</span> <span class="o">=</span> <span class="n">Valid</span><span class="p">)</span> <span class="n">OR</span> <span class="n">IG</span><span class="o">.</span><span class="n">xBAKEOUT</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Setpoint</span> <span class="n">evaluation</span> <span class="o">*</span><span class="p">)</span>
<span class="n">IG</span><span class="o">.</span><span class="n">xAT_VAC</span> <span class="o">:=</span> <span class="p">(</span><span class="n">IG</span><span class="o">.</span><span class="n">xPRESS_OK</span> <span class="n">AND</span> <span class="p">(</span><span class="n">IG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">&lt;</span> <span class="n">IG</span><span class="o">.</span><span class="n">rVAC_SP</span><span class="p">))</span> <span class="n">OR</span> <span class="n">IG</span><span class="o">.</span><span class="n">xBAKEOUT</span> <span class="n">AND</span> <span class="p">(</span><span class="n">IG</span><span class="o">.</span><span class="n">eState</span> <span class="o">=</span> <span class="n">Valid</span><span class="p">)</span> <span class="p">;</span>

<span class="n">ACT_Logger</span><span class="p">();</span>
<span class="p">(</span><span class="o">*</span><span class="n">Soft</span> <span class="n">IO</span> <span class="n">Linking</span><span class="o">*</span><span class="p">)</span>
<span class="o">//</span> <span class="n">check</span> <span class="n">ethercat</span> <span class="n">Diagnostics</span>
<span class="n">IO</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>
<span class="n">ACTION</span> <span class="n">ACT_Logger</span><span class="p">:</span>
<span class="o">//</span> <span class="n">ILK</span> <span class="n">logger</span>
<span class="n">IF</span> <span class="p">(</span><span class="n">IG</span><span class="o">.</span><span class="n">xLog</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">IG</span><span class="o">.</span><span class="n">xILKOk</span> <span class="n">AND</span> <span class="n">IG</span><span class="o">.</span><span class="n">q_xHV_DIS</span> <span class="n">THEN</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Lost external interlock while gauge was on.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span>
    <span class="n">END_IF</span>


    <span class="o">//</span> <span class="n">Log</span> <span class="n">Action</span>
    <span class="n">tAction</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span>   <span class="n">IG</span><span class="o">.</span><span class="n">xHV_SW</span><span class="p">);</span>
    <span class="n">IF</span> <span class="n">tAction</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span> <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Ion gauge commanded to switch on&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span> <span class="n">END_IF</span>



    <span class="o">//</span><span class="n">STATE</span> <span class="n">Logger</span>

    <span class="n">IF</span> <span class="n">ePrevState</span> <span class="o">&lt;&gt;</span> <span class="n">IG</span><span class="o">.</span><span class="n">eState</span> <span class="n">THEN</span>
              <span class="n">CASE</span> <span class="n">IG</span><span class="o">.</span><span class="n">eState</span> <span class="n">OF</span>
                    <span class="n">ValidHi</span><span class="p">:</span>
                            <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Gauge pressure valid high.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span>
                    <span class="n">ValidLo</span><span class="p">:</span>
                            <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Gauge pressure valid low.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span>
                    <span class="n">Valid</span><span class="p">:</span>
                            <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Gauge pressure valid.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span>
                    <span class="n">GaugeDisconnected</span><span class="p">:</span>
                            <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Gauge Disconnected.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span>
                    <span class="n">PressInvalid</span><span class="p">:</span>
                            <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Gauge pressure invalid.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Warning</span><span class="p">);</span>
                    <span class="n">OoR</span><span class="p">:</span>
                            <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Gauge pressure out of range.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Warning</span><span class="p">);</span>
                    <span class="n">Starting</span><span class="p">:</span>
                            <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Gauge starting.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span>
              <span class="n">END_CASE</span>
              <span class="n">ePrevState</span> <span class="o">:=</span> <span class="n">IG</span><span class="o">.</span><span class="n">eState</span><span class="p">;</span>
      <span class="n">END_IF</span>
<span class="n">END_IF</span>
<span class="n">END_ACTION</span>
<span class="n">ACTION</span> <span class="n">IO</span><span class="p">:</span>
<span class="p">(</span><span class="o">*</span><span class="n">soft</span> <span class="n">link</span> <span class="n">inputs</span><span class="o">*</span><span class="p">)</span>
<span class="n">IG</span><span class="o">.</span><span class="n">i_iPRESS_R</span><span class="o">:=</span>     <span class="n">i_iPRESS_R</span><span class="p">;</span>
<span class="n">IG</span><span class="o">.</span><span class="n">i_xHV_ON</span><span class="o">:=</span> <span class="n">i_xHV_ON</span><span class="p">;</span>
<span class="n">IG</span><span class="o">.</span><span class="n">i_xDisc_Active</span><span class="o">:=</span><span class="n">i_xDisc_Active</span><span class="p">;</span>
<span class="p">(</span><span class="o">*</span><span class="n">soft</span> <span class="n">link</span> <span class="n">outputs</span><span class="o">*</span><span class="p">)</span>
<span class="n">q_xHV_DIS</span> <span class="o">:=</span> <span class="n">IG</span><span class="o">.</span><span class="n">q_xHV_DIS</span><span class="p">;</span>

<span class="n">IG</span><span class="o">.</span><span class="n">sPath</span> <span class="o">:=</span> <span class="n">sPath</span><span class="p">;</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
</div>
<div class="section" id="fb-mks500-ep">
<h2>FB_MKS500_EP<a class="headerlink" href="#fb-mks500-ep" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span><span class="n">Deprecated</span><span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">function</span> <span class="ow">is</span> <span class="k">for</span> <span class="n">the</span> <span class="n">Cold</span> <span class="n">Cathode</span> <span class="n">MKS</span> <span class="mi">500</span> <span class="n">connected</span> <span class="n">to</span> <span class="n">Beckhoff</span> <span class="n">EP</span> <span class="n">boxes</span><span class="o">.</span>
<span class="n">A</span> <span class="n">separate</span> <span class="n">function</span> <span class="n">block</span> <span class="ow">is</span> <span class="n">necessary</span> <span class="k">for</span> <span class="n">the</span> <span class="n">MKS500</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">EP</span> <span class="n">box</span> <span class="n">interface</span> <span class="n">beacuse</span> <span class="n">the</span> <span class="n">EP</span>
<span class="n">boxes</span> <span class="n">do</span> <span class="ow">not</span> <span class="n">natively</span> <span class="n">support</span> <span class="n">the</span> <span class="mi">5</span><span class="n">v</span> <span class="n">IO</span> <span class="n">signals</span> <span class="n">on</span> <span class="n">the</span> <span class="n">MKS500</span> <span class="n">gauge</span><span class="o">.*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span><span class="n">This</span> <span class="n">function</span> <span class="n">provides</span> <span class="n">ILK</span> <span class="ow">and</span> <span class="n">Set</span> <span class="n">Point</span> <span class="n">Protection</span> <span class="k">for</span> <span class="n">the</span> <span class="n">Cold</span> <span class="n">Cathode</span><span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="mi">500</span> <span class="n">Logarithmic</span> <span class="n">Output</span> <span class="n">Conversion</span><span class="p">,</span> <span class="n">factory</span> <span class="n">default</span> <span class="n">configuration</span> <span class="o">*</span><span class="p">)</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_MKS500_EP</span> <span class="n">EXTENDS</span> <span class="n">FB_GaugeBase</span>
<span class="n">VAR_IN_OUT</span>

<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>

    <span class="n">PG</span>      <span class="p">:</span>       <span class="n">ST_VG</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span>
    <span class="s1">&#39;}</span>
    <span class="n">IG</span> <span class="p">:</span> <span class="n">ST_VG</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">rV</span> <span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
    <span class="n">GaugeTurnOnTmr</span> <span class="p">:</span> <span class="n">TON</span><span class="p">;</span>

    <span class="p">(</span><span class="o">*</span><span class="n">IOs</span> <span class="n">to</span> <span class="n">be</span> <span class="n">linked</span><span class="o">*</span><span class="p">)</span>
    <span class="o">///</span> <span class="n">Controls</span> <span class="ow">and</span> <span class="n">I</span><span class="o">/</span><span class="n">Os</span>
    <span class="n">i_iPRESS_R</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span><span class="n">INT</span><span class="p">;</span> <span class="o">//</span> <span class="nb">input</span> <span class="n">Pressure</span> <span class="o">//</span> <span class="n">Link</span> <span class="n">to</span> <span class="n">analog</span> <span class="n">Input</span>
    <span class="n">q_xHV_DIS</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Enable</span> <span class="n">High</span> <span class="n">Voltage</span> <span class="n">when</span> <span class="kc">True</span> <span class="o">//</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="p">(</span><span class="n">EP2624</span><span class="p">)</span> <span class="o">^</span><span class="n">Output</span>
    <span class="o">//</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span> <span class="n">CONSTANT</span>
    <span class="o">//</span> <span class="n">Ranges</span> <span class="n">has</span> <span class="n">to</span> <span class="n">match</span> <span class="n">the</span> <span class="n">configurator</span> <span class="n">software</span>
    <span class="n">pBase</span> <span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span><span class="mf">1.0E-10</span><span class="p">;</span><span class="o">//</span><span class="n">default</span> <span class="n">curve</span> <span class="n">base</span> <span class="n">pressure</span> <span class="ow">is</span> <span class="mf">1E-10</span><span class="o">.</span> <span class="n">Confusing</span> <span class="n">since</span> <span class="n">can</span><span class="s1">&#39;t actually read that low using analog out.</span>
    <span class="n">vBase</span> <span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">vDisconnected</span> <span class="p">:</span> <span class="n">REAL</span><span class="o">:=</span> <span class="mf">0.5</span><span class="p">;</span>
    <span class="n">vSlope</span> <span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mf">1.0</span><span class="p">;</span>
    <span class="n">vGaugeOff</span><span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mf">9.8</span><span class="p">;</span>
    <span class="n">vNoDischarge</span><span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mf">9.3</span><span class="p">;</span>
    <span class="n">MinPressure</span><span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mf">1E-10</span><span class="p">;</span>
    <span class="n">cDefaultPressure</span> <span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="mi">500</span> <span class="n">Logarithmic</span> <span class="n">Output</span> <span class="n">Conversion</span><span class="p">,</span> <span class="n">factory</span> <span class="n">default</span> <span class="n">configuration</span> <span class="o">*</span><span class="p">)</span>

<span class="n">rV</span> <span class="o">:=</span> <span class="mi">10</span><span class="o">*</span><span class="n">INT_TO_REAL</span><span class="p">(</span><span class="n">IG</span><span class="o">.</span><span class="n">i_iPRESS_R</span><span class="p">)</span><span class="o">/</span><span class="mi">32767</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Set</span> <span class="n">Guage</span> <span class="n">State</span> <span class="n">based</span> <span class="n">on</span> <span class="n">the</span> <span class="n">Analog</span> <span class="n">voltage</span><span class="o">*</span><span class="p">)</span>
<span class="n">IF</span> <span class="n">rV</span> <span class="o">&lt;</span> <span class="n">vDisconnected</span> <span class="n">THEN</span>
    <span class="n">IG</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">GaugeDisconnected</span><span class="p">;</span>
    <span class="n">IG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">:=</span> <span class="n">cDefaultPressure</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">rV</span> <span class="o">&gt;=</span> <span class="n">vDisconnected</span> <span class="n">AND</span> <span class="n">rV</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">vNoDischarge</span> <span class="o">-</span><span class="mf">0.3</span><span class="p">)</span>  <span class="n">THEN</span>
    <span class="n">IG</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">Valid</span><span class="p">;</span>
    <span class="n">IG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">:=</span> <span class="n">LREAL_TO_REAL</span><span class="p">(</span><span class="n">EXPT</span><span class="p">(</span><span class="mi">10</span><span class="p">,((</span><span class="n">rV</span><span class="o">-</span><span class="n">vBase</span><span class="p">)</span><span class="o">/</span><span class="n">vSlope</span><span class="o">+</span><span class="n">LOG</span><span class="p">(</span><span class="n">pBase</span><span class="p">))));</span>
<span class="n">ELSIF</span> <span class="n">rV</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">vNoDischarge</span> <span class="o">-</span><span class="mf">0.3</span><span class="p">)</span> <span class="n">AND</span> <span class="n">rV</span> <span class="o">&lt;</span><span class="p">(</span><span class="n">vGaugeOff</span> <span class="o">-</span><span class="mf">0.3</span><span class="p">)</span>   <span class="n">THEN</span>
    <span class="n">IG</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">Starting</span><span class="p">;</span>
    <span class="n">IG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">:=</span> <span class="n">LREAL_TO_REAL</span><span class="p">(</span><span class="n">EXPT</span><span class="p">(</span><span class="mi">10</span><span class="p">,((</span><span class="n">rV</span><span class="o">-</span><span class="n">vBase</span><span class="p">)</span><span class="o">/</span><span class="n">vSlope</span><span class="o">+</span><span class="n">LOG</span><span class="p">(</span><span class="n">pBase</span><span class="p">))));</span>
<span class="n">ELSIF</span> <span class="n">rV</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">vGaugeOff</span> <span class="o">-</span><span class="mf">0.3</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">IG</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">Off</span><span class="p">;</span>
    <span class="n">IG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">:=</span> <span class="n">LREAL_TO_REAL</span><span class="p">(</span><span class="n">EXPT</span><span class="p">(</span><span class="mi">10</span><span class="p">,((</span><span class="n">rV</span><span class="o">-</span><span class="n">vBase</span><span class="p">)</span><span class="o">/</span><span class="n">vSlope</span><span class="o">+</span><span class="n">LOG</span><span class="p">(</span><span class="n">pBase</span><span class="p">))));</span>
<span class="n">ELSE</span>
    <span class="n">IG</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">OoR</span><span class="p">;</span>
    <span class="n">IG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">:=</span> <span class="n">LREAL_TO_REAL</span><span class="p">(</span><span class="n">EXPT</span><span class="p">(</span><span class="mi">10</span><span class="p">,((</span><span class="n">rV</span><span class="o">-</span><span class="n">vBase</span><span class="p">)</span><span class="o">/</span><span class="n">vSlope</span><span class="o">+</span><span class="n">LOG</span><span class="p">(</span><span class="n">pBase</span><span class="p">))));</span>
<span class="n">END_IF</span>


<span class="p">(</span><span class="o">*</span> <span class="n">Ion</span> <span class="n">Gauge</span> <span class="n">Protection</span> <span class="n">Functions</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">If</span> <span class="n">the</span> <span class="n">PG</span> <span class="n">pressure</span> <span class="ow">is</span> <span class="n">greater</span> <span class="n">than</span> <span class="n">the</span> <span class="n">VG</span><span class="o">.</span><span class="n">PRO_SP</span> <span class="n">then</span> <span class="n">the</span> <span class="n">gauge</span> <span class="ow">is</span> <span class="n">disabled</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">If</span> <span class="n">the</span> <span class="n">PG</span> <span class="n">pressure</span> <span class="ow">is</span> <span class="n">less</span> <span class="n">than</span> <span class="n">the</span> <span class="n">VG</span><span class="o">.</span><span class="n">PRO_SP</span> <span class="n">then</span> <span class="n">the</span> <span class="n">gauge</span> <span class="ow">is</span> <span class="n">enabled</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">FB</span> <span class="n">also</span> <span class="n">implements</span> <span class="n">some</span> <span class="n">hysteresis</span> <span class="n">so</span> <span class="n">the</span> <span class="n">gauge</span> <span class="n">doesn</span><span class="s1">&#39;t have rapid power cycling while near the turn on boundary *)</span>


<span class="n">IF</span> <span class="n">PG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">&lt;=</span> <span class="n">IG</span><span class="o">.</span><span class="n">rPRO_SP</span> <span class="n">AND</span> <span class="n">PG</span><span class="o">.</span><span class="n">xPRESS_OK</span> <span class="n">THEN</span>

    <span class="n">IG</span><span class="o">.</span><span class="n">q_xHV_DIS</span> <span class="o">:=</span> <span class="n">IG</span><span class="o">.</span><span class="n">xHV_SW</span><span class="p">;</span>
    <span class="n">IG</span><span class="o">.</span><span class="n">xILKOk</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">IG</span><span class="o">.</span><span class="n">q_xHV_DIS</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">IG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">IG</span><span class="o">.</span><span class="n">rPRO_SP</span> <span class="o">+</span> <span class="n">IG</span><span class="o">.</span><span class="n">rHYS_PR</span><span class="p">)</span>  <span class="n">OR</span> <span class="n">PG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">IG</span><span class="o">.</span><span class="n">rPRO_SP</span> <span class="o">+</span> <span class="n">IG</span><span class="o">.</span><span class="n">rHYS_PR</span><span class="p">)</span> <span class="n">THEN</span>
            <span class="n">IG</span><span class="o">.</span><span class="n">q_xHV_DIS</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="n">IG</span><span class="o">.</span><span class="n">xHV_SW</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">ELSE</span>
    <span class="n">IG</span><span class="o">.</span><span class="n">q_xHV_DIS</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">IG</span><span class="o">.</span><span class="n">xHV_SW</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">IG</span><span class="o">.</span><span class="n">xILKOk</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Pressure</span> <span class="n">gauge</span> <span class="n">OK</span> <span class="n">checks</span> <span class="o">*</span><span class="p">)</span>

<span class="n">GaugeTurnOnTmr</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">IG</span><span class="o">.</span><span class="n">q_xHV_DIS</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#10S, Q=&gt;IG.xTurnOnTime);</span>


<span class="o">//</span><span class="n">Backwards</span> <span class="n">compatibility</span>
<span class="n">IG</span><span class="o">.</span><span class="n">xPRESS_OK</span> <span class="o">:=</span> <span class="p">(</span><span class="n">IG</span><span class="o">.</span><span class="n">eState</span> <span class="o">=</span> <span class="n">Valid</span><span class="p">)</span> <span class="n">OR</span> <span class="n">IG</span><span class="o">.</span><span class="n">xBAKEOUT</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Setpoint</span> <span class="n">evaluation</span> <span class="o">*</span><span class="p">)</span>
<span class="n">IG</span><span class="o">.</span><span class="n">xAT_VAC</span> <span class="o">:=</span> <span class="p">(</span><span class="n">IG</span><span class="o">.</span><span class="n">xPRESS_OK</span> <span class="n">AND</span> <span class="p">(</span><span class="n">IG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">&lt;</span> <span class="n">IG</span><span class="o">.</span><span class="n">rVAC_SP</span><span class="p">))</span> <span class="n">OR</span> <span class="n">IG</span><span class="o">.</span><span class="n">xBAKEOUT</span> <span class="n">AND</span> <span class="p">(</span><span class="n">IG</span><span class="o">.</span><span class="n">eState</span> <span class="o">=</span> <span class="n">Valid</span><span class="p">)</span> <span class="p">;</span>

<span class="n">ACT_Logger</span><span class="p">();</span>
<span class="p">(</span><span class="o">*</span><span class="n">Soft</span> <span class="n">IO</span> <span class="n">Linking</span><span class="o">*</span><span class="p">)</span>
<span class="o">//</span> <span class="n">check</span> <span class="n">ethercat</span> <span class="n">Diagnostics</span>
<span class="n">IO</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>
<span class="n">ACTION</span> <span class="n">ACT_Logger</span><span class="p">:</span>
<span class="n">IF</span> <span class="p">(</span><span class="n">IG</span><span class="o">.</span><span class="n">xLog</span><span class="p">)</span> <span class="n">THEN</span>
<span class="o">//</span> <span class="n">ILK</span> <span class="n">logger</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">IG</span><span class="o">.</span><span class="n">xILKOk</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">IG</span><span class="o">.</span><span class="n">q_xHV_DIS</span> <span class="n">THEN</span>
            <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Lost external interlock while gauge was on.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span>
<span class="n">END_IF</span>


<span class="o">//</span> <span class="n">Log</span> <span class="n">Action</span>
<span class="n">tAction</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span>  <span class="n">IG</span><span class="o">.</span><span class="n">q_xHV_DIS</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">tAction</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span> <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Ion gauge commanded to switch on&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span> <span class="n">END_IF</span>



<span class="o">//</span><span class="n">STATE</span> <span class="n">Logger</span>
<span class="n">IF</span> <span class="n">ePrevState</span> <span class="o">&lt;&gt;</span> <span class="n">IG</span><span class="o">.</span><span class="n">eState</span> <span class="n">THEN</span>
      <span class="n">CASE</span> <span class="n">IG</span><span class="o">.</span><span class="n">eState</span> <span class="n">OF</span>
            <span class="n">ValidHi</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Gauge pressure valid high.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span>
            <span class="n">ValidLo</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Gauge pressure valid low.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span>
            <span class="n">Valid</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Gauge pressure valid.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span>
            <span class="n">GaugeDisconnected</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Gauge Disconnected.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span>
            <span class="n">PressInvalid</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Gauge pressure invalid.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Warning</span><span class="p">);</span>
            <span class="n">OoR</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Gauge pressure out of range.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Warning</span><span class="p">);</span>
            <span class="n">Starting</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Gauge starting.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span>
      <span class="n">END_CASE</span>
      <span class="n">ePrevState</span> <span class="o">:=</span> <span class="n">IG</span><span class="o">.</span><span class="n">eState</span><span class="p">;</span>
  <span class="n">END_IF</span>
<span class="n">END_IF</span>
<span class="n">END_ACTION</span>
<span class="n">ACTION</span> <span class="n">IO</span><span class="p">:</span>
<span class="p">(</span><span class="o">*</span><span class="n">soft</span> <span class="n">link</span> <span class="n">inputs</span><span class="o">*</span><span class="p">)</span>
<span class="n">IG</span><span class="o">.</span><span class="n">i_iPRESS_R</span><span class="o">:=</span>     <span class="n">i_iPRESS_R</span><span class="p">;</span>
<span class="p">(</span><span class="o">*</span><span class="n">soft</span> <span class="n">link</span> <span class="n">outputs</span><span class="o">*</span><span class="p">)</span>
<span class="n">q_xHV_DIS</span> <span class="o">:=</span> <span class="n">IG</span><span class="o">.</span><span class="n">q_xHV_DIS</span><span class="p">;</span>

<span class="n">IG</span><span class="o">.</span><span class="n">sPath</span> <span class="o">:=</span> <span class="n">sPath</span><span class="p">;</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
</div>
<div class="section" id="fb-mks722">
<h2>FB_MKS722<a class="headerlink" href="#fb-mks722" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(* This function is for the MKS 722*)

FUNCTION_BLOCK FB_MKS722
VAR_IN_OUT

END_VAR
VAR_OUTPUT
    {attribute &#39;pytmc&#39; := &#39;
    pv:
    &#39;}
    VG      :       ST_VG;
END_VAR
VAR_INPUT
    i_rMinPressure  :       REAL;
    i_rMaxPressure  :       REAL;
END_VAR
VAR
    iTermBits: UINT := 32767 ; // The terminal&#39;s maximum value in bits
    rMinPressure: REAL;
    rVMin   :       REAL := 0.01; // Anything less than this voltage is considered disconnected
    rVMax : REAL := 10.5; // Anything more than this is considered invalid
    rV      :REAL;

    (*IO*)
    i_iPRESS_R AT%I* :INT; // input Pressure // Link to analog Input
END_VAR
(* Real-value calculation *)
If (iTermBits=0) THEN iTermBits := 32767;END_IF
rV := 10*INT_TO_REAL(VG.i_iPRESS_R)/iTermBits;


// Is the gauge plugged in, and within a reasonable range?
IF rV &lt; rVMin THEN
    VG.eState := GaugeDisconnected;
ELSIF rV &gt; rVMax THEN
    VG.eState := PressInvalid;
ELSIF VG.rPRESS &gt;= rMinPressure AND VG.rPRESS &lt;= i_rMaxPressure THEN
                            VG.eState := Valid;
ELSIF VG.rPRESS &lt; i_rMinPressure THEN
                            VG.eState := ValidLo;
ELSE
                            VG.eState := ValidHi;
END_IF

// Legacy Press OK boolean eval
VG.xPRESS_OK := VG.eState &gt;= gc_GaugeValidState;

(*IO Soft Mapping*)
ACT_IO();

END_FUNCTION_BLOCK
ACTION ACT_IO:
VG.i_iPRESS_R :=i_iPRESS_R;
END_ACTION
</pre></div>
</div>
</div>
<div class="section" id="fb-mks909">
<h2>FB_MKS909<a class="headerlink" href="#fb-mks909" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(* Standard MKS 909 hot cathode *)
(* works for 972 and 925 *)

FUNCTION_BLOCK FB_MKS909 EXTENDS FB_GaugeBase

VAR_INPUT
    PG      : ST_VG;
END_VAR
VAR_OUTPUT
    {attribute &#39;pytmc&#39; := &#39;
    pv:
    &#39;}
    IG      : ST_VG;
END_VAR
VAR_IN_OUT

END_VAR
VAR
    rV : REAL;
    rMaxPressure    :       REAL := 5E-2; //Torr
    rMinPressure    :       REAL := 1E-10; //Torr
    timer:TON;
    (*Default set point 50 mT*)
    rVAC_SP: REAL := 9E-3; // as per manual
    iTermBits: UINT := 30518 ; // The terminal&#39;s maximum value in bits default el3174 as per vacuum architecture
    (*IO*)
    i_iPRESS_R AT%I* :INT; // input Pressure // Link to analog Input
    q_xHV_DIS AT %Q* : BOOL := True; // Active Low

END_VAR
(* Standard MKS 9XX series conversion *)
(* works for 972 and 925 *)

//Default setpoint 50 mT
IF PG.rVAC_SP = 0 THEN
    PG.rVAC_SP := rVAC_SP;
END_IF
// check no div by zero
If (iTermBits=0) THEN iTermBits := 30518;END_IF
rV := 10*INT_TO_REAL(PG.i_iPRESS_R)/iTermBits;

(* Pressure OK check *)
// Gauge state
// Is the gauge plugged in, and within a reasonable range?
IF  (rV &gt;= 0.1 and rV &lt;=8.7) THEN // as per manual
    IG.rPRESS := LREAL_TO_REAL(EXPT(10, rV-10));
    IG.eState := Valid;
    IG.xPRESS_OK := TRUE; //Backwards compatibility
ELSIF rV &gt; 8.7 AND rV &lt; 10 THEN
    IG.rPRESS :=rMaxPressure;
    IG.xPRESS_OK := FALSE;
    IG.eState := Off;
ELSE
    IG.xPRESS_OK := FALSE;
    IG.eState := GaugeDisconnected;
END_IF


IF (PG.rPRESS &lt;= IG.rPRO_SP)  AND (PG.xPRESS_OK) THEN
             PG.q_xHV_DIS := NOT IG.xHV_SW;
             IG.xILKOk := TRUE;
    ELSIF NOT IG.q_xHV_DIS AND timer.Q THEN
            IF IG.rPRESS &gt; (IG.rPRO_SP + IG.rHYS_PR) OR PG.rPRESS &gt; (IG.rPRO_SP + IG.rHYS_PR) THEN
            IG.q_xHV_DIS := TRUE;
            IG.xHV_SW := FALSE;
            END_IF
    ELSE
            IG.q_xHV_DIS := TRUE;
            IG.xHV_SW := FALSE;
            IG.xILKOk := FALSE;
    END_IF


timer(IN:= NOT IG.q_xHV_DIS, PT:= T#2s);

(* Setpoint evaluation *)
IG.xAT_VAC := IG.xPRESS_OK AND (IG.rPRESS &lt; IG.rVAC_SP);

(*Soft IO Mapping*)
ACT_IO();

(*Logger*)

THIS^.ACT_Logger();

END_FUNCTION_BLOCK
ACTION ACT_IO:
(*soft link inputs*)
IG.i_iPRESS_R:=     i_iPRESS_R;

(*soft link outputs*)
q_xHV_DIS := IG.q_xHV_DIS;
END_ACTION
ACTION ACT_Logger:
// ILK logger
IF NOT IG.xILKOk AND NOT IG.q_xHV_DIS THEN
            fbLogger(sMsg:=&#39;Lost external interlock while gauge was on.&#39;, eSevr:=TcEventSeverity.Critical);
END_IF


// Log Action
tAction(CLK:=  IG.q_xHV_DIS);
IF tAction.Q THEN fbLogger(sMsg:=&#39;Ion gauge commanded to switch on&#39;, eSevr:=TcEventSeverity.Info); END_IF



//STATE Logger
IF ePrevState &lt;&gt; IG.eState THEN
      CASE IG.eState OF
            ValidHi:
            ValidLo:
            Valid:
                    fbLogger(sMsg:=&#39;Gauge pressure valid.&#39;, eSevr:=TcEventSeverity.Info);
            GaugeDisconnected:
                    fbLogger(sMsg:=&#39;Gauge Disconnected.&#39;, eSevr:=TcEventSeverity.Critical);
            PressInvalid:
                    fbLogger(sMsg:=&#39;Gauge pressure invalid.&#39;, eSevr:=TcEventSeverity.Warning);
            OoR:
                    fbLogger(sMsg:=&#39;Gauge pressure out of range.&#39;, eSevr:=TcEventSeverity.Warning);
            Starting:
                    fbLogger(sMsg:=&#39;Gauge starting.&#39;, eSevr:=TcEventSeverity.Info);
      END_CASE
      ePrevState := IG.eState;
  END_IF
END_ACTION
</pre></div>
</div>
</div>
<div class="section" id="fb-mks-937a">
<h2>FB_MKS_937A<a class="headerlink" href="#fb-mks-937a" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span> <span class="mi">937</span><span class="n">A</span> <span class="n">Logarithmic</span> <span class="n">Output</span> <span class="n">Conversion</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="mi">7</span><span class="o">-</span><span class="mi">15</span><span class="o">-</span><span class="mi">2015</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">function</span> <span class="n">will</span> <span class="n">read</span> <span class="n">the</span> <span class="n">pressure</span> <span class="kn">from</span> <span class="nn">any</span> <span class="n">gauge</span> <span class="n">on</span> <span class="n">a</span> <span class="mi">937</span><span class="n">A</span><span class="o">.</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">To</span> <span class="n">be</span> <span class="n">used</span> <span class="n">when</span> <span class="n">the</span> <span class="n">specific</span> <span class="n">device</span> <span class="n">function</span> <span class="n">block</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">available</span> <span class="o">*</span><span class="p">)</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_MKS_937A</span>
<span class="n">VAR_IN_OUT</span>

<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">PG</span>      <span class="p">:</span>       <span class="n">ST_VG</span> <span class="o">:=</span> <span class="n">g_DummyVG</span><span class="p">;</span> <span class="o">//</span> <span class="n">Gauge</span> <span class="n">Structure</span> <span class="n">used</span> <span class="n">to</span> <span class="n">Interlock</span> <span class="n">the</span> <span class="n">ion</span> <span class="n">gauges</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: &#39;</span><span class="p">}</span>
    <span class="n">VG</span> <span class="p">:</span> <span class="n">ST_VG</span><span class="p">;</span> <span class="o">//</span> <span class="n">Vacuum</span> <span class="n">Gauge</span> <span class="n">Data</span> <span class="n">Structure</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">rV</span>      <span class="p">:</span>       <span class="n">REAL</span><span class="p">;</span>
            <span class="p">(</span><span class="o">*</span><span class="n">IOs</span> <span class="n">to</span> <span class="n">be</span> <span class="n">linked</span><span class="o">*</span><span class="p">)</span>
    <span class="o">///</span> <span class="n">Controls</span> <span class="ow">and</span> <span class="n">I</span><span class="o">/</span><span class="n">Os</span>
    <span class="n">i_iPRESS_R</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span><span class="n">INT</span><span class="p">;</span> <span class="o">//</span> <span class="nb">input</span> <span class="n">Pressure</span> <span class="o">//</span> <span class="n">Link</span> <span class="n">to</span> <span class="n">analog</span> <span class="n">Input</span>
    <span class="n">q_xHV_DIS</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Disable</span> <span class="n">Gauge</span> <span class="n">High</span> <span class="n">Voltage</span> <span class="n">when</span> <span class="kc">True</span> <span class="o">//</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="p">(</span><span class="n">EL2794</span><span class="p">)</span> <span class="o">^</span><span class="n">Output</span>

<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="mi">937</span><span class="n">A</span> <span class="n">Logarithmic</span> <span class="n">Output</span> <span class="n">Conversion</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="mi">7</span><span class="o">-</span><span class="mi">15</span><span class="o">-</span><span class="mi">2015</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">function</span> <span class="n">will</span> <span class="n">read</span> <span class="n">the</span> <span class="n">pressure</span> <span class="kn">from</span> <span class="nn">any</span> <span class="n">gauge</span> <span class="n">on</span> <span class="n">a</span> <span class="mi">937</span><span class="n">A</span><span class="o">.</span> <span class="o">*</span><span class="p">)</span>

<span class="n">rV</span> <span class="o">:=</span> <span class="mi">10</span><span class="o">*</span><span class="n">INT_TO_REAL</span><span class="p">(</span><span class="n">VG</span><span class="o">.</span><span class="n">i_iPRESS_R</span><span class="p">)</span><span class="o">/</span><span class="mi">32767</span><span class="p">;</span>
<span class="n">VG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">:=</span> <span class="n">LREAL_TO_REAL</span><span class="p">(</span><span class="n">EXPT</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="n">rV</span><span class="o">/</span><span class="mf">0.6</span><span class="o">-</span><span class="mi">12</span><span class="p">));</span>


<span class="p">(</span><span class="o">*</span> <span class="n">Ion</span> <span class="n">Gauge</span> <span class="n">Protection</span> <span class="n">Functions</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">If</span> <span class="n">the</span> <span class="n">PG</span> <span class="n">pressure</span> <span class="ow">is</span> <span class="n">greater</span> <span class="n">than</span> <span class="n">the</span> <span class="n">VG</span><span class="o">.</span><span class="n">PRO_SP</span> <span class="n">then</span> <span class="n">the</span> <span class="n">gauge</span> <span class="ow">is</span> <span class="n">disabled</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">If</span> <span class="n">the</span> <span class="n">PG</span> <span class="n">pressure</span> <span class="ow">is</span> <span class="n">less</span> <span class="n">than</span> <span class="n">the</span> <span class="n">VG</span><span class="o">.</span><span class="n">PRO_SP</span> <span class="n">then</span> <span class="n">the</span> <span class="n">gauge</span> <span class="ow">is</span> <span class="n">enabled</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">FB</span> <span class="n">also</span> <span class="n">implements</span> <span class="n">some</span> <span class="n">hysteresis</span> <span class="n">so</span> <span class="n">the</span> <span class="n">gauge</span> <span class="n">doesn</span><span class="s1">&#39;t have rapid power cycling while near the turn on boundary *)</span>

<span class="n">IF</span> <span class="n">PG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">&lt;</span> <span class="n">VG</span><span class="o">.</span><span class="n">rPRO_SP</span> <span class="n">THEN</span>

<span class="n">VG</span><span class="o">.</span><span class="n">q_xHV_DIS</span> <span class="o">:=</span>  <span class="n">NOT</span> <span class="n">VG</span><span class="o">.</span><span class="n">xHV_SW</span><span class="p">;</span>

<span class="n">ELSIF</span> <span class="n">NOT</span> <span class="n">VG</span><span class="o">.</span><span class="n">q_xHV_DIS</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">VG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">&gt;</span> <span class="n">VG</span><span class="o">.</span><span class="n">rPRO_SP</span> <span class="o">+</span> <span class="n">VG</span><span class="o">.</span><span class="n">rHYS_PR</span> <span class="n">OR</span> <span class="n">PG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">&gt;</span> <span class="n">VG</span><span class="o">.</span><span class="n">rPRO_SP</span> <span class="o">+</span> <span class="n">VG</span><span class="o">.</span><span class="n">rHYS_PR</span> <span class="n">THEN</span>
            <span class="n">VG</span><span class="o">.</span><span class="n">q_xHV_DIS</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">ELSE</span>
    <span class="n">VG</span><span class="o">.</span><span class="n">q_xHV_DIS</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>


<span class="p">(</span><span class="o">*</span> <span class="n">Pressure</span> <span class="n">gauge</span> <span class="n">OK</span> <span class="n">checks</span> <span class="o">*</span><span class="p">)</span>
<span class="n">VG</span><span class="o">.</span><span class="n">xPRESS_OK</span> <span class="o">:=</span> <span class="p">(</span><span class="n">rV</span> <span class="o">&lt;=</span><span class="mf">9.6</span> <span class="p">)</span> <span class="n">AND</span> <span class="p">(</span><span class="n">rV</span><span class="o">&gt;=</span><span class="mf">0.6</span><span class="p">);</span> <span class="o">//</span><span class="n">legacy</span>

<span class="n">IF</span> <span class="p">(</span><span class="n">rV</span> <span class="o">&lt;=</span><span class="mf">9.6</span> <span class="p">)</span> <span class="n">AND</span> <span class="p">(</span><span class="n">rV</span><span class="o">&gt;=</span><span class="mf">0.6</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">VG</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">Valid</span><span class="p">;</span> <span class="o">//</span> <span class="n">normal</span>
<span class="n">ELSIF</span> <span class="n">rV</span> <span class="o">&gt;=</span> <span class="mf">0.18</span> <span class="n">AND</span> <span class="n">rV</span> <span class="o">&lt;=</span> <span class="mf">0.22</span> <span class="n">THEN</span>
    <span class="n">VG</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">ValidLo</span><span class="p">;</span> <span class="o">//</span><span class="n">LO</span>
<span class="n">ELSIF</span> <span class="n">rV</span> <span class="o">&gt;=</span> <span class="mf">9.7</span> <span class="n">AND</span> <span class="n">rV</span><span class="o">&lt;=</span> <span class="mf">9.9</span> <span class="n">THEN</span>
    <span class="n">VG</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">ValidHi</span><span class="p">;</span> <span class="o">//</span><span class="n">HIGH</span>
<span class="n">ELSIF</span> <span class="n">rV</span> <span class="o">&lt;</span> <span class="mf">0.18</span> <span class="n">THEN</span>
    <span class="n">VG</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">GaugeDisconnected</span><span class="p">;</span> <span class="o">//</span><span class="ow">not</span> <span class="n">on</span>
<span class="n">ELSE</span>
    <span class="n">VG</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">PressInvalid</span><span class="p">;</span> <span class="o">//</span><span class="n">other</span> <span class="n">fault</span> <span class="o">-</span> <span class="n">could</span> <span class="n">be</span> <span class="n">no</span> <span class="n">gauge</span><span class="p">,</span> <span class="n">controller</span> <span class="n">powering</span> <span class="n">up</span> <span class="n">etc</span>
<span class="n">END_IF</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Setpoint</span> <span class="n">evaluation</span> <span class="o">*</span><span class="p">)</span>
<span class="n">VG</span><span class="o">.</span><span class="n">xAT_VAC</span> <span class="o">:=</span> <span class="p">(</span><span class="n">VG</span><span class="o">.</span><span class="n">eState</span> <span class="o">=</span><span class="n">Valid</span><span class="p">)</span> <span class="n">AND</span> <span class="n">VG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">&lt;</span> <span class="n">VG</span><span class="o">.</span><span class="n">rVAC_SP</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span><span class="n">Soft</span> <span class="n">IO</span> <span class="n">Linking</span><span class="o">*</span><span class="p">)</span>
<span class="n">ACT_IO</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>
<span class="n">ACTION</span> <span class="n">ACT_IO</span><span class="p">:</span>
<span class="p">(</span><span class="o">*</span><span class="n">soft</span> <span class="n">link</span> <span class="n">inputs</span><span class="o">*</span><span class="p">)</span>
<span class="n">VG</span><span class="o">.</span><span class="n">i_iPRESS_R</span><span class="o">:=</span>     <span class="n">i_iPRESS_R</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span><span class="n">soft</span> <span class="n">link</span> <span class="n">outputs</span><span class="o">*</span><span class="p">)</span>
<span class="n">q_xHV_DIS</span> <span class="o">:=</span> <span class="n">VG</span><span class="o">.</span><span class="n">q_xHV_DIS</span><span class="p">;</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
</div>
<div class="section" id="fb-mks-937b">
<h2>FB_MKS_937B<a class="headerlink" href="#fb-mks-937b" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(* 937B Logarithmic Output Conversion *)
(* 5-20-2016, Alex Wallace and Scott Stubbs *)
(* This function will read the pressure from any gauge on a 937B. *)
(* To be used when the specific device function block is not available *)
FUNCTION_BLOCK FB_MKS_937B
VAR_IN_OUT

END_VAR
VAR_INPUT
    PG      :       ST_VG := g_DummyVG; // Gauge Structure used to Interlock the ion gauges
END_VAR
VAR_OUTPUT
    {attribute &#39;pytmc&#39; := &#39;pv: &#39;}
    VG : ST_VG; // Vacuum Gauge Data Structure



END_VAR
VAR
    rV      :       REAL;


            (*IOs to be linked*)
    /// Controls and I/Os
    i_iPRESS_R AT %I* :INT; // input Pressure // Link to analog Input
    q_xHV_DIS AT %Q* : BOOL; // Disable Gauge High Voltage when True // &#39;TcLinkTo&#39; (EL2794) ^Output

END_VAR
(* 937B Logarithmic Output Conversion *)
(* 5-20-2016, Alex Wallace and Scott Stubbs *)
(* This function will read the pressure from any gauge on a 937B. *)

rV := 10*INT_TO_REAL(VG.i_iPRESS_R)/32767;
VG.rPRESS := LREAL_TO_REAL(EXPT(10,(rV-7.2)/0.6));


(* Gauge Protection Functions *)
(* If the PG pressure is greater than the VG.PRO_SP then the gauge is disabled *)
(* If the PG pressure is less than the VG.PRO_SP then the gauge is enabled *)
(* This FB also implements some hysteresis so the gauge doesn&#39;t have rapid power cycling while near the turn on boundary *)

IF PG.rPRESS &lt; VG.rPRO_SP THEN // might enable the gauge automatically, do we want that?

VG.q_xHV_DIS := NOT VG.xHV_SW;

ELSIF NOT VG.q_xHV_DIS THEN
    IF VG.rPRESS &gt; VG.rPRO_SP + VG.rHYS_PR OR PG.rPRESS &gt; VG.rPRO_SP + VG.rHYS_PR THEN
            VG.q_xHV_DIS := TRUE;
    END_IF
ELSE
    VG.q_xHV_DIS := TRUE;
END_IF


(* Pressure gauge OK checks *)
VG.xPRESS_OK := (rV &lt;=9.6 ) AND (rV&gt;=0.6);
(* Pressure gauge State checks *)
IF (rV &lt;=9.7 ) AND (rV&gt;=0.6) THEN
    VG.eState := Valid; // normal
ELSIF rV &gt;= 0.18 AND rV &lt;= 0.22 THEN
    VG.eState := ValidLo; //LO
ELSIF rV &gt; 9.7 AND rV&lt;= 9.9 THEN
    VG.eState := ValidHi; //HIGH
ELSIF rV &lt; 0.18 THEN
    VG.eState := GaugeDisconnected; //not on
ELSE
    VG.eState := PressInvalid; //other fault - could be no gauge, controller powering up etc
END_IF

(* Setpoint evaluation *)
VG.xAT_VAC := (VG.eState =Valid) AND VG.rPRESS &lt; VG.rVAC_SP;


(*Soft IO Linking*)
// check ethercat Diagnostics
ACT_IO();

END_FUNCTION_BLOCK
ACTION ACT_IO:
(*soft link inputs*)
VG.i_iPRESS_R:=     i_iPRESS_R;

(*soft link outputs*)
q_xHV_DIS := VG.q_xHV_DIS;
END_ACTION
</pre></div>
</div>
</div>
<div class="section" id="fb-pip-gamma">
<h2>FB_PIP_Gamma<a class="headerlink" href="#fb-pip-gamma" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">function</span> <span class="n">block</span> <span class="n">does</span> <span class="n">basic</span> <span class="n">controls</span> <span class="n">FOR</span> <span class="n">the</span> <span class="n">ION</span> <span class="n">pump</span> <span class="n">connected</span> <span class="n">to</span> <span class="n">a</span> <span class="n">Gamma</span> <span class="n">QPCe</span> <span class="n">controller</span><span class="o">.</span>
 <span class="n">Provides</span> <span class="n">interlocking</span> <span class="n">interface</span><span class="o">.</span> <span class="n">Enable</span> <span class="n">HV</span> <span class="n">only</span> <span class="n">when</span> <span class="n">interlock</span> <span class="n">gauge</span> <span class="n">press</span> <span class="ow">is</span> <span class="n">less</span> <span class="n">than</span> <span class="mf">1.0E-4</span> <span class="n">Torr</span> <span class="o">*</span><span class="p">)</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PIP_Gamma</span> <span class="n">Extends</span> <span class="n">FB_Pump</span>
<span class="n">VAR_INPUT</span>
    <span class="n">i_stGauge</span>       <span class="p">:</span>       <span class="n">ST_VG</span><span class="p">;</span> <span class="o">//</span><span class="n">Ion</span> <span class="ow">or</span> <span class="n">Pirani</span> <span class="n">gauge</span> <span class="k">for</span> <span class="n">pump</span> <span class="n">interlock</span>
    <span class="n">i_xOverrideMode</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span><span class="n">To</span> <span class="n">be</span> <span class="n">linked</span> <span class="n">to</span> <span class="k">global</span> <span class="n">override</span> <span class="n">bit</span><span class="o">.</span> <span class="n">This</span> <span class="n">Overrides</span> <span class="n">Vacuum</span> <span class="n">interlock</span> <span class="n">logic</span><span class="o">*</span><span class="p">)</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span>
    <span class="s1">&#39;}</span>
    <span class="n">stPump</span>  <span class="p">:</span>       <span class="n">ST_PIP</span><span class="p">;</span> <span class="o">//</span><span class="n">Gamma</span> <span class="n">Ion</span> <span class="n">pump</span> <span class="n">structure</span>
    <span class="n">q_IG</span>    <span class="p">:</span>       <span class="n">ST_VG</span><span class="p">;</span> <span class="o">//</span><span class="n">When</span> <span class="n">ion</span> <span class="n">pump</span> <span class="ow">is</span> <span class="n">used</span> <span class="k">as</span> <span class="n">a</span> <span class="n">measuring</span> <span class="n">device</span> <span class="k">for</span> <span class="n">interlocking</span> <span class="n">gate</span> <span class="n">valves</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
 <span class="n">rPRESS</span> <span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>

 <span class="n">rV</span> <span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
 <span class="n">timer</span><span class="p">:</span><span class="n">TON</span><span class="p">;</span>
 <span class="n">rHVEna_SP</span> <span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span><span class="mf">1E-4</span><span class="p">;</span> <span class="o">//</span> <span class="n">Default</span> <span class="n">protection</span> <span class="n">setpoint</span> <span class="k">as</span> <span class="n">per</span> <span class="n">the</span> <span class="n">gamma</span> <span class="n">QPCe</span> <span class="n">manual</span>
 <span class="p">(</span><span class="o">*</span> <span class="n">IO</span> <span class="n">Controls</span> <span class="o">*</span><span class="p">)</span>
 <span class="n">q_xHVEna_DO</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>  <span class="o">//</span> <span class="n">Enable</span> <span class="n">High</span> <span class="n">Voltage</span> <span class="n">when</span> <span class="n">TRUE</span>
 <span class="n">i_iPRESS</span>  <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>  <span class="o">//</span>
 <span class="n">i_xSP_DI</span>  <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">NO</span> <span class="n">contact</span> <span class="o">//</span><span class="n">function</span> <span class="n">of</span> <span class="n">relay</span> <span class="nb">set</span> <span class="n">on</span> <span class="n">the</span> <span class="n">QPC</span> <span class="n">to</span> <span class="n">HV</span> <span class="n">output</span> <span class="n">state</span>

<span class="o">//</span> <span class="n">For</span> <span class="n">logging</span>
<span class="n">tTimeOutAction</span> <span class="p">:</span> <span class="n">F_TRIG</span><span class="p">;</span>
<span class="n">tOverrideActivated</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>

<span class="n">tPumpStartTimeout</span> <span class="p">:</span> <span class="n">TON</span> <span class="o">:=</span> <span class="p">(</span><span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#10s); // Timeout pump start if pressure &lt; 1E-11 for more than 10s.</span>
<span class="n">MinPressure</span> <span class="p">:</span> <span class="n">REAL</span><span class="o">:=</span> <span class="mf">1E-11</span><span class="p">;</span> <span class="o">//</span> <span class="n">Minimum</span> <span class="n">readback</span> <span class="n">pressure</span><span class="p">,</span> <span class="n">pump</span> <span class="n">must</span> <span class="n">register</span> <span class="n">pressure</span> <span class="n">above</span> <span class="n">this</span> <span class="n">to</span> <span class="n">be</span> <span class="n">considered</span> <span class="n">running</span>

<span class="o">//</span><span class="n">Overrides</span>
    <span class="n">tonOvrd</span> <span class="p">:</span>       <span class="n">TON</span><span class="p">;</span>
    <span class="n">tonDelOK</span> <span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">rtOK</span>    <span class="p">:</span>       <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">tOvrd</span>   <span class="p">:</span>       <span class="n">TIME</span> <span class="o">:=</span> <span class="n">T</span><span class="c1">#10s;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Does</span> <span class="n">Gamma</span> <span class="n">Ion</span> <span class="n">pump</span> <span class="n">HV</span> <span class="n">interlock</span><span class="o">.</span> <span class="n">Enable</span> <span class="n">HV</span> <span class="n">only</span> <span class="n">when</span> <span class="n">interlock</span> <span class="n">gauge</span> <span class="n">press</span> <span class="ow">is</span> <span class="n">less</span> <span class="n">than</span> <span class="mf">1.0E-4</span> <span class="n">Torr</span> <span class="o">*</span><span class="p">)</span>

<span class="p">(</span><span class="o">*</span><span class="n">Ensures</span> <span class="n">the</span> <span class="nb">set</span> <span class="n">point</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">higher</span> <span class="n">than</span> <span class="mf">1.0E-4</span><span class="o">*</span><span class="p">)</span>
<span class="n">IF</span> <span class="p">(</span><span class="n">stPump</span><span class="o">.</span><span class="n">rHVEna_SP</span> <span class="o">&gt;</span> <span class="n">rHVEna_SP</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">stPump</span><span class="o">.</span><span class="n">rHVEna_SP</span> <span class="o">:=</span> <span class="n">rHVEna_SP</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Interlock</span> <span class="o">*</span><span class="p">)</span>
<span class="o">//</span><span class="n">stPump</span><span class="o">.</span><span class="n">xHV_ExtIlk</span>  <span class="o">:=</span> <span class="n">i_stGauge</span><span class="o">.</span><span class="n">xPRESS_OK</span> <span class="n">AND</span> <span class="p">(</span><span class="n">i_stGauge</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">&lt;=</span> <span class="n">stPump</span><span class="o">.</span><span class="n">rHVEna_SP</span><span class="p">);</span><span class="o">//</span><span class="n">AND</span> <span class="n">NOT</span> <span class="n">tPumpStartTimeout</span><span class="o">.</span><span class="n">Q</span><span class="p">);</span> <span class="o">//</span><span class="n">ADP</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Enable</span> <span class="n">HV</span> <span class="o">*</span><span class="p">)</span>
<span class="n">IF</span> <span class="n">i_stGauge</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">&lt;=</span> <span class="n">stPump</span><span class="o">.</span><span class="n">rHVEna_SP</span> <span class="n">AND</span> <span class="n">i_stGauge</span><span class="o">.</span><span class="n">xPRESS_OK</span> <span class="n">THEN</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">stPump</span><span class="o">.</span><span class="n">xAutoOn</span><span class="p">)</span> <span class="n">THEN</span>  <span class="n">stPump</span><span class="o">.</span><span class="n">q_xHVEna_DO</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">ELSE</span> <span class="n">stPump</span><span class="o">.</span><span class="n">q_xHVEna_DO</span> <span class="o">:=</span> <span class="n">stPump</span><span class="o">.</span><span class="n">xHVEna_SW</span><span class="p">;</span>  <span class="n">END_IF</span>
    <span class="n">stPump</span><span class="o">.</span><span class="n">xILKOk</span><span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">stPump</span><span class="o">.</span><span class="n">q_xHVEna_DO</span> <span class="n">AND</span> <span class="n">timer</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">q_IG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">stPump</span><span class="o">.</span><span class="n">rHVEna_SP</span> <span class="o">+</span> <span class="n">stPump</span><span class="o">.</span><span class="n">rHYS_PR</span><span class="p">)</span> <span class="n">THEN</span> <span class="o">//</span> <span class="n">Ion</span> <span class="n">pumps</span> <span class="n">when</span> <span class="n">running</span> <span class="n">switches</span> <span class="n">off</span> <span class="n">based</span> <span class="n">on</span> <span class="n">their</span> <span class="n">own</span> <span class="n">pressure</span> <span class="n">readings</span>
            <span class="n">stPump</span><span class="o">.</span><span class="n">q_xHVEna_DO</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="n">stPump</span><span class="o">.</span><span class="n">xHVEna_SW</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="n">stPump</span><span class="o">.</span><span class="n">xILKOk</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">ELSE</span>
            <span class="n">stPump</span><span class="o">.</span><span class="n">q_xHVEna_DO</span> <span class="o">:=</span> <span class="n">stPump</span><span class="o">.</span><span class="n">xHVEna_SW</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">ELSIF</span> <span class="p">(</span><span class="n">tonOvrd</span><span class="o">.</span><span class="n">Q</span> <span class="n">AND</span> <span class="n">i_xOverrideMode</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">stPump</span><span class="o">.</span><span class="n">q_xHVEna_DO</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">stPump</span><span class="o">.</span><span class="n">q_xHVEna_DO</span>  <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">stPump</span><span class="o">.</span><span class="n">xHVEna_SW</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">stPump</span><span class="o">.</span><span class="n">xILKOk</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>


<span class="o">//</span><span class="n">stPump</span><span class="o">.</span><span class="n">q_xHVEna_DO</span> <span class="o">:=</span> <span class="n">stPump</span><span class="o">.</span><span class="n">xHVEna_SW</span> <span class="n">AND</span> <span class="n">stPump</span><span class="o">.</span><span class="n">xHV_ExtIlk</span><span class="p">;</span>
<span class="o">//</span><span class="n">stPump</span><span class="o">.</span><span class="n">xHVEna_SW</span> <span class="o">:=</span> <span class="n">stPump</span><span class="o">.</span><span class="n">q_xHVEna_DO</span><span class="p">;</span>

<span class="n">timer</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span> <span class="n">NOT</span> <span class="n">stPump</span><span class="o">.</span><span class="n">q_xHVEna_DO</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span> <span class="n">T</span><span class="c1">#1s);</span>

<span class="o">//</span> <span class="n">TAW</span> <span class="n">Experimental</span> <span class="n">ion</span> <span class="n">pump</span> <span class="n">timeout</span>
<span class="n">tPumpStartTimeout</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="p">(</span><span class="n">NOT</span> <span class="n">stPump</span><span class="o">.</span><span class="n">i_xHV_DI</span> <span class="n">AND</span> <span class="n">stPump</span><span class="o">.</span><span class="n">q_xHVEna_DO</span><span class="p">));</span>
<span class="n">tTimeOutAction</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">tPumpStartTimeout</span><span class="o">.</span><span class="n">Q</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">tTimeOutAction</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>  <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Pump time out.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span> <span class="n">END_IF</span>



<span class="p">(</span><span class="o">*</span><span class="n">Pump</span> <span class="n">STATE</span><span class="o">*</span><span class="p">)</span>
<span class="n">IF</span> <span class="n">tPumpStartTimeout</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span> <span class="o">//</span><span class="n">Pump</span> <span class="n">timeout</span>
    <span class="n">stPump</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">pumpFAULT</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">stPump</span><span class="o">.</span><span class="n">q_xHVEna_DO</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">stPump</span><span class="o">.</span><span class="n">i_xHV_DI</span> <span class="n">THEN</span>
    <span class="n">stPump</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">pumpSTARTING</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">NOT</span> <span class="n">stPump</span><span class="o">.</span><span class="n">q_xHVEna_DO</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">stPump</span><span class="o">.</span><span class="n">i_xHV_DI</span> <span class="n">THEN</span>
    <span class="n">stPump</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">pumpSTOPPED</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">stPump</span><span class="o">.</span><span class="n">q_xHVEna_DO</span> <span class="n">AND</span> <span class="n">stPump</span><span class="o">.</span><span class="n">i_xHV_DI</span> <span class="n">THEN</span>
    <span class="n">stPump</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">pumpRUNNING</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">NOT</span> <span class="n">stPump</span><span class="o">.</span><span class="n">q_xHVEna_DO</span> <span class="n">AND</span> <span class="n">stPump</span><span class="o">.</span><span class="n">i_xHV_DI</span> <span class="n">THEN</span>
    <span class="n">stPump</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">pumpSTOPPING</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">stPump</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">pumpFAULT</span><span class="p">;</span>
<span class="n">END_IF</span>



<span class="p">(</span><span class="o">*</span><span class="n">Update</span> <span class="n">output</span> <span class="n">gauge</span> <span class="n">values</span><span class="o">*</span><span class="p">)</span>
<span class="n">ACT_SetGauge</span><span class="p">();</span>
<span class="p">(</span><span class="o">*</span><span class="n">Soft</span> <span class="n">IO</span> <span class="n">Mapping</span><span class="o">*</span><span class="p">)</span>
<span class="n">IO</span><span class="p">();</span>

<span class="o">//</span> <span class="n">Log</span> <span class="n">States</span> <span class="ow">and</span> <span class="n">triggers</span>
<span class="n">ACT_Logger</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>
<span class="n">ACTION</span> <span class="n">ACT_IlkOverride</span><span class="p">:</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Override</span> <span class="n">logic</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Goal</span><span class="p">:</span> <span class="n">give</span> <span class="n">ability</span> <span class="n">to</span> <span class="n">override</span><span class="p">,</span> <span class="n">but</span> <span class="n">do</span> <span class="n">so</span> <span class="ow">in</span> <span class="n">a</span> <span class="n">way</span> <span class="n">that</span> <span class="n">people</span> <span class="n">won</span><span class="s1">&#39;t forget it.</span>
<span class="n">Solution</span><span class="p">:</span> <span class="n">Override</span> <span class="n">only</span> <span class="n">after</span> <span class="n">ten</span> <span class="n">seconds</span> <span class="n">of</span> <span class="n">override</span><span class="p">,</span> <span class="n">protect</span> <span class="n">against</span> <span class="n">blips</span><span class="p">,</span>
<span class="n">when</span> <span class="n">the</span> <span class="n">Pump</span> <span class="n">permission</span> <span class="n">goes</span> <span class="n">true</span> <span class="k">for</span> <span class="n">more</span> <span class="n">than</span> <span class="n">ten</span> <span class="n">seconds</span> <span class="n">consistently</span><span class="p">,</span> <span class="n">remove</span> <span class="n">override</span>
<span class="o">*</span><span class="p">)</span>

<span class="n">tonDelOK</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">stPump</span><span class="o">.</span><span class="n">xILKOk</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#10S);</span>
<span class="n">rtOK</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">tonDelOK</span><span class="o">.</span><span class="n">Q</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">rtOK</span><span class="o">.</span><span class="n">Q</span> <span class="n">AND</span> <span class="n">stPump</span><span class="o">.</span><span class="n">pv_xOvrdStart</span> <span class="n">THEN</span>
    <span class="n">stPump</span><span class="o">.</span><span class="n">pv_xOvrdStart</span> <span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">stPump</span><span class="o">.</span><span class="n">eState</span> <span class="o">=</span> <span class="n">pumpRUNNING</span><span class="p">)</span> <span class="n">AND</span> <span class="p">(</span><span class="n">i_xOverrideMode</span><span class="p">)</span> <span class="n">THEN</span> <span class="n">stPump</span><span class="o">.</span><span class="n">xHVEna_SW</span><span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span> <span class="n">END_IF</span>
    <span class="o">//</span><span class="n">Log</span>
    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Override expired&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Warning</span><span class="p">);</span>
<span class="n">END_IF</span>
<span class="o">//</span> <span class="n">Release</span> <span class="n">the</span> <span class="n">Force</span> <span class="n">Open</span> <span class="n">bit</span> <span class="n">when</span> <span class="n">the</span> <span class="n">system</span> <span class="n">override</span> <span class="ow">is</span> <span class="n">false</span>
<span class="n">IF</span> <span class="n">NOT</span><span class="p">(</span><span class="n">i_xOverrideMode</span><span class="p">)</span> <span class="n">THEN</span> <span class="n">stPump</span><span class="o">.</span><span class="n">pv_xOvrdStart</span> <span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span> <span class="n">END_IF</span>
<span class="o">//</span><span class="n">Override</span> <span class="n">timer</span>
<span class="n">tonOvrd</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span> <span class="n">stPump</span><span class="o">.</span><span class="n">pv_xOvrdStart</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span><span class="n">tOvrd</span><span class="p">);</span>
<span class="n">END_ACTION</span>
<span class="n">ACTION</span> <span class="n">ACT_Logger</span><span class="p">:</span>
<span class="o">//</span> <span class="n">ILK</span> <span class="n">logger</span>
<span class="n">tAction</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span> <span class="p">);</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="p">(</span><span class="n">stPump</span><span class="o">.</span><span class="n">xILKOk</span><span class="p">)</span> <span class="n">AND</span> <span class="p">((</span><span class="n">ePrevState</span> <span class="o">=</span> <span class="n">pumpRUNNING</span><span class="p">)</span> <span class="n">OR</span> <span class="p">(</span><span class="n">ePrevState</span> <span class="o">=</span> <span class="n">pumpSTARTING</span><span class="p">))</span> <span class="n">THEN</span>
    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Pump turned off due to loss of interlock.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span>
<span class="n">END_IF</span>

<span class="o">//</span><span class="n">STATE</span> <span class="n">Logger</span>
<span class="n">IF</span> <span class="n">ePrevState</span> <span class="o">&lt;&gt;</span> <span class="n">stPump</span><span class="o">.</span><span class="n">eState</span> <span class="n">THEN</span>
      <span class="n">CASE</span> <span class="n">stPump</span><span class="o">.</span><span class="n">eState</span> <span class="n">OF</span>
            <span class="n">pumpFAULT</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Pump Fault.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span>
            <span class="n">pumpSTOPPED</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Pump stopped.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span>
            <span class="n">pumpSTARTING</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Pump starting.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span>
            <span class="n">pumpRUNNING</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Pump running.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span>
            <span class="n">pumpSTOPPING</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Pump stopping.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span>
      <span class="n">END_CASE</span>
      <span class="n">ePrevState</span> <span class="o">:=</span> <span class="n">stPump</span><span class="o">.</span><span class="n">eState</span><span class="p">;</span>
  <span class="n">END_IF</span>


  <span class="o">//</span> <span class="n">Log</span> <span class="n">Action</span>
<span class="n">tAction</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span>  <span class="n">stPump</span><span class="o">.</span><span class="n">q_xHVEna_DO</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">tAction</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span> <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Pump commanded to start&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span> <span class="n">END_IF</span>
<span class="o">//</span> <span class="n">Log</span> <span class="n">override</span> <span class="n">mode</span> <span class="n">enabled</span>
<span class="n">tOverrideActivated</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span> <span class="p">(</span><span class="n">tonOvrd</span><span class="o">.</span><span class="n">Q</span> <span class="n">AND</span> <span class="n">i_xOverrideMode</span><span class="p">));</span>
<span class="n">IF</span> <span class="n">tOverrideActivated</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span> <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Pump override mode activated&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Warning</span><span class="p">);</span> <span class="n">END_IF</span>


<span class="o">//</span> <span class="n">Log</span> <span class="n">FAULT</span>
<span class="n">tFault</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span>  <span class="n">NOT</span> <span class="n">tPumpStartTimeout</span><span class="o">.</span><span class="n">Q</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">tFault</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span> <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Pump Fault&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span> <span class="n">END_IF</span>
<span class="n">END_ACTION</span>
<span class="n">ACTION</span> <span class="n">ACT_SetGauge</span><span class="p">:</span>
<span class="p">(</span><span class="o">*</span><span class="n">MG</span><span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">convert</span> <span class="n">the</span> <span class="n">analog</span> <span class="nb">input</span> <span class="n">into</span> <span class="n">readable</span> <span class="n">pressure</span><span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">use</span> <span class="n">logarithmic</span> <span class="n">Pressure</span> <span class="n">calculation</span><span class="p">,</span> <span class="n">Output</span><span class="o">=</span> <span class="n">Normal</span> <span class="ow">and</span> <span class="n">Offset</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="p">)</span>
<span class="n">rV</span> <span class="o">:=</span> <span class="mi">10</span><span class="o">*</span><span class="n">INT_TO_REAL</span><span class="p">(</span><span class="n">i_iPress</span><span class="p">)</span><span class="o">/</span><span class="mi">32767</span><span class="p">;</span>
<span class="o">//</span><span class="n">Manual</span> <span class="n">Page</span> <span class="mi">9</span>

<span class="k">if</span> <span class="p">(</span><span class="n">stPump</span><span class="o">.</span><span class="n">bOutputInverted</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">rPRESS</span> <span class="o">:=</span> <span class="n">LREAL_TO_REAL</span><span class="p">(</span><span class="n">EXPT</span><span class="p">(</span><span class="mi">10</span><span class="p">,(</span><span class="n">rV</span><span class="o">-</span><span class="n">stPump</span><span class="o">.</span><span class="n">iOffset</span><span class="p">)</span><span class="o">*-</span><span class="mi">1</span><span class="p">));</span>
<span class="n">ELSE</span>
    <span class="n">rPRESS</span> <span class="o">:=</span> <span class="n">LREAL_TO_REAL</span><span class="p">(</span><span class="n">EXPT</span><span class="p">(</span><span class="mi">10</span><span class="p">,(</span><span class="n">rV</span><span class="o">-</span><span class="n">stPump</span><span class="o">.</span><span class="n">iOffset</span><span class="p">)));</span>
<span class="n">END_IF</span>
<span class="n">IF</span> <span class="p">(</span><span class="n">stPump</span><span class="o">.</span><span class="n">q_xHVEna_DO</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">q_IG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">:=</span> <span class="n">rPRESS</span><span class="p">;</span>
    <span class="n">stPump</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">:=</span> <span class="n">rPRESS</span><span class="p">;</span>
<span class="n">END_IF</span>


<span class="n">IF</span> <span class="p">(</span><span class="n">stPump</span><span class="o">.</span><span class="n">i_xHV_DI</span><span class="p">)</span> <span class="n">AND</span> <span class="p">(</span><span class="n">q_IG</span><span class="o">.</span><span class="n">rPRESS</span> <span class="o">&lt;</span> <span class="n">q_IG</span><span class="o">.</span><span class="n">rVAC_SP</span><span class="p">)</span> <span class="n">THEN</span> <span class="o">//</span><span class="n">ADP</span><span class="o">//</span> <span class="n">AND</span> <span class="p">(</span><span class="n">q_IG</span><span class="o">.</span><span class="n">rPRESS</span><span class="o">&lt;&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="n">AND</span> <span class="n">stPump</span><span class="o">.</span><span class="n">q_xHVEna_DO</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">q_IG</span><span class="o">.</span><span class="n">xPRESS_OK</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">ELSE</span>
    <span class="n">q_IG</span><span class="o">.</span><span class="n">xPRESS_OK</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">q_IG</span><span class="o">.</span><span class="n">sPath</span> <span class="o">:=</span> <span class="n">This</span><span class="o">^.</span><span class="n">stPump</span><span class="o">.</span><span class="n">sPath</span><span class="p">;</span>
<span class="n">END_ACTION</span>
<span class="n">ACTION</span> <span class="n">IO</span><span class="p">:</span>
<span class="n">stPump</span><span class="o">.</span><span class="n">sIlkDeviceName</span> <span class="o">:=</span> <span class="n">This</span><span class="o">^.</span><span class="n">i_stGauge</span><span class="o">.</span><span class="n">sPath</span><span class="p">;</span>
<span class="n">stPump</span><span class="o">.</span><span class="n">xError</span> <span class="o">:=</span> <span class="p">(</span><span class="n">stPump</span><span class="o">.</span><span class="n">eState</span> <span class="o">=</span> <span class="n">pumpFAULT</span><span class="p">);</span>

<span class="p">(</span><span class="o">*</span><span class="n">inputs</span><span class="o">*</span><span class="p">)</span>
<span class="n">stPump</span><span class="o">.</span><span class="n">i_iPRESS</span><span class="o">:=</span>   <span class="n">i_iPRESS</span><span class="p">;</span>
<span class="n">stPump</span><span class="o">.</span><span class="n">i_xHV_DI</span><span class="o">:=</span>   <span class="n">i_xSP_DI</span><span class="p">;</span>
<span class="p">(</span><span class="o">*</span><span class="n">output</span><span class="o">*</span><span class="p">)</span>
<span class="n">q_xHVEna_DO</span><span class="o">:=</span>  <span class="n">stPump</span><span class="o">.</span><span class="n">q_xHVEna_DO</span><span class="p">;</span> <span class="o">//</span><span class="n">According</span> <span class="n">to</span> <span class="n">Manual</span> <span class="n">pin</span> <span class="n">should</span> <span class="n">be</span> <span class="n">grounded</span> <span class="n">to</span> <span class="n">activate</span> <span class="n">function</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
</div>
<div class="section" id="fb-pip-test">
<h2>FB_PIP_Test<a class="headerlink" href="#fb-pip-test" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PIP_Test</span> <span class="n">EXTENDS</span> <span class="n">TcUnit</span><span class="o">.</span><span class="n">FB_TestSuite</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">PG</span> <span class="p">:</span> <span class="n">ST_VG</span><span class="p">;</span>
    <span class="n">fb_PIP_GAMMA</span><span class="p">:</span> <span class="n">FB_PIP_GAMMA</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">M_INIT</span><span class="p">();</span>
<span class="n">M_Interlock</span><span class="p">();</span>
<span class="n">M_AutoStart</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</div>
<div class="section" id="fb-pressurestate">
<h2>FB_PressureState<a class="headerlink" href="#fb-pressurestate" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(*Deprecated*)
FUNCTION_BLOCK FB_PressureState
VAR_INPUT
    i_rV    :       REAL;
    i_rVMin :       REAL := 0.01; // Anything less than this voltage is considered disconnected
    i_rVMax :       REAL := 10.5; // Anything more than this is considered invalid
    i_IGTurnOnTime  :       TIME := T#10S;

    i_MinPressure   :       REAL;
    i_MaxPressure   :       REAL;
END_VAR
VAR_OUTPUT
    q_eState        :       E_PressureState;
END_VAR
VAR_IN_OUT
    iq_stVG :       ST_VG;
END_VAR
VAR
    tonGaugeTurnOnTmr : TON;
END_VAR
(* Pressure State Evaluation
A. Wallace, 2016-8-31

This FB serves to evaluate the state of the pressure based on the raw voltage, pressure, and gauge state.

*)
// Is the gauge plugged in, and within a reasonable range?
IF i_rV &lt; i_rVMin THEN
    q_eState := GaugeDisconnected;
ELSIF i_rV &gt; i_rVMax THEN
    q_eState := PressInvalid;
ELSE
    // Is the gauge reading back a pressure that makes sense?
    CASE iq_stVG.eTYPE OF
            IG903:
                    tonGaugeTurnOnTmr(IN:=iq_stVG.q_xHV_DIS, PT:=i_IGTurnOnTime, Q=&gt;iq_stVG.xTurnOnTime);
                    IF iq_stVG.q_xHV_DIS THEN
                            IF tonGaugeTurnOnTmr.Q THEN
                                    IF iq_stVG.rPRESS &gt;= i_MinPressure AND iq_stVG.rPRESS &lt;= i_MaxPressure THEN
                                            q_eState := Valid;
                                    ELSE
                                            q_eState := OoR;
                                    END_IF
                            ELSE
                                            q_eState := Starting;
                            END_IF
                    ELSE
                            q_eState := Off;
                    END_IF
            IG909:
                    IF iq_stVG.q_xHV_DIS THEN
                            IF iq_stVG.rPRESS &gt;= i_MinPressure AND iq_stVG.rPRESS &lt;= i_MaxPressure THEN
                                    q_eState := Valid;
                            ELSE
                                    q_eState := OoR;
                            END_IF
                    ELSE
                            q_eState := Off;
                    END_IF
            PG907, PG925, PG722B:
                    IF iq_stVG.rPRESS &gt;= i_MinPressure AND iq_stVG.rPRESS &lt;= i_MaxPressure THEN
                            q_eState := Valid;
                    ELSIF iq_stVG.rPRESS &lt; i_MinPressure THEN
                            q_eState := ValidLo;
                    ELSE
                            q_eState := ValidHi;
                    END_IF
            ELSE
                    q_eState := PressInvalid;
    END_CASE
END_IF


iq_stVG.eState := q_eState;

// Legacy Press OK boolean eval
iq_stVG.xPRESS_OK := q_eState &gt;= gc_GaugeValidState;

END_FUNCTION_BLOCK
</pre></div>
</div>
</div>
<div class="section" id="fb-ptm-agilent">
<h2>FB_PTM_Agilent<a class="headerlink" href="#fb-ptm-agilent" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(* This function block does basic controls FOR the Agilent TV Turbo pump. Turns off pump
in the event of errors/ warnings. Provides interlocking interface.*)
FUNCTION_BLOCK FB_PTM_Agilent EXTENDS FB_Pump
VAR_IN_OUT

END_VAR
VAR_INPUT
    i_xExtILKOk : BOOL; // Connect to external interlock logic(e.g TURBO_ILK Function), TRUE if not used.
    i_stGauge       :       ST_VG; //Pirani backing gauge for pump interlock
    i_rMaxBackingPressure : REAL;
END_VAR
VAR_OUTPUT
    {attribute &#39;pytmc&#39; :=&#39; pv:&#39;}
    iq_stPtm        :       ST_AgilentPTM;

END_VAR
VAR
    {attribute &#39;instance-path&#39;}
    {attribute &#39;noinit&#39;}
    sPath: STRING;
    //xRunOk        :       BOOL;
    nMaxR1Fault: INT :=5;
    nR1Fault : INT;
    tFaultWindowDuration : TIME := T#300S;
    tR1FaultDuration : TIME := T#120S;
    tTimeOutDuration: TIME:= T#10M;
    tFaultWindowElapsed: TON;
    tR1Fault : TON;
    tStartTimeOut : TON;
    tR1TimeOut: TON;
    step : INT :=0;
    nErrorCode: INT :=0;
    xBackingPressureOK: BOOL;
    iMaxSpeed : INT:=963;

    (*I/Os*)
    i_xSTART        AT%I*:  BOOL;
    i_xR1   AT%I*   :  BOOL;
    i_xR2   AT%I*   :  BOOL;
    i_xLSpd AT%I*:  BOOL;
    i_iTempMon AT%I*: INT;
    i_iPowerMon AT%I*: INT;
    i_iCurrentMon AT%I*: INT;
    i_iRawSpeed AT %I* : INT; // Link to Analog input
    i_xFault AT%I*  :       BOOL;
    q_RunDO AT%Q*   :       BOOL;
    q_xLSpd AT%Q*   :  BOOL;


    // For logging
  //  Msg : FB_FormatString;
   // fbJson : FB_JsonSaxWriter;
   tOverrideActivated : R_TRIG;

    iTermBits: UINT := 32767 ; // The terminal&#39;s maximum value in bits
END_VAR
(* Basic Agilent Turbo Controls *)
(* M. Ghaly, 2018-9-26 *)

(*connect External interlock to structure variable*)
//iq_stPtm.xExtRunOk := i_xExtILKOk;

(* state machine *)
CASE (step) OF
(*Pump Stopped State*)
    0: // Pump Stopped State
            iq_stPtm.xRunSW:=FALSE;
            //Reset Output signals;
            iq_stPtm.q_RunDO:=FALSE;
            iq_stPtm.q_xSS := FALSE;
            iq_stPtm.q_xLSpd:= FALSE;
            //Reset timer
            tFaultWindowElapsed.IN := FALSE;
            nR1Fault := 0;
            iq_stPtm.eState := pumpSTOPPED;
            step :=10;

(*Idle State waiting to start*)
    10: // Idle State, waiting for the xRunSwitch
            IF iq_stPtm.xExtRunOk  AND iq_stPTM.xRunSW THEN
                    iq_stPtm.q_RunDO := iq_stPTM.xRunSW; //
                    step:=20;
            END_IF
(*Pump Starting State*)
    20: // Pump is starting
            nErrorCode:=0;
            iq_stPtm.q_RunDO := iq_stPTM.xRunSW; // done in previous state
            IF (*(NOT iq_stPtm.i_xR1) AND*)iq_stPtm.i_xSTART  THEN
            iq_stPtm.eState := pumpSTARTING;
            step:= 40;
            ELSIF tStartTimeOut.Q THEN
                    step:=90; // or fault state
                    nErrorCode:=950;
            END_IF
            // should check R1 ?? check Fault condition?


    40: // Pump is starting
            iq_stPtm.eState := pumpSTARTING;
            IF   NOT iq_stPtm.i_xR1 AND NOT iq_stPtm.i_xSTART  THEN
                    step := 0 ;
            ELSIF NOT iq_stPtm.i_xR1 AND iq_stPtm.i_xSTART  THEN
                    step :=40;
            ELSIF iq_stPtm.i_xR1 AND NOT iq_stPtm.i_xSTART THEN
                    step:= 50;
            END_IF
            IF tR1TimeOut.Q THEN
                    step:= 90;
                    iq_stPtm.xPumpFaultLock := TRUE;
                    nErrorCode:= 930; // R1 Signal at Start time out.
           // fbLogger(sMsg:=&#39;Timeout: Pump could not achieve running speed.&#39;, eSevr:=TcEventSeverity.Warning);
            END_IF

    50: // Pump is Running (Normal Operation) ( R1 is True and STARTing is FALSE)
            iq_stPtm.eState := pumpRUNNING;
            IF NOT iq_stPtm.i_xR1 THEN
                    nR1Fault:= nR1Fault+1 ;
                    tFaultWindowElapsed.IN := TRUE; ///
                    //tR1Fault.IN := TRUE;
                    step :=60;
            END_IF

        //Log new state
        IF ePrevState &lt;&gt; iq_stPtm.eState THEN
            //fbLogger(sMsg:=&#39;Pump at speed.&#39;, eSevr:=TcEventSeverity.Verbose);
            ePrevState := iq_stPtm.eState;
            END_IF

    60: // Pump is Running (Not Nomral Operation) (R1 is False, pump not @ speed )
            IF ((nR1Fault = nMaxR1Fault) AND NOT tFaultWindowElapsed.Q) OR (tR1Fault.Q) THEN // number of fault occured during the same time window
                    step:= 90;
                    tR1Fault.IN := FALSE;
                    tFaultWindowElapsed.IN := FALSE;
                    iq_stPtm.xPumpFaultLock := TRUE;
                    nErrorCode:= 920; // R1 Signal Lost multiple times.
            //fbLogger(sMsg:=&#39;Running signal Lost multiple times.&#39;, eSevr:=TcEventSeverity.Warning);
            ELSIF tFaultWindowElapsed.Q  THEN
                    tFaultWindowElapsed.IN := FALSE;
                    nR1Fault := 0;
            ELSIF iq_stPtm.i_xR1 THEN
                    tR1Fault.IN := FALSE;
                    step:=50;
            END_IF

    90: // Pump Fault STATE
            iq_stPtm.xRunSW:=FALSE;
            iq_stPtm.q_RunDO:=FALSE;
            iq_stPtm.q_xSS := FALSE;
            iq_stPtm.q_xLSpd:= FALSE;
            iq_stPtm.eState := pumpFAULT;
            step := 95;

    95:
            IF (NOT iq_stPtm.xPumpFaultLock) OR iq_stPtm.xRunSW THEN
                    step:=0;
            END_IF
END_CASE

(* Interrupts *)
(* FAULT signal*)
IF (iq_stPtm.i_xFault) AND (step &lt; 90 ) THEN
    iq_stPtm.eState := pumpFAULT; // no need taken care of in the state
    iq_stPtm.xPumpFaultLock := TRUE;
    nErrorCode := 900; // Pump Controller FAULT
    step:=90;
END_IF


(*Pump Lock Reset bit*)
IF (iq_stPtm.xResetSW ) THEN
    iq_stPtm.xResetSW := FALSE;
    iq_stPtm.xPumpFaultLock := FALSE;
END_IF

(*Check backing gauge pressure*)
//xBackingPressureOK := i_stGauge.xPRESS_OK AND ( i_stGauge.rPRESS &lt; iq_stPtm.rBackingPressureSP);

(* Interlock Sum *)
iq_stPtm.xExtRunOk := i_xExtILKOk AND NOT iq_stPtm.i_xFault AND NOT iq_stPtm.xPumpFaultLock;// AND xBackingPressureOK;

IF NOT iq_stPtm.xExtRunOk AND (NOT (step &gt;= 90)) THEN
    step:=0;
END_IF

(*Stop By the Operator and not due to fault *)
IF (NOT iq_stPtm.xRunSW) AND (NOT (step &gt;= 90)) AND (NOT (step = 10)) THEN
    step := 0;
END_IF

// Log faults Moved to ACT_Logger
(*tErrorPresent(CLK:=iq_stPtm.xPumpFaultLock);
IF tErrorPresent.Q THEN
    fbJson.StartObject();
    fbJson.AddKey(&#39;vacuum_typecode&#39;);
    fbJson.AddUdint(nErrorCode);
    fbJson.EndObject();
    fbLogger.sJson := fbJson.GetDocument();
    fbLogger(sMsg:=&#39;Turbo control fault&#39;, eSevr:=TcEventSeverity.Warning);
    fbJson.ResetDocument();
END_IF
*)

(* Timers *)
tFaultWindowElapsed(PT:=tFaultWindowDuration);
tR1Fault(IN:= (step = 60), PT:=tR1FaultDuration);
tStartTimeOut(IN := (step=20), PT:=tTimeOutDuration);
tR1TimeOut(IN := (step=40), PT:=tTimeOutDuration);
(* IO Mapping*)
IO();
(*Assign Error Message*)
iq_stPtm.sError := ErrorMessage(nErrorCode, iq_stPtm.eState);
// Log States and triggers
ACT_Logger();
(*Validate Backing Pressure set point doesn&#39;t exceed the Maximum backingPressure*)
iq_stPtm.rBackingPressureSP := BackingPressureSetPoint(iq_stPtm.rBackingPressureSP,i_rMaxBackingPressure);

END_FUNCTION_BLOCK
ACTION ACT_Logger:
//STATE Logger
// ILK logger
IF NOT i_xExtIlkOK AND ePrevState = pumpRUNNING THEN
            fbLogger(sMsg:=&#39;Lost external interlock while pump was running.&#39;, eSevr:=TcEventSeverity.Critical);
END_IF


IF ePrevState &lt;&gt; iq_stPTM.eState THEN
      CASE iq_stPTM.eState OF
            pumpFAULT:
                    fbLogger(sMsg:=&#39;Pump Fault.&#39;, eSevr:=TcEventSeverity.Critical);
            pumpSTOPPED:
                    fbLogger(sMsg:=&#39;Pump stopped.&#39;, eSevr:=TcEventSeverity.Critical);
            pumpSTARTING:
                    fbLogger(sMsg:=&#39;Pump starting.&#39;, eSevr:=TcEventSeverity.Info);
            pumpRUNNING:
                    fbLogger(sMsg:=&#39;Pump running.&#39;, eSevr:=TcEventSeverity.Info);
      END_CASE
      ePrevState := iq_stPTM.eState;
  END_IF

// Log Action
tAction(CLK:=  iq_stPTM.q_RunDO);
IF tAction.Q THEN fbLogger(sMsg:=&#39;Pump commanded to start&#39;, eSevr:=TcEventSeverity.Info); END_IF


// Log FAULT
tFault(CLK:= iq_stPTM.i_xFault OR iq_stPtm.xPumpFaultLock);
IF tFault.Q THEN fbLogger(sMsg:=iq_stPtm.sError, eSevr:=TcEventSeverity.Critical); END_IF
END_ACTION
ACTION IO:
(*inputs*)
iq_stPtm.i_xSTART:= i_xSTART;
iq_stPtm.i_xR1:=    i_xR1;
iq_stPtm.i_xR2:=    i_xR2;
iq_stPtm.i_xLSpd:=  i_xLSpd;
iq_stPtm.i_xFault:= i_xFault;
(* Real-value calculation *)
If (iTermBits=0) THEN iTermBits := 32767;END_IF
iq_stPtm.i_rCurrentMon := 10*INT_TO_REAL(i_iCurrentMon)/iTermBits; // 1v is equal to 1A  Manual page 73
iq_stPtm.i_rTempMon := 10*INT_TO_REAL(i_iTempMon)/iTermBits; // 1v is equal to 1A  Manual page 73
iq_stPtm.i_rPowerMon := 10*INT_TO_REAL(i_iPowerMon)/iTermBits; // 1v is equal to 1A  Manual page 73
iq_stPtm.i_diCurSpd := 10*LREAL_TO_DINT(INT_TO_REAL(i_iRawSpeed)/iTermBits); // 1v is equal to 1A  Manual page 73


(*outputs*)
q_RunDO := iq_stPtm.q_RunDO;
q_xLSpd := iq_stPtm.q_xLSpd;
END_ACTION
</pre></div>
</div>
</div>
<div class="section" id="fb-ptm-ebara-010m">
<h2>FB_PTM_Ebara_010M<a class="headerlink" href="#fb-ptm-ebara-010m" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">function</span> <span class="n">block</span> <span class="n">does</span> <span class="n">basic</span> <span class="n">controls</span> <span class="n">FOR</span> <span class="n">the</span> <span class="n">Ebara</span> <span class="n">Turbo</span> <span class="n">pump</span> <span class="n">connected</span> <span class="n">to</span> <span class="n">the</span> <span class="n">ETC010M</span> <span class="n">Controller</span><span class="o">.</span>
 <span class="n">Turns</span> <span class="n">off</span> <span class="n">pump</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">event</span> <span class="n">of</span> <span class="n">errors</span><span class="o">/</span> <span class="n">warnings</span><span class="o">.</span> <span class="n">Provides</span> <span class="n">interlocking</span> <span class="n">interface</span><span class="o">.*</span><span class="p">)</span>
 <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;no_check&#39;</span><span class="p">}</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PTM_Ebara_010M</span> <span class="n">EXTENDS</span> <span class="n">FB_Pump</span>
<span class="n">VAR_IN_OUT</span>

<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">i_xExtILKOk</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Turbo</span> <span class="n">ILK</span> <span class="n">bit</span> <span class="p">,</span> <span class="nb">set</span> <span class="n">to</span> <span class="kc">True</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">used</span>
    <span class="o">//</span><span class="n">i_iRawSpeed</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span> <span class="o">//</span><span class="n">Should</span> <span class="n">come</span> <span class="kn">from</span> <span class="nn">PLC</span> <span class="n">Soft</span> <span class="n">IO</span><span class="o">.</span>
    <span class="n">i_rMaxBackingPressure</span> <span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="n">i_iMinSpeed</span> <span class="p">:</span> <span class="n">DINT</span> <span class="o">:=</span> <span class="mi">100</span><span class="p">;</span> <span class="o">//</span><span class="n">Hz</span> <span class="n">check</span> <span class="n">pump</span> <span class="n">manual</span> <span class="k">for</span> <span class="n">setting</span> <span class="n">P43</span>
    <span class="n">i_iMaxSpeed</span> <span class="p">:</span> <span class="n">DINT</span> <span class="o">:=</span> <span class="mi">560</span><span class="p">;</span> <span class="o">//</span><span class="n">Hz</span> <span class="n">check</span> <span class="n">pump</span> <span class="n">manual</span> <span class="k">for</span> <span class="n">setting</span> <span class="n">P43</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span>
    <span class="s1">&#39;}</span>
    <span class="n">iq_stPTM</span> <span class="p">:</span> <span class="n">ST_EbaraPTM</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">i_iADCBits</span> <span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">15</span><span class="p">;</span>
    <span class="n">RTRIG_INLK</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">TOF_RESET</span><span class="p">:</span> <span class="n">TON</span> <span class="o">:=</span><span class="p">(</span><span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#1S);</span>
    <span class="n">TOF_SetSpeed</span><span class="p">:</span> <span class="n">TON</span> <span class="o">:=</span><span class="p">(</span><span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#1S);</span>

    <span class="p">(</span><span class="o">*</span><span class="n">IO</span><span class="o">*</span><span class="p">)</span>
    <span class="p">(</span><span class="o">*</span><span class="n">inputs</span><span class="o">*</span><span class="p">)</span>
    <span class="n">i_xDecel</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">Link</span> <span class="n">to</span> <span class="n">brake</span> <span class="nb">input</span>
    <span class="n">i_xAccel</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">i_xRotate</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">i_xNCFault</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span><span class="o">//</span>
    <span class="n">i_xAtSpd</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">i_iRawSpeed</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span> <span class="o">//</span> <span class="n">Link</span> <span class="n">to</span> <span class="n">Analog</span> <span class="nb">input</span>
    <span class="n">i_iTempMon</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span> <span class="o">//</span> <span class="n">Link</span> <span class="n">to</span> <span class="n">Analog</span> <span class="nb">input</span> <span class="o">--</span> <span class="nb">input</span> <span class="n">Voltage</span> <span class="n">according</span> <span class="n">to</span> <span class="n">the</span> <span class="n">pump</span> <span class="n">temprature</span> <span class="mi">0</span><span class="o">-&gt;</span><span class="mi">5</span><span class="n">V</span> <span class="mi">0</span><span class="o">-&gt;</span><span class="mi">100</span><span class="n">C</span>
    <span class="n">i_iCurrentMon</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span> <span class="o">//</span><span class="n">Link</span> <span class="n">to</span> <span class="n">Analog</span> <span class="o">--</span> <span class="nb">input</span> <span class="n">Voltage</span> <span class="n">to</span> <span class="n">the</span> <span class="n">output</span> <span class="n">current</span> <span class="n">of</span> <span class="n">motor</span> <span class="mi">0</span><span class="o">-&gt;</span><span class="mi">5</span><span class="n">V</span> <span class="mi">0</span><span class="o">-&gt;</span><span class="mi">10</span><span class="n">A</span>

    <span class="p">(</span><span class="o">*</span><span class="n">output</span><span class="o">*</span><span class="p">)</span>
    <span class="n">q_xStart</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">link</span> <span class="n">to</span> <span class="n">output</span>
    <span class="n">q_xStop</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">Link</span> <span class="n">to</span> <span class="n">output</span>
    <span class="n">q_xReset</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">q_xProtection</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">q_xSetSpeed</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">q_iSpeedSet</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span> <span class="p">:</span><span class="n">INT</span><span class="p">;</span>        <span class="o">//</span><span class="n">Link</span> <span class="n">to</span> <span class="n">analog</span> <span class="n">Output</span>

<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Ebara</span> <span class="n">ETC</span> <span class="n">control</span> <span class="n">FB</span>
<span class="n">Scott</span> <span class="n">Stubbs</span> <span class="o">&amp;</span> <span class="n">Alex</span> <span class="n">W</span><span class="o">.</span>
<span class="n">Modified</span> <span class="n">Nov</span> <span class="mi">2018</span> <span class="n">by</span> <span class="n">M</span><span class="o">.</span> <span class="n">Ghaly</span>
<span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">The</span> <span class="n">pump</span> <span class="n">runs</span> <span class="n">when</span> <span class="n">the</span> <span class="n">RunDO</span> <span class="ow">is</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">true</span><span class="o">.</span> <span class="n">The</span> <span class="n">RunDO</span> <span class="n">sets</span> <span class="n">the</span> <span class="n">outputs</span> <span class="n">Start</span> <span class="ow">and</span> <span class="n">Stop</span> <span class="n">to</span> <span class="n">true</span> <span class="n">when</span> <span class="n">it</span>
<span class="ow">is</span> <span class="n">true</span><span class="p">,</span> <span class="ow">and</span> <span class="n">false</span> <span class="n">otherwise</span><span class="o">.</span> <span class="n">Per</span> <span class="n">the</span> <span class="n">manual</span><span class="p">,</span> <span class="n">when</span> <span class="n">START</span> <span class="n">bit</span> <span class="ow">is</span> <span class="n">closed</span> <span class="n">the</span> <span class="n">pump</span> <span class="n">will</span> <span class="n">accelerate</span><span class="p">,</span> <span class="ow">and</span> <span class="n">when</span> <span class="n">the</span> <span class="n">STOP</span>
<span class="n">bit</span> <span class="ow">is</span> <span class="n">Opened</span><span class="p">,</span> <span class="n">the</span> <span class="n">pump</span> <span class="n">will</span> <span class="n">decelerate</span> <span class="k">with</span> <span class="n">the</span> <span class="n">brake</span> <span class="ow">and</span> <span class="n">stop</span> <span class="o">*</span><span class="p">)</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Simple</span> <span class="n">protection</span> <span class="n">reset</span> <span class="o">*</span><span class="p">)</span>
<span class="n">iq_stPtm</span><span class="o">.</span><span class="n">xExtRunOk</span><span class="o">:=</span> <span class="n">i_xExtILKOk</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">i_xFault</span><span class="p">;</span>
<span class="n">iq_stPTM</span><span class="o">.</span><span class="n">q_xProtection</span><span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span><span class="o">//</span><span class="n">iq_stPTM</span><span class="o">.</span><span class="n">xExtRunOk</span><span class="p">;</span>
<span class="p">(</span><span class="o">*</span><span class="n">soft</span> <span class="n">IO</span> <span class="n">mapping</span><span class="o">*</span><span class="p">)</span>
<span class="n">ACT_IO</span><span class="p">();</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Basic</span> <span class="n">pump</span> <span class="n">supervisory</span> <span class="n">section</span> <span class="o">*</span><span class="p">)</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">If</span> <span class="n">override</span> <span class="n">mode</span><span class="p">,</span> <span class="n">ignore</span> <span class="n">everything</span> <span class="k">else</span> <span class="o">*</span><span class="p">)</span>
<span class="n">IF</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">i_xOverride</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">xRunSW</span> <span class="n">THEN</span>
            <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">q_RunDO</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">ELSE</span>
            <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">q_RunDO</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">END_IF</span>
    <span class="o">//</span><span class="n">Handle</span> <span class="n">faults</span>
<span class="n">ELSIF</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">i_xFault</span> <span class="n">OR</span> <span class="p">(</span> <span class="n">NOT</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">xExtRunOk</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">q_RunDO</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">xRunSW</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="o">//</span><span class="n">And</span> <span class="n">one</span> <span class="k">for</span> <span class="n">when</span> <span class="n">we</span> <span class="n">need</span> <span class="n">to</span> <span class="n">start</span> <span class="n">the</span> <span class="n">pump</span> <span class="n">normally</span><span class="o">.</span> <span class="n">Only</span> <span class="n">allows</span> <span class="n">pump</span> <span class="n">to</span> <span class="n">be</span> <span class="n">started</span> <span class="k">if</span> <span class="n">ILK</span> <span class="n">ok</span><span class="o">.</span>
<span class="n">ELSIF</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">xRunSW</span> <span class="n">AND</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">xExtRunOk</span> <span class="n">THEN</span>
    <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">q_RunDO</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="o">//</span><span class="n">One</span> <span class="n">section</span> <span class="k">for</span> <span class="n">when</span> <span class="n">pump</span> <span class="ow">is</span> <span class="n">told</span> <span class="n">to</span> <span class="n">stop</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">xRunSW</span> <span class="n">THEN</span>
            <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">q_RunDO</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="o">//</span><span class="n">IF</span> <span class="p">(</span><span class="n">NOT</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">i_xFault</span><span class="p">)(</span><span class="o">*</span> <span class="n">AND</span> <span class="p">(</span><span class="n">NOT</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">i_xALARM</span><span class="p">)</span> <span class="o">*</span><span class="p">)</span><span class="n">THEN</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">pumpSTOPPED</span><span class="p">;</span> <span class="n">END_IF</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span><span class="n">Set</span> <span class="n">the</span> <span class="n">Start</span> <span class="ow">and</span> <span class="n">Stop</span> <span class="n">outputs</span> <span class="n">to</span> <span class="n">Run</span> <span class="n">do</span> <span class="o">.</span> <span class="n">check</span> <span class="n">manual</span> <span class="n">alternate</span> <span class="n">START</span><span class="o">/</span><span class="n">STOP</span>
<span class="n">iq_stPTM</span><span class="o">.</span><span class="n">q_xStart</span> <span class="o">:=</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">q_RunDO</span><span class="p">;</span>
<span class="n">iq_stPTM</span><span class="o">.</span><span class="n">q_xStop</span> <span class="o">:=</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">q_RunDO</span><span class="p">;</span>



 <span class="p">(</span><span class="o">*</span> <span class="n">to</span> <span class="n">reset</span> <span class="n">the</span> <span class="n">Input</span> <span class="n">speed</span> <span class="n">OK</span> <span class="n">bit</span> <span class="o">*</span><span class="p">)</span>
 <span class="n">TOF_SetSpeed</span> <span class="p">(</span><span class="n">IN</span><span class="o">:=</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">iq_xSpeedSet</span><span class="p">,</span> <span class="n">Q</span> <span class="o">=&gt;</span> <span class="p">);</span>
 <span class="n">IF</span>  <span class="p">(</span><span class="n">TOF_SetSpeed</span><span class="o">.</span><span class="n">Q</span><span class="p">)</span> <span class="n">THEN</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">iq_xSpeedSet</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
 <span class="n">END_IF</span>
 <span class="p">(</span><span class="o">*</span> <span class="n">to</span> <span class="n">reset</span> <span class="n">the</span> <span class="n">Reset</span> <span class="n">Bit</span> <span class="o">*</span><span class="p">)</span>
 <span class="n">IF</span> <span class="p">(</span><span class="n">iq_stPTM</span><span class="o">.</span><span class="n">xResetSW</span> <span class="p">)</span> <span class="n">THEN</span>  <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">q_xReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
 <span class="n">END_IF</span>
 <span class="n">TOF_RESET</span> <span class="p">(</span><span class="n">IN</span><span class="o">:=</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">q_xReset</span><span class="p">,</span> <span class="n">Q</span> <span class="o">=&gt;</span> <span class="p">);</span>
 <span class="n">IF</span> <span class="n">TOF_RESET</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">q_xReset</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">xResetSW</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
 <span class="n">END_IF</span>
 <span class="p">(</span><span class="o">*</span><span class="n">When</span> <span class="n">the</span> <span class="n">Protection</span> <span class="n">signal</span> <span class="ow">is</span> <span class="n">lost</span><span class="p">,</span> <span class="n">Error</span> <span class="n">bit</span> <span class="n">doesn</span><span class="s1">&#39;t show, but the controller still needs to be reset*)</span>
<span class="n">RTRIG_INLK</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">q_xProtection</span> <span class="p">);</span>
 <span class="n">IF</span> <span class="p">(</span><span class="n">RTRIG_INLK</span><span class="o">.</span><span class="n">Q</span><span class="p">)</span> <span class="n">AND</span> <span class="p">(</span><span class="n">iq_stPTM</span><span class="o">.</span><span class="n">i_xNCFault</span><span class="p">)</span> <span class="n">THEN</span>
     <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">q_xReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
 <span class="n">END_IF</span>



<span class="p">(</span><span class="o">*</span><span class="n">Validate</span> <span class="n">Backing</span> <span class="n">Pressure</span> <span class="nb">set</span> <span class="n">point</span> <span class="n">doesn</span><span class="s1">&#39;t exceed the Maximum backingPressure*)</span>
<span class="n">iq_stPtm</span><span class="o">.</span><span class="n">rBackingPressureSP</span> <span class="o">:=</span> <span class="n">BackingPressureSetPoint</span><span class="p">(</span><span class="n">iq_stPtm</span><span class="o">.</span><span class="n">rBackingPressureSP</span><span class="p">,</span><span class="n">i_rMaxBackingPressure</span><span class="p">);</span>


 <span class="p">(</span><span class="o">*</span><span class="n">Pump</span> <span class="n">STATE</span><span class="o">*</span><span class="p">)</span>
<span class="n">IF</span> <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">i_xFault</span> <span class="n">THEN</span>
    <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">pumpFAULT</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">i_xDecel</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">q_RunDO</span> <span class="n">THEN</span>
    <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">pumpSTOPPING</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">NOT</span> <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">q_RunDO</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">i_xFault</span> <span class="n">THEN</span>
    <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">pumpSTOPPED</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">NOT</span> <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">i_xAtSpd</span>  <span class="n">AND</span> <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">q_RunDO</span> <span class="n">AND</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">i_xAccel</span> <span class="n">THEN</span>
    <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">pumpSTARTING</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">i_xAtSpd</span> <span class="n">AND</span> <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">q_RunDO</span> <span class="n">THEN</span>
    <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">pumpRUNNING</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">pumpFAULT</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="p">(</span><span class="o">*</span><span class="n">soft</span> <span class="n">IO</span> <span class="n">mapping</span><span class="o">*</span><span class="p">)</span>
<span class="n">ACT_IO</span><span class="p">();</span>
<span class="o">//</span> <span class="n">Log</span> <span class="n">States</span> <span class="ow">and</span> <span class="n">triggers</span>
<span class="n">ACT_Logger</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>
<span class="n">ACTION</span> <span class="n">ACT_IO</span><span class="p">:</span>
<span class="p">(</span><span class="o">*</span><span class="n">soft</span> <span class="n">io</span> <span class="n">mapping</span><span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span><span class="n">inputs</span><span class="o">*</span><span class="p">)</span>
    <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">i_xDecel</span> <span class="o">:=</span> <span class="n">i_xDecel</span> <span class="p">;</span>
    <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">i_xAccel</span> <span class="o">:=</span>    <span class="n">i_xAccel</span> <span class="p">;</span>
    <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">i_xRotate</span> <span class="o">:=</span>   <span class="n">i_xRotate</span><span class="p">;</span>
    <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">i_xFault</span> <span class="o">:=</span> <span class="n">NOT</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">i_xNCFault</span><span class="p">;</span>   <span class="o">//</span><span class="n">Normally</span> <span class="n">closed</span> <span class="n">fault</span> <span class="n">handling</span>
    <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">i_xNCFault</span> <span class="o">:=</span>  <span class="n">i_xNCFault</span> <span class="p">;</span>
    <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">i_xALARM</span><span class="o">:=</span> <span class="n">NOT</span> <span class="n">i_xNCFault</span><span class="p">;</span>
    <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">i_xAtSpd</span> <span class="o">:=</span> <span class="n">i_xAtSpd</span><span class="p">;</span>
    <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">i_rTempMon</span> <span class="o">:=</span> <span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="n">INT_TO_REAL</span><span class="p">(</span><span class="n">i_iTempMon</span><span class="p">)</span><span class="o">/</span><span class="mi">16383</span><span class="p">));</span><span class="o">//</span> <span class="n">Manual</span> <span class="n">page</span> <span class="mi">28</span><span class="p">(</span><span class="n">DC</span> <span class="mi">0</span> <span class="n">to</span> <span class="mi">5</span><span class="n">V</span> <span class="o">-&gt;</span> <span class="mi">0</span> <span class="n">to</span> <span class="mi">100</span> <span class="n">DegC</span><span class="p">)</span>
    <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">i_rCurrentMon</span> <span class="o">:=</span> <span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="p">(</span><span class="n">INT_TO_REAL</span><span class="p">(</span><span class="n">i_iCurrentMon</span><span class="p">)</span><span class="o">/</span><span class="mi">16383</span><span class="p">));</span><span class="o">//</span> <span class="n">Manual</span> <span class="n">page</span> <span class="mi">28</span> <span class="p">(</span><span class="n">DC</span> <span class="mi">0</span> <span class="n">to</span> <span class="mi">5</span><span class="n">V</span> <span class="o">-&gt;</span> <span class="mi">0</span> <span class="n">to</span> <span class="mi">10</span> <span class="n">A</span><span class="p">)</span>
    <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">i_diCurSpd</span> <span class="o">:=</span> <span class="n">LREAL_TO_DINT</span><span class="p">(</span><span class="mi">560</span><span class="o">*</span><span class="n">LREAL_TO_DINT</span><span class="p">(</span><span class="n">i_iRawSpeed</span><span class="p">)</span><span class="o">/</span><span class="mi">16383</span><span class="p">);</span><span class="o">//</span><span class="p">(</span><span class="mi">560</span><span class="o">*</span><span class="p">(</span><span class="n">INT_TO_REAL</span><span class="p">(</span><span class="n">i_iRawSpeed</span><span class="p">)</span><span class="o">/</span><span class="mi">16383</span><span class="p">));</span><span class="o">//</span> <span class="n">Manual</span> <span class="n">page</span> <span class="mi">28</span> <span class="p">(</span><span class="n">DC</span> <span class="mi">0</span> <span class="n">to</span> <span class="mi">5</span><span class="n">V</span> <span class="o">-&gt;</span> <span class="mi">100</span> <span class="n">to</span> <span class="mi">560</span><span class="n">Hz</span> <span class="n">Rated</span> <span class="n">Rotational</span> <span class="n">Speed</span> <span class="p">)</span>
<span class="p">(</span><span class="o">*</span><span class="n">outputs</span><span class="o">*</span><span class="p">)</span>
    <span class="n">q_xStart</span><span class="o">:=</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">q_xStart</span><span class="p">;</span>
    <span class="n">q_xStop</span> <span class="o">:=</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">q_xStop</span><span class="p">;</span>
    <span class="n">q_xReset</span> <span class="o">:=</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">q_xReset</span><span class="p">;</span>
    <span class="n">q_xProtection</span> <span class="o">:=</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">q_xProtection</span><span class="p">;</span>
    <span class="n">q_xSetSpeed</span> <span class="o">:=</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">iq_xSpeedSet</span><span class="p">;</span>


<span class="p">(</span><span class="o">*</span><span class="n">Validate</span> <span class="n">Set</span> <span class="n">Speed</span> <span class="n">within</span> <span class="nb">range</span> <span class="o">*</span><span class="p">)</span>
<span class="n">IF</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">q_iSpeedSet</span>  <span class="o">&gt;=</span> <span class="n">i_iMinSpeed</span> <span class="n">AND</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">q_iSpeedSet</span>  <span class="o">&lt;=</span><span class="n">i_iMaxSpeed</span> <span class="n">THEN</span>
    <span class="n">q_iSpeedSet</span>  <span class="o">:=</span> <span class="n">LIMIT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">DINT_TO_INT</span><span class="p">((</span><span class="n">iq_stPTM</span><span class="o">.</span><span class="n">q_iSpeedSet</span> <span class="o">-</span> <span class="n">i_iMinSpeed</span><span class="p">)</span> <span class="o">/</span> <span class="n">i_iMaxSpeed</span> <span class="o">*</span><span class="mi">16383</span><span class="o">/</span><span class="mi">5</span><span class="p">),</span><span class="mi">16383</span><span class="p">);</span> <span class="o">//</span><span class="n">Max</span> <span class="mi">5</span><span class="n">V</span>
<span class="n">END_IF</span>
<span class="n">END_ACTION</span>
<span class="n">ACTION</span> <span class="n">ACT_Logger</span><span class="p">:</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">i_xExtIlkOK</span> <span class="n">AND</span> <span class="p">(</span><span class="n">ePrevState</span> <span class="o">=</span> <span class="n">pumpRUNNING</span> <span class="n">OR</span> <span class="n">ePrevState</span> <span class="o">=</span> <span class="n">pumpSTARTING</span><span class="p">)</span> <span class="n">THEN</span>
            <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Pump turned off due to loss of interlock.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span>
<span class="n">END_IF</span>
<span class="o">//</span> <span class="n">Log</span> <span class="n">Action</span>
<span class="n">tAction</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span>  <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">q_RunDO</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">tAction</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span> <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Pump commanded to start&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span> <span class="n">END_IF</span>



<span class="o">//</span><span class="n">STATE</span> <span class="n">Logger</span>
<span class="n">IF</span> <span class="n">ePrevState</span> <span class="o">&lt;&gt;</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">eState</span> <span class="n">THEN</span>
      <span class="n">CASE</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">eState</span> <span class="n">OF</span>
            <span class="n">pumpFAULT</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Pump Fault.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span>
            <span class="n">pumpSTOPPED</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Pump stopped.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span>
            <span class="n">pumpSTARTING</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Pump starting.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span>
            <span class="n">pumpRUNNING</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Pump running.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span>
            <span class="n">pumpSTOPPING</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Pump decelerating.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span>
      <span class="n">END_CASE</span>
      <span class="n">ePrevState</span> <span class="o">:=</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">eState</span><span class="p">;</span>
  <span class="n">END_IF</span>


<span class="o">//</span> <span class="n">Log</span> <span class="n">FAULT</span>
<span class="n">tFault</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">i_xNCFault</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">tFault</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span> <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Pump Lost Alarm OK bit&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span> <span class="n">END_IF</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
</div>
<div class="section" id="fb-ptm-ebara-011m">
<h2>FB_PTM_Ebara_011M<a class="headerlink" href="#fb-ptm-ebara-011m" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(* This function block does basic controls FOR the Ebara Turbo pump connected to the ETC011M Controller.
 Turns off pump in the event of errors/ warnings. Provides interlocking interface.*)
{attribute &#39;no_check&#39;}
FUNCTION_BLOCK FB_PTM_Ebara_011M EXTENDS FB_Pump
VAR_IN_OUT
END_VAR
VAR_INPUT
    i_rMaxBackingPressure : REAL := 3;
    i_iMinSpeed : DINT := 100; //check pump manual for setting
    i_iMaxSpeed : DINT := 560; // check pump manual for setting
    i_xExtILKOk : BOOL; // Connect to external interlock logic, TRUE if not used.
END_VAR
VAR_OUTPUT
    {attribute &#39;pytmc&#39; := &#39;
    pv:
    &#39;}
    iq_stPTM : ST_EbaraPTM;
END_VAR
VAR
    TOF_SetSpeed: TON := (PT:=T#1S);
    TOF_RESET: TON :=(PT:=T#1S);
    i_iADCBits : UINT := 12;
    (*IO*)
    (*inputs*)
    i_xDecel AT %I* : BOOL; //Link to brake input
    i_xAccel AT %I* : BOOL;
    i_xRotate AT %I* : BOOL;
    i_xFaultNC AT %I* : BOOL;// remove?
    i_xAtSpd AT %I* : BOOL;
    i_iRawSpeed AT %I* : INT; // Link to Analog input

    (*output*)
    q_xStart AT %Q* : BOOL; // link to output
    q_xStop AT %Q* : BOOL; //Link to output
    q_xReset AT %Q* : BOOL;
    q_xProtection AT %Q* : BOOL;
    q_xSetSpeed AT %Q* : BOOL;
    q_iSpeedSet AT %Q* :INT;        //Link to analog Output


END_VAR
(* Ebara ETC control FB
Scott Stubbs &amp; Alex W.
Modified Nov 2018 by M. Ghaly
*)

(* Switch processing *)
//TOF_START.IN := iq_stPTM.i_xStart;
//TOF_START();
//TOF_STOP.IN  := iq_stPTM.i_xStop;
//TOF_STOP();
//TOF_RESET.IN := iq_stPTM.i_xReset;
//TOF_RESET();

(* Simple protection reset *)
iq_stPtm.xExtRunOk:= i_xExtILKOk;
iq_stPTM.q_xProtection := TRUE;//iq_stPTM.xExtRunOk;

(*soft IO mapping*)
ACT_IO();

(* Basic pump supervisory section *)
    (* If override mode, ignore everything else *)
IF iq_stPTM.i_xOverride THEN
    IF iq_stPTM.xRunSW THEN
            iq_stPTM.q_RunDO:=TRUE;
    ELSE
            iq_stPTM.q_RunDO:=FALSE;
    END_IF
    //Handle faults - the way the Ebara cable is done, xFault is normally closed
ELSIF iq_stPTM.i_xFault OR (iq_stPTM.q_RunDO AND NOT iq_stPTM.xExtRunOk) THEN
    iq_stPTM.q_RunDO:=FALSE;
    //iq_stPTM.q_xProtection:=FALSE;
    iq_stPTM.xRunSW:=FALSE;
    //And one for when we need to start the pump normally. Only allows pump to be started if ILK ok.
ELSIF iq_stPTM.xRunSW AND iq_stPTM.xExtRunOk THEN
    iq_stPTM.q_RunDO:=TRUE;
END_IF
//One section for when pump is told to stop
IF NOT iq_stPTM.xRunSW THEN
            iq_stPTM.q_RunDO:=FALSE;
            IF (NOT iq_stPTM.i_xFault) AND (NOT iq_stPTM.i_xALARM) THEN iq_stPTM.eState := pumpSTOPPED; END_IF;
END_IF

//Set the Start and Stop outputs to Run do . check manual.
iq_stPTM.q_xStart := iq_stPTM.q_xStop := iq_stPTM.q_RunDO;

(* to reset the Input speed OK bit *)
 TOF_SetSpeed (IN:= iq_stPTM.iq_xSpeedSet, Q =&gt; );
 IF TOF_SetSpeed.Q THEN iq_stPTM.iq_xSpeedSet:= FALSE;
 END_IF
 (* to reset the Reset Bit *)
 IF (iq_stPTM.xResetSW ) THEN  iq_stPTM.q_xReset := TRUE;
 END_IF
 TOF_RESET (IN:= iq_stPTM.q_xReset, Q =&gt; );
 IF TOF_RESET.Q THEN
    iq_stPTM.q_xReset:= FALSE;
    iq_stPTM.xResetSW := FALSE;
 END_IF


 (*Pump STATE*)
IF iq_stPtm.i_xFault THEN
    iq_stPtm.eState := pumpFAULT;
ELSIF iq_stPTM.i_xDecel AND NOT iq_stPtm.q_RunDO THEN
    iq_stPtm.eState := pumpSTOPPING;
ELSIF NOT iq_stPtm.q_RunDO AND NOT iq_stPTM.i_xFault THEN
    iq_stPtm.eState := pumpSTOPPED;
ELSIF NOT iq_stPtm.i_xAtSpd  AND iq_stPtm.q_RunDO THEN
    iq_stPtm.eState := pumpSTARTING;
ELSIF iq_stPtm.i_xAtSpd AND iq_stPtm.q_RunDO THEN
    iq_stPtm.eState := pumpRUNNING;
ELSE
    iq_stPtm.eState := pumpFAULT;
END_IF

(*Validate Backing Pressure set point doesn&#39;t exceed the Maximum backingPressure*)
iq_stPtm.rBackingPressureSP := BackingPressureSetPoint(iq_stPtm.rBackingPressureSP,i_rMaxBackingPressure);


(*soft IO mapping*)
ACT_IO();
// Log States and triggers
ACT_Logger();

END_FUNCTION_BLOCK
ACTION ACT_IO:
(*soft io mapping*)
(*inputs*)
    iq_stPTM.i_xDecel := i_xDecel ;
    iq_stPTM.i_xAccel :=    i_xAccel ;
    iq_stPTM.i_xRotate :=   i_xRotate;
    iq_stPTM.i_xNCFault :=  i_xFaultNC ;
    iq_stPTM.i_xAtSpd := i_xAtSpd;
    //iq_stPTM.i_iRawSpeed :=       i_iRawSpeed;
//V (AI/32767*10) * (33600 {Max RPM} - 100) / 5
(*outputs*)
    q_xStart:= iq_stPTM.q_xStart;
    q_xStop := iq_stPTM.q_xStop;
    q_xReset := iq_stPTM.q_xReset;
    q_xProtection := iq_stPTM.q_xProtection;
    q_xSetSpeed := iq_stPTM.iq_xSpeedSet;
(*Validate Set Speed within range *)
IF iq_stPTM.q_iSpeedSet  &gt;= i_iMinSpeed AND iq_stPTM.q_iSpeedSet  &lt;=i_iMaxSpeed THEN
    q_iSpeedSet  := LIMIT(0, DINT_TO_INT((iq_stPTM.q_iSpeedSet - i_iMinSpeed) / i_iMaxSpeed *16383/5),16383); //Max output 5V
    //:= DINT_TO_INT((iq_stPTM.q_iSpeedSet-100) / 33600 *32767/2); //Max 5V
END_IF

(* Pump speed calculation *)
IF i_iRawSpeed / (EXPT(2,i_iADCBits)-1) * 10 &gt;= 0.2 THEN //Speed reading appears zero at ~0.16V
iq_stPTM.i_diCurSpd := LREAL_TO_DINT(560*LREAL_TO_DINT(i_iRawSpeed)/16383);
//iq_stPTM.i_diCurSpd := LREAL_TO_DINT(i_iRawSpeed/(EXPT(2,i_iADCBits)-1)*67000);
//V (AI/(2^{# ADC bits} -1 ) * 10[ADC 10V scaling]) * (33600 [Max RPM] - 100) / 5
ELSE
    iq_stPTM.i_diCurSpd := 0;
END_IF

//Normally closed fault handling
iq_stPTM.i_xFault := NOT iq_stPTM.i_xNCFault; //??
END_ACTION
ACTION ACT_Logger:
//STATE Logger
IF NOT i_xExtIlkOK AND ePrevState = pumpRUNNING THEN
            fbLogger(sMsg:=&#39;Lost external interlock while pump was running.&#39;, eSevr:=TcEventSeverity.Critical);
END_IF


IF ePrevState &lt;&gt; iq_stPTM.eState THEN
      CASE iq_stPTM.eState OF
            pumpFAULT:
                    fbLogger(sMsg:=&#39;Pump Fault.&#39;, eSevr:=TcEventSeverity.Critical);
            pumpSTOPPED:
                    fbLogger(sMsg:=&#39;Pump stopped.&#39;, eSevr:=TcEventSeverity.Critical);
            pumpSTARTING:
                    fbLogger(sMsg:=&#39;Pump starting.&#39;, eSevr:=TcEventSeverity.Info);
            pumpRUNNING:
                    fbLogger(sMsg:=&#39;Pump running.&#39;, eSevr:=TcEventSeverity.Info);
            pumpSTOPPING:
                    fbLogger(sMsg:=&#39;Pump decelerating.&#39;, eSevr:=TcEventSeverity.Info);
      END_CASE
      ePrevState := iq_stPTM.eState;
  END_IF

// ILK logger



// Log Action
tAction(CLK:=  iq_stPTM.q_RunDO);
IF tAction.Q THEN fbLogger(sMsg:=&#39;Pump commanded to start&#39;, eSevr:=TcEventSeverity.Info); END_IF


// Log FAULT
tFault(CLK:= iq_stPTM.i_xNCFault);
IF tFault.Q THEN fbLogger(sMsg:=&#39;Pump Lost Alarm OK bit&#39;, eSevr:=TcEventSeverity.Critical); END_IF
END_ACTION
</pre></div>
</div>
</div>
<div class="section" id="fb-ptm-magdrivedigital">
<h2>FB_PTM_MagDriveDigital<a class="headerlink" href="#fb-ptm-magdrivedigital" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">function</span> <span class="n">block</span> <span class="n">does</span> <span class="n">basic</span> <span class="n">controls</span> <span class="n">FOR</span> <span class="n">the</span> <span class="n">Leybold</span> <span class="n">connected</span> <span class="n">to</span> <span class="n">the</span> <span class="n">MagDriveDigital</span> <span class="n">Controller</span><span class="o">.</span>
 <span class="n">Turns</span> <span class="n">off</span> <span class="n">pump</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">event</span> <span class="n">of</span> <span class="n">errors</span><span class="o">/</span> <span class="n">warnings</span><span class="o">.</span> <span class="n">Provides</span> <span class="n">interlocking</span> <span class="n">interface</span><span class="o">.*</span><span class="p">)</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PTM_MagDriveDigital</span> <span class="n">EXTENDS</span> <span class="n">FB_Pump</span>
<span class="n">VAR_IN_OUT</span>

<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>

    <span class="n">i_xExtILKOk</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Connect</span> <span class="n">to</span> <span class="n">external</span> <span class="n">interlock</span> <span class="n">logic</span><span class="p">,</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">used</span><span class="o">.</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span>
    <span class="s1">&#39;}</span>
    <span class="n">iq_stPtm</span>        <span class="p">:</span>       <span class="n">ST_LeyboldPTM</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">xRunOk</span>  <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">tofRemoteDelay</span>  <span class="p">:</span>       <span class="n">TOF</span><span class="p">;</span>


    <span class="p">(</span><span class="o">*</span><span class="n">IO</span><span class="o">*</span><span class="p">)</span>
    <span class="n">i_xAtSpd</span> <span class="n">AT</span><span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Normaml</span> <span class="n">operation</span> <span class="n">when</span> <span class="n">true</span>
    <span class="n">i_xFault</span> <span class="n">AT</span><span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Error</span> <span class="n">NC</span>
    <span class="n">i_xAccel</span> <span class="n">AT</span><span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">i_xDecel</span> <span class="n">AT</span><span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">i_xWarn</span> <span class="n">AT</span><span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="n">q_RunDO</span> <span class="n">AT</span><span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Start</span><span class="o">/</span><span class="n">Stop</span>
    <span class="n">q_xRemote</span> <span class="n">AT</span><span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Basic</span> <span class="n">MagDrive</span> <span class="n">Digital</span> <span class="n">Turbo</span> <span class="n">Controls</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">A</span><span class="o">.</span> <span class="n">Wallace</span><span class="p">,</span> <span class="mi">2015</span><span class="o">-</span><span class="mi">7</span><span class="o">-</span><span class="mi">15</span> <span class="o">*</span><span class="p">)</span>

<span class="n">tofRemoteDelay</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">iq_stPtm</span><span class="o">.</span><span class="n">q_RunDO</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#5S);</span>

<span class="n">iq_stPtm</span><span class="o">.</span><span class="n">q_xRemote</span> <span class="o">:=</span> <span class="n">tofRemoteDelay</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Interlock</span> <span class="n">Sum</span> <span class="o">*</span><span class="p">)</span>
<span class="n">iq_stPtm</span><span class="o">.</span><span class="n">xExtRunOk</span><span class="o">:=</span> <span class="n">i_xExtILKOk</span><span class="p">;</span>
<span class="n">xRunOk</span> <span class="o">:=</span> <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">xExtRunOk</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">i_xFault</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Basic</span> <span class="n">pump</span> <span class="n">supervisory</span> <span class="n">section</span> <span class="o">*</span><span class="p">)</span>
<span class="n">IF</span> <span class="n">xRunOk</span> <span class="n">THEN</span>
    <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">q_RunDO</span> <span class="o">:=</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">xRunSW</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">xRunSW</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">q_RunDO</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="p">(</span><span class="o">*</span><span class="n">Pump</span> <span class="n">STATE</span><span class="o">*</span><span class="p">)</span>
<span class="n">IF</span> <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">i_xFault</span> <span class="n">THEN</span>
    <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">pumpFAULT</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">i_xDecel</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">q_RunDO</span> <span class="n">THEN</span>
    <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">pumpSTOPPING</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">NOT</span> <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">q_RunDO</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">i_xFault</span> <span class="n">THEN</span>
    <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">pumpSTOPPED</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">NOT</span> <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">i_xAtSpd</span>  <span class="n">AND</span> <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">q_RunDO</span> <span class="n">AND</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">i_xAccel</span> <span class="n">THEN</span>
    <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">pumpSTARTING</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">i_xAtSpd</span> <span class="n">AND</span> <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">q_RunDO</span> <span class="n">THEN</span>
    <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">pumpRUNNING</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">pumpFAULT</span><span class="p">;</span>
<span class="n">END_IF</span>


<span class="p">(</span><span class="o">*</span><span class="n">I</span><span class="o">/</span><span class="n">O</span> <span class="n">soft</span> <span class="n">mapping</span><span class="o">*</span><span class="p">)</span>
<span class="n">ACT_IO</span><span class="p">();</span>
<span class="o">//</span> <span class="n">Log</span> <span class="n">States</span> <span class="ow">and</span> <span class="n">triggers</span>
<span class="n">ACT_Logger</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>
<span class="n">ACTION</span> <span class="n">ACT_IO</span><span class="p">:</span>
<span class="p">(</span><span class="o">*</span><span class="n">Inputs</span><span class="o">*</span><span class="p">)</span>
<span class="n">iq_stPtm</span><span class="o">.</span><span class="n">i_xAtSpd</span> <span class="o">:=</span> <span class="n">i_xAtSpd</span><span class="p">;</span>
<span class="n">iq_stPtm</span><span class="o">.</span><span class="n">i_xFault</span> <span class="o">:=</span> <span class="n">NOT</span> <span class="n">i_xFault</span><span class="p">;</span>
<span class="n">iq_stPtm</span><span class="o">.</span><span class="n">i_xAccel</span> <span class="o">:=</span> <span class="n">i_xAccel</span><span class="p">;</span>
<span class="n">iq_stPtm</span><span class="o">.</span><span class="n">i_xDecel</span> <span class="o">:=</span> <span class="n">i_xDecel</span><span class="p">;</span>
<span class="n">iq_stPtm</span><span class="o">.</span><span class="n">i_xWarn</span> <span class="o">:=</span> <span class="n">i_xWarn</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span><span class="n">Outputs</span><span class="o">*</span><span class="p">)</span>
<span class="n">q_RunDO</span> <span class="o">:=</span> <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">q_RunDO</span><span class="p">;</span>
<span class="n">q_xRemote</span> <span class="o">:=</span> <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">q_xRemote</span><span class="p">;</span> <span class="o">//</span> <span class="n">remote</span> <span class="n">out</span>
<span class="n">END_ACTION</span>
<span class="n">ACTION</span> <span class="n">ACT_Logger</span><span class="p">:</span>
<span class="o">//</span><span class="n">STATE</span> <span class="n">Logger</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">i_xExtIlkOK</span> <span class="n">AND</span> <span class="n">ePrevState</span> <span class="o">=</span> <span class="n">pumpRUNNING</span> <span class="n">THEN</span>
            <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Lost external interlock while pump was running.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span>
<span class="n">END_IF</span>


<span class="n">IF</span> <span class="n">ePrevState</span> <span class="o">&lt;&gt;</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">eState</span> <span class="n">THEN</span>
      <span class="n">CASE</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">eState</span> <span class="n">OF</span>
            <span class="n">pumpFAULT</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Pump Fault.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span>
            <span class="n">pumpSTOPPED</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Pump stopped.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span>
            <span class="n">pumpSTARTING</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Pump starting.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span>
            <span class="n">pumpRUNNING</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Pump running.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span>
      <span class="n">END_CASE</span>
      <span class="n">ePrevState</span> <span class="o">:=</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">eState</span><span class="p">;</span>
  <span class="n">END_IF</span>

<span class="o">//</span> <span class="n">ILK</span> <span class="n">logger</span>



<span class="o">//</span> <span class="n">Log</span> <span class="n">Action</span>
<span class="n">tAction</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span>  <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">q_RunDO</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">tAction</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span> <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Pump commanded to start&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span> <span class="n">END_IF</span>


<span class="o">//</span> <span class="n">Log</span> <span class="n">FAULT</span>
<span class="n">tFault</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span> <span class="n">NOT</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">i_xFault</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">tFault</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span> <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Pump Lost Alarm OK bit&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span> <span class="n">END_IF</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
</div>
<div class="section" id="fb-ptm-pfeiffer">
<h2>FB_PTM_Pfeiffer<a class="headerlink" href="#fb-ptm-pfeiffer" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">function</span> <span class="n">block</span> <span class="n">does</span> <span class="n">basic</span> <span class="n">controls</span> <span class="n">FOR</span> <span class="n">the</span> <span class="n">Pfeiffer</span> <span class="n">Turbo</span> <span class="n">pump</span> <span class="n">connected</span> <span class="n">to</span> <span class="n">the</span> <span class="n">TM700</span> <span class="ow">and</span> <span class="n">TC400</span> <span class="n">Controllers</span><span class="o">.</span>
 <span class="n">Turns</span> <span class="n">off</span> <span class="n">pump</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">event</span> <span class="n">of</span> <span class="n">errors</span><span class="o">/</span> <span class="n">warnings</span><span class="o">.</span> <span class="n">Provides</span> <span class="n">interlocking</span> <span class="n">interface</span><span class="o">.*</span><span class="p">)</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PTM_Pfeiffer</span> <span class="n">EXTENDS</span> <span class="n">FB_Pump</span>
<span class="n">VAR_IN_OUT</span>

<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">i_xExtIlkOK</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Connect</span> <span class="n">to</span> <span class="n">external</span> <span class="n">interlock</span> <span class="n">logic</span><span class="p">,</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">used</span><span class="o">.</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span>
    <span class="s1">&#39;}</span>
    <span class="n">iq_stPTM</span> <span class="p">:</span> <span class="n">ST_PfeifferPTM</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="p">(</span><span class="o">*</span><span class="n">IO</span><span class="o">*</span><span class="p">)</span>
    <span class="n">i_xAtSpd</span> <span class="n">AT</span><span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Normaml</span> <span class="n">operation</span> <span class="n">when</span> <span class="n">true</span>
    <span class="n">i_xFaultNC</span> <span class="n">AT</span><span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Error</span>
    <span class="n">i_xWarn</span> <span class="n">AT</span><span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">i_xRemote</span> <span class="n">AT</span><span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="n">q_RunDO</span> <span class="n">AT</span><span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Start</span><span class="o">/</span><span class="n">Stop</span>
    <span class="n">q_PumpingStation</span> <span class="n">AT</span><span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Start</span><span class="o">/</span><span class="n">Stop</span> <span class="n">interlock</span>
    <span class="n">q_xRemote</span> <span class="n">AT</span><span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Basic</span> <span class="n">pump</span> <span class="n">supervisory</span> <span class="n">section</span> <span class="o">*</span><span class="p">)</span>

<span class="n">q_xRemote</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Interlock</span> <span class="n">Sum</span> <span class="o">*</span><span class="p">)</span>
<span class="n">iq_stPtm</span><span class="o">.</span><span class="n">xExtRunOk</span><span class="o">:=</span> <span class="n">i_xExtILKOk</span><span class="p">;</span>
<span class="n">IF</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">xExtRunOk</span> <span class="n">THEN</span>
    <span class="n">q_PumpingStation</span><span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">q_PumpingStation</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">xExtRunOk</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">i_xFault</span> <span class="n">OR</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">i_xTempFault</span> <span class="n">THEN</span>
    <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">q_RunDO</span><span class="o">:=</span><span class="n">iq_stPTM</span><span class="o">.</span><span class="n">xRunSW</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">xRunSW</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">q_RunDO</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>


<span class="p">(</span><span class="o">*</span><span class="n">Pump</span> <span class="n">STATE</span><span class="o">*</span><span class="p">)</span>
<span class="n">IF</span> <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">i_xFault</span> <span class="n">THEN</span>
    <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">pumpFAULT</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">NOT</span> <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">q_RunDO</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">i_xFault</span> <span class="n">THEN</span>
    <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">pumpSTOPPED</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">NOT</span> <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">i_xAtSpd</span>  <span class="n">AND</span> <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">q_RunDO</span> <span class="n">THEN</span>
    <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">pumpSTARTING</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">i_xAtSpd</span> <span class="n">AND</span> <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">q_RunDO</span> <span class="n">THEN</span>
    <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">pumpRUNNING</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">pumpFAULT</span><span class="p">;</span>
<span class="n">END_IF</span>


<span class="p">(</span><span class="o">*</span><span class="n">Soft</span> <span class="n">IO</span> <span class="n">Mapping</span><span class="o">*</span><span class="p">)</span>
<span class="n">ACT_IO</span><span class="p">();</span>
<span class="o">//</span> <span class="n">Log</span> <span class="n">States</span> <span class="ow">and</span> <span class="n">triggers</span>
<span class="n">ACT_Logger</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>
<span class="n">ACTION</span> <span class="n">ACT_IO</span><span class="p">:</span>
<span class="p">(</span><span class="o">*</span><span class="n">outputs</span><span class="o">*</span><span class="p">)</span>
<span class="n">q_RunDO</span> <span class="o">:=</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">q_RunDO</span><span class="p">;</span>
<span class="o">//</span><span class="n">q_xRemote</span> <span class="o">:=</span> <span class="n">iq_stPTM</span><span class="o">.</span>
<span class="o">//</span><span class="n">q_PumpingStation</span> <span class="n">AT</span><span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Start</span><span class="o">/</span><span class="n">Stop</span>

<span class="p">(</span><span class="o">*</span><span class="n">inputs</span><span class="o">*</span><span class="p">)</span>
<span class="n">iq_stPTM</span><span class="o">.</span><span class="n">i_xAtSpd</span><span class="o">:=</span> <span class="n">i_xAtSpd</span><span class="p">;</span>
<span class="n">iq_stPTM</span><span class="o">.</span><span class="n">i_xFault</span><span class="o">:=</span> <span class="n">NOT</span> <span class="n">i_xFaultNC</span><span class="p">;</span>
<span class="n">iq_stPTM</span><span class="o">.</span><span class="n">i_xWarn</span><span class="o">:=</span>          <span class="n">i_xWarn</span> <span class="p">;</span>
<span class="n">END_ACTION</span>
<span class="n">ACTION</span> <span class="n">ACT_Logger</span><span class="p">:</span>
<span class="o">//</span><span class="n">STATE</span> <span class="n">Logger</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">i_xExtIlkOK</span> <span class="n">AND</span> <span class="n">ePrevState</span> <span class="o">=</span> <span class="n">pumpRUNNING</span> <span class="n">THEN</span>
            <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Lost external interlock while pump was running.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span>
<span class="n">END_IF</span>


<span class="n">IF</span> <span class="n">ePrevState</span> <span class="o">&lt;&gt;</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">eState</span> <span class="n">THEN</span>
      <span class="n">CASE</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">eState</span> <span class="n">OF</span>
            <span class="n">pumpFAULT</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Pump Fault.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span>
            <span class="n">pumpSTOPPED</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Pump stopped.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span>
            <span class="n">pumpSTARTING</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Pump starting.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span>
            <span class="n">pumpRUNNING</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Pump running.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span>
      <span class="n">END_CASE</span>
      <span class="n">ePrevState</span> <span class="o">:=</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">eState</span><span class="p">;</span>
  <span class="n">END_IF</span>

<span class="o">//</span> <span class="n">ILK</span> <span class="n">logger</span>



<span class="o">//</span> <span class="n">Log</span> <span class="n">Action</span>
<span class="n">tAction</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span>  <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">q_RunDO</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">tAction</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span> <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Pump commanded to start&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span> <span class="n">END_IF</span>


<span class="o">//</span> <span class="n">Log</span> <span class="n">FAULT</span>
<span class="n">tFault</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span> <span class="n">NOT</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">i_xFault</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">tFault</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span> <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Pump Lost Alarm OK bit&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span> <span class="n">END_IF</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
</div>
<div class="section" id="fb-ptm-test">
<h2>FB_PTM_Test<a class="headerlink" href="#fb-ptm-test" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PTM_Test</span> <span class="n">EXTENDS</span> <span class="n">TcUnit</span><span class="o">.</span><span class="n">FB_TestSuite</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fb_TwisTorr</span><span class="p">:</span> <span class="n">FB_PTM_TwisTorr</span><span class="p">;</span>
    <span class="n">fb_PTM_Ebara_010M</span><span class="p">:</span><span class="n">FB_PTM_Ebara_010M</span><span class="p">;</span>

    <span class="n">cycle</span><span class="p">:</span><span class="n">INT</span> <span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
    <span class="p">(</span><span class="o">*</span><span class="n">IO</span><span class="o">*</span><span class="p">)</span>
    <span class="n">q_iSpeedSet</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span><span class="n">INT</span><span class="p">;</span>
    <span class="n">i_diCurSpd</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span> <span class="p">:</span><span class="n">INT</span><span class="p">;</span>

    <span class="n">i_iRawSpeed</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span> <span class="o">//</span> <span class="n">Link</span> <span class="n">to</span> <span class="n">Analog</span> <span class="nb">input</span>
    <span class="n">i_iTempMon</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span> <span class="o">//</span> <span class="n">Link</span> <span class="n">to</span> <span class="n">Analog</span> <span class="nb">input</span> <span class="o">--</span> <span class="nb">input</span> <span class="n">Voltage</span> <span class="n">according</span> <span class="n">to</span> <span class="n">the</span> <span class="n">pump</span> <span class="n">temprature</span> <span class="mi">0</span><span class="o">-&gt;</span><span class="mi">5</span><span class="n">V</span> <span class="mi">0</span><span class="o">-&gt;</span><span class="mi">100</span><span class="n">C</span>
    <span class="n">i_iCurrentMon</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span> <span class="o">//</span><span class="n">Link</span> <span class="n">to</span> <span class="n">Analog</span> <span class="o">--</span> <span class="nb">input</span> <span class="n">Voltage</span> <span class="n">to</span> <span class="n">the</span> <span class="n">output</span> <span class="n">current</span> <span class="n">of</span> <span class="n">motor</span> <span class="mi">0</span><span class="o">-&gt;</span><span class="mi">5</span><span class="n">V</span> <span class="mi">0</span><span class="o">-&gt;</span><span class="mi">10</span><span class="n">A</span>

<span class="n">END_VAR</span>
<span class="n">M_INIT</span><span class="p">();</span>
<span class="n">M_Interlock</span><span class="p">();</span>
<span class="n">M_PTM_EBARA</span><span class="p">();</span>
<span class="n">cycle</span><span class="o">:=</span><span class="n">cycle</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</div>
<div class="section" id="fb-ptm-turbodrive">
<h2>FB_PTM_TurboDrive<a class="headerlink" href="#fb-ptm-turbodrive" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">Function</span> <span class="n">block</span> <span class="n">provides</span> <span class="n">basic</span> <span class="n">turbo</span> <span class="n">control</span> <span class="k">for</span> <span class="n">Leybold</span> <span class="n">Turbo</span> <span class="n">Drive</span> <span class="mi">300</span><span class="p">,</span> <span class="n">Turbo</span> <span class="n">Drive</span> <span class="mi">400</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">TD20</span> <span class="n">Classic</span> <span class="n">Via</span> <span class="n">Remote</span> <span class="n">X1</span> <span class="n">Connector</span> <span class="mi">9</span><span class="o">-</span><span class="n">way</span> <span class="n">PLC</span> <span class="n">interface</span><span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">When</span> <span class="n">serial</span> <span class="n">interface</span> <span class="ow">is</span> <span class="n">implemented</span><span class="p">,</span> <span class="n">call</span> <span class="n">Method</span> <span class="n">M_Serial_IO</span> <span class="n">after</span> <span class="n">fb</span> <span class="n">instantiation</span><span class="p">,</span> <span class="ow">in</span> <span class="n">order</span> <span class="n">to</span> <span class="n">add</span> <span class="n">the</span> <span class="n">serial</span> <span class="n">status</span> <span class="o">*</span><span class="p">)</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PTM_TurboDrive</span> <span class="n">EXTENDS</span> <span class="n">FB_Pump</span>
<span class="n">VAR_IN_OUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">i_xExtILKOk</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Connect</span> <span class="n">to</span> <span class="n">external</span> <span class="n">interlock</span> <span class="n">logic</span><span class="p">,</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">used</span><span class="o">.</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span>
    <span class="s1">&#39;}</span>
    <span class="n">iq_stPtm</span>        <span class="p">:</span>       <span class="n">ST_LeyboldPTM</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>

    <span class="n">xRunOk</span>  <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">tofRemoteDelay</span>  <span class="p">:</span>       <span class="n">TOF</span><span class="p">;</span>


    <span class="p">(</span><span class="o">*</span><span class="n">IO</span><span class="o">*</span><span class="p">)</span>
    <span class="n">i_xAtSpd</span> <span class="n">AT</span><span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Normaml</span> <span class="n">operation</span> <span class="n">when</span> <span class="n">true</span>
    <span class="n">i_xFaultNC</span> <span class="n">AT</span><span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Error</span> <span class="n">Active</span> <span class="n">when</span> <span class="n">no</span> <span class="n">Error</span> <span class="ow">is</span> <span class="n">present</span>
    <span class="n">q_RunDO</span> <span class="n">AT</span><span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Start</span><span class="o">/</span><span class="n">Stop</span>

<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Basic</span> <span class="n">Turbo</span> <span class="n">Control</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">Function</span> <span class="n">block</span> <span class="n">provides</span> <span class="n">basic</span> <span class="n">turbo</span> <span class="n">control</span> <span class="k">for</span> <span class="n">Leybold</span> <span class="n">Turbo</span> <span class="n">Drive</span> <span class="mi">300</span><span class="p">,</span> <span class="n">Turbo</span> <span class="n">Drive</span> <span class="mi">400</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">TD20</span> <span class="n">Classic</span> <span class="n">Via</span> <span class="n">Remote</span> <span class="n">X1</span> <span class="n">Connector</span> <span class="mi">9</span><span class="o">-</span><span class="n">way</span> <span class="n">PLC</span> <span class="n">interface</span><span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">M</span><span class="o">.</span> <span class="n">Ghaly</span> <span class="n">Jan</span><span class="o">.</span> <span class="mi">2019</span> <span class="o">*</span><span class="p">)</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Interlock</span> <span class="n">Sum</span> <span class="o">*</span><span class="p">)</span>
<span class="n">iq_stPtm</span><span class="o">.</span><span class="n">xExtRunOk</span><span class="o">:=</span> <span class="n">i_xExtILKOk</span><span class="p">;</span>
<span class="n">xRunOk</span> <span class="o">:=</span> <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">xExtRunOk</span> <span class="n">AND</span> <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">i_xNCError</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Basic</span> <span class="n">pump</span> <span class="n">supervisory</span> <span class="n">section</span> <span class="o">*</span><span class="p">)</span>
<span class="n">IF</span> <span class="n">xRunOk</span> <span class="n">THEN</span>
    <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">q_RunDO</span> <span class="o">:=</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">xRunSW</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">xRunSW</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">q_RunDO</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="p">(</span><span class="o">*</span><span class="n">Pump</span> <span class="n">States</span><span class="o">*</span><span class="p">)</span>
<span class="n">IF</span> <span class="p">(</span><span class="n">iq_stPtm</span><span class="o">.</span><span class="n">i_xFault</span><span class="p">)</span> <span class="n">THEN</span>
            <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">pumpFAULT</span><span class="p">;</span>
            <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">xRunSW</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">q_RunDO</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="p">(</span><span class="n">iq_stPtm</span><span class="o">.</span><span class="n">q_RunDO</span><span class="p">)</span> <span class="n">AND</span> <span class="p">(</span><span class="n">iq_stPtm</span><span class="o">.</span><span class="n">i_xAtSpd</span><span class="p">)</span> <span class="n">THEN</span>
            <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">pumpRUNNING</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="p">(</span><span class="n">iq_stPtm</span><span class="o">.</span><span class="n">q_RunDO</span><span class="p">)</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="p">(</span><span class="n">iq_stPtm</span><span class="o">.</span><span class="n">i_xAtSpd</span><span class="p">)</span> <span class="n">THEN</span>
            <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">pumpSTARTING</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">NOT</span> <span class="p">(</span><span class="n">iq_stPtm</span><span class="o">.</span><span class="n">q_RunDO</span><span class="p">)</span> <span class="n">THEN</span>
            <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">pumpSTOPPED</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">pumpFAULT</span><span class="p">;</span>
<span class="n">END_IF</span><span class="p">;</span>


<span class="p">(</span><span class="o">*</span><span class="n">I</span><span class="o">/</span><span class="n">O</span> <span class="n">soft</span> <span class="n">mapping</span><span class="o">*</span><span class="p">)</span>
<span class="n">ACT_IO</span><span class="p">();</span>
<span class="o">//</span> <span class="n">Log</span> <span class="n">States</span> <span class="ow">and</span> <span class="n">triggers</span>
<span class="n">This</span><span class="o">^.</span><span class="n">ACT_Logger</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>
<span class="n">ACTION</span> <span class="n">ACT_IO</span><span class="p">:</span>
<span class="p">(</span><span class="o">*</span><span class="n">Inputs</span><span class="o">*</span><span class="p">)</span>
<span class="n">iq_stPtm</span><span class="o">.</span><span class="n">i_xAtSpd</span> <span class="o">:=</span> <span class="n">i_xAtSpd</span><span class="p">;</span>
<span class="n">iq_stPtm</span><span class="o">.</span><span class="n">i_xNCError</span> <span class="o">:=</span> <span class="n">i_xFaultNC</span><span class="p">;</span>
<span class="n">iq_stPtm</span><span class="o">.</span><span class="n">i_xFault</span> <span class="o">:=</span> <span class="n">NOT</span> <span class="n">i_xFaultNC</span><span class="p">;</span>



<span class="p">(</span><span class="o">*</span><span class="n">Outputs</span><span class="o">*</span><span class="p">)</span>
<span class="n">q_RunDO</span> <span class="o">:=</span> <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">q_RunDO</span><span class="p">;</span>
<span class="n">END_ACTION</span>
<span class="n">ACTION</span> <span class="n">ACT_Logger</span><span class="p">:</span>
<span class="o">//</span><span class="n">STATE</span> <span class="n">Logger</span>
<span class="o">//</span> <span class="n">ILK</span> <span class="n">logger</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">i_xExtIlkOK</span> <span class="n">AND</span> <span class="n">ePrevState</span> <span class="o">=</span> <span class="n">pumpRUNNING</span> <span class="n">THEN</span>
            <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Lost external interlock while pump was running.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span>
<span class="n">END_IF</span>


<span class="n">IF</span> <span class="n">ePrevState</span> <span class="o">&lt;&gt;</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">eState</span> <span class="n">THEN</span>
      <span class="n">CASE</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">eState</span> <span class="n">OF</span>
            <span class="n">pumpFAULT</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Pump Fault.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span>
            <span class="n">pumpSTOPPED</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Pump stopped.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span>
            <span class="n">pumpSTARTING</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Pump starting.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span>
            <span class="n">pumpRUNNING</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Pump running.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span>
      <span class="n">END_CASE</span>
      <span class="n">ePrevState</span> <span class="o">:=</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">eState</span><span class="p">;</span>
  <span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Log</span> <span class="n">Action</span>
<span class="n">tAction</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span>  <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">q_RunDO</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">tAction</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span> <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Pump commanded to start&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span> <span class="n">END_IF</span>


<span class="o">//</span> <span class="n">Log</span> <span class="n">FAULT</span>
<span class="n">tFault</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span> <span class="n">NOT</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">i_xFault</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">tFault</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span> <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Pump Lost Alarm OK bit&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span> <span class="n">END_IF</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
</div>
<div class="section" id="fb-ptm-twistorr">
<h2>FB_PTM_TwisTorr<a class="headerlink" href="#fb-ptm-twistorr" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">function</span> <span class="n">block</span> <span class="n">does</span> <span class="n">basic</span> <span class="n">controls</span> <span class="n">FOR</span> <span class="n">the</span> <span class="n">Agilent</span> <span class="n">TwisTorr</span> <span class="mi">304</span> <span class="n">FS</span> <span class="k">with</span> <span class="n">on</span> <span class="n">board</span> <span class="n">Controller</span><span class="o">.</span>
 <span class="n">Turns</span> <span class="n">off</span> <span class="n">pump</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">event</span> <span class="n">of</span> <span class="n">errors</span><span class="o">/</span> <span class="n">warnings</span><span class="o">.</span> <span class="n">Provides</span> <span class="n">interlocking</span> <span class="n">interface</span><span class="o">.*</span><span class="p">)</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PTM_TwisTorr</span> <span class="n">EXTENDS</span> <span class="n">FB_Pump</span>
<span class="n">VAR_INPUT</span>
    <span class="n">i_xExtILKOk</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Connect</span> <span class="n">to</span> <span class="n">external</span> <span class="n">interlock</span> <span class="n">logic</span><span class="p">,</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">used</span><span class="o">.</span>

<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39; pv: &#39;</span><span class="p">}</span>
    <span class="n">iq_stPtm</span>        <span class="p">:</span>       <span class="n">ST_PTM</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">xRunOk</span>  <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">(</span><span class="o">*</span><span class="n">IO</span><span class="o">*</span><span class="p">)</span>
    <span class="n">i_xAtSpd</span> <span class="n">AT</span><span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Normaml</span> <span class="n">operation</span> <span class="n">when</span> <span class="n">true</span>
    <span class="n">i_xFault</span> <span class="n">AT</span><span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Error</span> <span class="o">//</span> <span class="n">this</span> <span class="nb">open</span> <span class="n">collector</span> <span class="n">output</span> <span class="n">signal</span> <span class="ow">is</span> <span class="n">ON</span> <span class="n">when</span> <span class="n">a</span> <span class="n">system</span> <span class="n">fault</span> <span class="n">condition</span> <span class="ow">is</span> <span class="n">detected</span>

    <span class="n">q_RunDO</span> <span class="n">AT</span><span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Start</span><span class="o">/</span><span class="n">Stop</span>

<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Interlock</span> <span class="n">Sum</span> <span class="o">*</span><span class="p">)</span>
<span class="n">iq_stPtm</span><span class="o">.</span><span class="n">xExtRunOk</span><span class="o">:=</span> <span class="n">i_xExtILKOk</span><span class="p">;</span>
<span class="n">xRunOk</span> <span class="o">:=</span> <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">xExtRunOk</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">i_xFault</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Basic</span> <span class="n">pump</span> <span class="n">supervisory</span> <span class="n">section</span> <span class="o">*</span><span class="p">)</span>
<span class="n">IF</span> <span class="n">xRunOk</span> <span class="n">THEN</span>
    <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">q_RunDO</span> <span class="o">:=</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">xRunSW</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">xRunSW</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">q_RunDO</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="p">(</span><span class="o">*</span><span class="n">Pump</span> <span class="n">STATE</span><span class="o">*</span><span class="p">)</span>
<span class="n">IF</span> <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">i_xFault</span> <span class="n">THEN</span>
    <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">pumpFAULT</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">NOT</span> <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">q_RunDO</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">i_xFault</span> <span class="n">THEN</span>
    <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">pumpSTOPPED</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">NOT</span> <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">i_xAtSpd</span>  <span class="n">AND</span> <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">q_RunDO</span> <span class="n">THEN</span>
    <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">pumpSTARTING</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">i_xAtSpd</span> <span class="n">AND</span> <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">q_RunDO</span> <span class="n">THEN</span>
    <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">pumpRUNNING</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">pumpFAULT</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="p">(</span><span class="o">*</span><span class="n">I</span><span class="o">/</span><span class="n">O</span> <span class="n">soft</span> <span class="n">mapping</span><span class="o">*</span><span class="p">)</span>
<span class="n">ACT_IO</span><span class="p">();</span>
<span class="o">//</span> <span class="n">Log</span> <span class="n">States</span> <span class="ow">and</span> <span class="n">triggers</span>
<span class="n">ACT_Logger</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>
<span class="n">ACTION</span> <span class="n">ACT_IO</span><span class="p">:</span>
<span class="p">(</span><span class="o">*</span><span class="n">Inputs</span><span class="o">*</span><span class="p">)</span>
<span class="n">iq_stPtm</span><span class="o">.</span><span class="n">i_xAtSpd</span> <span class="o">:=</span> <span class="n">i_xAtSpd</span><span class="p">;</span>
<span class="n">iq_stPtm</span><span class="o">.</span><span class="n">i_xFault</span> <span class="o">:=</span> <span class="n">i_xFault</span><span class="p">;</span>


<span class="p">(</span><span class="o">*</span><span class="n">Outputs</span><span class="o">*</span><span class="p">)</span>
<span class="n">q_RunDO</span> <span class="o">:=</span> <span class="n">iq_stPtm</span><span class="o">.</span><span class="n">q_RunDO</span><span class="p">;</span>
<span class="n">END_ACTION</span>
<span class="n">ACTION</span> <span class="n">ACT_Logger</span><span class="p">:</span>
<span class="o">//</span><span class="n">STATE</span> <span class="n">Logger</span>
<span class="o">//</span> <span class="n">ILK</span> <span class="n">logger</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">i_xExtIlkOK</span> <span class="n">AND</span> <span class="n">ePrevState</span> <span class="o">=</span> <span class="n">pumpRUNNING</span> <span class="n">THEN</span>
            <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Lost external interlock while pump was running.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span>
<span class="n">END_IF</span>


<span class="n">IF</span> <span class="n">ePrevState</span> <span class="o">&lt;&gt;</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">eState</span> <span class="n">THEN</span>
      <span class="n">CASE</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">eState</span> <span class="n">OF</span>
            <span class="n">pumpFAULT</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Pump Fault.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span>
            <span class="n">pumpSTOPPED</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Pump stopped.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span>
            <span class="n">pumpSTARTING</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Pump starting.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span>
            <span class="n">pumpRUNNING</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Pump running.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span>
      <span class="n">END_CASE</span>
      <span class="n">ePrevState</span> <span class="o">:=</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">eState</span><span class="p">;</span>
  <span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Log</span> <span class="n">Action</span>
<span class="n">tAction</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span>  <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">q_RunDO</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">tAction</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span> <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Pump commanded to start&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span> <span class="n">END_IF</span>


<span class="o">//</span> <span class="n">Log</span> <span class="n">FAULT</span>
<span class="n">tFault</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span> <span class="n">NOT</span> <span class="n">iq_stPTM</span><span class="o">.</span><span class="n">i_xFault</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">tFault</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span> <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Pump Lost Alarm OK bit&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span> <span class="n">END_IF</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
</div>
<div class="section" id="fb-pump">
<h2>FB_Pump<a class="headerlink" href="#fb-pump" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_Pump</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>

 <span class="o">//</span> <span class="n">For</span> <span class="n">logging</span>
    <span class="n">fbLogger</span> <span class="p">:</span> <span class="n">FB_LogMessage</span> <span class="o">:=</span> <span class="p">(</span><span class="n">eSubsystem</span><span class="o">:=</span><span class="n">E_SubSystem</span><span class="o">.</span><span class="n">VACUUM</span><span class="p">);</span>
    <span class="n">ePrevState</span> <span class="p">:</span> <span class="n">E_PumpState</span><span class="p">;</span>
    <span class="n">tErrorPresent</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">tAction</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span> <span class="o">//</span> <span class="n">Primary</span> <span class="n">action</span> <span class="n">of</span> <span class="n">this</span> <span class="n">device</span> <span class="p">(</span><span class="n">OPN_DO</span><span class="p">,</span> <span class="n">PUMP_RUN</span><span class="p">,</span> <span class="n">etc</span><span class="o">.</span><span class="p">)</span>
    <span class="n">tFault</span> <span class="p">:</span> <span class="n">F_TRIG</span><span class="p">;</span>
<span class="n">END_VAR</span>


<span class="n">END_FUNCTION_BLOCK</span>
<span class="n">ACTION</span> <span class="n">ACT_Logger</span><span class="p">:</span>

<span class="n">END_ACTION</span>
</pre></div>
</div>
</div>
<div class="section" id="fb-scrollpump">
<h2>FB_ScrollPump<a class="headerlink" href="#fb-scrollpump" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">Function</span> <span class="n">block</span> <span class="n">provides</span> <span class="n">basic</span>  <span class="n">control</span> <span class="k">for</span> <span class="n">Scroll</span> <span class="n">Pumps</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Turn</span> <span class="n">on</span> <span class="n">scroll</span> <span class="n">pump</span> <span class="k">if</span> <span class="n">the</span> <span class="n">Turbo</span> <span class="n">Vent</span> <span class="n">Valve</span> <span class="ow">is</span> <span class="n">closed</span><span class="o">.</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Cannot</span> <span class="n">turn</span> <span class="n">off</span> <span class="n">scroll</span> <span class="n">pump</span> <span class="k">if</span> <span class="n">turb</span> <span class="ow">is</span> <span class="n">running</span><span class="o">.</span> <span class="n">delay</span> <span class="n">scroll</span> <span class="n">off</span> <span class="mi">150</span><span class="n">s</span><span class="o">.*</span><span class="p">)</span>

<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_ScrollPump</span>
<span class="n">VAR_IN_OUT</span>

<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span>
    <span class="s1">&#39;}</span>
    <span class="n">iq_stPFO</span>        <span class="p">:</span>       <span class="n">ST_RoughPump</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">TurboIsON</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">xExtIlk</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">Tmr_TOF</span> <span class="p">:</span> <span class="n">TOF</span><span class="p">;</span>
    <span class="n">tTimerDuration</span> <span class="p">:</span> <span class="n">Time</span><span class="o">:=</span> <span class="n">T</span><span class="c1">#150S;</span>
    <span class="o">//</span><span class="n">Previous_RunSW</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Digital</span> <span class="n">Output</span> <span class="n">to</span> <span class="n">be</span> <span class="n">linked</span>
    <span class="n">q_xRunDo</span> <span class="n">AT</span><span class="o">%</span><span class="n">Q</span><span class="o">*</span>  <span class="p">:</span>   <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span><span class="n">Turn</span> <span class="n">on</span> <span class="n">scroll</span> <span class="n">pump</span> <span class="k">if</span> <span class="n">the</span> <span class="n">Turbo</span> <span class="n">Vent</span> <span class="n">Valve</span> <span class="ow">is</span> <span class="n">closed</span><span class="o">.</span> <span class="n">So</span> <span class="n">you</span> <span class="n">are</span> <span class="ow">not</span> <span class="n">just</span>
<span class="o">//</span> <span class="n">pumping</span> <span class="n">air</span> <span class="ow">and</span> <span class="n">accomplishing</span> <span class="n">nothing</span>

<span class="o">//</span> <span class="n">cannot</span> <span class="n">turn</span> <span class="n">off</span> <span class="n">scroll</span> <span class="n">pump</span> <span class="k">if</span> <span class="n">turb</span> <span class="ow">is</span> <span class="n">running</span><span class="o">.</span> <span class="n">delay</span> <span class="n">scroll</span> <span class="n">off</span> <span class="mi">150</span><span class="n">s</span><span class="o">.</span>
<span class="n">iq_stPFO</span><span class="o">.</span><span class="n">xIlkOK</span> <span class="o">:=</span> <span class="n">xExtIlk</span><span class="p">;</span><span class="o">//</span> <span class="ow">and</span> <span class="n">NOT</span> <span class="n">Tmr_TOF</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>

<span class="n">Tmr_TOF</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">TurboIsON</span><span class="p">,</span> <span class="n">PT</span> <span class="o">:=</span> <span class="n">tTimerDuration</span><span class="p">);</span>

<span class="n">IF</span> <span class="n">iq_stPFO</span><span class="o">.</span><span class="n">xIlkOK</span> <span class="n">THEN</span>
    <span class="n">iq_stPFO</span><span class="o">.</span><span class="n">q_xRunDo</span> <span class="o">:=</span> <span class="p">(</span><span class="n">Tmr_TOF</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">iq_stPFO</span><span class="o">.</span><span class="n">pv_xRunSW</span><span class="p">);</span>
<span class="n">ELSE</span>
    <span class="n">iq_stPFO</span><span class="o">.</span><span class="n">q_xRunDo</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">iq_stPFO</span><span class="o">.</span><span class="n">pv_xRunSW</span> <span class="o">:=</span> <span class="n">iq_stPFO</span><span class="o">.</span><span class="n">q_xRunDo</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span><span class="n">State</span> <span class="n">evaluation</span><span class="o">*</span><span class="p">)</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">iq_stPFO</span><span class="o">.</span><span class="n">q_xRunDo</span> <span class="n">THEN</span>
    <span class="n">iq_stPFO</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">pumpSTOPPED</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">iq_stPFO</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">pumpRUNNING</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="p">(</span><span class="o">*</span><span class="n">soft</span> <span class="n">io</span> <span class="n">Mapping</span><span class="o">*</span><span class="p">)</span>
<span class="n">IO</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>
<span class="n">ACTION</span> <span class="n">IO</span><span class="p">:</span>
<span class="n">q_xRunDo</span><span class="o">:=</span> <span class="n">iq_stPFO</span><span class="o">.</span><span class="n">q_xRunDo</span><span class="p">;</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
</div>
<div class="section" id="fb-tgcc-ads">
<h2>FB_TGCC_ADS<a class="headerlink" href="#fb-tgcc-ads" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">function</span> <span class="n">block</span> <span class="ow">is</span> <span class="n">created</span> <span class="k">for</span> <span class="n">interface</span> <span class="n">devices</span> <span class="n">between</span> <span class="n">different</span> <span class="n">PLC</span><span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Not</span> <span class="nb">all</span> <span class="n">the</span> <span class="n">Variables</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">original</span> <span class="n">structure</span> <span class="ow">is</span> <span class="n">required</span><span class="p">,</span> <span class="n">just</span> <span class="n">few</span> <span class="n">signals</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">The</span> <span class="n">variable</span> <span class="n">values</span> <span class="n">are</span> <span class="n">read</span> <span class="n">via</span> <span class="n">ADS</span> <span class="n">using</span> <span class="n">the</span> <span class="n">symbol</span> <span class="n">name</span><span class="o">*</span><span class="p">)</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_TGCC_ADS</span>
<span class="n">VAR_INPUT</span>
    <span class="n">sNetId</span> <span class="p">:</span> <span class="n">String</span><span class="p">;</span> <span class="o">//</span><span class="n">NetID</span> <span class="n">of</span> <span class="n">the</span> <span class="n">Destination</span> <span class="n">PLC</span> <span class="n">controller</span>
    <span class="n">nPort</span> <span class="p">:</span> <span class="n">uint</span><span class="p">;</span> <span class="o">//</span> <span class="n">port</span> <span class="n">number</span>
    <span class="n">sVarName</span> <span class="p">:</span> <span class="n">string</span><span class="p">;</span><span class="o">//</span> <span class="n">the</span> <span class="n">variable</span> <span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">declared</span> <span class="n">gauge</span> <span class="n">function</span> <span class="n">block</span><span class="o">.</span>
    <span class="n">iWatchdog</span><span class="p">:</span><span class="n">UDINT</span><span class="p">;</span><span class="o">//</span><span class="n">The</span> <span class="n">watchdog</span> <span class="n">variable</span> <span class="n">name</span> <span class="n">written</span> <span class="n">to</span> <span class="n">by</span> <span class="n">the</span> <span class="n">remote</span> <span class="n">plc</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv:&#39;</span><span class="p">}</span>
    <span class="n">IG</span> <span class="p">:</span> <span class="n">ST_VG</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fb_CheckWatchdog</span><span class="p">:</span> <span class="n">FB_CheckWatchdog</span><span class="p">;</span>
    <span class="n">fb_Read_VG</span><span class="p">:</span> <span class="n">FB_ReadAdsSymByName</span><span class="p">;</span>
    <span class="n">ftReset</span><span class="p">:</span> <span class="n">F_TRIG</span><span class="p">;</span>
    <span class="n">xFirstPass</span><span class="p">:</span> <span class="n">BOOL</span><span class="o">:=</span> <span class="n">true</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">ftReset</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span> <span class="n">fb_Read_VG</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">OR</span> <span class="n">xFirstPass</span><span class="p">);</span>
<span class="n">xFirstPass</span> <span class="o">:=</span> <span class="n">false</span><span class="p">;</span>
<span class="p">(</span><span class="o">*</span><span class="n">calling</span> <span class="n">ADS</span> <span class="n">read</span> <span class="n">function</span><span class="o">*</span><span class="p">)</span>

<span class="o">//</span><span class="n">IG</span><span class="o">.</span><span class="n">xPRESS_OK</span> <span class="o">:=</span> <span class="n">false</span><span class="p">;</span>

<span class="n">fb_Read_VG</span><span class="p">(</span>
    <span class="n">bRead</span><span class="o">:=</span><span class="n">ftReset</span><span class="o">.</span><span class="n">Q</span> <span class="p">,</span>
    <span class="n">sNetId</span><span class="o">:=</span> <span class="n">sNetId</span><span class="p">,</span>
    <span class="n">nPort</span><span class="o">:=</span> <span class="n">nPort</span><span class="p">,</span>
    <span class="n">sVarName</span><span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="n">sVarName</span><span class="p">,</span><span class="s1">&#39;.IG&#39;</span><span class="p">),</span>
    <span class="n">nDestAddr</span><span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">IG</span><span class="p">),</span>
    <span class="n">nLen</span><span class="o">:=</span> <span class="n">SIZEOF</span><span class="p">(</span><span class="n">IG</span><span class="p">),</span>
    <span class="n">tTimeout</span><span class="o">:=</span> <span class="p">,</span>
    <span class="n">eComMode</span><span class="o">:=</span><span class="n">eAdsComModeFastCom</span> <span class="p">,</span>
    <span class="n">bBusy</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">bError</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">nErrorId</span><span class="o">=&gt;</span> <span class="p">);</span>


<span class="p">(</span><span class="o">*</span><span class="n">Error</span><span class="o">*</span><span class="p">)</span>
<span class="n">fb_CheckWatchdog</span><span class="p">(</span>
    <span class="n">bEnable</span><span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">tWatchdogTime</span><span class="o">:=</span> <span class="n">T</span><span class="c1">#900ms,</span>
    <span class="n">nCnt</span><span class="o">:=</span> <span class="n">iWatchdog</span> <span class="p">,</span>
    <span class="n">bWatchdog</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">nLastCnt</span><span class="o">=&gt;</span> <span class="p">);</span>
<span class="n">bError</span><span class="o">:=</span> <span class="n">fb_Read_VG</span><span class="o">.</span><span class="n">bError</span> <span class="n">OR</span> <span class="n">fb_CheckWatchdog</span><span class="o">.</span><span class="n">bWatchdog</span><span class="p">;</span>

<span class="n">IG</span><span class="o">.</span><span class="n">xPRESS_OK</span> <span class="o">:=</span> <span class="n">NOT</span><span class="p">(</span><span class="n">fb_Read_VG</span><span class="o">.</span><span class="n">bError</span> <span class="n">AND</span> <span class="n">fb_CheckWatchdog</span><span class="o">.</span><span class="n">bWatchdog</span><span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</div>
<div class="section" id="fb-tpip-ads">
<h2>FB_TPIP_ADS<a class="headerlink" href="#fb-tpip-ads" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">function</span> <span class="n">block</span> <span class="ow">is</span> <span class="n">created</span> <span class="k">for</span> <span class="n">interface</span> <span class="n">devices</span> <span class="n">between</span> <span class="n">different</span> <span class="n">PLC</span><span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Not</span> <span class="nb">all</span> <span class="n">the</span> <span class="n">Variables</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">original</span> <span class="n">structure</span> <span class="ow">is</span> <span class="n">required</span><span class="p">,</span> <span class="n">just</span> <span class="n">few</span> <span class="n">signals</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">The</span> <span class="n">variable</span> <span class="n">values</span> <span class="n">are</span> <span class="n">read</span> <span class="n">via</span> <span class="n">ADS</span> <span class="n">using</span> <span class="n">the</span> <span class="n">symbol</span> <span class="n">name</span><span class="o">*</span><span class="p">)</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_TPIP_ADS</span>
<span class="n">VAR_INPUT</span>
    <span class="n">sNetId</span> <span class="p">:</span> <span class="n">String</span><span class="p">;</span> <span class="o">//</span><span class="n">NetID</span> <span class="n">of</span> <span class="n">the</span> <span class="n">Destination</span> <span class="n">PLC</span> <span class="n">controller</span>
    <span class="n">nPort</span> <span class="p">:</span> <span class="n">uint</span><span class="p">;</span> <span class="o">//</span> <span class="n">port</span> <span class="n">number</span>
    <span class="n">sVarName</span> <span class="p">:</span> <span class="n">string</span><span class="p">;</span><span class="o">//</span> <span class="n">the</span> <span class="n">variable</span> <span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">declared</span> <span class="n">pip</span><span class="o">/</span><span class="n">pin</span> <span class="n">function</span> <span class="n">block</span><span class="o">.</span>
    <span class="n">iWatchdog</span><span class="p">:</span><span class="n">UDINT</span><span class="p">;</span><span class="o">//</span><span class="n">The</span> <span class="n">watchdog</span> <span class="n">variable</span> <span class="n">name</span> <span class="n">written</span> <span class="n">to</span> <span class="n">by</span> <span class="n">the</span> <span class="n">remote</span> <span class="n">plc</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv:&#39;</span><span class="p">}</span>
    <span class="n">IG</span> <span class="p">:</span> <span class="n">ST_VG</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fb_CheckWatchdog</span><span class="p">:</span> <span class="n">FB_CheckWatchdog</span><span class="p">;</span>
    <span class="n">fb_Read_VG</span><span class="p">:</span> <span class="n">FB_ReadAdsSymByName</span><span class="p">;</span>
    <span class="n">ftReset</span><span class="p">:</span> <span class="n">F_TRIG</span><span class="p">;</span>
    <span class="n">xFirstPass</span><span class="p">:</span> <span class="n">BOOL</span><span class="o">:=</span> <span class="n">true</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">ftReset</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span> <span class="n">fb_Read_VG</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">OR</span> <span class="n">xFirstPass</span><span class="p">);</span>
<span class="n">xFirstPass</span> <span class="o">:=</span> <span class="n">false</span><span class="p">;</span>
<span class="p">(</span><span class="o">*</span><span class="n">calling</span> <span class="n">ADS</span> <span class="n">read</span> <span class="n">function</span><span class="o">*</span><span class="p">)</span>

<span class="n">fb_Read_VG</span><span class="p">(</span>
    <span class="n">bRead</span><span class="o">:=</span><span class="n">ftReset</span><span class="o">.</span><span class="n">Q</span> <span class="p">,</span>
    <span class="n">sNetId</span><span class="o">:=</span> <span class="n">sNetId</span><span class="p">,</span>
    <span class="n">nPort</span><span class="o">:=</span> <span class="n">nPort</span><span class="p">,</span>
    <span class="n">sVarName</span><span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="n">sVarName</span><span class="p">,</span><span class="s1">&#39;.q_IG&#39;</span><span class="p">),</span>
    <span class="n">nDestAddr</span><span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">IG</span><span class="p">),</span>
    <span class="n">nLen</span><span class="o">:=</span> <span class="n">SIZEOF</span><span class="p">(</span><span class="n">IG</span><span class="p">),</span>
    <span class="n">tTimeout</span><span class="o">:=</span> <span class="p">,</span>
    <span class="n">eComMode</span><span class="o">:=</span><span class="n">eAdsComModeFastCom</span> <span class="p">,</span>
    <span class="n">bBusy</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">bError</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">nErrorId</span><span class="o">=&gt;</span> <span class="p">);</span>


<span class="p">(</span><span class="o">*</span><span class="n">Error</span><span class="o">*</span><span class="p">)</span>
<span class="n">fb_CheckWatchdog</span><span class="p">(</span>
    <span class="n">bEnable</span><span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">tWatchdogTime</span><span class="o">:=</span> <span class="n">T</span><span class="c1">#900ms,</span>
    <span class="n">nCnt</span><span class="o">:=</span> <span class="n">iWatchdog</span> <span class="p">,</span>
    <span class="n">bWatchdog</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">nLastCnt</span><span class="o">=&gt;</span> <span class="p">);</span>
<span class="n">bError</span><span class="o">:=</span> <span class="n">fb_Read_VG</span><span class="o">.</span><span class="n">bError</span> <span class="n">OR</span> <span class="n">fb_CheckWatchdog</span><span class="o">.</span><span class="n">bWatchdog</span><span class="p">;</span>

<span class="n">IG</span><span class="o">.</span><span class="n">xPRESS_OK</span> <span class="o">:=</span> <span class="n">NOT</span><span class="p">(</span> <span class="n">fb_Read_VG</span><span class="o">.</span><span class="n">bError</span> <span class="n">AND</span> <span class="n">fb_CheckWatchdog</span><span class="o">.</span><span class="n">bWatchdog</span><span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</div>
<div class="section" id="fb-turboextlogic">
<h2>FB_TurboExtLogic<a class="headerlink" href="#fb-turboextlogic" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span><span class="n">deprecated</span><span class="o">*</span><span class="p">)</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_TurboExtLogic</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">Turbo</span>           <span class="p">:</span>       <span class="n">ST_AgilentPTM</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">BackingGauge</span><span class="p">:</span>   <span class="n">ST_VG</span><span class="p">;</span>
    <span class="n">InletGauge</span>      <span class="p">:</span>       <span class="n">ST_VG</span><span class="p">;</span>
    <span class="n">VentValve</span>       <span class="p">:</span>       <span class="n">ST_VCC_NO</span><span class="p">;</span>
    <span class="n">ScrollPump</span>      <span class="p">:</span>       <span class="n">ST_RoughPump</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>


<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</div>
<div class="section" id="fb-turbventvalve-no">
<h2>FB_TurbVentvalve_NO<a class="headerlink" href="#fb-turbventvalve-no" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">function</span> <span class="n">block</span> <span class="n">impelemets</span> <span class="n">Interlock</span> <span class="k">for</span> <span class="n">Agilent</span> <span class="n">Turbo</span> <span class="n">Vent</span> <span class="n">Valve</span> <span class="n">Normally</span> <span class="n">Open</span><span class="o">*</span><span class="p">)</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_TurbVentvalve_NO</span>
<span class="n">VAR_OUTPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span><span class="s1">&#39; pv:&#39;</span><span class="p">}</span>
    <span class="n">q_stValve</span> <span class="p">:</span> <span class="n">ST_VCC_NO</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">i_stPTM</span> <span class="p">:</span> <span class="n">ST_AgilentPTM</span><span class="p">;</span> <span class="o">//</span><span class="n">Agilent</span> <span class="n">Turbo</span> <span class="n">Pump</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">tofTmr</span>          <span class="p">:</span>       <span class="n">TOF</span><span class="p">;</span>

    <span class="p">(</span><span class="o">*</span><span class="n">Output</span><span class="o">*</span><span class="p">)</span>
    <span class="n">q_xCLS_DO</span> <span class="n">AT</span><span class="o">%</span><span class="n">Q</span><span class="o">*</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="p">(</span><span class="o">*</span><span class="n">If</span> <span class="n">the</span> <span class="n">turbo</span> <span class="ow">is</span> <span class="n">on</span><span class="p">,</span> <span class="n">you</span> <span class="n">cannot</span> <span class="nb">open</span> <span class="n">the</span> <span class="n">valve</span><span class="o">.</span> <span class="n">In</span> <span class="n">order</span> <span class="n">to</span> <span class="nb">open</span> <span class="n">the</span> <span class="n">valve</span><span class="p">,</span> <span class="n">you</span> <span class="n">have</span> <span class="n">to</span> <span class="n">allow</span> <span class="n">the</span> <span class="n">turbopump</span>
 <span class="n">to</span> <span class="n">have</span> <span class="n">already</span> <span class="n">been</span> <span class="n">turned</span> <span class="n">off</span> <span class="k">for</span> <span class="mi">2</span> <span class="n">minutes</span> <span class="ow">and</span> <span class="n">you</span> <span class="n">have</span> <span class="n">to</span> <span class="n">press</span> <span class="n">the</span> <span class="nb">open</span> <span class="n">button</span> <span class="n">on</span> <span class="n">the</span> <span class="n">vent</span> <span class="n">valve</span>

<span class="n">If</span> <span class="n">the</span> <span class="n">code</span> <span class="n">looks</span> <span class="n">confusing</span> <span class="n">please</span> <span class="n">use</span> <span class="n">a</span> <span class="n">truth</span> <span class="n">table</span> <span class="n">to</span> <span class="n">verify</span><span class="o">*</span><span class="p">)</span>


<span class="n">END_FUNCTION_BLOCK</span>
<span class="n">ACTION</span> <span class="n">ACT_IO</span><span class="p">:</span>
<span class="p">(</span><span class="o">*</span><span class="n">outputs</span><span class="o">*</span><span class="p">)</span>
<span class="n">q_xCLS_DO</span><span class="o">:=</span> <span class="n">q_stValve</span><span class="o">.</span><span class="n">xCLS_DO</span><span class="p">;</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
</div>
<div class="section" id="fb-tvgc-ads">
<h2>FB_TVGC_ADS<a class="headerlink" href="#fb-tvgc-ads" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">function</span> <span class="n">block</span> <span class="ow">is</span> <span class="n">created</span> <span class="k">for</span> <span class="n">interface</span> <span class="n">devices</span> <span class="n">between</span> <span class="n">different</span> <span class="n">PLC</span><span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Not</span> <span class="nb">all</span> <span class="n">the</span> <span class="n">fields</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">original</span> <span class="n">structure</span> <span class="ow">is</span> <span class="n">required</span><span class="p">,</span> <span class="n">just</span> <span class="n">few</span> <span class="n">signals</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span><span class="n">Use</span> <span class="k">with</span> <span class="n">FB_ADS_WATCHDOG</span> <span class="n">on</span> <span class="n">remotePLC</span><span class="o">*</span><span class="p">)</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_TVGC_ADS</span>
<span class="n">VAR_INPUT</span>
    <span class="n">sNetId</span> <span class="p">:</span> <span class="n">String</span><span class="p">;</span> <span class="o">//</span><span class="n">NetID</span> <span class="n">of</span> <span class="n">the</span> <span class="n">Destination</span> <span class="n">PLC</span> <span class="n">controller</span>
    <span class="n">nPort</span> <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span> <span class="o">//</span> <span class="n">port</span> <span class="n">number</span>
    <span class="n">sVarName</span> <span class="p">:</span> <span class="n">string</span><span class="p">;</span><span class="o">//</span> <span class="n">the</span> <span class="n">variable</span> <span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="n">declared</span> <span class="n">function</span> <span class="n">block</span><span class="o">.</span>
    <span class="n">iWatchdog</span><span class="p">:</span><span class="n">UDINT</span><span class="p">;</span><span class="o">//</span><span class="n">The</span> <span class="n">watchdog</span> <span class="n">variable</span> <span class="n">name</span> <span class="n">written</span> <span class="n">to</span> <span class="n">by</span> <span class="n">the</span> <span class="n">remote</span> <span class="n">plc</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: &#39;</span><span class="p">}</span>
    <span class="n">VGC</span><span class="p">:</span><span class="n">ST_VGC</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span><span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fb_CheckWatchdog</span><span class="p">:</span> <span class="n">FB_CheckWatchdog</span><span class="p">;</span>
    <span class="n">fb_Read_VGC</span><span class="p">:</span> <span class="n">FB_ReadAdsSymByName</span><span class="p">;</span>
    <span class="n">ftReset</span><span class="p">:</span> <span class="n">F_TRIG</span><span class="p">;</span>
    <span class="n">xFirstPass</span><span class="p">:</span> <span class="nb">bool</span><span class="o">:=</span> <span class="n">true</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">ftReset</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span> <span class="n">fb_Read_VGC</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">OR</span> <span class="n">xFirstPass</span><span class="p">);</span>
<span class="n">xFirstPass</span><span class="o">:=</span><span class="n">false</span><span class="p">;</span>
<span class="p">(</span><span class="o">*</span><span class="n">calling</span> <span class="n">ADS</span> <span class="n">read</span> <span class="n">function</span><span class="o">*</span><span class="p">)</span>
<span class="n">fb_Read_VGC</span><span class="p">(</span>
    <span class="n">bRead</span><span class="o">:=</span> <span class="n">ftReset</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span>
    <span class="n">sNetId</span><span class="o">:=</span> <span class="n">sNetId</span><span class="p">,</span>
    <span class="n">nPort</span><span class="o">:=</span> <span class="n">nPort</span><span class="p">,</span>
    <span class="n">sVarName</span><span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="n">sVarName</span><span class="p">,</span><span class="s1">&#39;.iq_stValve&#39;</span><span class="p">),</span>
    <span class="n">nDestAddr</span><span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">VGC</span><span class="p">),</span>
    <span class="n">nLen</span><span class="o">:=</span> <span class="n">SIZEOF</span><span class="p">(</span><span class="n">VGC</span><span class="p">),</span>
    <span class="n">tTimeout</span><span class="o">:=</span> <span class="p">,</span>
    <span class="n">eComMode</span><span class="o">:=</span> <span class="n">eAdsComModeFastCom</span><span class="p">,</span>
    <span class="n">bBusy</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">bError</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">nErrorId</span><span class="o">=&gt;</span> <span class="p">);</span>


<span class="p">(</span><span class="o">*</span><span class="n">Error</span><span class="o">*</span><span class="p">)</span>
<span class="n">fb_CheckWatchdog</span><span class="p">(</span>
    <span class="n">bEnable</span><span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">tWatchdogTime</span><span class="o">:=</span> <span class="n">T</span><span class="c1">#900ms,</span>
    <span class="n">nCnt</span><span class="o">:=</span> <span class="n">iWatchdog</span> <span class="p">,</span>
    <span class="n">bWatchdog</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">nLastCnt</span><span class="o">=&gt;</span> <span class="p">);</span>
<span class="n">bError</span><span class="o">:=</span> <span class="n">fb_Read_VGC</span><span class="o">.</span><span class="n">bError</span> <span class="n">OR</span> <span class="n">fb_CheckWatchdog</span><span class="o">.</span><span class="n">bWatchdog</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</div>
<div class="section" id="fb-valve">
<h2>FB_Valve<a class="headerlink" href="#fb-valve" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_Valve</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="o">//</span> <span class="n">For</span> <span class="n">logging</span>
    <span class="n">fbLogger</span> <span class="p">:</span> <span class="n">FB_LogMessage</span> <span class="o">:=</span> <span class="p">(</span><span class="n">eSubsystem</span><span class="o">:=</span><span class="n">E_SubSystem</span><span class="o">.</span><span class="n">VACUUM</span><span class="p">);</span>
    <span class="n">ePrevState</span> <span class="p">:</span> <span class="n">E_ValvePositionState</span><span class="p">;</span>
    <span class="n">tErrorPresent</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">tAction</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span> <span class="o">//</span> <span class="n">Primary</span> <span class="n">action</span> <span class="n">of</span> <span class="n">this</span> <span class="n">device</span> <span class="p">(</span><span class="n">OPN_DO</span><span class="p">,</span> <span class="n">etc</span><span class="o">.</span><span class="p">)</span>
    <span class="n">tOverrideActivated</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
<span class="n">END_VAR</span>


<span class="n">END_FUNCTION_BLOCK</span>
<span class="n">ACTION</span> <span class="n">ACT_Logger</span><span class="p">:</span>

<span class="n">END_ACTION</span>
</pre></div>
</div>
</div>
<div class="section" id="fb-valve-interface">
<h2>FB_Valve_Interface<a class="headerlink" href="#fb-valve-interface" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">function</span> <span class="n">block</span> <span class="ow">is</span> <span class="n">created</span> <span class="k">for</span> <span class="n">interface</span> <span class="n">devices</span> <span class="n">between</span> <span class="n">different</span> <span class="n">PLC</span><span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Not</span> <span class="nb">all</span> <span class="n">the</span> <span class="n">fields</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">original</span> <span class="n">structure</span> <span class="ow">is</span> <span class="n">required</span><span class="p">,</span> <span class="n">just</span> <span class="n">few</span> <span class="n">signals</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">They</span> <span class="n">have</span> <span class="n">to</span> <span class="n">be</span> <span class="n">linked</span> <span class="n">to</span> <span class="n">the</span> <span class="n">custom</span> <span class="n">created</span> <span class="n">variables</span> <span class="n">on</span> <span class="n">the</span> <span class="n">EL6692</span><span class="o">/</span><span class="mi">5</span> <span class="n">primary</span> <span class="n">side</span><span class="o">*</span><span class="p">)</span>

<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_Valve_Interface</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: &#39;</span><span class="p">}</span>
    <span class="n">VGC</span><span class="p">:</span><span class="n">ST_VGC</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">i_xOpnLS</span> <span class="n">AT</span><span class="o">%</span><span class="n">I</span><span class="o">*</span>  <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">i_xClsLS</span> <span class="n">AT</span><span class="o">%</span><span class="n">I</span><span class="o">*</span>  <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">function</span> <span class="n">block</span> <span class="ow">is</span> <span class="n">created</span> <span class="k">for</span> <span class="n">interface</span> <span class="n">devices</span> <span class="n">between</span> <span class="n">different</span> <span class="n">PLC</span><span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Not</span> <span class="nb">all</span> <span class="n">the</span> <span class="n">fields</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">original</span> <span class="n">structure</span> <span class="ow">is</span> <span class="n">required</span><span class="p">,</span> <span class="n">just</span> <span class="n">few</span> <span class="n">signals</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">They</span> <span class="n">have</span> <span class="n">to</span> <span class="n">be</span> <span class="n">linked</span> <span class="n">to</span> <span class="n">the</span> <span class="n">custom</span> <span class="n">created</span> <span class="n">variables</span> <span class="n">on</span> <span class="n">the</span> <span class="n">EL6692</span><span class="o">/</span><span class="mi">5</span> <span class="n">primary</span> <span class="n">side</span><span class="o">*</span><span class="p">)</span>


<span class="n">VGC</span><span class="o">.</span><span class="n">i_xClsLS</span> <span class="o">:=</span> <span class="n">i_xClsLS</span><span class="p">;</span>
<span class="n">VGC</span><span class="o">.</span><span class="n">i_xOpnLS</span> <span class="o">:=</span> <span class="n">i_xOpnLS</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</div>
<div class="section" id="fb-vcc">
<h2>FB_VCC<a class="headerlink" href="#fb-vcc" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span><span class="n">Deprecated</span><span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">THE</span> <span class="n">FB_VCC</span> <span class="n">FUNCTION</span> <span class="n">BLOCK</span> <span class="n">IS</span> <span class="n">DEPRECATED</span><span class="o">.</span> <span class="n">USE</span> <span class="n">FB_VVC</span> <span class="n">INSTEAD</span><span class="o">.</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">Function</span> <span class="n">Block</span> <span class="n">Implements</span> <span class="n">Basic</span> <span class="n">Functionality</span> <span class="k">for</span> <span class="n">Vent</span> <span class="n">Valves</span> <span class="n">VVC</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Note</span> <span class="n">Interlock</span> <span class="n">Logic</span> <span class="ow">is</span> <span class="n">External</span> <span class="o">*</span><span class="p">)</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_VCC</span>
<span class="n">VAR_IN_OUT</span>

<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">i_xExtILK_OK</span><span class="p">:</span><span class="n">BOOL</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span><span class="n">Other</span> <span class="n">External</span> <span class="n">Interlock</span><span class="p">,</span> <span class="n">Set</span> <span class="n">to</span> <span class="kc">True</span> <span class="n">when</span> <span class="n">no</span> <span class="n">external</span> <span class="n">interlock</span> <span class="ow">is</span> <span class="n">required</span><span class="o">*</span><span class="p">)</span>
    <span class="n">i_xOverrideMode</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span><span class="n">To</span> <span class="n">be</span> <span class="n">linked</span> <span class="n">to</span> <span class="k">global</span> <span class="n">override</span> <span class="n">bit</span><span class="o">.</span> <span class="n">This</span> <span class="n">Overrides</span> <span class="n">Vacuum</span> <span class="n">logic</span> <span class="n">only</span><span class="o">*</span><span class="p">)</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span>
    <span class="s1">&#39;}</span>
    <span class="n">iq_stValve</span> <span class="p">:</span> <span class="n">ST_VVC</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>

    <span class="n">tonOvrd</span> <span class="p">:</span>       <span class="n">TON</span><span class="p">;</span>
    <span class="n">tonDelOK</span> <span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">rtOK</span>    <span class="p">:</span>       <span class="n">R_TRIG</span><span class="p">;</span>

    <span class="p">(</span><span class="o">*</span><span class="n">IO</span><span class="o">*</span><span class="p">)</span>
    <span class="n">q_xOPN_DO</span>       <span class="n">AT</span><span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

<span class="n">END_VAR</span>
<span class="n">iq_stValve</span><span class="o">.</span><span class="n">xOPN_OK</span> <span class="o">:=</span> <span class="n">i_xExtILK_OK</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">NOT</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">xOPN_OK</span> <span class="n">THEN</span>
<span class="n">iq_stValve</span><span class="o">.</span><span class="n">pv_xOPN_SW</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Override</span> <span class="n">logic</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Goal</span><span class="p">:</span> <span class="n">give</span> <span class="n">ability</span> <span class="n">to</span> <span class="n">override</span><span class="p">,</span> <span class="n">but</span> <span class="n">do</span> <span class="n">so</span> <span class="ow">in</span> <span class="n">a</span> <span class="n">way</span> <span class="n">that</span> <span class="n">people</span> <span class="n">won</span><span class="s1">&#39;t forget it.</span>
<span class="n">Solution</span><span class="p">:</span> <span class="n">Override</span> <span class="n">only</span> <span class="n">after</span> <span class="n">ten</span> <span class="n">seconds</span> <span class="n">of</span> <span class="n">override</span><span class="p">,</span> <span class="n">protect</span> <span class="n">against</span> <span class="n">blips</span><span class="p">,</span>
<span class="n">when</span> <span class="n">the</span> <span class="n">valve</span> <span class="n">permission</span> <span class="n">goes</span> <span class="n">true</span> <span class="k">for</span> <span class="n">more</span> <span class="n">than</span> <span class="n">ten</span> <span class="n">seconds</span> <span class="n">consistently</span><span class="p">,</span> <span class="n">remove</span> <span class="n">override</span>
<span class="o">*</span><span class="p">)</span>

<span class="n">tonDelOK</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">iq_stValve</span><span class="o">.</span><span class="n">xOPN_OK</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#10S);</span>
<span class="n">rtOK</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">tonDelOK</span><span class="o">.</span><span class="n">Q</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">rtOK</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">xOvrdOpn</span> <span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span> <span class="n">END_IF</span>

<span class="o">//</span><span class="n">Override</span> <span class="n">timer</span>
<span class="n">tonOvrd</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">iq_stValve</span><span class="o">.</span><span class="n">xOvrdOpn</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#10S);</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Here</span><span class="s1">&#39;s where the valve opens *)</span>
<span class="n">iq_stValve</span><span class="o">.</span><span class="n">q_xOPN_DO</span> <span class="o">:=</span> <span class="p">(</span><span class="n">iq_stValve</span><span class="o">.</span><span class="n">pv_xOPN_SW</span> <span class="n">AND</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">xOPN_OK</span><span class="p">)</span> <span class="n">OR</span> <span class="p">(</span><span class="n">tonOvrd</span><span class="o">.</span><span class="n">Q</span> <span class="n">AND</span> <span class="n">i_xOverrideMode</span><span class="p">);</span>

<span class="p">(</span><span class="o">*</span><span class="n">IO</span> <span class="n">Mapping</span><span class="o">*</span><span class="p">)</span>
<span class="n">ACT_IO</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>
<span class="n">ACTION</span> <span class="n">ACT_IO</span><span class="p">:</span>
<span class="p">(</span><span class="o">*</span><span class="n">inputs</span><span class="o">*</span><span class="p">)</span>
<span class="n">iq_stValve</span><span class="o">.</span><span class="n">xOverrideMode</span> <span class="o">:=</span> <span class="n">i_xOverrideMode</span><span class="p">;</span>
<span class="p">(</span><span class="o">*</span><span class="n">outputs</span><span class="o">*</span><span class="p">)</span>
<span class="n">q_xOPN_DO</span><span class="o">:=</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">q_xOPN_DO</span><span class="p">;</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
</div>
<div class="section" id="fb-vcc-no">
<h2>FB_VCC_NO<a class="headerlink" href="#fb-vcc-no" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span><span class="n">Deprecated</span><span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">Function</span> <span class="n">Block</span> <span class="n">Implements</span> <span class="n">Basic</span> <span class="n">Functionality</span> <span class="k">for</span> <span class="n">NO</span> <span class="n">Vent</span> <span class="n">Valves</span> <span class="n">VVC</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Note</span> <span class="n">Interlock</span> <span class="n">Logic</span> <span class="ow">is</span> <span class="n">External</span> <span class="o">*</span><span class="p">)</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_VCC_NO</span>
<span class="n">VAR_IN_OUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv:&#39;</span><span class="p">}</span>
    <span class="n">iq_stValve</span> <span class="p">:</span> <span class="n">ST_VCC_NO</span><span class="p">;</span>

<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">i_xExtILK_OK</span><span class="p">:</span><span class="n">BOOL</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span><span class="n">Other</span> <span class="n">External</span> <span class="n">Interlock</span><span class="p">,</span> <span class="n">Set</span> <span class="n">to</span> <span class="kc">True</span> <span class="n">when</span> <span class="n">no</span> <span class="n">external</span> <span class="n">interlock</span> <span class="ow">is</span> <span class="n">required</span><span class="o">*</span><span class="p">)</span>
    <span class="n">i_xOverrideMode</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span><span class="n">To</span> <span class="n">be</span> <span class="n">linked</span> <span class="n">to</span> <span class="k">global</span> <span class="n">override</span> <span class="n">bit</span><span class="o">.</span> <span class="n">This</span> <span class="n">Overrides</span> <span class="n">Vacuum</span> <span class="n">logic</span> <span class="n">only</span><span class="p">,</span> <span class="n">EPS</span><span class="p">,</span> <span class="n">MPS</span> <span class="ow">and</span> <span class="n">PMPS</span> <span class="n">are</span> <span class="n">still</span> <span class="n">enforces</span><span class="o">*</span><span class="p">)</span>

<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>

    <span class="n">tonOvrd</span> <span class="p">:</span>       <span class="n">TON</span><span class="p">;</span>
    <span class="n">tonDelOK</span> <span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">rtOK</span>    <span class="p">:</span>       <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="p">(</span><span class="o">*</span><span class="n">IO</span><span class="o">*</span><span class="p">)</span>
    <span class="n">xCLS_DO</span> <span class="n">AT</span><span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">xCLS_OK</span> <span class="n">THEN</span>
<span class="n">iq_stValve</span><span class="o">.</span><span class="n">pv_xCLS_SW</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Override</span> <span class="n">logic</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Goal</span><span class="p">:</span> <span class="n">give</span> <span class="n">ability</span> <span class="n">to</span> <span class="n">override</span><span class="p">,</span> <span class="n">but</span> <span class="n">do</span> <span class="n">so</span> <span class="ow">in</span> <span class="n">a</span> <span class="n">way</span> <span class="n">that</span> <span class="n">people</span> <span class="n">won</span><span class="s1">&#39;t forget it.</span>
<span class="n">Solution</span><span class="p">:</span> <span class="n">Override</span> <span class="n">only</span> <span class="n">after</span> <span class="n">ten</span> <span class="n">seconds</span> <span class="n">of</span> <span class="n">override</span><span class="p">,</span> <span class="n">protect</span> <span class="n">against</span> <span class="n">blips</span><span class="p">,</span>
<span class="n">when</span> <span class="n">the</span> <span class="n">valve</span> <span class="n">permission</span> <span class="n">goes</span> <span class="n">true</span> <span class="k">for</span> <span class="n">more</span> <span class="n">than</span> <span class="n">ten</span> <span class="n">seconds</span> <span class="n">consistently</span><span class="p">,</span> <span class="n">remove</span> <span class="n">override</span>
<span class="o">*</span><span class="p">)</span>

<span class="n">tonDelOK</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">iq_stValve</span><span class="o">.</span><span class="n">xCLS_OK</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#10S);</span>
<span class="n">rtOK</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">tonDelOK</span><span class="o">.</span><span class="n">Q</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">rtOK</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">pv_xOvrdCls</span> <span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span> <span class="n">END_IF</span>

<span class="o">//</span><span class="n">Override</span> <span class="n">timer</span>
<span class="n">tonOvrd</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">iq_stValve</span><span class="o">.</span><span class="n">pv_xOvrdCls</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#10S);</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Here</span><span class="s1">&#39;s where the valve is closed *)</span>
<span class="n">iq_stValve</span><span class="o">.</span><span class="n">xCLS_DO</span> <span class="o">:=</span> <span class="p">(</span><span class="n">iq_stValve</span><span class="o">.</span><span class="n">pv_xCLS_SW</span> <span class="n">AND</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">xCLS_OK</span><span class="p">)</span> <span class="n">OR</span> <span class="p">(</span><span class="n">tonOvrd</span><span class="o">.</span><span class="n">Q</span> <span class="n">AND</span> <span class="n">i_xOverrideMode</span><span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>
<span class="n">ACTION</span> <span class="n">ACT_IO</span><span class="p">:</span>
<span class="p">(</span><span class="o">*</span><span class="n">inputs</span><span class="o">*</span><span class="p">)</span>
<span class="n">iq_stValve</span><span class="o">.</span><span class="n">xOverrideMode</span> <span class="o">:=</span> <span class="n">i_xOverrideMode</span><span class="p">;</span>
<span class="p">(</span><span class="o">*</span><span class="n">outputs</span><span class="o">*</span><span class="p">)</span>
<span class="n">xCLS_DO</span><span class="o">:=</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">xCLS_DO</span><span class="p">;</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
</div>
<div class="section" id="fb-vcn">
<h2>FB_VCN<a class="headerlink" href="#fb-vcn" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">function</span> <span class="n">implements</span> <span class="n">the</span> <span class="n">Basic</span> <span class="n">functions</span> <span class="k">for</span> <span class="n">the</span> <span class="n">Pfeiffer</span> <span class="n">EVR</span> <span class="mi">116</span> <span class="n">needle</span> <span class="n">valve</span><span class="o">*</span><span class="p">)</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_VCN</span>
<span class="n">VAR_INPUT</span>
    <span class="n">i_xExtIlkOK</span>     <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">External</span> <span class="n">Interlock</span><span class="p">,</span> <span class="n">SET</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">used</span>
    <span class="n">i_ReqPos</span>        <span class="p">:</span>       <span class="n">REAL</span><span class="p">;</span> <span class="o">//</span><span class="n">Requested</span> <span class="n">position</span>

<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span>
    <span class="s1">&#39;}</span>
    <span class="n">iq_stVCN</span>        <span class="p">:</span>       <span class="n">ST_VCN</span><span class="p">;</span> <span class="o">//</span><span class="n">Needle</span> <span class="n">valve</span> <span class="n">structure</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>

<span class="n">END_VAR</span>

<span class="n">VAR</span> <span class="n">CONSTANT</span>
    <span class="n">rOpenVoltage</span>    <span class="p">:</span>       <span class="n">REAL</span> <span class="o">:=</span> <span class="mf">9.1</span><span class="p">;</span> <span class="o">//</span> <span class="n">From</span> <span class="n">the</span> <span class="n">EVR</span> <span class="mi">116</span> <span class="n">manual</span><span class="p">,</span> <span class="n">A</span> <span class="n">Voltage</span> <span class="n">of</span> <span class="mi">9</span><span class="n">V</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">completely</span> <span class="n">Open</span>
    <span class="n">rCloseVoltage</span>   <span class="p">:</span>       <span class="n">REAL</span> <span class="o">:=</span> <span class="mf">0.4</span><span class="p">;</span><span class="o">//</span> <span class="n">a</span> <span class="n">voltage</span> <span class="o">&lt;</span><span class="mf">0.5</span> <span class="n">V</span> <span class="n">the</span> <span class="n">valve</span> <span class="ow">is</span> <span class="n">closed</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="o">//</span> <span class="n">Requested</span> <span class="n">voltage</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">POS_AO</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span> <span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">rReqVoltage</span><span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="o">//</span><span class="n">iResolution</span><span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span><span class="mi">16</span><span class="p">;</span>
    <span class="o">//</span>
    <span class="p">(</span><span class="o">*</span><span class="n">IO</span><span class="o">*</span><span class="p">)</span>
    <span class="n">q_iRawPosition</span> <span class="n">AT</span><span class="o">%</span><span class="n">Q</span><span class="o">*</span> <span class="p">:</span><span class="n">INT</span><span class="p">;</span>

<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Needle</span> <span class="n">valve</span> <span class="n">control</span> <span class="n">FB</span>
<span class="n">A</span><span class="o">.</span> <span class="n">Wallace</span> <span class="mi">2016</span><span class="o">-</span><span class="mi">7</span><span class="o">-</span><span class="mi">21</span>

<span class="n">This</span> <span class="n">FB</span> <span class="n">should</span> <span class="n">be</span> <span class="n">used</span> <span class="k">as</span> <span class="n">a</span> <span class="n">low</span> <span class="n">level</span> <span class="n">control</span> <span class="n">block</span><span class="o">.</span>

<span class="n">It</span> <span class="n">provides</span><span class="p">:</span>

<span class="n">Valve</span> <span class="n">position</span> <span class="n">ceiling</span>
<span class="n">Interlock</span>
<span class="n">Scaling</span>

<span class="n">It</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">intended</span> <span class="k">for</span><span class="p">:</span>
<span class="n">Closed</span><span class="o">-</span><span class="n">loop</span> <span class="n">control</span>

<span class="n">It</span> <span class="n">could</span> <span class="n">be</span> <span class="n">used</span> <span class="k">for</span><span class="p">:</span>
<span class="n">Valve</span> <span class="n">position</span><span class="o">/</span><span class="n">flow</span> <span class="n">linearization</span>

<span class="n">Note</span><span class="p">:</span> <span class="n">Raw</span> <span class="n">position</span> <span class="n">calc</span> <span class="ow">is</span> <span class="n">based</span> <span class="n">on</span> <span class="mf">0.5</span> <span class="n">to</span> <span class="mi">9</span><span class="n">V</span> <span class="n">span</span><span class="p">,</span> <span class="mi">32767</span> <span class="n">bits</span>
<span class="o">*</span><span class="p">)</span>

<span class="o">//</span> <span class="n">Interlocking</span>
<span class="n">iq_stVCN</span><span class="o">.</span><span class="n">xIlkOK</span> <span class="o">:=</span> <span class="n">i_xExtIlkOK</span><span class="p">;</span>
<span class="p">(</span><span class="o">*</span><span class="n">Checking</span> <span class="n">which</span> <span class="n">Control</span> <span class="n">mode</span> <span class="ow">is</span> <span class="n">selected</span><span class="o">*</span><span class="p">)</span>
<span class="n">IF</span> <span class="n">iq_stVCN</span><span class="o">.</span><span class="n">xIlkOK</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">iq_stVCN</span><span class="o">.</span><span class="n">eValveControl</span> <span class="o">=</span> <span class="n">OpenValve</span> <span class="n">THEN</span>
            <span class="n">iq_stVCN</span><span class="o">.</span><span class="n">rReqPosition</span> <span class="o">:=</span> <span class="n">iq_stVCN</span><span class="o">.</span><span class="n">rUpperLimit</span><span class="p">;(</span><span class="o">*</span><span class="n">Percentage</span><span class="o">*</span><span class="p">)</span><span class="o">//</span> <span class="n">iq_stVCN</span><span class="o">.</span><span class="n">rUpperLimit</span><span class="p">;</span>
    <span class="n">ELSIF</span> <span class="n">iq_stVCN</span><span class="o">.</span><span class="n">eValveControl</span> <span class="o">=</span> <span class="n">CloseValve</span> <span class="n">THEN</span>
            <span class="n">iq_stVCN</span><span class="o">.</span><span class="n">rReqPosition</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span><span class="n">Percentage</span><span class="o">*</span><span class="p">)</span>
    <span class="n">ELSIF</span> <span class="p">(</span><span class="n">iq_stVCN</span><span class="o">.</span><span class="n">eValveControl</span> <span class="o">=</span> <span class="n">ManualControl</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">AND</span> <span class="p">(</span><span class="n">iq_stVCN</span><span class="o">.</span><span class="n">xOPN_SW</span><span class="p">)</span><span class="o">*</span><span class="p">)</span> <span class="n">THEN</span>
            <span class="n">iq_stVCN</span><span class="o">.</span><span class="n">rReqPosition</span> <span class="o">:=</span> <span class="n">LIMIT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">iq_stVCN</span><span class="o">.</span><span class="n">rReqPosition</span><span class="p">,</span> <span class="n">iq_stVCN</span><span class="o">.</span><span class="n">rUpperLimit</span><span class="p">);</span>
    <span class="n">ELSIF</span> <span class="n">iq_stVCN</span><span class="o">.</span><span class="n">eValveControl</span> <span class="o">=</span> <span class="n">PressureControl</span> <span class="n">THEN</span>
            <span class="n">iq_stVCN</span><span class="o">.</span><span class="n">rReqPosition</span> <span class="o">:=</span> <span class="n">LIMIT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i_ReqPos</span><span class="p">,</span> <span class="n">iq_stVCN</span><span class="o">.</span><span class="n">rUpperLimit</span><span class="p">);</span>
    <span class="n">END_IF</span>
<span class="n">ELSE</span>
    <span class="n">iq_stVCN</span><span class="o">.</span><span class="n">rReqPosition</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">iq_stVCN</span><span class="o">.</span><span class="n">eValveControl</span> <span class="o">:=</span> <span class="n">CloseValve</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Requested</span> <span class="n">Voltage</span> <span class="n">calculation</span>
<span class="n">rReqVoltage</span> <span class="o">:=</span> <span class="n">iq_stVCN</span><span class="o">.</span><span class="n">rReqPosition</span> <span class="o">*</span> <span class="p">(</span><span class="n">rOpenVoltage</span><span class="o">-</span><span class="n">rCloseVoltage</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span> <span class="o">+</span> <span class="n">rCloseVoltage</span><span class="p">;</span>
<span class="n">rReqVoltage</span> <span class="o">:=</span> <span class="n">LIMIT</span><span class="p">(</span><span class="n">rCloseVoltage</span><span class="p">,</span> <span class="n">rReqVoltage</span><span class="p">,</span> <span class="n">rOpenVoltage</span><span class="p">);</span> <span class="o">//</span><span class="n">The</span> <span class="n">requested</span> <span class="n">voltage</span> <span class="n">should</span> <span class="n">remain</span> <span class="n">within</span> <span class="n">this</span> <span class="nb">range</span>
<span class="o">//</span><span class="n">Raw</span> <span class="n">position</span> <span class="n">calc</span>
<span class="n">iq_stvcn</span><span class="o">.</span><span class="n">q_iRawPosition</span> <span class="o">:=</span> <span class="n">REAL_TO_INT</span><span class="p">(</span> <span class="mi">32767</span><span class="o">/</span><span class="mi">10</span> <span class="o">*</span> <span class="n">rReqVoltage</span><span class="p">);</span>

<span class="p">(</span><span class="o">*</span><span class="n">SOft</span> <span class="n">IO</span> <span class="n">Mapping</span><span class="o">*</span><span class="p">)</span>
<span class="n">ACT_IO</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>
<span class="n">ACTION</span> <span class="n">ACT_IO</span><span class="p">:</span>
<span class="p">(</span><span class="o">*</span><span class="n">outputs</span><span class="o">*</span><span class="p">)</span>
<span class="n">q_iRawPosition</span> <span class="o">:=</span> <span class="n">iq_stVCN</span><span class="o">.</span><span class="n">q_iRawPosition</span><span class="p">;</span>
<span class="p">(</span><span class="o">*</span><span class="n">inputs</span><span class="o">*</span><span class="p">)</span>
<span class="n">iq_stVCN</span><span class="o">.</span><span class="n">i_iPosition</span> <span class="o">:=</span> <span class="n">iq_stvcn</span><span class="o">.</span><span class="n">q_iRawPosition</span><span class="p">;</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
</div>
<div class="section" id="fb-vfs">
<h2>FB_VFS<a class="headerlink" href="#fb-vfs" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_VFS</span> <span class="n">EXTENDS</span> <span class="n">FB_Valve</span>
<span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">function</span> <span class="n">block</span> <span class="n">implements</span> <span class="n">basic</span> <span class="n">functionality</span> <span class="k">for</span> <span class="n">Fast</span> <span class="n">Shutter</span><span class="o">/</span><span class="n">Valves</span><span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Create</span> <span class="n">a</span> <span class="n">separate</span> <span class="n">virtual</span> <span class="n">PLC</span> <span class="k">for</span> <span class="n">the</span> <span class="n">fast</span> <span class="n">shutter</span> <span class="n">logic</span><span class="p">,</span> <span class="ow">and</span> <span class="n">tie</span><span class="o">/</span><span class="nb">map</span> <span class="n">this</span> <span class="n">task</span> <span class="n">to</span> <span class="n">the</span> <span class="n">FAST</span> <span class="n">I</span><span class="o">/</span><span class="n">O</span> <span class="n">portion</span> <span class="n">of</span> <span class="n">the</span> <span class="n">ethercat</span> <span class="n">bus</span><span class="p">,</span>
 <span class="n">so</span> <span class="n">we</span> <span class="n">can</span> <span class="n">scan</span> <span class="n">these</span> <span class="n">I</span><span class="o">/</span><span class="n">Os</span> <span class="n">faster</span> <span class="n">than</span> <span class="n">the</span> <span class="n">rest</span> <span class="n">of</span> <span class="n">the</span> <span class="n">vacuum</span> <span class="n">I</span><span class="o">/</span><span class="n">Os</span><span class="o">.</span>
<span class="n">The</span> <span class="n">Fast</span> <span class="n">shutter</span> <span class="n">was</span> <span class="n">tested</span> <span class="k">with</span> <span class="n">PLC</span> <span class="n">task</span> <span class="n">Cycle</span> <span class="n">Base</span> <span class="n">Time</span> <span class="mi">50</span><span class="n">us</span> <span class="k">with</span> <span class="n">cycle</span> <span class="n">time</span> <span class="mf">0.050</span><span class="n">ms</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>

<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>

    <span class="n">i_xPMPS_OK</span><span class="p">:</span>     <span class="n">BOOL</span>    <span class="p">;</span> <span class="p">(</span><span class="o">*</span><span class="n">External</span> <span class="n">MPS</span> <span class="n">interlock</span><span class="p">,</span> <span class="n">Set</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">when</span> <span class="n">no</span> <span class="n">PMPS</span> <span class="n">interlock</span> <span class="ow">is</span> <span class="n">required</span><span class="o">*</span><span class="p">)</span>
    <span class="n">i_xExt_OK</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span><span class="n">Other</span> <span class="n">External</span> <span class="n">Interlock</span><span class="p">,</span> <span class="n">Set</span> <span class="n">to</span> <span class="kc">True</span> <span class="n">when</span> <span class="n">no</span> <span class="n">external</span> <span class="n">interlock</span> <span class="ow">is</span> <span class="n">required</span><span class="o">*</span><span class="p">)</span>


<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>

    <span class="n">iq_stValve</span> <span class="n">AT</span><span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">ST_VGC</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span> <span class="n">All</span> <span class="n">valve</span> <span class="n">data</span> <span class="ow">and</span> <span class="n">states</span> <span class="n">will</span> <span class="n">be</span> <span class="ow">in</span> <span class="n">this</span> <span class="n">struct</span><span class="o">*</span><span class="p">)</span>


<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">io_fbFFHWO</span>    <span class="p">:</span>    <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="o">//</span> <span class="n">PMPS</span>
    <span class="n">fbFF</span>    <span class="p">:</span>    <span class="n">FB_FastFault</span> <span class="o">:=</span><span class="p">(</span>
        <span class="n">i_DevName</span> <span class="o">:=</span> <span class="s1">&#39;VFS&#39;</span><span class="p">,</span>
        <span class="n">i_Desc</span> <span class="o">:=</span> <span class="s1">&#39;Fault occurs when fast valve is not in open state&#39;</span><span class="p">,</span>
        <span class="n">i_TypeCode</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#1010);</span>

    <span class="n">rDiffPressAllowed</span>       <span class="p">:</span>       <span class="n">REAL</span> <span class="o">:=</span> <span class="mf">22.5</span><span class="p">;</span> <span class="o">//</span> <span class="n">Torr</span><span class="p">,</span> <span class="n">Default</span> <span class="n">value</span> <span class="n">comes</span> <span class="kn">from</span> <span class="nn">Vat</span> <span class="n">Valve</span> <span class="n">Manual</span>
    <span class="n">rDiffPress</span> <span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
    <span class="nb">set</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">reset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="n">xFirstPass</span>      <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">fbFSInit</span>                <span class="p">:</span>       <span class="n">R_TRIG</span><span class="p">;</span>

    <span class="n">tonDelOK</span> <span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">rtOK</span>    <span class="p">:</span>       <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">tonOvrd</span> <span class="p">:</span>       <span class="n">TON</span><span class="p">;</span>

    <span class="n">tDelOK</span>  <span class="p">:</span>       <span class="n">TIME</span> <span class="o">:=</span> <span class="n">T</span><span class="c1">#60S;</span>
    <span class="n">tOvrd</span>   <span class="p">:</span>       <span class="n">TIME</span> <span class="o">:=</span> <span class="n">T</span><span class="c1">#10s;</span>

    <span class="n">xClose</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">xOpen</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">CloseTimer</span><span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">TimDur</span><span class="p">:</span> <span class="n">TIME</span> <span class="o">:=</span> <span class="n">T</span><span class="c1">#20MS;</span>
    <span class="n">OpenTimer</span><span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">OpenTimDur</span><span class="p">:</span> <span class="n">TIME</span> <span class="o">:=</span> <span class="n">T</span><span class="c1">#2S;</span>

    <span class="p">(</span><span class="o">*</span> <span class="n">Timeouts</span><span class="o">*</span><span class="p">)</span>
    <span class="n">tTimeOutDuration</span><span class="p">:</span> <span class="n">TIME</span><span class="o">:=</span> <span class="n">T</span><span class="c1">#0.5S;</span>
    <span class="n">tOPNtimeout</span><span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">tCLStimeout</span><span class="p">:</span><span class="n">TON</span><span class="p">;</span>


    <span class="p">(</span><span class="o">*</span><span class="n">IO</span><span class="o">*</span><span class="p">)</span>
    <span class="n">i_xOpnLS</span>        <span class="n">AT</span><span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">i_xClsLS</span>        <span class="n">AT</span><span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">q_xClose_A</span>      <span class="n">AT</span><span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">q_xClose_B</span>      <span class="n">AT</span><span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">q_xClose_C</span>      <span class="n">AT</span><span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">q_xOPN_DO</span>       <span class="n">AT</span><span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">i_xTrigger</span>      <span class="n">AT</span><span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Could</span> <span class="n">be</span> <span class="n">Up</span> <span class="n">to</span> <span class="mi">4</span>

    <span class="o">//</span> <span class="n">Interface</span>
    <span class="n">i_xPress_OK</span> <span class="n">AT</span><span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span><span class="n">BOOL</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span><span class="n">To</span> <span class="n">be</span> <span class="n">linked</span> <span class="n">to</span> <span class="n">the</span> <span class="n">Fast</span> <span class="n">sensor</span> <span class="n">structure</span> <span class="n">signal</span> <span class="n">IG</span><span class="o">.</span><span class="n">xPRESS_OK</span><span class="p">,</span> <span class="n">to</span> <span class="n">make</span> <span class="n">sure</span> <span class="n">that</span> <span class="n">the</span> <span class="n">device</span> <span class="ow">is</span> <span class="n">connected</span><span class="o">*</span><span class="p">)</span>
    <span class="n">i_xOPN_SW</span> <span class="n">AT</span><span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span><span class="n">BOOL</span><span class="p">;</span>
    <span class="n">i_xCLS_SW</span> <span class="n">AT</span><span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span><span class="n">BOOL</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span><span class="n">external</span> <span class="nb">open</span> <span class="n">signal</span> <span class="n">e</span><span class="o">.</span><span class="n">g</span> <span class="n">epics</span><span class="o">*</span><span class="p">)</span>
    <span class="n">i_xResetFault</span>   <span class="n">AT</span><span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;(</span><span class="o">*</span><span class="n">FFO</span> <span class="n">iReset</span><span class="o">*</span><span class="p">)</span>
    <span class="n">i_xOverrideMode</span> <span class="n">AT</span><span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span><span class="n">To</span> <span class="n">be</span> <span class="n">linked</span> <span class="n">to</span> <span class="k">global</span> <span class="n">override</span> <span class="n">bit</span><span class="o">.</span> <span class="n">This</span> <span class="n">Overrides</span> <span class="n">Vacuum</span> <span class="n">logic</span> <span class="n">only</span><span class="p">,</span> <span class="n">EPS</span><span class="p">,</span> <span class="n">MPS</span> <span class="ow">and</span> <span class="n">PMPS</span> <span class="n">are</span> <span class="n">still</span> <span class="n">enforces</span><span class="o">*</span><span class="p">)</span>
    <span class="n">i_xOverrideOpen</span> <span class="n">AT</span><span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">q_xTrigger</span>      <span class="n">AT</span><span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span><span class="n">Interface</span><span class="o">*</span><span class="p">)</span>
    <span class="n">q_xVFS_Open</span> <span class="n">AT</span><span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span><span class="n">Interface</span><span class="o">*</span><span class="p">)</span>
    <span class="n">q_xVFS_Closed</span> <span class="n">AT</span><span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span><span class="n">Interface</span><span class="o">*</span><span class="p">)</span>
    <span class="n">q_xVAC_FAULT_OK</span> <span class="n">AT</span><span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span><span class="n">Valve</span> <span class="n">Vacuum</span> <span class="n">OK</span><span class="p">,</span> <span class="ow">is</span> <span class="nb">set</span> <span class="n">to</span> <span class="kc">False</span> <span class="n">when</span> <span class="n">there</span> <span class="ow">is</span> <span class="n">Vacuum</span> <span class="n">Fault</span><span class="o">*</span><span class="p">)</span>
    <span class="n">q_xMPS_OK</span>        <span class="n">AT</span><span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span><span class="n">MPS</span> <span class="n">Fault</span> <span class="n">OK</span><span class="p">,</span> <span class="ow">is</span> <span class="nb">set</span> <span class="n">when</span> <span class="n">the</span> <span class="n">Valve</span> <span class="ow">is</span> <span class="n">Open</span> <span class="ow">and</span> <span class="n">there</span> <span class="ow">is</span> <span class="n">no</span> <span class="n">trigger</span><span class="o">*</span><span class="p">)</span>


<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Fast</span> <span class="n">Shutter</span><span class="o">/</span><span class="n">Valve</span> <span class="n">Function</span> <span class="n">Block</span><span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">M</span><span class="o">.</span><span class="n">Ghaly</span> <span class="n">Feb</span> <span class="mi">2019</span><span class="o">*</span><span class="p">)</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Fast</span> <span class="n">Shutters</span> <span class="n">do</span> <span class="ow">not</span> <span class="n">function</span> <span class="k">as</span> <span class="n">complete</span> <span class="n">isolation</span> <span class="n">valves</span><span class="p">,</span> <span class="n">but</span> <span class="n">are</span> <span class="n">intended</span> <span class="n">to</span> <span class="n">rapidly</span> <span class="n">limit</span> <span class="n">conductance</span>
<span class="n">between</span> <span class="n">vacuum</span> <span class="n">regions</span><span class="o">.</span>  <span class="n">They</span> <span class="n">should</span> <span class="n">be</span> <span class="n">installed</span> <span class="ow">in</span> <span class="n">conjunction</span> <span class="k">with</span> <span class="n">isolation</span> <span class="n">gate</span> <span class="n">valves</span><span class="o">.</span>  <span class="n">The</span> <span class="n">conductance</span>
<span class="n">of</span> <span class="n">the</span> <span class="n">fast</span> <span class="n">shutter</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">closed</span> <span class="n">state</span> <span class="n">may</span> <span class="n">be</span> <span class="n">sufficiently</span> <span class="n">low</span> <span class="k">as</span> <span class="n">to</span> <span class="n">create</span> <span class="n">an</span> <span class="n">isolated</span> <span class="n">vacuum</span> <span class="n">region</span><span class="o">.</span>
<span class="n">Thus</span><span class="p">,</span> <span class="n">at</span> <span class="n">least</span> <span class="n">a</span> <span class="n">pirani</span> <span class="n">gauge</span><span class="p">,</span> <span class="n">that</span> <span class="n">can</span> <span class="n">measure</span> <span class="n">a</span> <span class="n">pressure</span> <span class="n">down</span> <span class="n">to</span> <span class="mi">1</span><span class="n">x10</span><span class="o">-</span><span class="mi">4</span> <span class="n">Torr</span><span class="p">,</span> <span class="n">needs</span> <span class="n">to</span> <span class="n">be</span> <span class="n">installed</span> <span class="n">between</span>
<span class="n">the</span> <span class="n">shutter</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">isolation</span> <span class="n">gate</span> <span class="n">valve</span><span class="o">.</span>
<span class="n">In</span> <span class="n">the</span> <span class="n">case</span> <span class="n">where</span> <span class="n">a</span> <span class="n">gauge</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">installed</span><span class="p">,</span> <span class="n">the</span> <span class="n">neigboring</span> <span class="n">gate</span> <span class="n">Valves</span> <span class="n">should</span> <span class="ow">not</span> <span class="n">be</span> <span class="n">opened</span> <span class="n">unless</span> <span class="n">the</span> <span class="n">shutter</span>
<span class="ow">is</span> <span class="n">Open</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Soft</span> <span class="n">IO</span> <span class="n">Mapping</span><span class="o">*</span><span class="p">)</span>
<span class="n">IO</span><span class="p">();</span>

<span class="o">///</span><span class="n">Check</span> <span class="n">valve</span> <span class="n">postion</span>
<span class="n">IF</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">i_xClsLS</span> <span class="n">AND</span>  <span class="n">iq_stValve</span><span class="o">.</span><span class="n">i_xOpnLS</span> <span class="n">THEN</span>
    <span class="n">iq_stValve</span><span class="o">.</span><span class="n">eState</span><span class="o">:=</span><span class="n">INVALID</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">NOT</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">i_xClsLS</span> <span class="n">AND</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">i_xOpnLS</span> <span class="n">THEN</span>
    <span class="n">iq_stValve</span><span class="o">.</span><span class="n">eState</span><span class="o">:=</span><span class="n">OPEN</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">i_xClsLS</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">i_xOpnLS</span> <span class="n">THEN</span>
    <span class="n">iq_stValve</span><span class="o">.</span><span class="n">eState</span><span class="o">:=</span><span class="n">CLOSED</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">NOT</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">i_xClsLS</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">i_xOpnLS</span> <span class="n">THEN</span>
    <span class="n">iq_stValve</span><span class="o">.</span><span class="n">eState</span><span class="o">:=</span><span class="n">MOVING</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">iq_stValve</span><span class="o">.</span><span class="n">eState</span><span class="o">:=</span><span class="n">INVALID</span><span class="p">;</span>
<span class="n">END_IF</span>


<span class="p">(</span><span class="o">*</span> <span class="n">Here</span><span class="s1">&#39;s where the valve opens *)</span>
<span class="o">//</span><span class="n">iq_stValve</span><span class="o">.</span><span class="n">q_xOPN_DO</span> <span class="o">:=</span> <span class="p">(</span><span class="n">NOT</span><span class="p">(</span><span class="n">i_xCLS_SW</span><span class="p">)</span> <span class="n">AND</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">xOPN_OK</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">i_xOpnLS</span><span class="p">)</span> <span class="n">OR</span> <span class="p">(</span><span class="n">tonOvrd</span><span class="o">.</span><span class="n">Q</span> <span class="n">AND</span> <span class="n">i_xOverrideMode</span><span class="p">);</span>


<span class="p">(</span><span class="o">*</span> <span class="n">Input</span> <span class="n">Trigger</span> <span class="n">to</span> <span class="n">close</span> <span class="n">the</span> <span class="n">Fast</span> <span class="n">Shutter</span><span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Neighboring</span> <span class="n">Valves</span> <span class="n">Should</span> <span class="n">also</span> <span class="n">be</span> <span class="n">triggered</span> <span class="n">to</span> <span class="n">Close</span><span class="o">*</span><span class="p">)</span>
<span class="n">IF</span> <span class="p">(</span><span class="n">i_xTrigger</span><span class="p">)</span> <span class="n">OR</span> <span class="n">NOT</span> <span class="p">(</span><span class="n">i_xPress_OK</span><span class="p">)</span> <span class="n">OR</span> <span class="n">NOT</span> <span class="p">(</span><span class="n">i_xExt_OK</span><span class="p">)</span>  <span class="n">OR</span> <span class="n">i_xCLS_SW</span>  <span class="n">THEN</span>
    <span class="n">xClose</span><span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">xOpen</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">q_xVAC_FAULT_OK</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">IF</span> <span class="p">(</span><span class="n">NOT</span> <span class="n">i_xCLS_SW</span><span class="p">)</span> <span class="n">THEN</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">xERR_ExtFault</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span> <span class="n">END_IF</span><span class="p">;</span>
    <span class="n">i_xCLS_SW</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">iq_stValve</span><span class="o">.</span><span class="n">q_xOPN_DO</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">iq_stValve</span><span class="o">.</span><span class="n">pv_xOPN_SW</span> <span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">xOpen</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="p">((</span><span class="n">iq_stValve</span><span class="o">.</span><span class="n">pv_xOPN_SW</span><span class="p">)</span> <span class="n">AND</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">xOPN_OK</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">i_xOpnLS</span><span class="p">)</span> <span class="n">OR</span> <span class="p">(</span><span class="n">tonOvrd</span><span class="o">.</span><span class="n">Q</span> <span class="n">AND</span> <span class="n">i_xOverrideMode</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">iq_stValve</span><span class="o">.</span><span class="n">q_xOPN_DO</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">IF</span> <span class="p">(</span><span class="n">xClose</span><span class="p">)</span> <span class="n">AND</span> <span class="p">(</span><span class="n">NOT</span> <span class="n">i_xClsLS</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">q_xClose_A</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">q_xClose_B</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">q_xClose_C</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">IF</span><span class="p">(</span><span class="n">CloseTimer</span><span class="o">.</span><span class="n">Q</span><span class="p">)</span> <span class="n">OR</span> <span class="p">(</span><span class="n">i_xClsLS</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">q_xClose_A</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">q_xClose_B</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">q_xClose_C</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">xClose</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">i_xOPN_SW</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span><span class="p">(</span><span class="n">OpenTimer</span><span class="o">.</span><span class="n">Q</span><span class="p">)</span> <span class="n">AND</span> <span class="p">(</span><span class="n">i_xOpnLS</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">iq_stValve</span><span class="o">.</span><span class="n">q_xOPN_DO</span> <span class="o">:=</span>  <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">i_xOPN_SW</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">xOpen</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Neighboring</span> <span class="n">Valves</span> <span class="n">Interlock</span> <span class="n">bit</span> <span class="ow">is</span> <span class="n">reset</span> <span class="n">When</span> <span class="n">the</span> <span class="n">Vacuum</span> <span class="n">event</span> <span class="n">error</span> <span class="ow">is</span> <span class="n">reset</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">Shutter</span> <span class="ow">is</span> <span class="n">opened</span> <span class="o">*</span><span class="p">)</span>
<span class="n">IF</span> <span class="p">(</span><span class="n">NOT</span> <span class="n">i_xTrigger</span><span class="p">)</span> <span class="n">AND</span> <span class="p">(</span><span class="n">NOT</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">xERR_ExtFault</span><span class="p">)</span> <span class="n">AND</span> <span class="n">i_xOpnLS</span> <span class="n">THEN</span>
    <span class="n">q_xVAC_FAULT_OK</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="p">(</span><span class="o">*</span><span class="n">OPN</span> <span class="n">OK</span> <span class="n">evaluation</span> <span class="n">bit</span> <span class="o">*</span><span class="p">)</span>
<span class="n">iq_stValve</span><span class="o">.</span><span class="n">xOPN_OK</span> <span class="o">:=</span> <span class="p">(</span><span class="n">NOT</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">xERR_ExtFault</span><span class="p">)</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">i_xTrigger</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span> <span class="n">If</span> <span class="n">Epics</span> <span class="n">Command</span> <span class="n">to</span> <span class="n">close</span> <span class="n">the</span> <span class="n">Valve</span><span class="p">,</span> <span class="n">check</span> <span class="k">if</span> <span class="n">PMPS</span><span class="p">,</span> <span class="n">otherwise</span> <span class="n">Keep</span> <span class="n">command</span> <span class="nb">set</span> <span class="n">to</span> <span class="nb">open</span> <span class="n">valve</span> <span class="o">*</span><span class="p">)</span>
<span class="o">//</span> <span class="ow">is</span> <span class="n">there</span> <span class="n">really</span> <span class="n">a</span> <span class="n">PMPS</span> <span class="n">requirment</span><span class="o">.</span>



<span class="p">(</span><span class="o">*</span> <span class="n">When</span> <span class="n">the</span> <span class="n">valve</span>  <span class="ow">is</span> <span class="nb">open</span> <span class="n">MPS</span> <span class="ow">is</span> <span class="n">OK</span><span class="o">*</span><span class="p">)</span>
<span class="n">q_xMPS_OK</span> <span class="o">:=</span> <span class="p">(</span><span class="n">iq_stValve</span><span class="o">.</span><span class="n">eState</span><span class="o">=</span><span class="n">OPEN</span><span class="p">)</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">i_xTrigger</span> <span class="n">AND</span> <span class="n">i_xPress_OK</span><span class="p">;</span><span class="o">//</span><span class="n">gauge</span> <span class="ow">is</span> <span class="n">connected</span>


<span class="p">(</span><span class="o">*</span> <span class="n">Override</span> <span class="n">logic</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Goal</span><span class="p">:</span> <span class="n">give</span> <span class="n">ability</span> <span class="n">to</span> <span class="n">override</span><span class="p">,</span> <span class="n">but</span> <span class="n">do</span> <span class="n">so</span> <span class="ow">in</span> <span class="n">a</span> <span class="n">way</span> <span class="n">that</span> <span class="n">people</span> <span class="n">won</span><span class="s1">&#39;t forget it.</span>
<span class="n">Solution</span><span class="p">:</span> <span class="n">Override</span> <span class="n">only</span> <span class="n">after</span> <span class="n">ten</span> <span class="n">seconds</span> <span class="n">of</span> <span class="n">override</span><span class="p">,</span> <span class="n">protect</span> <span class="n">against</span> <span class="n">blips</span><span class="p">,</span>
<span class="n">when</span> <span class="n">the</span> <span class="n">valve</span> <span class="n">permission</span> <span class="n">goes</span> <span class="n">true</span> <span class="k">for</span> <span class="n">more</span> <span class="n">than</span> <span class="n">ten</span> <span class="n">seconds</span> <span class="n">consistently</span><span class="p">,</span> <span class="n">remove</span> <span class="n">override</span>
<span class="o">*</span><span class="p">)</span>

<span class="n">tonDelOK</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">iq_stValve</span><span class="o">.</span><span class="n">xOPN_OK</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span><span class="n">tDelOK</span><span class="p">);</span>
<span class="n">rtOK</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">tonDelOK</span><span class="o">.</span><span class="n">Q</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">rtOK</span><span class="o">.</span><span class="n">Q</span> <span class="n">AND</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">pv_xOvrdOpn</span> <span class="n">THEN</span>
    <span class="n">iq_stValve</span><span class="o">.</span><span class="n">pv_xOvrdOpn</span> <span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="o">//</span><span class="n">iq_stValve</span><span class="o">.</span><span class="n">pv_xOPN_SW</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span> <span class="o">//</span><span class="k">for</span> <span class="n">seamless</span> <span class="n">transition</span>
<span class="n">END_IF</span>

<span class="o">//</span><span class="n">Override</span> <span class="n">timer</span>
<span class="n">tonOvrd</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">iq_stValve</span><span class="o">.</span><span class="n">pv_xOvrdOpn</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span><span class="n">tOvrd</span><span class="p">);</span>



<span class="o">///</span><span class="n">Check</span> <span class="n">valve</span> <span class="n">postion</span> <span class="n">timout</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">i_xClsLS</span> <span class="n">AND</span> <span class="n">tCLStimeout</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">iq_stValve</span><span class="o">.</span><span class="n">bErrorPresent</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">NOT</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">i_xOpnLS</span> <span class="n">AND</span> <span class="n">tOPNtimeout</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">iq_stValve</span><span class="o">.</span><span class="n">bErrorPresent</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="p">(</span><span class="o">*</span><span class="n">Timers</span><span class="o">*</span><span class="p">)</span>
<span class="n">CloseTimer</span> <span class="p">(</span> <span class="n">IN</span><span class="o">:=</span><span class="n">xClose</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span> <span class="n">TimDur</span><span class="p">,</span> <span class="n">Q</span><span class="o">=&gt;</span><span class="p">);</span>
<span class="n">OpenTimer</span> <span class="p">(</span> <span class="n">IN</span><span class="o">:=</span><span class="n">i_xOpnLS</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span> <span class="n">OpenTimDur</span><span class="p">,</span> <span class="n">Q</span><span class="o">=&gt;</span><span class="p">);</span>
<span class="n">tOPNtimeout</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">q_xOPN_DO</span><span class="p">,</span> <span class="n">PT</span> <span class="o">:=</span> <span class="n">tTimeOutDuration</span> <span class="p">);</span>
<span class="n">tCLStimeout</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span> <span class="n">NOT</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">q_xOPN_DO</span><span class="p">,</span> <span class="n">PT</span> <span class="o">:=</span> <span class="n">tTimeOutDuration</span><span class="p">);</span>


<span class="p">(</span><span class="o">*</span> <span class="n">Soft</span> <span class="n">IO</span> <span class="n">Mapping</span><span class="o">*</span><span class="p">)</span>
<span class="n">IO</span><span class="p">();</span>
<span class="n">ACT_Logger</span><span class="p">();</span>
<span class="o">//</span> <span class="n">Alarm</span> <span class="n">reset</span>
<span class="o">//////////////////////////////////////</span>
<span class="n">ACT_ResetAlarms</span><span class="p">();</span>

<span class="p">(</span><span class="o">*</span><span class="n">FAST</span> <span class="n">FAULT</span><span class="o">*</span><span class="p">)</span>
<span class="n">fbFF</span><span class="p">(</span><span class="n">i_xOK</span> <span class="o">:=</span> <span class="n">q_xMPS_OK</span><span class="p">,</span>
    <span class="n">i_xReset</span> <span class="o">:=</span> <span class="n">i_xResetFault</span><span class="p">,</span>
    <span class="n">io_fbFFHWO</span> <span class="o">:=</span> <span class="n">io_fbFFHWO</span><span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>
<span class="n">ACTION</span> <span class="n">ACT_Logger</span><span class="p">:</span>
<span class="o">//</span> <span class="n">ILK</span> <span class="n">logger</span>

<span class="n">IF</span> <span class="n">i_xTrigger</span> <span class="n">AND</span> <span class="n">ePrevState</span> <span class="o">=</span> <span class="n">OPEN</span> <span class="n">THEN</span>
            <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Fast valve triggered to close&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span>
<span class="n">END_IF</span>


<span class="o">//</span><span class="n">STATE</span> <span class="n">Logger</span>

<span class="n">IF</span> <span class="n">ePrevState</span> <span class="o">&lt;&gt;</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">eState</span> <span class="n">THEN</span>
      <span class="n">CASE</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">eState</span> <span class="n">OF</span>
            <span class="n">INVALID</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Valve invalid position.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span>
            <span class="n">MOVING</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Valve moving&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Warning</span><span class="p">);</span>
            <span class="n">OPEN</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Valve Open.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span>
            <span class="n">CLOSED</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Valve closed.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span>
      <span class="n">END_CASE</span>
      <span class="n">ePrevState</span> <span class="o">:=</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">eState</span><span class="p">;</span>
  <span class="n">END_IF</span>



<span class="o">//</span> <span class="n">Log</span> <span class="n">valve</span> <span class="n">timeouts</span>
<span class="n">tErrorPresent</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">iq_stValve</span><span class="o">.</span><span class="n">bErrorPresent</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">tErrorPresent</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span> <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="n">iq_stValve</span><span class="o">.</span><span class="n">sErrorMessage</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Warning</span><span class="p">);</span> <span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Log</span> <span class="n">valve</span> <span class="nb">open</span>
<span class="n">tAction</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">q_xOPN_DO</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">tAction</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span> <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Valve commanded open&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span> <span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Log</span> <span class="n">override</span> <span class="n">mode</span> <span class="n">enabled</span>
<span class="n">tOverrideActivated</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span> <span class="p">(</span><span class="n">tonOvrd</span><span class="o">.</span><span class="n">Q</span> <span class="n">AND</span> <span class="n">i_xOverrideMode</span><span class="p">));</span>
<span class="n">IF</span> <span class="n">tOverrideActivated</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span> <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Valve override mode activated&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Warning</span><span class="p">);</span> <span class="n">END_IF</span>
<span class="n">END_ACTION</span>
<span class="n">ACTION</span> <span class="n">ACT_ResetAlarms</span><span class="p">:</span>
<span class="n">iq_stValve</span><span class="o">.</span><span class="n">xERR_DifPres</span> <span class="n">R</span><span class="o">=</span> <span class="n">i_xResetFault</span><span class="p">;</span>

<span class="n">iq_stValve</span><span class="o">.</span><span class="n">bErrorPresent</span> <span class="n">R</span><span class="o">=</span> <span class="n">i_xResetFault</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">NOT</span> <span class="n">i_xTrigger</span>  <span class="n">THEN</span>
    <span class="n">iq_stValve</span><span class="o">.</span><span class="n">xERR_ExtFault</span> <span class="n">R</span><span class="o">=</span> <span class="n">i_xResetFault</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">END_ACTION</span>
<span class="n">ACTION</span> <span class="n">IO</span><span class="p">:</span>
<span class="p">(</span><span class="o">*</span><span class="n">inputs</span><span class="o">*</span><span class="p">)</span>
<span class="n">iq_stValve</span><span class="o">.</span><span class="n">pv_xOPN_SW</span> <span class="o">:=</span> <span class="n">i_xOPN_SW</span><span class="p">;</span>
<span class="n">iq_stValve</span><span class="o">.</span><span class="n">i_xOpnLS</span> <span class="o">:=</span>      <span class="n">i_xOpnLS</span><span class="p">;</span>
<span class="n">iq_stValve</span><span class="o">.</span><span class="n">i_xClsLS</span><span class="o">:=</span>       <span class="n">i_xClsLS</span><span class="p">;</span>
<span class="n">iq_stValve</span><span class="o">.</span><span class="n">xEXT_OK</span> <span class="o">:=</span> <span class="n">i_xEXT_OK</span><span class="p">;</span>
<span class="n">iq_stValve</span><span class="o">.</span><span class="n">xOverrideMode</span> <span class="o">:=</span> <span class="n">i_xOverrideMode</span><span class="p">;</span>
<span class="n">iq_stValve</span><span class="o">.</span><span class="n">pv_xOvrdOpn</span> <span class="o">:=</span> <span class="n">i_xOverrideOpen</span><span class="p">;</span>
<span class="p">(</span><span class="o">*</span><span class="n">outputs</span><span class="o">*</span><span class="p">)</span>
<span class="n">q_xOPN_DO</span><span class="o">:=</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">q_xOPN_DO</span><span class="p">;</span>
<span class="n">q_xTrigger</span><span class="o">:=</span><span class="n">i_xTrigger</span><span class="p">;</span>

<span class="o">//</span><span class="n">iq_stValve</span><span class="o">.</span><span class="n">pv_xOPN_SW</span><span class="o">:=</span> <span class="n">i_xOPN_SW</span><span class="p">;</span>

<span class="n">q_xVFS_Closed</span><span class="o">:=</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">i_xClsLS</span><span class="p">;</span>
<span class="n">q_xVFS_Open</span><span class="o">:=</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">i_xOpnLS</span><span class="p">;</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
</div>
<div class="section" id="fb-vfs-interface">
<h2>FB_VFS_Interface<a class="headerlink" href="#fb-vfs-interface" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span><span class="n">Used</span> <span class="k">as</span> <span class="n">soft</span> <span class="n">IO</span> <span class="n">mapping</span> <span class="n">to</span> <span class="n">create</span> <span class="n">a</span> <span class="n">psuedo</span> <span class="n">valve</span> <span class="n">to</span> <span class="n">communicate</span> <span class="n">over</span> <span class="n">two</span> <span class="n">task</span> <span class="n">on</span> <span class="n">the</span> <span class="n">same</span> <span class="n">PLC</span><span class="o">.*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span><span class="k">for</span> <span class="n">FAST</span> <span class="n">shutter</span> <span class="n">control</span><span class="o">*</span><span class="p">)</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_VFS_Interface</span>
<span class="n">VAR_INPUT</span>
    <span class="n">IG</span> <span class="p">:</span> <span class="n">ST_VG</span><span class="p">;</span> <span class="o">//</span> <span class="n">The</span> <span class="n">Cold</span> <span class="n">Cathode</span> <span class="n">Data</span> <span class="n">Structure</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">FF_Reset</span>
    <span class="s1">&#39;}</span>
    <span class="n">i_xFFReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>

<span class="n">END_VAR</span>
<span class="n">VAR</span>

    <span class="p">(</span><span class="o">*</span><span class="n">outputs</span><span class="o">*</span><span class="p">)</span>
    <span class="n">q_xPRESS_OK</span> <span class="n">AT</span><span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">OPEN_SW</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">OPEN</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span> <span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">q_xOPN_SW</span> <span class="n">AT</span><span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span><span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">CLS_SW</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">CLOSE</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span> <span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">q_xCLS_SW</span> <span class="n">AT</span><span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span><span class="n">BOOL</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span><span class="n">external</span> <span class="nb">open</span> <span class="n">signal</span> <span class="n">e</span><span class="o">.</span><span class="n">g</span> <span class="n">epics</span><span class="o">*</span><span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">FAULT_RESET</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span> <span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">q_xVAC_FAULT_Reset</span> <span class="n">AT</span><span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span><span class="n">Valve</span> <span class="n">Vacuum</span> <span class="n">OK</span><span class="p">,</span> <span class="ow">is</span> <span class="nb">set</span> <span class="n">to</span> <span class="kc">False</span> <span class="n">when</span> <span class="n">there</span> <span class="ow">is</span> <span class="n">Vacuum</span> <span class="n">Fault</span><span class="o">*</span><span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">VFS_OVRD_ON</span> <span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">Override</span> <span class="n">OFF</span> <span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">Override</span> <span class="n">ON</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">q_xOverrideMode</span> <span class="n">AT</span><span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span><span class="n">To</span> <span class="n">be</span> <span class="n">linked</span> <span class="n">to</span> <span class="k">global</span> <span class="n">override</span> <span class="n">bit</span><span class="o">.</span> <span class="n">This</span> <span class="n">Overrides</span> <span class="n">Vacuum</span> <span class="n">logic</span> <span class="n">only</span><span class="p">,</span> <span class="n">EPS</span><span class="p">,</span> <span class="n">MPS</span> <span class="ow">and</span> <span class="n">PMPS</span> <span class="n">are</span> <span class="n">still</span> <span class="n">enforces</span><span class="o">*</span><span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">VFS_FORCE_OPN</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">FORCE</span> <span class="n">OPEN</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">q_xOverrideOpen</span> <span class="n">AT</span><span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="p">(</span><span class="o">*</span><span class="n">inputs</span><span class="o">*</span><span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">TRIG</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">TRIG_OFF</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRIG_ON</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span> <span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">i_xTrigger</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">IS_OPEN</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">NOT</span> <span class="n">OPEN</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">OPEN</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span> <span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">i_xVFS_Open</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">IS_CLOSED</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">NOT</span> <span class="n">CLOSED</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">CLOSE</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span> <span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">i_xVFS_Closed</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">VAC_FAULT_OK</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FAULT</span> <span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">FAULT</span> <span class="n">OK</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span> <span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">i_xVAC_FAULT_OK</span> <span class="n">AT</span><span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span><span class="n">Valve</span> <span class="n">Vacuum</span> <span class="n">OK</span><span class="p">,</span> <span class="ow">is</span> <span class="nb">set</span> <span class="n">to</span> <span class="kc">False</span> <span class="n">when</span> <span class="n">there</span> <span class="ow">is</span> <span class="n">Vacuum</span> <span class="n">Fault</span><span class="o">*</span><span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">FFO_OK</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FAULT</span> <span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">FAULT</span> <span class="n">OK</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span> <span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">i_xMPS_OK</span> <span class="n">AT</span><span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;(</span><span class="o">*</span><span class="n">MPS</span> <span class="n">Fault</span> <span class="n">OK</span><span class="p">,</span> <span class="ow">is</span> <span class="nb">set</span> <span class="n">when</span> <span class="n">the</span> <span class="n">Valve</span> <span class="ow">is</span> <span class="n">Open</span> <span class="ow">and</span> <span class="n">there</span> <span class="ow">is</span> <span class="n">no</span> <span class="n">trigger</span><span class="o">*</span><span class="p">)</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span><span class="n">soft</span> <span class="n">IO</span> <span class="n">Mapping</span><span class="o">*</span><span class="p">)</span>

<span class="n">q_xPRESS_OK</span> <span class="o">:=</span> <span class="n">IG</span><span class="o">.</span><span class="n">xPRESS_OK</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</div>
<div class="section" id="fb-vgc">
<h2>FB_VGC<a class="headerlink" href="#fb-vgc" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(* This function block implements basic functionality for Isolation Gate Valves*)
(* This function block interlock is as follows:
1. The valve can be opened when the difference between the pressures on both sides is
less than the maximum differential pressure.
2. This rule persists until the pressures on both sides are lower than the vacuum-setpoint.
3. Once at-vac, the valve will close if the pressure on either side rises above the setpoint.*)
(*This function block also implements PMPS and EPS interlocks, as well as Fast MPS trigger*)
{attribute &#39;no_check&#39;}
FUNCTION_BLOCK FB_VGC Extends FB_Valve
VAR_IN_OUT

END_VAR
VAR_INPUT
    (*Upstream Gauge, usually ion gauge*)
    i_stUSG :       ST_VG;
    (*Downstream Gauge, usually ion gauge*)
    i_stDSG :       ST_VG;
    {attribute &#39;pytmc&#39; := &#39;
    pv: Dis_DPIlk
    &#39;}
    i_xDis_DPIlk : BOOL := FALSE;  (* Set to true when calling the function to disable the differential pressure interlock *)
    {attribute &#39;pytmc&#39; := &#39;
    pv: EPS_OK
    &#39;}
    i_xEPS_OK:      BOOL    := TRUE; (*External EPS interlock, Set to TRUE when no EPS interlock is required, otherwise set to correct interlock signal*)
    {attribute &#39;pytmc&#39; := &#39;
    pv: MPS_OK
    &#39;}
    i_xPMPS_OK:     BOOL    ; (*External MPS interlock, Set to TRUE when no PMPS interlock is required*)
            i_xExt_OK: BOOL; (*Other External Interlock, Set to True when no external interlock is required. If this Valve is neigboring a Fast Shutter this should be linked to the fast shutter xVAC_FAULT_OK*)
    i_xOverrideMode : BOOL; (*To be linked to global override bit. This Overrides Vacuum logic only, EPS, MPS and PMPS are still enforces*)
    // Reset fault
    {attribute &#39;pytmc&#39; := &#39;
    pv: FF_Reset
    &#39;}
    i_xReset: BOOL;
    i_xIsAperture:BOOL :=FALSE; // Set tp True if this is an Aperture Valve, the MPS Fault will trip only when moving.
END_VAR
VAR_OUTPUT
    {attribute &#39;pytmc&#39; := &#39;
    pv:
    &#39;}
    iq_stValve : ST_VGC; (* All valve data and states will be in this struct*)

    {attribute &#39;pytmc&#39; := &#39;
    pv: MPS_FAULT_OK
    field: ZNAM MPS FAULT ;
    field: ONAM MPS OK ;
    &#39;}
    xMPS_OK:        BOOL; (*MPS Fast OK, is set when the Valve is Open*)
END_VAR
VAR_IN_OUT
    io_fbFFHWO    :    FB_HardwareFFOutput;
END_VAR
VAR
    // PMPS
    FFO    :    FB_FastFault :=(
        i_DevName := &#39;VGC&#39;,
        i_Desc := &#39;Fault occurs when the valve is not in open state&#39;,
        i_TypeCode := 16#1010);
    //g_FastFaultOutput1    :       FB_HardwareFFOutput;

    {attribute &#39;instance-path&#39;}
    {attribute &#39;noinit&#39;}
    sPath: STRING;

    rDiffPressAllowed       :       REAL := 22.5; // Torr, Default value comes from Vat Valve Manual
    rDiffPress : REAL;
    set : BOOL;
    reset: BOOL;

    xFirstPass      :       BOOL;
    fbFSInit                :       R_TRIG;

    tonDelOK : TON;
    rtOK    :       R_TRIG;
    tonOvrd :       TON;

    tDelOK  :       TIME := T#60S;
    tOvrd   :       TIME := T#10s;


    (* Timeouts*)
    tTimeOutDuration: TIME:= T#30S;
    tOPNtimeout: TON;
    tCLStimeout:TON;


    (*IO*)
    i_xOpnLS        AT%I*: BOOL;
    i_xClsLS        AT%I*: BOOL;
    q_xOPN_DO       AT%Q*: BOOL;

    // For logging
    eVGCPrevState : E_VGC;


END_VAR
(* Vacuum gate valve
A. Wallace
16-10-29

A gate valve isolates vacuum volumes. Ideally it can be opened when a system is vented
to allow for faster pumping, and will close when high vacuum is lost.

The following behavior is good for valves in something like a gas attenuator.
This function block does the following:
1. The valve can be opened when the difference between the pressures on both sides is
less than the maximum differential pressure.
2. This rule persists until the pressures on both sides are lower than the vacuum-setpoint.
3. Once at-vac, the valve will close if the pressure on either side rises above the setpoint.

Alternatively, the differential pressure interlock can be disabled so the valve may only be opened
if the pressure on both sides is lower than the at-vacuum-setpoint. You want this behavior if
the valve is to be used in a UHV section.

Hysteresis is employed to ensure a smooth transition from vented/pumping down, to at-vac.

Finally, an override system is built in so you can bypass all the interlocking logic and
get back online.
*)
(* 10/1/2018 Margaret Ghaly included EPS, PMPS Checkes and MPS trigger signals*)


fbFSInit( CLK := TRUE, Q =&gt; xFirstPass);
(*IO Mapping*)
ACT_IO();

(* On first PLC pass, put valve into vented state, which implies a closed valve *)
IF xFirstPass THEN
    iq_stValve.eVGC_State := Vented;
    iq_stValve.pv_xOPN_SW := FALSE;
END_IF


///Check valve position
IF iq_stValve.i_xClsLS AND  iq_stValve.i_xOpnLS THEN
    iq_stValve.eState:=INVALID;
ELSIF NOT iq_stValve.i_xClsLS AND iq_stValve.i_xOpnLS AND iq_stValve.q_xOPN_DO THEN
    iq_stValve.eState:=OPEN;
ELSIF NOT iq_stValve.i_xClsLS AND iq_stValve.i_xOpnLS AND NOT iq_stValve.q_xOPN_DO THEN
    iq_stValve.eState:=OPEN_F;
ELSIF iq_stValve.i_xClsLS AND NOT iq_stValve.i_xOpnLS AND NOT iq_stValve.q_xOPN_DO THEN
    iq_stValve.eState:=CLOSED;
ELSIF NOT iq_stValve.i_xClsLS AND NOT iq_stValve.i_xOpnLS THEN
    iq_stValve.eState:=MOVING;
ELSE
    iq_stValve.eState:=INVALID;
END_IF

// Update hysteresis
///////////////////////////////////////////////////
IF iq_stValve.rAT_VAC_SP_LAST &lt;&gt; iq_stValve.rAT_VAC_SP OR xFirstPass THEN
    iq_stValve.rAT_VAC_SP_LAST := iq_stValve.rAT_VAC_SP;
    iq_stValve.rAT_VAC_HYS := iq_stValve.rHYST_PERC * iq_stValve.rAT_VAC_SP;
END_IF

iq_stValve.rAT_VAC_HYS := LIMIT(0, iq_stValve.rAT_VAC_HYS, iq_stValve.rAT_VAC_SP);
IF iq_stValve.rAT_VAC_SP &lt;&gt; 0 THEN
    IF iq_stValve.rHYST_PERC &lt;&gt; (iq_stValve.rAT_VAC_HYS / iq_stValve.rAT_VAC_SP) THEN
            iq_stValve.rHYST_PERC := LIMIT(0, (iq_stValve.rAT_VAC_HYS / iq_stValve.rAT_VAC_SP) ,1);
    END_IF
END_IF
// Valve at vacuum check
///////////////////////////////////////////////////
    set := i_stUSG.rPRESS &lt; iq_stValve.rAT_VAC_HYS AND i_stDSG.rPRESS &lt; iq_stValve.rAT_VAC_HYS AND i_stUSG.xPRESS_OK AND i_stDSG.xPRESS_OK;
    iq_stValve.xAT_VAC S= set;
    reset := i_stUSG.rPRESS &gt; iq_stValve.rAT_VAC_SP OR i_stDSG.rPRESS &gt; iq_stValve.rAT_VAC_SP OR NOT i_stUSG.xPRESS_OK OR NOT i_stDSG.xPRESS_OK;
    iq_stValve.xAT_VAC R= reset;

// Differential pressure check
///////////////////////////////////////////////////
    (* Calc the differential pressure across the valve *)
    rDiffPress := ABS(i_stUSG.rPRESS - i_stDSG.rPRESS);

    (* As long as the differential pressure is less than 30mbar, the valve is allowed to open *)
    IF rDiffPress &lt;= rDiffPressAllowed AND i_stUSG.xPRESS_OK AND i_stDSG.xPRESS_OK THEN
            iq_stValve.xDP_OK := TRUE;
    ELSE
            iq_stValve.xDP_OK       := FALSE;
            (* If the differential pressure is exceeded, even when the valve is open,
            the state is unexpected and triggers a fault, because it suggests that something
            is wrong with the valve, or gauges or mapping or there is a major leak on one side.*)
            iq_stValve.eVGC_State := ERR_DiffPress;
        iq_stValve.xERR_DifPres := TRUE;
    END_IF

// Valve state
///////////////////////////////////////////////////
CASE iq_stValve.eVGC_State OF
    Vented: (* The Vented state is used during pump down *)
            (* Assuming the pump down went well, we are now at vacuum on both sides,
            so we move to the vacuum state, otherwise remain in the vented state *)
            IF iq_stValve.xAT_VAC AND (NOT (iq_stValve.xERR_DifPres)) AND (NOT (iq_stValve.xERR_SP)) AND (NOT (iq_stValve.xERR_ExtFault))THEN
                iq_stValve.eVGC_State := AtVacuum;
            ELSE
                iq_stValve.eVGC_State := Vented;
            END_IF

    AtVacuum:
            IF iq_stValve.xAT_VAC THEN
            (* If both pressure setpoints are made,
            then enable the differential pressure interlock, regardless of the valve state
            assuming we&#39;re using some kind of ion gauge where a pressure setpoint cannot be higher than 1E-4 T *)
            iq_stValve.eVGC_State := AtVacuum;

            ELSE

                    (* If the valve is open (or in an unknown state) and either gauge is not at it&#39;s vacuum setpoint,
                    we have a loss of vacuum error *)
                    IF (iq_stValve.i_xOpnLS OR (NOT iq_stValve.i_xOpnLS AND NOT iq_stValve.i_xClsLS)) THEN
                            iq_stValve.eVGC_State := ERR_LostVac;
                            iq_stValve.xERR_SP := TRUE; //TAW changed this to the ERR_SP bool because I think that&#39;s what it was intended to be?

                    (* Alternatively, if the valve is already closed and we lose pressure on one side,
                    it was probably intentional venting, so we calmly move back to venting mode, and
                    disable the differential pressure interlock *) //??
                    ELSIF iq_stValve.i_xClsLS THEN
                            iq_stValve.eVGC_State := Vented;
                    END_IF

            END_IF

    ERR_DiffPress:
            IF NOT (iq_stValve.xERR_DifPres) THEN
                    IF iq_stValve.xAT_VAC AND (NOT (iq_stValve.xERR_DifPres)) AND (NOT (iq_stValve.xERR_SP)) AND (NOT (iq_stValve.xERR_ExtFault))THEN
                    iq_stValve.eVGC_State := AtVacuum;
                    ELSE
                    iq_stValve.eVGC_State := Vented;
                    END_IF
            END_IF


    ERR_LostVac:
            IF NOT (iq_stValve.xERR_SP) THEN
                    IF iq_stValve.xAT_VAC AND (NOT (iq_stValve.xERR_DifPres)) AND (NOT (iq_stValve.xERR_SP)) AND (NOT (iq_stValve.xERR_ExtFault))THEN
                    iq_stValve.eVGC_State := AtVacuum;
                    ELSE
                    iq_stValve.eVGC_State := Vented;
                    END_IF
            END_IF

    ERR_ExtFault:
            IF NOT (iq_stValve.xERR_ExtFault) AND (NOT i_xExt_OK) THEN
                    IF iq_stValve.xAT_VAC AND (NOT (iq_stValve.xERR_DifPres)) AND (NOT (iq_stValve.xERR_SP)) AND (NOT (iq_stValve.xERR_ExtFault))THEN
                    iq_stValve.eVGC_State := AtVacuum;
                    ELSE
                    iq_stValve.eVGC_State := Vented;
                    END_IF
            END_IF
END_CASE

IF (NOT i_xExt_OK) AND (iq_stValve.eState=OPEN)  THEN
    iq_stValve.eVGC_State := ERR_ExtFault;
    iq_stValve.xERR_ExtFault := TRUE;
END_IF

// Interlock evaluation - with bypass for DP ILK bypass
///////////////////////////////////////////////
IF i_xDis_DPIlk THEN
    iq_stValve.xOPN_OK := iq_stValve.xEXT_OK; // AND iq_stValve.xDP_OK ;
ELSE
    iq_stValve.xOPN_OK := iq_stValve.xEXT_OK AND iq_stValve.xAT_VAC;
END_IF


(* Valve operation *)

(* Override logic *)
(* Goal: give ability to override, but do so in a way that people won&#39;t forget it.
Solution: Override only after ten seconds of override, protect against blips,
when the valve permission goes true for more than ten seconds consistently, remove override
*)

tonDelOK(IN:=iq_stValve.xOPN_OK, PT:=tDelOK);
rtOK(CLK:=tonDelOK.Q);
IF rtOK.Q AND iq_stValve.pv_xOvrdOpn THEN
    iq_stValve.pv_xOvrdOpn :=FALSE;
    if (iq_stValve.eState = OPEN) AND (i_xOverrideMode) THEN iq_stValve.pv_xOPN_SW := TRUE; END_IF //for seamless transition
    //Log
    fbLogger(sMsg:=&#39;Override expired&#39;, eSevr:=TcEventSeverity.Warning);
END_IF
// Release the Force Open bit when the system override is false
IF NOT (i_xOverrideMode) THEN  iq_stValve.pv_xOvrdOpn :=FALSE; END_IF
//Override timer
tonOvrd(IN:=iq_stValve.pv_xOvrdOpn, PT:=tOvrd);

(* If Epics Command to close the Valve while it was open, check if PMPS and EPS are ok, otherwise Keep command set to open valve *)
IF NOT(iq_stValve.pv_xOPN_SW) AND (iq_stValve.eState =OPEN) AND (NOT (i_xPMPS_OK) OR (i_xEPS_OK)) THEN
    //iq_stValve.pv_xOPN_SW := TRUE; // plc to only reset never to set this signal
END_IF
(* Reset the EPICS command to open the valve if the interlock is lost *)
(* based on EPS ok state, EPS overrides OPN_OK*)
IF NOT iq_stValve.xOPN_OK THEN
    IF i_xEPS_OK THEN iq_stValve.pv_xOPN_SW := FALSE; iq_stValve.sErrorMessage := &#39;ILK Active&#39;;
    ELSE //iq_stValve.pv_xOPN_SW := TRUE;           // plc to only reset never to set this signal
    END_IF
END_IF

(* Here&#39;s where the valve opens *)
iq_stValve.q_xOPN_DO := (iq_stValve.pv_xOPN_SW AND iq_stValve.xOPN_OK) OR (tonOvrd.Q AND i_xOverrideMode);

(*MPS Fault setting*)
If (i_xIsAperture ) THEN
    (* When the valve  is open or in Closed position MPS is OK, Fault while moving*)
    xMPS_OK := (iq_stValve.eState=OPEN) OR (iq_stValve.eState=OPEN_F) OR (iq_stValve.eState=CLOSED);//iq_stValve.i_xOpnLS;
ELSE
    (* When the valve  is open MPS is OK*)
    xMPS_OK := (iq_stValve.eState=OPEN) OR (iq_stValve.eState=OPEN_F);//iq_stValve.i_xOpnLS;
END_IF


///Check valve moving postion timout
IF NOT iq_stValve.i_xClsLS AND tCLStimeout.Q THEN
    iq_stValve.bErrorPresent := TRUE;
    iq_stValve.sErrorMessage := &#39;Close Timeout&#39;;
ELSIF NOT iq_stValve.i_xOpnLS AND tOPNtimeout.Q THEN
    iq_stValve.bErrorPresent := TRUE;
    iq_stValve.sErrorMessage := &#39;Open Timeout&#39;;
END_IF
IF (iq_stValve.eState=INVALID) THEN
    iq_stValve.bErrorPresent := TRUE;
    iq_stValve.sErrorMessage := CONCAT(sPath,&#39;Invalid Valve Position&#39;);
END_IF


(*Timers*)
tOPNtimeout(IN:= iq_stValve.q_xOPN_DO, PT := tTimeOutDuration );
tCLStimeout(IN:= NOT iq_stValve.q_xOPN_DO, PT := tTimeOutDuration);

// Log valve timeouts
tErrorPresent(CLK:=iq_stValve.bErrorPresent);
IF tErrorPresent.Q THEN fbLogger(sMsg:=iq_stValve.sErrorMessage, eSevr:=TcEventSeverity.Warning); END_IF

// Log valve open
tAction(CLK:= iq_stValve.q_xOPN_DO);
IF tAction.Q THEN fbLogger(sMsg:=&#39;Valve commanded open&#39;, eSevr:=TcEventSeverity.Info); END_IF

// Log override mode enabled
tOverrideActivated(CLK:= (tonOvrd.Q AND i_xOverrideMode));
IF tOverrideActivated.Q THEN fbLogger(sMsg:=&#39;Valve override mode activated&#39;, eSevr:=TcEventSeverity.Warning); END_IF

// Alarm reset
//////////////////////////////////////
ACT_ResetAlarms();

(*IO Mapping*)
ACT_IO();

// Log States and triggers
ACT_Logger();

(*FAST FAULT*)
FFO(i_xOK := xMPS_OK,
    i_xReset := i_xReset,
    i_xAutoReset :=TRUE,
    io_fbFFHWO := io_fbFFHWO);

END_FUNCTION_BLOCK
ACTION ACT_IO:
(*inputs*)
iq_stValve.i_xOpnLS :=      i_xOpnLS;
iq_stValve.i_xClsLS:=       i_xClsLS;
iq_stValve.xEXT_OK := i_xEXT_OK;
iq_stValve.xOverrideMode := i_xOverrideMode;
(*outputs*)
q_xOPN_DO:= iq_stValve.q_xOPN_DO;

(*ILK Devices*)
iq_stValve.sIlkUSDeviceName := This^.i_stUSG.sPath;
iq_stValve.sIlkDSDeviceName := This^.i_stDSG.sPath;
END_ACTION
ACTION ACT_Logger:
// ILK logger

(*IF NOT i_xExtILK_OK AND ePrevState = OPEN THEN
            fbLogger(sMsg:=&#39;Lost external interlock while valve was open.&#39;, eSevr:=TcEventSeverity.Critical);
END_IF
*)

//Positiong STATE Logger
IF ePrevState &lt;&gt; iq_stValve.eState THEN
      CASE iq_stValve.eState OF
            INVALID:
                    fbLogger(sMsg:=&#39;Valve invalid position.&#39;, eSevr:=TcEventSeverity.Critical);
            MOVING:
                    fbLogger(sMsg:=&#39;Valve moving&#39;, eSevr:=TcEventSeverity.Warning);
            OPEN:
                    fbLogger(sMsg:=&#39;Valve Open.&#39;, eSevr:=TcEventSeverity.Info);
            OPEN_F:
                    fbLogger(sMsg:=&#39;Valve Open without open do.&#39;, eSevr:=TcEventSeverity.Info);
            CLOSED:
                    fbLogger(sMsg:=&#39;Valve closed.&#39;, eSevr:=TcEventSeverity.Info);
      END_CASE
      ePrevState := iq_stValve.eState;
  END_IF

 //Pressure STATE Logger
IF eVGCPrevState &lt;&gt; iq_stValve.eVGC_State THEN
      CASE iq_stValve.eVGC_State OF
            Vented:
                     fbLogger(sMsg:=&#39;Vented&#39;, eSevr:=TcEventSeverity.Info);
            AtVacuum:
                     fbLogger(sMsg:=&#39;Vacuum setpoint satisfied&#39;, eSevr:=TcEventSeverity.Info);
            ERR_DiffPress:
                     fbLogger(sMsg:=&#39;Potential accidental vent.&#39;, eSevr:=TcEventSeverity.Critical);
            ERR_LostVac:
                    fbLogger(sMsg:=&#39;Unexpected loss of vacuum while valve was open or moving.&#39;, eSevr:=TcEventSeverity.Critical);
            ERR_ExtFault:
                     fbLogger(sMsg:=&#39;Lost external interlock while valve was open.&#39;, eSevr:=TcEventSeverity.Critical);
      END_CASE
      eVGCPrevState := iq_stValve.eVGC_State;
  END_IF



// Log valve timeouts
tErrorPresent(CLK:=iq_stValve.bErrorPresent);
IF tErrorPresent.Q THEN fbLogger(sMsg:=iq_stValve.sErrorMessage, eSevr:=TcEventSeverity.Warning); END_IF

// Log valve open
tAction(CLK:= iq_stValve.q_xOPN_DO);
IF tAction.Q THEN fbLogger(sMsg:=&#39;Valve commanded open&#39;, eSevr:=TcEventSeverity.Info); END_IF

// Log override mode enabled
tOverrideActivated(CLK:= (tonOvrd.Q AND i_xOverrideMode));
IF tOverrideActivated.Q THEN fbLogger(sMsg:=&#39;Valve override mode activated&#39;, eSevr:=TcEventSeverity.Warning); END_IF
END_ACTION
ACTION ACT_ResetAlarms:
iq_stValve.xERR_DifPres R= iq_stValve.pv_xAlmRst;
iq_stValve.xERR_SP R= iq_stValve.pv_xAlmRst;
iq_stValve.bErrorPresent R= iq_stValve.pv_xAlmRst;

IF ( iq_stValve.pv_xAlmRst) THEN
    iq_stValve.sErrorMessage :=&#39;&#39;;
END_IF
END_ACTION
</pre></div>
</div>
</div>
<div class="section" id="fb-vgc-ap">
<h2>FB_VGC_AP<a class="headerlink" href="#fb-vgc-ap" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(*Deprectated*)
(* This function block implements basic functionality for Isolation Gate Valves with Appertures*)
(* This function block interlock is as follows:
1. The valve can be opened when the difference between the pressures on both sides is
less than the maximum differential pressure.
2. This rule persists until the pressures on both sides are lower than the vacuum-setpoint.
3. Once at-vac, the valve will close if the pressure on either side rises above the setpoint.*)
(*This function block also implements PMPS and EPS interlocks, as well as Fast MPS trigger*)
(* MPS is triggered differently than the VGC *)
{attribute &#39;no_check&#39;}
FUNCTION_BLOCK FB_VGC_AP
VAR_IN_OUT

END_VAR
VAR_INPUT
    (*Upstream Gauge, usually ion gauge*)
    i_stUSG :       ST_VG;
    (*Downstream Gauge, usually ion gauge*)
    i_stDSG :       ST_VG;
    {attribute &#39;pytmc&#39; := &#39;
    pv: Dis_DPIlk
    &#39;}
    i_xDis_DPIlk : BOOL := FALSE;  (* Set to true when calling the function to disable the differential pressure interlock *)
    {attribute &#39;pytmc&#39; := &#39;
    pv: EPS_OK
    &#39;}
    i_xEPS_OK:      BOOL    := TRUE; (*External EPS interlock, Set to TRUE when no EPS interlock is required, otherwise set to correct interlock signal*)
    {attribute &#39;pytmc&#39; := &#39;
    pv: MPS_OK
    &#39;}
    i_xPMPS_OK:     BOOL    ; (*External MPS interlock, Set to TRUE when no PMPS interlock is required*)
    i_xExt_OK: BOOL; (*Other External Interlock, Set to True when no external interlock is required. If this Valve is neigboring a Fast Shutter this should be linked to the fast shutter xVAC_FAULT_OK*)
    i_xOverrideMode : BOOL; (*To be linked to global override bit. This Overrides Vacuum logic only, EPS, MPS and PMPS are still enforces*)
    // Reset fault
    {attribute &#39;pytmc&#39; := &#39;
    pv: FF_Reset
    &#39;}
    i_xReset: BOOL;
END_VAR
VAR_OUTPUT
    {attribute &#39;pytmc&#39; := &#39;
    pv:
    &#39;}
    iq_stValve : ST_VGC; (* All valve data and states will be in this struct*)

    {attribute &#39;pytmc&#39; := &#39;
    pv: MPS_FAULT_OK
    &#39;}
    xMPS_OK:        BOOL; (*MPS Fast OK, is set when the Valve is Open*)
END_VAR
VAR_IN_OUT
    io_fbFFHWO    :    FB_HardwareFFOutput;
END_VAR
VAR
    // PMPS
    fbFF    :    FB_FastFault :=(
        i_DevName := &#39;VGC Aptr&#39;,
        i_Desc := &#39;Fault occurs when the valve is not in open state&#39;,
        i_TypeCode := 16#1010);
    //g_FastFaultOutput1    :       FB_HardwareFFOutput;

    {attribute &#39;instance-path&#39;}
    {attribute &#39;noinit&#39;}
    sPath: STRING;

    rDiffPressAllowed       :       REAL := 22.5; // Torr, Default value comes from Vat Valve Manual
    rDiffPress : REAL;
    set : BOOL;
    reset: BOOL;

    xFirstPass      :       BOOL;
    fbFSInit                :       R_TRIG;

    tonDelOK : TON;
    rtOK    :       R_TRIG;
    tonOvrd :       TON;

    tDelOK  :       TIME := T#60S;
    tOvrd   :       TIME := T#10s;


    (* Timeouts*)
    tTimeOutDuration: TIME:= T#30S;
    tOPNtimeout: TON;
    tCLStimeout:TON;

     // For logging
    fbLogger : FB_LogMessage := (eSubsystem:=E_SubSystem.VACUUM);
    ePrevState : E_VGC;
    tErrorPresent : R_TRIG;
    tAction : R_TRIG; // Primary action of this device (OPN_DO, PUMP_RUN, etc.)
    tOverrideActivated : R_TRIG;



    (*IO*)
    i_xOpnLS        AT%I*: BOOL;
    i_xClsLS        AT%I*: BOOL;
    q_xOPN_DO       AT%Q*: BOOL;

END_VAR
(* Vacuum gate valve
A. Wallace
16-10-29

A gate valve isolates vacuum volumes. Ideally it can be opened when a system is vented
to allow for faster pumping, and will close when high vacuum is lost.

The following behavior is good for valves in something like a gas attenuator.
This function block does the following:
1. The valve can be opened when the difference between the pressures on both sides is
less than the maximum differential pressure.
2. This rule persists until the pressures on both sides are lower than the vacuum-setpoint.
3. Once at-vac, the valve will close if the pressure on either side rises above the setpoint.

Alternatively, the differential pressure interlock can be disabled so the valve may only be opened
if the pressure on both sides is lower than the at-vacuum-setpoint. You want this behavior if
the valve is to be used in a UHV section.

Hysteresis is employed to ensure a smooth transition from vented/pumping down, to at-vac.

Finally, an override system is built in so you can bypass all the interlocking logic and
get back online.
*)
(* 10/1/2018 Margaret Ghaly included EPS, PMPS Checkes and MPS trigger signals*)


fbFSInit( CLK := TRUE, Q =&gt; xFirstPass);
(*IO Mapping*)
ACT_IO();

(* On first PLC pass, put valve into vented state, which implies a closed valve *)
IF xFirstPass THEN
    iq_stValve.eVGC_State := Vented;
    iq_stValve.pv_xOPN_SW := FALSE;
END_IF


///Check valve position
IF iq_stValve.i_xClsLS AND  iq_stValve.i_xOpnLS THEN
    iq_stValve.eState:=INVALID;
ELSIF NOT iq_stValve.i_xClsLS AND iq_stValve.i_xOpnLS AND iq_stValve.q_xOPN_DO THEN
    iq_stValve.eState:=OPEN;
ELSIF NOT iq_stValve.i_xClsLS AND iq_stValve.i_xOpnLS AND NOT iq_stValve.q_xOPN_DO THEN
    iq_stValve.eState:=OPEN_F;
ELSIF iq_stValve.i_xClsLS AND NOT iq_stValve.i_xOpnLS AND NOT iq_stValve.q_xOPN_DO THEN
    iq_stValve.eState:=CLOSED;
ELSIF NOT iq_stValve.i_xClsLS AND NOT iq_stValve.i_xOpnLS THEN
    iq_stValve.eState:=MOVING;
ELSE
    iq_stValve.eState:=INVALID;
END_IF

// Update hysteresis
///////////////////////////////////////////////////
IF iq_stValve.rAT_VAC_SP_LAST &lt;&gt; iq_stValve.rAT_VAC_SP OR xFirstPass THEN
    iq_stValve.rAT_VAC_SP_LAST := iq_stValve.rAT_VAC_SP;
    iq_stValve.rAT_VAC_HYS := iq_stValve.rHYST_PERC * iq_stValve.rAT_VAC_SP;
END_IF

iq_stValve.rAT_VAC_HYS := LIMIT(0, iq_stValve.rAT_VAC_HYS, iq_stValve.rAT_VAC_SP);
IF iq_stValve.rAT_VAC_SP &lt;&gt; 0 THEN
    IF iq_stValve.rHYST_PERC &lt;&gt; (iq_stValve.rAT_VAC_HYS / iq_stValve.rAT_VAC_SP) THEN
            iq_stValve.rHYST_PERC := LIMIT(0, (iq_stValve.rAT_VAC_HYS / iq_stValve.rAT_VAC_SP) ,1);
    END_IF

END_IF
// Valve at vacuum check
///////////////////////////////////////////////////
    set := i_stUSG.rPRESS &lt; iq_stValve.rAT_VAC_HYS AND i_stDSG.rPRESS &lt; iq_stValve.rAT_VAC_HYS AND i_stUSG.xPRESS_OK AND i_stDSG.xPRESS_OK;
    iq_stValve.xAT_VAC S= set;
    reset := i_stUSG.rPRESS &gt; iq_stValve.rAT_VAC_SP OR i_stDSG.rPRESS &gt; iq_stValve.rAT_VAC_SP OR NOT i_stUSG.xPRESS_OK OR NOT i_stDSG.xPRESS_OK;
    iq_stValve.xAT_VAC R= reset;

// Differential pressure check
///////////////////////////////////////////////////
    (* Calc the differential pressure across the valve *)
    rDiffPress := ABS(i_stUSG.rPRESS - i_stDSG.rPRESS);

    (* As long as the differential pressure is less than 30mbar, the valve is allowed to open *)
    IF rDiffPress &lt;= rDiffPressAllowed AND i_stUSG.xPRESS_OK AND i_stDSG.xPRESS_OK THEN
            iq_stValve.xDP_OK := TRUE;
    ELSE
            iq_stValve.xDP_OK       := FALSE;
            (* If the differential pressure is exceeded, even when the valve is open,
            the state is unexpected and triggers a fault, because it suggests that something
            is wrong with the valve, or gauges or mapping or there is a major leak on one side.*)
            iq_stValve.eVGC_State := ERR_DiffPress;
    END_IF

// Valve state
///////////////////////////////////////////////////
CASE iq_stValve.eVGC_State OF
    Vented: (* The Vented state is used during pump down *)
        //Log new state
        IF ePrevState &lt;&gt; iq_stValve.eVGC_State THEN
            fbLogger(sMsg:=&#39;Vented&#39;, eSevr:=TcEventSeverity.Info);
            ePrevState := iq_stValve.eVGC_State;
            END_IF

            (* Assuming the pump down went well, we are now at vacuum on both sides,
            so we move to the vacuum state, otherwise remain in the vented state *)
            IF iq_stValve.xAT_VAC AND (NOT (iq_stValve.xERR_DifPres)) AND  (NOT (iq_stValve.xERR_SP)) and  (NOT (iq_stValve.xERR_ExtFault))THEN
                iq_stValve.eVGC_State := AtVacuum;
            ELSE
                iq_stValve.eVGC_State := Vented;
            END_IF

    AtVacuum:
        //Log new state
        IF ePrevState &lt;&gt; iq_stValve.eVGC_State THEN
            fbLogger(sMsg:=&#39;Vacuum setpoint satisfied&#39;, eSevr:=TcEventSeverity.Info);
            ePrevState := iq_stValve.eVGC_State;
            END_IF

            IF iq_stValve.xAT_VAC THEN
            (* If both pressure setpoints are made,
            then enable the differential pressure interlock, regardless of the valve state
            assuming we&#39;re using some kind of ion gauge where a pressure setpoint cannot be higher than 1E-4 T *)
            iq_stValve.eVGC_State := AtVacuum;

            ELSE

                    (* If the valve is open (or in an unknown state) and either gauge is not at it&#39;s vacuum setpoint,
                    we have a loss of vacuum error *)
                    IF (iq_stValve.i_xOpnLS OR (NOT iq_stValve.i_xOpnLS AND NOT iq_stValve.i_xClsLS)) THEN
                            iq_stValve.eVGC_State := ERR_LostVac;
                            iq_stValve.xERR_SP := TRUE; //TAW changed this to the ERR_SP bool because I think that&#39;s what it was intended to be?

                    (* Alternatively, if the valve is already closed and we lose pressure on one side,
                    it was probably intentional venting, so we calmly move back to venting mode, and
                    disable the differential pressure interlock *) //??
                    ELSIF iq_stValve.i_xClsLS THEN
                            iq_stValve.eVGC_State := Vented;
                    END_IF

            END_IF
    ERR_DiffPress:
        //Log new state
        IF ePrevState &lt;&gt; iq_stValve.eVGC_State THEN
            fbLogger(sMsg:=&#39;Potential accidental vent.&#39;, eSevr:=TcEventSeverity.Critical);
            ePrevState := iq_stValve.eVGC_State;
            END_IF

            IF NOT (iq_stValve.xERR_DifPres) THEN
                    iq_stValve.eVGC_State := Vented;
            END_IF


    ERR_LostVac:
        //Log new state
        IF ePrevState &lt;&gt; iq_stValve.eVGC_State THEN
            fbLogger(sMsg:=&#39;Unexpected loss of vacuum while valve was open.&#39;, eSevr:=TcEventSeverity.Critical);
            ePrevState := iq_stValve.eVGC_State;
            END_IF
            IF NOT (iq_stValve.xERR_SP) THEN
                    iq_stValve.eVGC_State := Vented;
            END_IF

    ERR_ExtFault:
        //Log new state
        IF ePrevState &lt;&gt; iq_stValve.eVGC_State THEN
            fbLogger(sMsg:=&#39;Lost external interlock while valve was open.&#39;, eSevr:=TcEventSeverity.Critical);
            ePrevState := iq_stValve.eVGC_State;
            END_IF
            IF NOT (iq_stValve.xERR_ExtFault) AND (NOT i_xExt_OK) THEN
                    iq_stValve.eVGC_State := Vented;
            END_IF
    END_CASE



IF (NOT i_xExt_OK) THEN
    iq_stValve.eVGC_State := ERR_ExtFault;
    iq_stValve.xERR_ExtFault := TRUE;
END_IF

// Interlock evaluation - with bypass for DP ILK bypass
///////////////////////////////////////////////
IF i_xDis_DPIlk THEN
    iq_stValve.xOPN_OK := iq_stValve.xEXT_OK; // AND iq_stValve.xDP_OK ;
ELSE
    iq_stValve.xOPN_OK := iq_stValve.xEXT_OK AND iq_stValve.xAT_VAC;
END_IF


(* Valve operation *)

(* Override logic *)
(* Goal: give ability to override, but do so in a way that people won&#39;t forget it.
Solution: Override only after ten seconds of override, protect against blips,
when the valve permission goes true for more than ten seconds consistently, remove override
*)

tonDelOK(IN:=iq_stValve.xOPN_OK, PT:=tDelOK);
rtOK(CLK:=tonDelOK.Q);
IF rtOK.Q AND iq_stValve.pv_xOvrdOpn THEN
    iq_stValve.pv_xOvrdOpn :=FALSE;
    if (iq_stValve.eState = OPEN) AND (i_xOverrideMode) THEN iq_stValve.pv_xOPN_SW := TRUE; END_IF  //for seamless transition
    //Log
    fbLogger(sMsg:=&#39;Override expired&#39;, eSevr:=TcEventSeverity.Warning);

END_IF

//Override timer
tonOvrd(IN:=iq_stValve.pv_xOvrdOpn, PT:=tOvrd);

(* If Epics Command to close the Valve, check if PMPS and EPS are ok, otherwise Keep command set to open valve *)
IF NOT(iq_stValve.pv_xOPN_SW) AND ((NOT i_xPMPS_OK) OR (NOT i_xEPS_OK)) THEN
    //iq_stValve.pv_xOPN_SW := TRUE; // plc to only reset never to set this signal
END_IF
(* Reset the EPICS command to open the valve if the interlock is lost *)
(* based on EPS ok state, EPS overrides OPN_OK*)
IF NOT iq_stValve.xOPN_OK THEN
    IF i_xEPS_OK THEN iq_stValve.pv_xOPN_SW := FALSE; iq_stValve.sErrorMessage := &#39;ILK Active&#39;;
    ELSE //iq_stValve.pv_xOPN_SW := TRUE;           // plc to only reset never to set this signal
    END_IF
END_IF

(* Here&#39;s where the valve opens *)
iq_stValve.q_xOPN_DO := (iq_stValve.pv_xOPN_SW AND iq_stValve.xOPN_OK) OR (tonOvrd.Q AND i_xOverrideMode);

(* When the valve  is open MPS is OK*)
xMPS_OK := (iq_stValve.eState=OPEN) OR (iq_stValve.eState=CLOSED);//iq_stValve.i_xOpnLS;

///Check valve moving postion timout
IF NOT iq_stValve.i_xClsLS AND tCLStimeout.Q THEN
    iq_stValve.bErrorPresent := TRUE;
    iq_stValve.sErrorMessage := &#39;Close Timeout&#39;;
ELSIF NOT iq_stValve.i_xOpnLS AND tOPNtimeout.Q THEN
    iq_stValve.bErrorPresent := TRUE;
    iq_stValve.sErrorMessage := &#39;Open Timeout&#39;;
END_IF
IF (iq_stValve.eState=INVALID) THEN
    iq_stValve.bErrorPresent := TRUE;
    iq_stValve.sErrorMessage := CONCAT(sPath,&#39;Invalid Valve Position&#39;);
END_IF
(*Timers*)
tOPNtimeout(IN:= iq_stValve.q_xOPN_DO, PT := tTimeOutDuration );
tCLStimeout(IN:= NOT iq_stValve.q_xOPN_DO, PT := tTimeOutDuration);


// Log valve timeouts
tErrorPresent(CLK:=iq_stValve.bErrorPresent);
IF tErrorPresent.Q THEN fbLogger(sMsg:=iq_stValve.sErrorMessage, eSevr:=TcEventSeverity.Warning); END_IF

// Log valve open
tAction(CLK:= iq_stValve.q_xOPN_DO);
IF tAction.Q THEN fbLogger(sMsg:=&#39;Valve commanded open&#39;, eSevr:=TcEventSeverity.Info); END_IF

// Log override mode enabled
tOverrideActivated(CLK:= (tonOvrd.Q AND i_xOverrideMode));
IF tOverrideActivated.Q THEN fbLogger(sMsg:=&#39;Valve override mode activated&#39;, eSevr:=TcEventSeverity.Warning); END_IF


// Alarm reset
//////////////////////////////////////
ACT_ResetAlarms();

(*IO Mapping*)
ACT_IO();

(*FAST FAULT*)
fbFF(i_xOK := xMPS_OK,
    i_xReset := i_xReset,
    i_xAutoReset :=TRUE,
    io_fbFFHWO := io_fbFFHWO);

END_FUNCTION_BLOCK
ACTION ACT_IO:
(*inputs*)
iq_stValve.i_xOpnLS :=      i_xOpnLS;
iq_stValve.i_xClsLS:=       i_xClsLS;
iq_stValve.xEXT_OK := i_xEXT_OK;
iq_stValve.xOverrideMode := i_xOverrideMode;
(*outputs*)
q_xOPN_DO:= iq_stValve.q_xOPN_DO;
END_ACTION
ACTION ACT_ResetAlarms:
iq_stValve.xERR_DifPres R= iq_stValve.pv_xAlmRst;
iq_stValve.xERR_SP R= iq_stValve.pv_xAlmRst;
iq_stValve.bErrorPresent R= iq_stValve.pv_xAlmRst;

IF ( iq_stValve.pv_xAlmRst) THEN
    iq_stValve.sErrorMessage :=&#39;&#39;;
END_IF
END_ACTION
</pre></div>
</div>
</div>
<div class="section" id="fb-vgc-ebd">
<h2>FB_VGC_EBD<a class="headerlink" href="#fb-vgc-ebd" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(*Deprecated*)
(* This function block is similar to the FB_VGC, except it has 2 outputs to actuate the Valve*)
(* This function block implements basic functionality for Isolation Gate Valves*)
(* This function block interlock is as follows:
1. The valve can be opened when the difference between the pressures on both sides is
less than the maximum differential pressure.
2. This rule persists until the pressures on both sides are lower than the vacuum-setpoint.
3. Once at-vac, the valve will close if the pressure on either side rises above the setpoint.*)
(*This function block also implements PMPS and EPS interlocks, as well as Fast MPS trigger*)
{attribute &#39;no_check&#39;}
FUNCTION_BLOCK FB_VGC_EBD
VAR_IN_OUT

END_VAR
VAR_INPUT
    (*Upstream Gauge, usually ion gauge*)
    i_stUSG :       ST_VG;
    (*Downstream Gauge, usually ion gauge*)
    i_stDSG :       ST_VG;
    {attribute &#39;pytmc&#39; := &#39;
    pv: Dis_DPIlk
    &#39;}
    i_xDis_DPIlk : BOOL := FALSE;  (* Set to true when calling the function to disable the differential pressure interlock *)
    {attribute &#39;pytmc&#39; := &#39;
    pv: EPS_OK
    &#39;}
    i_xEPS_OK:      BOOL    := TRUE; (*External EPS interlock, Set to TRUE when no EPS interlock is required, otherwise set to correct interlock signal*)
    {attribute &#39;pytmc&#39; := &#39;
    pv: MPS_OK
    &#39;}
    i_xPMPS_OK:     BOOL    ; (*External MPS interlock, Set to TRUE when no PMPS interlock is required*)
    i_xExt_OK: BOOL; (*Other External Interlock, Set to True when no external interlock is required*)
    i_xOverrideMode : BOOL; (*To be linked to global override bit. This Overrides Vacuum logic only, EPS, MPS and PMPS are still enforces*)
    // Reset fault
    {attribute &#39;pytmc&#39; := &#39;
    pv: FF_Reset
    &#39;}
    i_xReset: BOOL;
END_VAR
VAR_OUTPUT
    {attribute &#39;pytmc&#39; := &#39;
    pv:
    &#39;}
    iq_stValve : ST_VGC; (* All valve data and states will be in this struct*)

    {attribute &#39;pytmc&#39; := &#39;
    pv: MPS_FAULT_OK
    field: ZNAM MPS FAULT ;
    field: ONAM MPS OK ;
    &#39;}
    xMPS_OK:        BOOL; (*MPS Fast OK, is set when the Valve is Open*)
END_VAR
VAR_IN_OUT
    io_fbFFHWO    :    FB_HardwareFFOutput;
END_VAR
VAR
    // PMPS
    fbFF    :    FB_FastFault :=(
        i_DevName := &#39;VGC&#39;,
        i_Desc := &#39;Fault occurs when the valve is not in open state&#39;,
        i_TypeCode := 16#1010);
    {attribute &#39;instance-path&#39;}
    {attribute &#39;noinit&#39;}
    sPath: STRING;

    rDiffPressAllowed       :       REAL := 22.5; // Torr, Default value comes from Vat Valve Manual
    rDiffPress : REAL;
    set : BOOL;
    reset: BOOL;

    xFirstPass      :       BOOL;
    fbFSInit                :       R_TRIG;

    tonDelOK : TON;
    rtOK    :       R_TRIG;
    tonOvrd :       TON;

    tDelOK  :       TIME := T#60S;
    tOvrd   :       TIME := T#10s;


    (* Timeouts*)
    tTimeOutDuration: TIME:= T#30S;
    tOPNtimeout: TON;
    tCLStimeout:TON;


     // For logging
    fbLogger : FB_LogMessage := (eSubsystem:=E_SubSystem.VACUUM);
    ePrevState : E_VGC;
    tErrorPresent : R_TRIG;
    tAction : R_TRIG; // Primary action of this device (OPN_DO, PUMP_RUN, etc.)
    tOverrideActivated : R_TRIG;

    (*IO*)
    i_xOpnLS        AT%I*: BOOL;
    i_xClsLS        AT%I*: BOOL;
    q_xOPN_DO       AT%Q*: BOOL;
    q_xOPN_DO_2     AT%Q*: BOOL;

END_VAR
(* Vacuum gate valve
A. Wallace
16-10-29

A gate valve isolates vacuum volumes. Ideally it can be opened when a system is vented
to allow for faster pumping, and will close when high vacuum is lost.

The following behavior is good for valves in something like a gas attenuator.
This function block does the following:
1. The valve can be opened when the difference between the pressures on both sides is
less than the maximum differential pressure.
2. This rule persists until the pressures on both sides are lower than the vacuum-setpoint.
3. Once at-vac, the valve will close if the pressure on either side rises above the setpoint.

Alternatively, the differential pressure interlock can be disabled so the valve may only be opened
if the pressure on both sides is lower than the at-vacuum-setpoint. You want this behavior if
the valve is to be used in a UHV section.

Hysteresis is employed to ensure a smooth transition from vented/pumping down, to at-vac.

Finally, an override system is built in so you can bypass all the interlocking logic and
get back online.
*)
(* 10/1/2018 Margaret Ghaly included EPS, PMPS Checkes and MPS trigger signals*)


fbFSInit( CLK := TRUE, Q =&gt; xFirstPass);
(*IO Mapping*)
ACT_IO();

(* On first PLC pass, put valve into vented state, which implies a closed valve *)
IF xFirstPass THEN
    iq_stValve.eVGC_State := Vented;
    iq_stValve.pv_xOPN_SW := FALSE;
END_IF


///Check valve postion
IF iq_stValve.i_xClsLS AND  iq_stValve.i_xOpnLS THEN
    iq_stValve.eState:=INVALID;
ELSIF NOT iq_stValve.i_xClsLS AND iq_stValve.i_xOpnLS AND iq_stValve.q_xOPN_DO THEN
    iq_stValve.eState:=OPEN;
ELSIF iq_stValve.i_xClsLS AND NOT iq_stValve.i_xOpnLS AND NOT iq_stValve.q_xOPN_DO THEN
    iq_stValve.eState:=CLOSED;
ELSIF NOT iq_stValve.i_xClsLS AND NOT iq_stValve.i_xOpnLS THEN
    iq_stValve.eState:=MOVING;
ELSE
    iq_stValve.eState:=INVALID;
END_IF

// Update hysteresis
///////////////////////////////////////////////////
IF iq_stValve.rAT_VAC_SP_LAST &lt;&gt; iq_stValve.rAT_VAC_SP OR xFirstPass THEN
    iq_stValve.rAT_VAC_SP_LAST := iq_stValve.rAT_VAC_SP;
    iq_stValve.rAT_VAC_HYS := iq_stValve.rHYST_PERC * iq_stValve.rAT_VAC_SP;
END_IF

iq_stValve.rAT_VAC_HYS := LIMIT(0, iq_stValve.rAT_VAC_HYS, iq_stValve.rAT_VAC_SP);
IF iq_stValve.rAT_VAC_SP &lt;&gt; 0 THEN
    IF iq_stValve.rHYST_PERC &lt;&gt; (iq_stValve.rAT_VAC_HYS / iq_stValve.rAT_VAC_SP) THEN
            iq_stValve.rHYST_PERC := LIMIT(0, (iq_stValve.rAT_VAC_HYS / iq_stValve.rAT_VAC_SP) ,1);
    END_IF

END_IF
// Valve at vacuum check
///////////////////////////////////////////////////
    set := i_stUSG.rPRESS &lt; iq_stValve.rAT_VAC_HYS AND i_stDSG.rPRESS &lt; iq_stValve.rAT_VAC_HYS AND i_stUSG.xPRESS_OK AND i_stDSG.xPRESS_OK;
    iq_stValve.xAT_VAC S= set;
    reset := i_stUSG.rPRESS &gt; iq_stValve.rAT_VAC_SP OR i_stDSG.rPRESS &gt; iq_stValve.rAT_VAC_SP OR NOT i_stUSG.xPRESS_OK OR NOT i_stDSG.xPRESS_OK;
    iq_stValve.xAT_VAC R= reset;

// Differential pressure check
///////////////////////////////////////////////////
    (* Calc the differential pressure across the valve *)
    rDiffPress := ABS(i_stUSG.rPRESS - i_stDSG.rPRESS);

    (* As long as the differential pressure is less than 30mbar, the valve is allowed to open *)
    IF rDiffPress &lt;= rDiffPressAllowed AND i_stUSG.xPRESS_OK AND i_stDSG.xPRESS_OK THEN
            iq_stValve.xDP_OK := TRUE;
    ELSE
            iq_stValve.xDP_OK       := FALSE;
            (* If the differential pressure is exceeded, even when the valve is open,
            the state is unexpected and triggers a fault, because it suggests that something
            is wrong with the valve, or gauges or mapping or there is a major leak on one side.*)
            iq_stValve.eVGC_State := ERR_DiffPress;
        iq_stValve.xERR_DifPres := TRUE;
    END_IF

// Valve state
///////////////////////////////////////////////////
CASE iq_stValve.eVGC_State OF
    Vented: (* The Vented state is used during pump down *)
        //Log new state
        IF ePrevState &lt;&gt; iq_stValve.eVGC_State THEN
            fbLogger(sMsg:=&#39;Vented&#39;, eSevr:=TcEventSeverity.Info);
            ePrevState := iq_stValve.eVGC_State;
            END_IF

            (* Assuming the pump down went well, we are now at vacuum on both sides,
            so we move to the vacuum state, otherwise remain in the vented state *)
            IF iq_stValve.xAT_VAC AND (NOT (iq_stValve.xERR_DifPres)) AND  (NOT (iq_stValve.xERR_SP)) and  (NOT (iq_stValve.xERR_ExtFault))THEN
                iq_stValve.eVGC_State := AtVacuum;
            ELSE
                iq_stValve.eVGC_State := Vented;
            END_IF

    AtVacuum:
        //Log new state
        IF ePrevState &lt;&gt; iq_stValve.eVGC_State THEN
            fbLogger(sMsg:=&#39;Vacuum setpoint satisfied&#39;, eSevr:=TcEventSeverity.Info);
            ePrevState := iq_stValve.eVGC_State;
            END_IF

            IF iq_stValve.xAT_VAC THEN
            (* If both pressure setpoints are made,
            then enable the differential pressure interlock, regardless of the valve state
            assuming we&#39;re using some kind of ion gauge where a pressure setpoint cannot be higher than 1E-4 T *)
            iq_stValve.eVGC_State := AtVacuum;

            ELSE

                    (* If the valve is open (or in an unknown state) and either gauge is not at it&#39;s vacuum setpoint,
                    we have a loss of vacuum error *)
                    IF (iq_stValve.i_xOpnLS OR (NOT iq_stValve.i_xOpnLS AND NOT iq_stValve.i_xClsLS)) THEN
                            iq_stValve.eVGC_State := ERR_LostVac;
                            iq_stValve.xERR_SP := TRUE; //TAW changed this to the ERR_SP bool because I think that&#39;s what it was intended to be?

                    (* Alternatively, if the valve is already closed and we lose pressure on one side,
                    it was probably intentional venting, so we calmly move back to venting mode, and
                    disable the differential pressure interlock *) //??
                    ELSIF iq_stValve.i_xClsLS THEN
                            iq_stValve.eVGC_State := Vented;
                    END_IF

            END_IF

    ERR_DiffPress:
        //Log new state
        IF ePrevState &lt;&gt; iq_stValve.eVGC_State THEN
            fbLogger(sMsg:=&#39;Potential accidental vent.&#39;, eSevr:=TcEventSeverity.Critical);
            ePrevState := iq_stValve.eVGC_State;
            END_IF

            IF NOT (iq_stValve.xERR_DifPres) THEN
                    iq_stValve.eVGC_State := Vented;
            END_IF


    ERR_LostVac:
        //Log new state
        IF ePrevState &lt;&gt; iq_stValve.eVGC_State THEN
            fbLogger(sMsg:=&#39;Unexpected loss of vacuum while valve was open.&#39;, eSevr:=TcEventSeverity.Critical);
            ePrevState := iq_stValve.eVGC_State;
            END_IF
            IF NOT (iq_stValve.xERR_SP) THEN
                    iq_stValve.eVGC_State := Vented;
            END_IF

    ERR_ExtFault:
        //Log new state
        IF ePrevState &lt;&gt; iq_stValve.eVGC_State THEN
            fbLogger(sMsg:=&#39;Lost external interlock while valve was open.&#39;, eSevr:=TcEventSeverity.Critical);
            ePrevState := iq_stValve.eVGC_State;
            END_IF
            IF NOT (iq_stValve.xERR_ExtFault) AND (NOT i_xExt_OK) THEN
                    iq_stValve.eVGC_State := Vented;
            END_IF
END_CASE

IF (NOT i_xExt_OK) THEN
    iq_stValve.eVGC_State := ERR_ExtFault;
    iq_stValve.xERR_ExtFault := TRUE;
END_IF

// Interlock evaluation - with bypass for DP ILK bypass
///////////////////////////////////////////////
IF i_xDis_DPIlk THEN
    iq_stValve.xOPN_OK := iq_stValve.xEXT_OK; // AND iq_stValve.xDP_OK ;
ELSE
    iq_stValve.xOPN_OK := iq_stValve.xEXT_OK AND iq_stValve.xAT_VAC;
END_IF


(* Valve operation *)

(* Override logic *)
(* Goal: give ability to override, but do so in a way that people won&#39;t forget it.
Solution: Override only after ten seconds of override, protect against blips,
when the valve permission goes true for more than ten seconds consistently, remove override
*)

tonDelOK(IN:=iq_stValve.xOPN_OK, PT:=tDelOK);
rtOK(CLK:=tonDelOK.Q);
IF rtOK.Q AND iq_stValve.pv_xOvrdOpn THEN
    iq_stValve.pv_xOvrdOpn :=FALSE;
    if (iq_stValve.eState = OPEN) AND (i_xOverrideMode) THEN iq_stValve.pv_xOPN_SW := TRUE; END_IF //for seamless transition
    //Log
    fbLogger(sMsg:=&#39;Override expired&#39;, eSevr:=TcEventSeverity.Warning);

END_IF

//Override timer
tonOvrd(IN:=iq_stValve.pv_xOvrdOpn, PT:=tOvrd);

(* If Epics Command to close the Valve, check if PMPS and EPS are ok, otherwise Keep command set to open valve *)
IF NOT(iq_stValve.pv_xOPN_SW) AND ((NOT i_xPMPS_OK) OR (NOT i_xEPS_OK)) THEN
    //iq_stValve.pv_xOPN_SW := TRUE; // plc to only reset never to set this signal
END_IF
(* Reset the EPICS command to open the valve if the interlock is lost *)
(* based on EPS ok state, EPS overrides OPN_OK*)
IF NOT iq_stValve.xOPN_OK THEN
    IF i_xEPS_OK THEN iq_stValve.pv_xOPN_SW := FALSE; iq_stValve.sErrorMessage := &#39;ILK Active&#39;;
    ELSE //iq_stValve.pv_xOPN_SW := TRUE;           // plc to only reset never to set this signal
    END_IF
END_IF

(* Here&#39;s where the valve opens *)
iq_stValve.q_xOPN_DO := (iq_stValve.pv_xOPN_SW AND iq_stValve.xOPN_OK) OR (tonOvrd.Q AND i_xOverrideMode);

(* When the valve  is open MPS is OK*)
xMPS_OK := (iq_stValve.eState=OPEN) OR (iq_stValve.eState=OPEN_F);//iq_stValve.i_xOpnLS;

///Check valve moving postion timout
IF NOT iq_stValve.i_xClsLS AND tCLStimeout.Q THEN
    iq_stValve.bErrorPresent := TRUE;
    iq_stValve.sErrorMessage := &#39; Close Timeout&#39;;
ELSIF NOT iq_stValve.i_xOpnLS AND tOPNtimeout.Q THEN
    iq_stValve.bErrorPresent := TRUE;
    iq_stValve.sErrorMessage := &#39; Open Timeout&#39;;
END_IF
IF (iq_stValve.eState=INVALID) THEN
    iq_stValve.bErrorPresent := TRUE;
    iq_stValve.sErrorMessage := CONCAT(sPath,&#39; Invalid Valve Position&#39;);
END_IF


(*Timers*)
tOPNtimeout(IN:= iq_stValve.q_xOPN_DO, PT := tTimeOutDuration );
tCLStimeout(IN:= NOT iq_stValve.q_xOPN_DO, PT := tTimeOutDuration);

// Log valve timeouts
tErrorPresent(CLK:=iq_stValve.bErrorPresent);
IF tErrorPresent.Q THEN fbLogger(sMsg:=iq_stValve.sErrorMessage, eSevr:=TcEventSeverity.Warning); END_IF

// Log valve open
tAction(CLK:= iq_stValve.q_xOPN_DO);
IF tAction.Q THEN fbLogger(sMsg:=&#39;Valve commanded open&#39;, eSevr:=TcEventSeverity.Info); END_IF

// Log override mode enabled
tOverrideActivated(CLK:= (tonOvrd.Q AND i_xOverrideMode));
IF tOverrideActivated.Q THEN fbLogger(sMsg:=&#39;Valve override mode activated&#39;, eSevr:=TcEventSeverity.Warning); END_IF

// Alarm reset
//////////////////////////////////////
ACT_ResetAlarms();

(*IO Mapping*)
ACT_IO();

(*FAST FAULT*)
fbFF(i_xOK := xMPS_OK,
    i_xReset := i_xReset,
    i_xAutoReset :=TRUE,
    io_fbFFHWO := io_fbFFHWO);

END_FUNCTION_BLOCK
ACTION ACT_IO:
(*inputs*)
iq_stValve.i_xOpnLS :=      i_xOpnLS;
iq_stValve.i_xClsLS:=       i_xClsLS;
iq_stValve.xEXT_OK := i_xEXT_OK;
iq_stValve.xOverrideMode := i_xOverrideMode;
(*outputs*)
q_xOPN_DO:= iq_stValve.q_xOPN_DO;
q_xOPN_DO_2:= iq_stValve.q_xOPN_DO;


(*ILK Devices*)
iq_stValve.sIlkUSDeviceName := This^.i_stUSG.sPath;
iq_stValve.sIlkDSDeviceName := This^.i_stDSG.sPath;
END_ACTION
ACTION ACT_ResetAlarms:
iq_stValve.xERR_DifPres R= iq_stValve.pv_xAlmRst;
iq_stValve.xERR_SP R= iq_stValve.pv_xAlmRst;
iq_stValve.bErrorPresent R= iq_stValve.pv_xAlmRst;

IF ( iq_stValve.pv_xAlmRst) THEN
    iq_stValve.sErrorMessage :=&#39;&#39;;
END_IF
END_ACTION
</pre></div>
</div>
</div>
<div class="section" id="fb-vgc-test">
<h2>FB_VGC_Test<a class="headerlink" href="#fb-vgc-test" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_VGC_Test</span> <span class="n">EXTENDS</span> <span class="n">TcUnit</span><span class="o">.</span><span class="n">FB_TestSuite</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">VGC</span><span class="p">:</span> <span class="n">FB_VGC</span><span class="p">;</span>
    <span class="n">US_IG</span> <span class="p">:</span> <span class="n">ST_VG</span><span class="p">;</span>
    <span class="n">DS_IG</span> <span class="p">:</span> <span class="n">ST_VG</span><span class="p">;</span>
    <span class="n">io_fbFFHWO</span>    <span class="p">:</span>    <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
    <span class="n">TotalTests</span> <span class="p">:</span> <span class="n">INT</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">ex</span>               <span class="p">:</span> <span class="n">__SYSTEM</span><span class="o">.</span><span class="n">ExceptionCode</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">M_INIT</span><span class="p">();</span>
<span class="n">M_Interlock</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</div>
<div class="section" id="fb-vrc">
<h2>FB_VRC<a class="headerlink" href="#fb-vrc" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">Function</span> <span class="n">Block</span> <span class="n">Implements</span> <span class="n">Basic</span> <span class="n">Functionality</span> <span class="k">for</span> <span class="n">certain</span> <span class="n">types</span> <span class="n">of</span> <span class="n">valves</span> <span class="n">e</span><span class="o">.</span><span class="n">g</span> <span class="n">Turbo</span> <span class="n">Isolation</span> <span class="n">valves</span><span class="p">,</span> <span class="n">Apperture</span> <span class="n">Valve</span><span class="o">.</span>
<span class="n">This</span> <span class="n">function</span> <span class="n">block</span> <span class="ow">is</span> <span class="n">interloked</span> <span class="n">by</span> <span class="n">an</span> <span class="nb">input</span> <span class="p">(</span><span class="n">i_xExtILK_OK</span><span class="p">)</span><span class="o">.</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">so</span> <span class="n">developers</span> <span class="n">can</span> <span class="n">interface</span> <span class="k">with</span> <span class="n">custom</span>
<span class="n">interlocking</span> <span class="n">logic</span> <span class="n">outside</span> <span class="n">this</span> <span class="n">function</span> <span class="n">block</span><span class="o">.*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Note</span> <span class="n">Interlock</span> <span class="n">Logic</span> <span class="ow">is</span> <span class="n">External</span> <span class="o">*</span><span class="p">)</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;no_check&#39;</span><span class="p">}</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_VRC</span> <span class="n">EXTENDS</span> <span class="n">FB_Valve</span>
<span class="n">VAR_IN_OUT</span>

<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">i_xExtILK_OK</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">Connect</span> <span class="n">to</span> <span class="n">Interlock</span> <span class="n">logic</span> <span class="n">condition</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">g</span> <span class="n">F_TURBO_VRC_ILK</span> <span class="n">Function</span><span class="p">),</span> <span class="n">otherwise</span><span class="p">,</span> <span class="n">Set</span> <span class="n">to</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">the</span> <span class="n">valve</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">interlocked</span>
    <span class="n">i_xOverrideMode</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span><span class="n">To</span> <span class="n">be</span> <span class="n">linked</span> <span class="n">to</span> <span class="k">global</span> <span class="n">override</span> <span class="n">bit</span><span class="o">.</span> <span class="n">This</span> <span class="n">Overrides</span> <span class="n">Vacuum</span> <span class="n">logic</span> <span class="n">only</span><span class="p">,</span> <span class="n">EPS</span><span class="p">,</span> <span class="n">MPS</span> <span class="ow">and</span> <span class="n">PMPS</span> <span class="n">are</span> <span class="n">still</span> <span class="n">enforces</span><span class="o">*</span><span class="p">)</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span>
    <span class="s1">&#39;}</span>
    <span class="n">iq_stValve</span> <span class="p">:</span> <span class="n">ST_VRC</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;instance-path&#39;</span><span class="p">}</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;noinit&#39;</span><span class="p">}</span>
    <span class="n">sPath</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">xFirstPass</span>      <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">fbFSInit</span>                <span class="p">:</span>       <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">tonOvrd</span> <span class="p">:</span>       <span class="n">TON</span><span class="p">;</span>
    <span class="n">tonDelOK</span> <span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">rtOK</span>    <span class="p">:</span>       <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">tOvrd</span>   <span class="p">:</span>       <span class="n">TIME</span> <span class="o">:=</span> <span class="n">T</span><span class="c1">#10s;</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">Timeouts</span><span class="o">*</span><span class="p">)</span>
    <span class="n">tTimeOutDuration</span><span class="p">:</span> <span class="n">TIME</span><span class="o">:=</span> <span class="n">T</span><span class="c1">#30S;</span>
    <span class="n">tOPNtimeout</span><span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">tCLStimeout</span><span class="p">:</span><span class="n">TON</span><span class="p">;</span>


    <span class="p">(</span><span class="o">*</span><span class="n">IO</span><span class="o">*</span><span class="p">)</span>
    <span class="n">i_xOpnLS</span>        <span class="n">AT</span><span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">i_xClsLS</span>        <span class="n">AT</span><span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">q_xOPN_DO</span>       <span class="n">AT</span><span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">On</span> <span class="n">first</span> <span class="n">PLC</span> <span class="k">pass</span><span class="p">,</span> <span class="n">put</span> <span class="n">valve</span> <span class="n">into</span> <span class="n">vented</span> <span class="n">state</span><span class="p">,</span> <span class="n">which</span> <span class="n">implies</span> <span class="n">a</span> <span class="n">closed</span> <span class="n">valve</span> <span class="o">*</span><span class="p">)</span>
<span class="n">fbFSInit</span><span class="p">(</span> <span class="n">CLK</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">Q</span> <span class="o">=&gt;</span> <span class="n">xFirstPass</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">xFirstPass</span> <span class="n">THEN</span>
    <span class="n">iq_stValve</span><span class="o">.</span><span class="n">eVGC_State</span> <span class="o">:=</span> <span class="n">Vented</span><span class="p">;</span>
    <span class="n">iq_stValve</span><span class="o">.</span><span class="n">pv_xOPN_SW</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">ePrevState</span> <span class="o">:=</span> <span class="n">INVALID</span><span class="p">;</span>
<span class="n">END_IF</span>




<span class="o">///</span><span class="n">Check</span> <span class="n">valve</span> <span class="n">position</span>
<span class="n">IF</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">i_xClsLS</span> <span class="n">AND</span>  <span class="n">iq_stValve</span><span class="o">.</span><span class="n">i_xOpnLS</span> <span class="n">THEN</span>
    <span class="n">iq_stValve</span><span class="o">.</span><span class="n">eState</span><span class="o">:=</span><span class="n">INVALID</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">NOT</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">i_xClsLS</span> <span class="n">AND</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">i_xOpnLS</span> <span class="n">AND</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">q_xOPN_DO</span> <span class="n">THEN</span>
    <span class="n">iq_stValve</span><span class="o">.</span><span class="n">eState</span><span class="o">:=</span><span class="n">OPEN</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">NOT</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">i_xClsLS</span> <span class="n">AND</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">i_xOpnLS</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">q_xOPN_DO</span> <span class="n">THEN</span>
    <span class="n">iq_stValve</span><span class="o">.</span><span class="n">eState</span><span class="o">:=</span><span class="n">OPEN_F</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">i_xClsLS</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">i_xOpnLS</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">q_xOPN_DO</span> <span class="n">THEN</span>
    <span class="n">iq_stValve</span><span class="o">.</span><span class="n">eState</span><span class="o">:=</span><span class="n">CLOSED</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">NOT</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">i_xClsLS</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">i_xOpnLS</span> <span class="n">THEN</span>
    <span class="n">iq_stValve</span><span class="o">.</span><span class="n">eState</span><span class="o">:=</span><span class="n">MOVING</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">iq_stValve</span><span class="o">.</span><span class="n">eState</span><span class="o">:=</span><span class="n">INVALID</span><span class="p">;</span>
<span class="n">END_IF</span>


<span class="p">(</span><span class="o">*</span><span class="n">evaluate</span> <span class="n">Valve</span> <span class="nb">open</span> <span class="n">external</span> <span class="n">interlock</span><span class="o">*</span><span class="p">)</span>
<span class="n">iq_stValve</span><span class="o">.</span><span class="n">xOPN_OK</span> <span class="o">:=</span> <span class="n">i_xExtILK_OK</span><span class="p">;</span>
<span class="n">iq_stValve</span><span class="o">.</span><span class="n">xEXT_OK</span> <span class="o">:=</span> <span class="n">i_xExtILK_OK</span><span class="p">;</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">xOPN_OK</span> <span class="ow">and</span> <span class="n">NOT</span> <span class="n">tonOvrd</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">iq_stValve</span><span class="o">.</span><span class="n">pv_xOPN_SW</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">iq_stValve</span><span class="o">.</span><span class="n">eVGC_State</span> <span class="o">:=</span> <span class="n">ERR_ExtFault</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="p">(</span><span class="n">iq_stValve</span><span class="o">.</span><span class="n">q_xOPN_DO</span><span class="p">)</span> <span class="n">AND</span> <span class="p">(</span><span class="n">iq_stValve</span><span class="o">.</span><span class="n">xOPN_OK</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">iq_stValve</span><span class="o">.</span><span class="n">eVGC_State</span> <span class="o">:=</span> <span class="n">AtVacuum</span><span class="p">;</span>
<span class="n">END_IF</span>


<span class="p">(</span><span class="o">*</span> <span class="n">Override</span> <span class="n">logic</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Goal</span><span class="p">:</span> <span class="n">give</span> <span class="n">ability</span> <span class="n">to</span> <span class="n">override</span><span class="p">,</span> <span class="n">but</span> <span class="n">do</span> <span class="n">so</span> <span class="ow">in</span> <span class="n">a</span> <span class="n">way</span> <span class="n">that</span> <span class="n">people</span> <span class="n">won</span><span class="s1">&#39;t forget it.</span>
<span class="n">Solution</span><span class="p">:</span> <span class="n">Override</span> <span class="n">only</span> <span class="n">after</span> <span class="n">ten</span> <span class="n">seconds</span> <span class="n">of</span> <span class="n">override</span><span class="p">,</span> <span class="n">protect</span> <span class="n">against</span> <span class="n">blips</span><span class="p">,</span>
<span class="n">when</span> <span class="n">the</span> <span class="n">valve</span> <span class="n">permission</span> <span class="n">goes</span> <span class="n">true</span> <span class="k">for</span> <span class="n">more</span> <span class="n">than</span> <span class="n">ten</span> <span class="n">seconds</span> <span class="n">consistently</span><span class="p">,</span> <span class="n">remove</span> <span class="n">override</span>
<span class="o">*</span><span class="p">)</span>

<span class="n">tonDelOK</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">iq_stValve</span><span class="o">.</span><span class="n">xOPN_OK</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#10S);</span>
<span class="n">rtOK</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">tonDelOK</span><span class="o">.</span><span class="n">Q</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">rtOK</span><span class="o">.</span><span class="n">Q</span> <span class="n">AND</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">pv_xOvrdOpn</span> <span class="n">THEN</span>
    <span class="n">iq_stValve</span><span class="o">.</span><span class="n">pv_xOvrdOpn</span> <span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">iq_stValve</span><span class="o">.</span><span class="n">eState</span><span class="o">=</span><span class="n">OPEN</span><span class="p">)</span> <span class="n">AND</span> <span class="p">(</span><span class="n">i_xOverrideMode</span><span class="p">)</span> <span class="n">THEN</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">pv_xOPN_SW</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span> <span class="n">END_IF</span>
    <span class="o">//</span><span class="n">Log</span>
    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Override expired&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Warning</span><span class="p">);</span>
<span class="n">END_IF</span>
<span class="o">//</span> <span class="n">Release</span> <span class="n">the</span> <span class="n">Force</span> <span class="n">Open</span> <span class="n">bit</span> <span class="n">when</span> <span class="n">the</span> <span class="n">system</span> <span class="n">override</span> <span class="ow">is</span> <span class="n">false</span>
<span class="n">IF</span> <span class="n">NOT</span><span class="p">(</span><span class="n">i_xOverrideMode</span><span class="p">)</span> <span class="n">THEN</span>  <span class="n">iq_stValve</span><span class="o">.</span><span class="n">pv_xOvrdOpn</span> <span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span> <span class="n">END_IF</span>
<span class="o">//</span><span class="n">Override</span> <span class="n">timer</span>
<span class="n">tonOvrd</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">iq_stValve</span><span class="o">.</span><span class="n">pv_xOvrdOpn</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span><span class="n">tOvrd</span><span class="p">);</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Here</span><span class="s1">&#39;s where the valve opens *)</span>
<span class="n">iq_stValve</span><span class="o">.</span><span class="n">q_xOPN_DO</span> <span class="o">:=</span> <span class="p">(</span><span class="n">iq_stValve</span><span class="o">.</span><span class="n">pv_xOPN_SW</span> <span class="n">AND</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">xOPN_OK</span><span class="p">)</span> <span class="n">OR</span> <span class="p">(</span><span class="n">tonOvrd</span><span class="o">.</span><span class="n">Q</span> <span class="n">AND</span> <span class="n">i_xOverrideMode</span><span class="p">);</span>


<span class="o">///</span><span class="n">Check</span> <span class="n">valve</span> <span class="n">moving</span> <span class="n">position</span> <span class="n">timout</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">i_xClsLS</span> <span class="n">AND</span> <span class="n">tCLStimeout</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">iq_stValve</span><span class="o">.</span><span class="n">bErrorPresent</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">iq_stValve</span><span class="o">.</span><span class="n">sErrorMessage</span> <span class="o">:=</span> <span class="s1">&#39; Close Timeout&#39;</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">NOT</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">i_xOpnLS</span> <span class="n">AND</span> <span class="n">tOPNtimeout</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">iq_stValve</span><span class="o">.</span><span class="n">bErrorPresent</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">iq_stValve</span><span class="o">.</span><span class="n">sErrorMessage</span> <span class="o">:=</span> <span class="s1">&#39; Open Timeout&#39;</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">IF</span> <span class="p">(</span><span class="n">iq_stValve</span><span class="o">.</span><span class="n">eState</span><span class="o">=</span><span class="n">INVALID</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">iq_stValve</span><span class="o">.</span><span class="n">bErrorPresent</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">iq_stValve</span><span class="o">.</span><span class="n">sErrorMessage</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="n">sPath</span><span class="p">,</span><span class="s1">&#39; Invalid Valve Position&#39;</span><span class="p">);</span>
<span class="n">END_IF</span>

<span class="p">(</span><span class="o">*</span><span class="n">Timers</span><span class="o">*</span><span class="p">)</span>
<span class="n">tOPNtimeout</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">q_xOPN_DO</span><span class="p">,</span> <span class="n">PT</span> <span class="o">:=</span> <span class="n">tTimeOutDuration</span> <span class="p">);</span>
<span class="n">tCLStimeout</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span> <span class="n">NOT</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">q_xOPN_DO</span><span class="p">,</span> <span class="n">PT</span> <span class="o">:=</span> <span class="n">tTimeOutDuration</span><span class="p">);</span>


<span class="p">(</span><span class="o">*</span><span class="n">Soft</span> <span class="n">IO</span> <span class="n">Mapping</span><span class="o">*</span><span class="p">)</span>
<span class="n">ACT_IO</span><span class="p">();</span>

<span class="o">//</span> <span class="n">Log</span> <span class="n">States</span> <span class="ow">and</span> <span class="n">triggers</span>
<span class="n">ACT_Logger</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>
<span class="n">ACTION</span> <span class="n">ACT_IO</span><span class="p">:</span>
<span class="p">(</span><span class="o">*</span><span class="n">inputs</span><span class="o">*</span><span class="p">)</span>
<span class="n">iq_stValve</span><span class="o">.</span><span class="n">i_xOpnLS</span> <span class="o">:=</span>      <span class="n">i_xOpnLS</span><span class="p">;</span>
<span class="n">iq_stValve</span><span class="o">.</span><span class="n">i_xClsLS</span><span class="o">:=</span>       <span class="n">i_xClsLS</span><span class="p">;</span>
<span class="n">iq_stValve</span><span class="o">.</span><span class="n">xOverrideMode</span> <span class="o">:=</span> <span class="n">i_xOverrideMode</span><span class="p">;</span>
<span class="p">(</span><span class="o">*</span><span class="n">outputs</span><span class="o">*</span><span class="p">)</span>
<span class="n">q_xOPN_DO</span><span class="o">:=</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">q_xOPN_DO</span><span class="p">;</span>
<span class="n">END_ACTION</span>
<span class="n">ACTION</span> <span class="n">ACT_Logger</span><span class="p">:</span>
<span class="o">//</span> <span class="n">ILK</span> <span class="n">logger</span>

<span class="n">IF</span> <span class="n">NOT</span> <span class="n">i_xExtILK_OK</span> <span class="n">AND</span> <span class="n">ePrevState</span> <span class="o">=</span> <span class="n">OPEN</span> <span class="n">THEN</span>
            <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Lost external interlock while valve was open.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span>
<span class="n">END_IF</span>


<span class="o">//</span><span class="n">STATE</span> <span class="n">Logger</span>

<span class="n">IF</span> <span class="n">ePrevState</span> <span class="o">&lt;&gt;</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">eState</span> <span class="n">THEN</span>
      <span class="n">CASE</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">eState</span> <span class="n">OF</span>
            <span class="n">INVALID</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Valve invalid position.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span>
            <span class="n">MOVING</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Valve moving&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Warning</span><span class="p">);</span>
            <span class="n">OPEN</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Valve Open.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span>
            <span class="n">CLOSED</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Valve closed.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span>
      <span class="n">END_CASE</span>
      <span class="n">ePrevState</span> <span class="o">:=</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">eState</span><span class="p">;</span>
  <span class="n">END_IF</span>



<span class="o">//</span> <span class="n">Log</span> <span class="n">valve</span> <span class="n">timeouts</span>
<span class="n">tErrorPresent</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">iq_stValve</span><span class="o">.</span><span class="n">bErrorPresent</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">tErrorPresent</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span> <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="n">iq_stValve</span><span class="o">.</span><span class="n">sErrorMessage</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Warning</span><span class="p">);</span> <span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Log</span> <span class="n">valve</span> <span class="nb">open</span>
<span class="n">tAction</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">q_xOPN_DO</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">tAction</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span> <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Valve commanded open&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span> <span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Log</span> <span class="n">override</span> <span class="n">mode</span> <span class="n">enabled</span>
<span class="n">tOverrideActivated</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span> <span class="p">(</span><span class="n">tonOvrd</span><span class="o">.</span><span class="n">Q</span> <span class="n">AND</span> <span class="n">i_xOverrideMode</span><span class="p">));</span>
<span class="n">IF</span> <span class="n">tOverrideActivated</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span> <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Valve override mode activated&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Warning</span><span class="p">);</span> <span class="n">END_IF</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
</div>
<div class="section" id="fb-vrc-ebd">
<h2>FB_VRC_EBD<a class="headerlink" href="#fb-vrc-ebd" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">function</span> <span class="n">block</span> <span class="ow">is</span> <span class="n">similar</span> <span class="n">to</span> <span class="n">the</span> <span class="n">FB_VGC</span><span class="p">,</span> <span class="k">except</span> <span class="n">it</span> <span class="n">has</span> <span class="mi">2</span> <span class="n">outputs</span> <span class="n">to</span> <span class="n">actuate</span> <span class="n">the</span> <span class="n">Valve</span><span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">Function</span> <span class="n">Block</span> <span class="n">Implements</span> <span class="n">Basic</span> <span class="n">Functionality</span> <span class="k">for</span> <span class="n">certain</span> <span class="n">types</span> <span class="n">of</span> <span class="n">valves</span> <span class="n">e</span><span class="o">.</span><span class="n">g</span> <span class="n">Turbo</span> <span class="n">Isolation</span> <span class="n">valves</span><span class="p">,</span> <span class="n">Apperture</span> <span class="n">Valve</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Note</span> <span class="n">Interlock</span> <span class="n">Logic</span> <span class="ow">is</span> <span class="n">External</span> <span class="o">*</span><span class="p">)</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_VRC_EBD</span> <span class="n">EXTENDS</span> <span class="n">FB_Valve</span>
<span class="n">VAR_IN_OUT</span>

<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">i_xExtILK_OK</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">Connect</span> <span class="n">to</span> <span class="n">Interlock</span> <span class="n">logic</span> <span class="n">condition</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">g</span> <span class="n">F_TURBO_VRC_ILK</span> <span class="n">Function</span><span class="p">),</span> <span class="n">otherwise</span><span class="p">,</span> <span class="n">Set</span> <span class="n">to</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">the</span> <span class="n">valve</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">interlocked</span>
    <span class="n">i_xOverrideMode</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span><span class="n">To</span> <span class="n">be</span> <span class="n">linked</span> <span class="n">to</span> <span class="k">global</span> <span class="n">override</span> <span class="n">bit</span><span class="o">.</span> <span class="n">This</span> <span class="n">Overrides</span> <span class="n">Vacuum</span> <span class="n">logic</span> <span class="n">only</span><span class="p">,</span> <span class="n">EPS</span><span class="p">,</span> <span class="n">MPS</span> <span class="ow">and</span> <span class="n">PMPS</span> <span class="n">are</span> <span class="n">still</span> <span class="n">enforces</span><span class="o">*</span><span class="p">)</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span>
    <span class="s1">&#39;}</span>
    <span class="n">iq_stValve</span> <span class="p">:</span> <span class="n">ST_VRC</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;instance-path&#39;</span><span class="p">}</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;noinit&#39;</span><span class="p">}</span>
    <span class="n">sPath</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">xFirstPass</span>      <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">fbFSInit</span>                <span class="p">:</span>       <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">tonOvrd</span> <span class="p">:</span>       <span class="n">TON</span><span class="p">;</span>
    <span class="n">tonDelOK</span> <span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">rtOK</span>    <span class="p">:</span>       <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">tOvrd</span>   <span class="p">:</span>       <span class="n">TIME</span> <span class="o">:=</span> <span class="n">T</span><span class="c1">#10s;</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">Timeouts</span><span class="o">*</span><span class="p">)</span>
    <span class="n">tTimeOutDuration</span><span class="p">:</span> <span class="n">TIME</span><span class="o">:=</span> <span class="n">T</span><span class="c1">#30S;</span>
    <span class="n">tOPNtimeout</span><span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">tCLStimeout</span><span class="p">:</span><span class="n">TON</span><span class="p">;</span>

    <span class="p">(</span><span class="o">*</span><span class="n">IO</span><span class="o">*</span><span class="p">)</span>
    <span class="n">i_xOpnLS</span>        <span class="n">AT</span><span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">i_xClsLS</span>        <span class="n">AT</span><span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">q_xOPN_DO</span>       <span class="n">AT</span><span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">q_xOPN_DO_2</span>     <span class="n">AT</span><span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">On</span> <span class="n">first</span> <span class="n">PLC</span> <span class="k">pass</span><span class="p">,</span> <span class="n">put</span> <span class="n">valve</span> <span class="n">into</span> <span class="n">vented</span> <span class="n">state</span><span class="p">,</span> <span class="n">which</span> <span class="n">implies</span> <span class="n">a</span> <span class="n">closed</span> <span class="n">valve</span> <span class="o">*</span><span class="p">)</span>
<span class="n">fbFSInit</span><span class="p">(</span> <span class="n">CLK</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">Q</span> <span class="o">=&gt;</span> <span class="n">xFirstPass</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">xFirstPass</span> <span class="n">THEN</span>
    <span class="n">iq_stValve</span><span class="o">.</span><span class="n">eVGC_State</span> <span class="o">:=</span> <span class="n">Vented</span><span class="p">;</span>
    <span class="n">iq_stValve</span><span class="o">.</span><span class="n">pv_xOPN_SW</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>


<span class="o">///</span><span class="n">Check</span> <span class="n">valve</span> <span class="n">position</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">i_xClsLS</span> <span class="n">AND</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">i_xOpnLS</span> <span class="n">THEN</span>
    <span class="n">iq_stValve</span><span class="o">.</span><span class="n">eState</span><span class="o">:=</span><span class="n">OPEN</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">i_xClsLS</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">i_xOpnLS</span> <span class="n">THEN</span>
    <span class="n">iq_stValve</span><span class="o">.</span><span class="n">eState</span><span class="o">:=</span><span class="n">CLOSED</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">NOT</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">i_xClsLS</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">i_xOpnLS</span> <span class="n">THEN</span>
    <span class="n">iq_stValve</span><span class="o">.</span><span class="n">eState</span><span class="o">:=</span><span class="n">MOVING</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">iq_stValve</span><span class="o">.</span><span class="n">eState</span><span class="o">:=</span><span class="n">INVALID</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="p">(</span><span class="o">*</span><span class="n">evaluate</span> <span class="n">Valve</span> <span class="nb">open</span> <span class="n">external</span> <span class="n">interlock</span><span class="o">*</span><span class="p">)</span>
<span class="n">iq_stValve</span><span class="o">.</span><span class="n">xOPN_OK</span> <span class="o">:=</span> <span class="n">i_xExtILK_OK</span><span class="p">;</span>
<span class="n">iq_stValve</span><span class="o">.</span><span class="n">xEXT_OK</span> <span class="o">:=</span> <span class="n">i_xExtILK_OK</span><span class="p">;</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">xOPN_OK</span> <span class="ow">and</span> <span class="n">NOT</span> <span class="n">tonOvrd</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">iq_stValve</span><span class="o">.</span><span class="n">pv_xOPN_SW</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">iq_stValve</span><span class="o">.</span><span class="n">eVGC_State</span> <span class="o">:=</span> <span class="n">ERR_ExtFault</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="p">(</span><span class="n">iq_stValve</span><span class="o">.</span><span class="n">q_xOPN_DO</span><span class="p">)</span> <span class="n">AND</span> <span class="p">(</span><span class="n">iq_stValve</span><span class="o">.</span><span class="n">xOPN_OK</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">iq_stValve</span><span class="o">.</span><span class="n">eVGC_State</span> <span class="o">:=</span> <span class="n">AtVacuum</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Override</span> <span class="n">logic</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Goal</span><span class="p">:</span> <span class="n">give</span> <span class="n">ability</span> <span class="n">to</span> <span class="n">override</span><span class="p">,</span> <span class="n">but</span> <span class="n">do</span> <span class="n">so</span> <span class="ow">in</span> <span class="n">a</span> <span class="n">way</span> <span class="n">that</span> <span class="n">people</span> <span class="n">won</span><span class="s1">&#39;t forget it.</span>
<span class="n">Solution</span><span class="p">:</span> <span class="n">Override</span> <span class="n">only</span> <span class="n">after</span> <span class="n">ten</span> <span class="n">seconds</span> <span class="n">of</span> <span class="n">override</span><span class="p">,</span> <span class="n">protect</span> <span class="n">against</span> <span class="n">blips</span><span class="p">,</span>
<span class="n">when</span> <span class="n">the</span> <span class="n">valve</span> <span class="n">permission</span> <span class="n">goes</span> <span class="n">true</span> <span class="k">for</span> <span class="n">more</span> <span class="n">than</span> <span class="n">ten</span> <span class="n">seconds</span> <span class="n">consistently</span><span class="p">,</span> <span class="n">remove</span> <span class="n">override</span>
<span class="o">*</span><span class="p">)</span>

<span class="n">tonDelOK</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">iq_stValve</span><span class="o">.</span><span class="n">xOPN_OK</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#10S);</span>
<span class="n">rtOK</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">tonDelOK</span><span class="o">.</span><span class="n">Q</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">rtOK</span><span class="o">.</span><span class="n">Q</span> <span class="n">AND</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">pv_xOvrdOpn</span> <span class="n">THEN</span>
    <span class="n">iq_stValve</span><span class="o">.</span><span class="n">pv_xOvrdOpn</span> <span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">iq_stValve</span><span class="o">.</span><span class="n">eState</span><span class="o">=</span><span class="n">OPEN</span><span class="p">)</span> <span class="n">AND</span> <span class="p">(</span><span class="n">i_xOverrideMode</span><span class="p">)</span> <span class="n">THEN</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">pv_xOPN_SW</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span> <span class="n">END_IF</span>
    <span class="o">//</span><span class="n">Log</span>
    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Override expired&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Warning</span><span class="p">);</span>
<span class="n">END_IF</span>

<span class="o">//</span><span class="n">Override</span> <span class="n">timer</span>
<span class="n">tonOvrd</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">iq_stValve</span><span class="o">.</span><span class="n">pv_xOvrdOpn</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#10S);</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Here</span><span class="s1">&#39;s where the valve opens *)</span>
<span class="n">iq_stValve</span><span class="o">.</span><span class="n">q_xOPN_DO</span> <span class="o">:=</span> <span class="p">(</span><span class="n">iq_stValve</span><span class="o">.</span><span class="n">pv_xOPN_SW</span> <span class="n">AND</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">xOPN_OK</span><span class="p">)</span> <span class="n">OR</span> <span class="p">(</span><span class="n">tonOvrd</span><span class="o">.</span><span class="n">Q</span> <span class="n">AND</span> <span class="n">i_xOverrideMode</span><span class="p">);</span>

<span class="o">///</span><span class="n">Check</span> <span class="n">valve</span> <span class="n">moving</span> <span class="n">postion</span> <span class="n">timout</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">i_xClsLS</span> <span class="n">AND</span> <span class="n">tCLStimeout</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">iq_stValve</span><span class="o">.</span><span class="n">bErrorPresent</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">iq_stValve</span><span class="o">.</span><span class="n">sErrorMessage</span> <span class="o">:=</span> <span class="s1">&#39; Close Timeout&#39;</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">NOT</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">i_xOpnLS</span> <span class="n">AND</span> <span class="n">tOPNtimeout</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">iq_stValve</span><span class="o">.</span><span class="n">bErrorPresent</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">iq_stValve</span><span class="o">.</span><span class="n">sErrorMessage</span> <span class="o">:=</span> <span class="s1">&#39; Open Timeout&#39;</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">IF</span> <span class="p">(</span><span class="n">iq_stValve</span><span class="o">.</span><span class="n">eState</span><span class="o">=</span><span class="n">INVALID</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">iq_stValve</span><span class="o">.</span><span class="n">bErrorPresent</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">iq_stValve</span><span class="o">.</span><span class="n">sErrorMessage</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="n">sPath</span><span class="p">,</span><span class="s1">&#39; Invalid Valve Position&#39;</span><span class="p">);</span>
<span class="n">END_IF</span>

<span class="p">(</span><span class="o">*</span><span class="n">Timers</span><span class="o">*</span><span class="p">)</span>
<span class="n">tOPNtimeout</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">q_xOPN_DO</span><span class="p">,</span> <span class="n">PT</span> <span class="o">:=</span> <span class="n">tTimeOutDuration</span> <span class="p">);</span>
<span class="n">tCLStimeout</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span> <span class="n">NOT</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">q_xOPN_DO</span><span class="p">,</span> <span class="n">PT</span> <span class="o">:=</span> <span class="n">tTimeOutDuration</span><span class="p">);</span>




<span class="p">(</span><span class="o">*</span><span class="n">Soft</span> <span class="n">IO</span> <span class="n">Mapping</span><span class="o">*</span><span class="p">)</span>
<span class="n">ACT_IO</span><span class="p">();</span>

<span class="o">//</span> <span class="n">Log</span> <span class="n">States</span> <span class="ow">and</span> <span class="n">triggers</span>
<span class="n">ACT_Logger</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>
<span class="n">ACTION</span> <span class="n">ACT_IO</span><span class="p">:</span>
<span class="p">(</span><span class="o">*</span><span class="n">inputs</span><span class="o">*</span><span class="p">)</span>
<span class="n">iq_stValve</span><span class="o">.</span><span class="n">i_xOpnLS</span> <span class="o">:=</span>      <span class="n">i_xOpnLS</span><span class="p">;</span>
<span class="n">iq_stValve</span><span class="o">.</span><span class="n">i_xClsLS</span><span class="o">:=</span>       <span class="n">i_xClsLS</span><span class="p">;</span>
<span class="n">iq_stValve</span><span class="o">.</span><span class="n">xOverrideMode</span> <span class="o">:=</span> <span class="n">i_xOverrideMode</span><span class="p">;</span>
<span class="p">(</span><span class="o">*</span><span class="n">outputs</span><span class="o">*</span><span class="p">)</span>
<span class="n">q_xOPN_DO</span><span class="o">:=</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">q_xOPN_DO</span><span class="p">;</span>
<span class="n">q_xOPN_DO_2</span><span class="o">:=</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">q_xOPN_DO</span><span class="p">;</span>
<span class="n">END_ACTION</span>
<span class="n">ACTION</span> <span class="n">ACT_Logger</span><span class="p">:</span>
<span class="o">//</span> <span class="n">ILK</span> <span class="n">logger</span>

<span class="n">IF</span> <span class="n">NOT</span> <span class="n">i_xExtILK_OK</span> <span class="n">AND</span> <span class="n">ePrevState</span> <span class="o">=</span> <span class="n">OPEN</span> <span class="n">THEN</span>
            <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Lost external interlock while valve was open.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span>
<span class="n">END_IF</span>


<span class="o">//</span><span class="n">STATE</span> <span class="n">Logger</span>

<span class="n">IF</span> <span class="n">ePrevState</span> <span class="o">&lt;&gt;</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">eState</span> <span class="n">THEN</span>
      <span class="n">CASE</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">eState</span> <span class="n">OF</span>
            <span class="n">INVALID</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Valve invalid position.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span>
            <span class="n">MOVING</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Valve moving&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Warning</span><span class="p">);</span>
            <span class="n">OPEN</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Valve Open.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span>
            <span class="n">CLOSED</span><span class="p">:</span>
                    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Valve closed.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span>
      <span class="n">END_CASE</span>
      <span class="n">ePrevState</span> <span class="o">:=</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">eState</span><span class="p">;</span>
  <span class="n">END_IF</span>



<span class="o">//</span> <span class="n">Log</span> <span class="n">valve</span> <span class="n">timeouts</span>
<span class="n">tErrorPresent</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">iq_stValve</span><span class="o">.</span><span class="n">bErrorPresent</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">tErrorPresent</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span> <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="n">iq_stValve</span><span class="o">.</span><span class="n">sErrorMessage</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Warning</span><span class="p">);</span> <span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Log</span> <span class="n">valve</span> <span class="nb">open</span>
<span class="n">tAction</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">q_xOPN_DO</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">tAction</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span> <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Valve commanded open&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span> <span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Log</span> <span class="n">override</span> <span class="n">mode</span> <span class="n">enabled</span>
<span class="n">tOverrideActivated</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span> <span class="p">(</span><span class="n">tonOvrd</span><span class="o">.</span><span class="n">Q</span> <span class="n">AND</span> <span class="n">i_xOverrideMode</span><span class="p">));</span>
<span class="n">IF</span> <span class="n">tOverrideActivated</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span> <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Valve override mode activated&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Warning</span><span class="p">);</span> <span class="n">END_IF</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
</div>
<div class="section" id="fb-vrc-no">
<h2>FB_VRC_NO<a class="headerlink" href="#fb-vrc-no" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">function</span> <span class="n">block</span> <span class="ow">is</span> <span class="n">different</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">regular</span> <span class="n">VRC</span> <span class="ow">in</span> <span class="n">that</span> <span class="n">CLOSING</span> <span class="n">must</span> <span class="n">be</span> <span class="n">permitted</span><span class="o">.</span> <span class="o">*</span><span class="p">)</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_VRC_NO</span> <span class="n">EXTENDS</span> <span class="n">FB_Valve</span>
<span class="n">VAR_IN_OUT</span>

<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">EXT_ILK_OK</span> <span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">NOT</span> <span class="n">OK</span> <span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">OK</span> <span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span> <span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">i_xExtILK_OK</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">Connect</span> <span class="n">to</span> <span class="n">Interlock</span> <span class="n">logic</span> <span class="n">condition</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">g</span> <span class="n">F_TURBO_VRC_ILK</span> <span class="n">Function</span><span class="p">),</span> <span class="n">otherwise</span><span class="p">,</span> <span class="n">Set</span> <span class="n">to</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">the</span> <span class="n">valve</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">interlocked</span>
    <span class="n">i_xOverrideMode</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span><span class="n">To</span> <span class="n">be</span> <span class="n">linked</span> <span class="n">to</span> <span class="k">global</span> <span class="n">override</span> <span class="n">bit</span><span class="o">.</span> <span class="n">This</span> <span class="n">Overrides</span> <span class="n">Vacuum</span> <span class="n">logic</span> <span class="n">only</span><span class="p">,</span> <span class="n">EPS</span><span class="p">,</span> <span class="n">MPS</span> <span class="ow">and</span> <span class="n">PMPS</span> <span class="n">are</span> <span class="n">still</span> <span class="n">enforces</span><span class="o">*</span><span class="p">)</span>

<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
            <span class="n">iq_stValve</span> <span class="p">:</span> <span class="n">ST_VRC</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;noinit&#39;</span><span class="p">}</span>
    <span class="n">sPath</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">xFirstPass</span>      <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">fbFSInit</span>                <span class="p">:</span>       <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">tonOvrd</span> <span class="p">:</span>       <span class="n">TON</span><span class="p">;</span>
    <span class="n">tonDelOK</span> <span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">rtOK</span>    <span class="p">:</span>       <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">tOvrd</span>   <span class="p">:</span>       <span class="n">TIME</span> <span class="o">:=</span> <span class="n">T</span><span class="c1">#10s;</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">Timeouts</span><span class="o">*</span><span class="p">)</span>
    <span class="n">tTimeOutDuration</span><span class="p">:</span> <span class="n">TIME</span><span class="o">:=</span> <span class="n">T</span><span class="c1">#30S;</span>
    <span class="n">tOPNtimeout</span><span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">tCLStimeout</span><span class="p">:</span><span class="n">TON</span><span class="p">;</span>
            <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">CLS_SW</span> <span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">CLOSE</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">OPEN</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span> <span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">pv_xCLS_SW</span>      <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">FORCE_CLS</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">pv_xOvrdCls</span>     <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span><span class="n">IO</span><span class="o">*</span><span class="p">)</span>
    <span class="n">i_xOpnLS</span>        <span class="n">AT</span><span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">i_xClsLS</span>        <span class="n">AT</span><span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">q_xCLS_DO</span>       <span class="n">AT</span><span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">function</span> <span class="n">block</span> <span class="ow">is</span> <span class="n">different</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">regular</span> <span class="n">VRC</span> <span class="ow">in</span> <span class="n">that</span> <span class="n">CLOSING</span> <span class="n">must</span> <span class="n">be</span> <span class="n">permitted</span><span class="o">.</span> <span class="o">*</span><span class="p">)</span>

<span class="p">(</span><span class="o">*</span> <span class="n">On</span> <span class="n">first</span> <span class="n">PLC</span> <span class="k">pass</span><span class="p">,</span> <span class="n">put</span> <span class="n">valve</span> <span class="n">into</span> <span class="n">vented</span> <span class="n">state</span><span class="p">,</span> <span class="n">which</span> <span class="n">implies</span> <span class="n">a</span> <span class="n">closed</span> <span class="n">valve</span> <span class="o">*</span><span class="p">)</span>
<span class="n">fbFSInit</span><span class="p">(</span> <span class="n">CLK</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">Q</span> <span class="o">=&gt;</span> <span class="n">xFirstPass</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">xFirstPass</span> <span class="n">THEN</span>
    <span class="n">pv_xCLS_SW</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>




<span class="o">///</span><span class="n">Check</span> <span class="n">valve</span> <span class="n">position</span>
<span class="n">IF</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">i_xClsLS</span> <span class="n">AND</span>  <span class="n">iq_stValve</span><span class="o">.</span><span class="n">i_xOpnLS</span> <span class="n">THEN</span>
    <span class="n">iq_stValve</span><span class="o">.</span><span class="n">eState</span><span class="o">:=</span><span class="n">INVALID</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">NOT</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">i_xClsLS</span> <span class="n">AND</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">i_xOpnLS</span> <span class="n">AND</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">q_xOPN_DO</span> <span class="n">THEN</span>
    <span class="n">iq_stValve</span><span class="o">.</span><span class="n">eState</span><span class="o">:=</span><span class="n">OPEN</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">i_xClsLS</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">i_xOpnLS</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">q_xOPN_DO</span> <span class="n">THEN</span>
    <span class="n">iq_stValve</span><span class="o">.</span><span class="n">eState</span><span class="o">:=</span><span class="n">CLOSED</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">NOT</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">i_xClsLS</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">i_xOpnLS</span> <span class="n">THEN</span>
    <span class="n">iq_stValve</span><span class="o">.</span><span class="n">eState</span><span class="o">:=</span><span class="n">MOVING</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">iq_stValve</span><span class="o">.</span><span class="n">eState</span><span class="o">:=</span><span class="n">INVALID</span><span class="p">;</span>
<span class="n">END_IF</span>


<span class="p">(</span><span class="o">*</span><span class="n">evaluate</span> <span class="n">Valve</span> <span class="n">CLose</span> <span class="n">external</span> <span class="n">interlock</span><span class="o">*</span><span class="p">)</span>
<span class="n">iq_stValve</span><span class="o">.</span><span class="n">xCLS_OK</span> <span class="o">:=</span> <span class="n">i_xExtILK_OK</span><span class="p">;</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">xCLS_OK</span> <span class="ow">and</span> <span class="n">NOT</span> <span class="n">tonOvrd</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">pv_xCLS_SW</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>


<span class="p">(</span><span class="o">*</span> <span class="n">Override</span> <span class="n">logic</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Goal</span><span class="p">:</span> <span class="n">give</span> <span class="n">ability</span> <span class="n">to</span> <span class="n">override</span><span class="p">,</span> <span class="n">but</span> <span class="n">do</span> <span class="n">so</span> <span class="ow">in</span> <span class="n">a</span> <span class="n">way</span> <span class="n">that</span> <span class="n">people</span> <span class="n">won</span><span class="s1">&#39;t forget it.</span>
<span class="n">Solution</span><span class="p">:</span> <span class="n">Override</span> <span class="n">only</span> <span class="n">after</span> <span class="n">ten</span> <span class="n">seconds</span> <span class="n">of</span> <span class="n">override</span><span class="p">,</span> <span class="n">protect</span> <span class="n">against</span> <span class="n">blips</span><span class="p">,</span>
<span class="n">when</span> <span class="n">the</span> <span class="n">valve</span> <span class="n">permission</span> <span class="n">goes</span> <span class="n">true</span> <span class="k">for</span> <span class="n">more</span> <span class="n">than</span> <span class="n">ten</span> <span class="n">seconds</span> <span class="n">consistently</span><span class="p">,</span> <span class="n">remove</span> <span class="n">override</span>
<span class="o">*</span><span class="p">)</span>

<span class="n">tonDelOK</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">iq_stValve</span><span class="o">.</span><span class="n">xCLS_OK</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#10S);</span>
<span class="n">rtOK</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">tonDelOK</span><span class="o">.</span><span class="n">Q</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">rtOK</span><span class="o">.</span><span class="n">Q</span> <span class="n">AND</span> <span class="n">pv_xOvrdCls</span> <span class="n">THEN</span>
    <span class="n">pv_xOvrdCls</span> <span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">iq_stValve</span><span class="o">.</span><span class="n">eState</span><span class="o">=</span><span class="n">CLOSED</span><span class="p">)</span> <span class="n">AND</span> <span class="p">(</span><span class="n">i_xOverrideMode</span><span class="p">)</span> <span class="n">THEN</span> <span class="n">pv_xCLS_SW</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span> <span class="n">END_IF</span>
    <span class="o">//</span><span class="n">Log</span>
    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Override expired&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Warning</span><span class="p">);</span>
<span class="n">END_IF</span>

<span class="o">//</span><span class="n">Override</span> <span class="n">timer</span>
<span class="n">tonOvrd</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">pv_xOvrdCls</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span><span class="n">tOvrd</span><span class="p">);</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Here</span><span class="s1">&#39;s where the valve Actuates *)</span>
<span class="n">q_xCLS_DO</span> <span class="o">:=</span> <span class="p">((</span><span class="n">iq_stValve</span><span class="o">.</span><span class="n">xCLS_OK</span>  <span class="n">AND</span> <span class="n">pv_xCLS_SW</span><span class="p">)</span><span class="n">OR</span> <span class="p">(</span><span class="n">tonOvrd</span><span class="o">.</span><span class="n">Q</span> <span class="n">AND</span> <span class="n">i_xOverrideMode</span><span class="p">));</span>
<span class="n">iq_stValve</span><span class="o">.</span><span class="n">q_xOPN_DO</span> <span class="o">:=</span> <span class="n">NOT</span> <span class="n">q_xCLS_DO</span><span class="p">;</span>



<span class="o">///</span><span class="n">Check</span> <span class="n">valve</span> <span class="n">moving</span> <span class="n">position</span> <span class="n">timout</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">i_xClsLS</span> <span class="n">AND</span> <span class="n">tCLStimeout</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">iq_stValve</span><span class="o">.</span><span class="n">bErrorPresent</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="o">//</span><span class="n">iq_stValve</span><span class="o">.</span><span class="n">sErrorMessage</span> <span class="o">:=</span> <span class="s1">&#39; Close Timeout&#39;</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">NOT</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">i_xOpnLS</span> <span class="n">AND</span> <span class="n">tOPNtimeout</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">iq_stValve</span><span class="o">.</span><span class="n">bErrorPresent</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="o">//</span><span class="n">iq_stValve</span><span class="o">.</span><span class="n">sErrorMessage</span> <span class="o">:=</span> <span class="s1">&#39; Open Timeout&#39;</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">IF</span> <span class="p">(</span><span class="n">iq_stValve</span><span class="o">.</span><span class="n">eState</span><span class="o">=</span><span class="n">INVALID</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">iq_stValve</span><span class="o">.</span><span class="n">bErrorPresent</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="o">//</span><span class="n">iq_stValve</span><span class="o">.</span><span class="n">sErrorMessage</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="n">sPath</span><span class="p">,</span><span class="s1">&#39; Invalid Valve Position&#39;</span><span class="p">);</span>
<span class="n">END_IF</span>

<span class="p">(</span><span class="o">*</span><span class="n">Timers</span><span class="o">*</span><span class="p">)</span>
<span class="n">tOPNtimeout</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">q_xOPN_DO</span><span class="p">,</span> <span class="n">PT</span> <span class="o">:=</span> <span class="n">tTimeOutDuration</span> <span class="p">);</span>
<span class="n">tCLStimeout</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span> <span class="n">NOT</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">q_xOPN_DO</span><span class="p">,</span> <span class="n">PT</span> <span class="o">:=</span> <span class="n">tTimeOutDuration</span><span class="p">);</span>


<span class="p">(</span><span class="o">*</span><span class="n">Soft</span> <span class="n">IO</span> <span class="n">Mapping</span><span class="o">*</span><span class="p">)</span>
<span class="n">ACT_IO</span><span class="p">();</span>

<span class="o">//</span> <span class="n">Log</span> <span class="n">States</span> <span class="ow">and</span> <span class="n">triggers</span>
<span class="n">ACT_Logger</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>
<span class="n">ACTION</span> <span class="n">ACT_IO</span><span class="p">:</span>
<span class="p">(</span><span class="o">*</span><span class="n">inputs</span><span class="o">*</span><span class="p">)</span>
<span class="n">iq_stValve</span><span class="o">.</span><span class="n">i_xOpnLS</span> <span class="o">:=</span>      <span class="n">i_xOpnLS</span><span class="p">;</span>
<span class="n">iq_stValve</span><span class="o">.</span><span class="n">i_xClsLS</span><span class="o">:=</span>       <span class="n">i_xClsLS</span><span class="p">;</span>
<span class="o">//</span><span class="n">iq_stValve</span><span class="o">.</span> <span class="o">:=</span> <span class="n">i_xEXT_OK</span><span class="p">;</span>
<span class="n">iq_stValve</span><span class="o">.</span><span class="n">xOverrideMode</span> <span class="o">:=</span> <span class="n">i_xOverrideMode</span><span class="p">;</span>
<span class="p">(</span><span class="o">*</span><span class="n">outputs</span><span class="o">*</span><span class="p">)</span>
<span class="o">//</span><span class="n">q_xOPN_DO</span><span class="o">:=</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">q_xOPN_DO</span><span class="p">;</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
</div>
<div class="section" id="fb-vrc-ok-cls">
<h2>FB_VRC_OK_CLS<a class="headerlink" href="#fb-vrc-ok-cls" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">function</span> <span class="n">block</span> <span class="ow">is</span> <span class="n">different</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">regular</span> <span class="n">VRC</span> <span class="ow">in</span> <span class="n">that</span> <span class="n">CLOSING</span> <span class="n">must</span> <span class="n">be</span> <span class="n">permitted</span><span class="o">.</span> <span class="o">*</span><span class="p">)</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_VRC_OK_CLS</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">iq_stValve</span> <span class="p">:</span> <span class="n">ST_VRC</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">i_xOverrideMode</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>

<span class="n">tonOvrd</span>     <span class="p">:</span>       <span class="n">TON</span><span class="p">;</span>
<span class="n">tonDelOK</span> <span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
<span class="n">rtOK</span>        <span class="p">:</span>       <span class="n">R_TRIG</span><span class="p">;</span>

<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">function</span> <span class="n">block</span> <span class="ow">is</span> <span class="n">different</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">regular</span> <span class="n">VRC</span> <span class="ow">in</span> <span class="n">that</span> <span class="n">CLOSING</span> <span class="n">must</span> <span class="n">be</span> <span class="n">permitted</span><span class="o">.</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Implemented</span> <span class="k">for</span> <span class="n">the</span> <span class="n">funky</span> <span class="n">valve</span> <span class="mi">04</span> <span class="n">on</span> <span class="n">LAMP</span> <span class="o">*</span><span class="p">)</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">xOPN_OK</span> <span class="ow">and</span> <span class="n">NOT</span> <span class="n">tonOvrd</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
<span class="n">iq_stValve</span><span class="o">.</span><span class="n">pv_xOPN_SW</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Override</span> <span class="n">logic</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Goal</span><span class="p">:</span> <span class="n">give</span> <span class="n">ability</span> <span class="n">to</span> <span class="n">override</span><span class="p">,</span> <span class="n">but</span> <span class="n">do</span> <span class="n">so</span> <span class="ow">in</span> <span class="n">a</span> <span class="n">way</span> <span class="n">that</span> <span class="n">people</span> <span class="n">won</span><span class="s1">&#39;t forget it.</span>
<span class="n">Solution</span><span class="p">:</span> <span class="n">Override</span> <span class="n">only</span> <span class="n">after</span> <span class="n">ten</span> <span class="n">seconds</span> <span class="n">of</span> <span class="n">override</span><span class="p">,</span> <span class="n">protect</span> <span class="n">against</span> <span class="n">blips</span><span class="p">,</span>
<span class="n">when</span> <span class="n">the</span> <span class="n">valve</span> <span class="n">permission</span> <span class="n">goes</span> <span class="n">true</span> <span class="k">for</span> <span class="n">more</span> <span class="n">than</span> <span class="n">ten</span> <span class="n">seconds</span> <span class="n">consistently</span><span class="p">,</span> <span class="n">remove</span> <span class="n">override</span>
<span class="o">*</span><span class="p">)</span>

<span class="n">tonDelOK</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">iq_stValve</span><span class="o">.</span><span class="n">xOPN_OK</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#10S);</span>
<span class="n">rtOK</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">tonDelOK</span><span class="o">.</span><span class="n">Q</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">rtOK</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">pv_xOvrdOpn</span> <span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span> <span class="n">END_IF</span>

<span class="o">//</span><span class="n">Override</span> <span class="n">timer</span>
<span class="n">tonOvrd</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">iq_stValve</span><span class="o">.</span><span class="n">pv_xOvrdOpn</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#10S);</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Here</span><span class="s1">&#39;s where the valve opens *)</span>
<span class="n">iq_stValve</span><span class="o">.</span><span class="n">q_xOPN_DO</span> <span class="o">:=</span> <span class="n">NOT</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">xCLS_OK</span> <span class="n">OR</span> <span class="p">((</span><span class="n">iq_stValve</span><span class="o">.</span><span class="n">pv_xOPN_SW</span> <span class="n">AND</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">xOPN_OK</span><span class="p">)</span> <span class="n">OR</span> <span class="p">(</span><span class="n">tonOvrd</span><span class="o">.</span><span class="n">Q</span> <span class="n">AND</span> <span class="n">i_xOverrideMode</span><span class="p">));</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</div>
<div class="section" id="fb-vrc-test">
<h2>FB_VRC_Test<a class="headerlink" href="#fb-vrc-test" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_VRC_Test</span> <span class="n">EXTENDS</span> <span class="n">TcUnit</span><span class="o">.</span><span class="n">FB_TestSuite</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">VRC</span><span class="p">:</span> <span class="n">FB_VRC</span><span class="p">;</span>
    <span class="n">ex</span>               <span class="p">:</span> <span class="n">__SYSTEM</span><span class="o">.</span><span class="n">ExceptionCode</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">M_INIT</span><span class="p">();</span>
<span class="n">M_Interlock</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</div>
<div class="section" id="fb-vvc">
<h2>FB_VVC<a class="headerlink" href="#fb-vvc" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">Function</span> <span class="n">Block</span> <span class="n">Implements</span> <span class="n">Basic</span> <span class="n">Functionality</span> <span class="k">for</span> <span class="n">Vent</span> <span class="n">Valves</span> <span class="n">VVC</span><span class="o">.</span>

    <span class="n">This</span> <span class="n">function</span> <span class="n">block</span> <span class="ow">is</span> <span class="n">also</span> <span class="n">intended</span> <span class="k">for</span> <span class="n">the</span> <span class="n">general</span> <span class="n">use</span> <span class="n">case</span> <span class="n">of</span> <span class="n">solenoid</span> <span class="n">driven</span> <span class="p">(</span><span class="n">non</span><span class="o">-</span><span class="n">variable</span><span class="p">)</span> <span class="n">valves</span> <span class="n">that</span> <span class="n">lack</span> <span class="n">status</span> <span class="n">readbacks</span> <span class="ow">or</span> <span class="n">position</span> <span class="n">indicators</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Note</span> <span class="n">Interlock</span> <span class="n">Logic</span> <span class="ow">is</span> <span class="n">External</span> <span class="o">*</span><span class="p">)</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_VVC</span>
<span class="n">VAR_IN_OUT</span>

<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">i_xExtILK_OK</span><span class="p">:</span><span class="n">BOOL</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span><span class="n">Other</span> <span class="n">External</span> <span class="n">Interlock</span><span class="p">,</span> <span class="n">Set</span> <span class="n">to</span> <span class="kc">True</span> <span class="n">when</span> <span class="n">no</span> <span class="n">external</span> <span class="n">interlock</span> <span class="ow">is</span> <span class="n">required</span><span class="o">*</span><span class="p">)</span>
    <span class="n">i_xOverrideMode</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span><span class="n">To</span> <span class="n">be</span> <span class="n">linked</span> <span class="n">to</span> <span class="k">global</span> <span class="n">override</span> <span class="n">bit</span><span class="o">.</span> <span class="n">This</span> <span class="n">Overrides</span> <span class="n">Vacuum</span> <span class="n">logic</span> <span class="n">only</span><span class="o">*</span><span class="p">)</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span>
    <span class="s1">&#39;}</span>
    <span class="n">iq_stValve</span> <span class="p">:</span> <span class="n">ST_VVC</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>

    <span class="n">tonOvrd</span> <span class="p">:</span>       <span class="n">TON</span><span class="p">;</span>
    <span class="n">tonDelOK</span> <span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">rtOK</span>    <span class="p">:</span>       <span class="n">R_TRIG</span><span class="p">;</span>

    <span class="p">(</span><span class="o">*</span><span class="n">IO</span><span class="o">*</span><span class="p">)</span>
    <span class="n">q_xOPN_DO</span>       <span class="n">AT</span><span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="n">pv_xOvrdOpn</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">iq_stValve</span><span class="o">.</span><span class="n">xOPN_OK</span> <span class="o">:=</span> <span class="n">i_xExtILK_OK</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">NOT</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">xOPN_OK</span> <span class="n">THEN</span>
<span class="n">iq_stValve</span><span class="o">.</span><span class="n">pv_xOPN_SW</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Override</span> <span class="n">logic</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Goal</span><span class="p">:</span> <span class="n">give</span> <span class="n">ability</span> <span class="n">to</span> <span class="n">override</span><span class="p">,</span> <span class="n">but</span> <span class="n">do</span> <span class="n">so</span> <span class="ow">in</span> <span class="n">a</span> <span class="n">way</span> <span class="n">that</span> <span class="n">people</span> <span class="n">won</span><span class="s1">&#39;t forget it.</span>
<span class="n">Solution</span><span class="p">:</span> <span class="n">Override</span> <span class="n">only</span> <span class="n">after</span> <span class="n">ten</span> <span class="n">seconds</span> <span class="n">of</span> <span class="n">override</span><span class="p">,</span> <span class="n">protect</span> <span class="n">against</span> <span class="n">blips</span><span class="p">,</span>
<span class="n">when</span> <span class="n">the</span> <span class="n">valve</span> <span class="n">permission</span> <span class="n">goes</span> <span class="n">true</span> <span class="k">for</span> <span class="n">more</span> <span class="n">than</span> <span class="n">ten</span> <span class="n">seconds</span> <span class="n">consistently</span><span class="p">,</span> <span class="n">remove</span> <span class="n">override</span>
<span class="o">*</span><span class="p">)</span>

<span class="n">tonDelOK</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">iq_stValve</span><span class="o">.</span><span class="n">xOPN_OK</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#10S);</span>
<span class="n">rtOK</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">tonDelOK</span><span class="o">.</span><span class="n">Q</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">rtOK</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">xOvrdOpn</span> <span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span> <span class="n">END_IF</span>
<span class="o">//</span> <span class="n">Release</span> <span class="n">the</span> <span class="n">Force</span> <span class="n">Open</span> <span class="n">bit</span> <span class="n">when</span> <span class="n">the</span> <span class="n">system</span> <span class="n">override</span> <span class="ow">is</span> <span class="n">false</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="p">(</span><span class="n">i_xOverrideMode</span><span class="p">)</span> <span class="n">THEN</span>  <span class="n">iq_stValve</span><span class="o">.</span><span class="n">xOvrdOpn</span> <span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span> <span class="n">END_IF</span>

<span class="o">//</span><span class="n">Override</span> <span class="n">timer</span>
<span class="n">tonOvrd</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">iq_stValve</span><span class="o">.</span><span class="n">xOvrdOpn</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#10S);</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Here</span><span class="s1">&#39;s where the valve opens *)</span>
<span class="n">iq_stValve</span><span class="o">.</span><span class="n">q_xOPN_DO</span> <span class="o">:=</span> <span class="p">(</span><span class="n">iq_stValve</span><span class="o">.</span><span class="n">pv_xOPN_SW</span> <span class="n">AND</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">xOPN_OK</span><span class="p">)</span> <span class="n">OR</span> <span class="p">(</span><span class="n">tonOvrd</span><span class="o">.</span><span class="n">Q</span> <span class="n">AND</span> <span class="n">i_xOverrideMode</span><span class="p">);</span>

<span class="p">(</span><span class="o">*</span><span class="n">IO</span> <span class="n">Mapping</span><span class="o">*</span><span class="p">)</span>
<span class="n">ACT_IO</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>
<span class="n">ACTION</span> <span class="n">ACT_IO</span><span class="p">:</span>
<span class="p">(</span><span class="o">*</span><span class="n">inputs</span><span class="o">*</span><span class="p">)</span>
<span class="n">iq_stValve</span><span class="o">.</span><span class="n">xOverrideMode</span> <span class="o">:=</span> <span class="n">i_xOverrideMode</span><span class="p">;</span>
<span class="p">(</span><span class="o">*</span><span class="n">outputs</span><span class="o">*</span><span class="p">)</span>
<span class="n">q_xOPN_DO</span><span class="o">:=</span> <span class="n">iq_stValve</span><span class="o">.</span><span class="n">q_xOPN_DO</span><span class="p">;</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
</div>
<div class="section" id="prg-test">
<h2>PRG_Test<a class="headerlink" href="#prg-test" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PROGRAM</span> <span class="n">PRG_Test</span>
<span class="n">VAR</span>
    <span class="n">fb_VGC_Test</span><span class="p">:</span> <span class="n">FB_VGC_Test</span><span class="p">;</span>
    <span class="n">fb_VRC_Test</span><span class="p">:</span> <span class="n">FB_VRC_Test</span><span class="p">;</span>
    <span class="n">fb_PIP_Test</span><span class="p">:</span> <span class="n">FB_PIP_Test</span><span class="p">;</span>
    <span class="n">fb_PTM_Test</span><span class="p">:</span> <span class="n">FB_PTM_Test</span><span class="p">;</span>
    <span class="n">fb_GPI_Test</span><span class="p">:</span><span class="n">FB_GPI_Test</span><span class="p">;</span>
    <span class="n">fb_GCC_Test</span><span class="p">:</span><span class="n">FB_GCC_Test</span><span class="p">;</span>

    <span class="n">TotalTests</span> <span class="p">:</span> <span class="n">INT</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TcUnit</span><span class="o">.</span><span class="n">RUN</span><span class="p">();</span>

<span class="n">END_PROGRAM</span>
</pre></div>
</div>
</div>
<div class="section" id="v-to-int">
<h2>V_TO_INT<a class="headerlink" href="#v-to-int" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;no_check&#39;</span><span class="p">}</span>
<span class="n">FUNCTION</span> <span class="n">V_TO_INT</span> <span class="p">:</span> <span class="n">INT</span>
<span class="n">VAR_INPUT</span>
    <span class="n">analog</span> <span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">iBits</span> <span class="p">:</span><span class="n">INT</span> <span class="o">:=</span> <span class="mi">32767</span><span class="p">;</span>
    <span class="n">iFullRange</span><span class="p">:</span><span class="n">INT</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="k">if</span> <span class="p">(</span> <span class="n">iFullRange</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">)</span> <span class="n">THEN</span> <span class="n">iFullRange</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span><span class="n">END_IF</span>
<span class="n">V_TO_INT</span> <span class="o">:=</span> <span class="n">REAL_TO_INT</span><span class="p">(</span><span class="n">analog</span> <span class="o">*</span> <span class="mi">32767</span> <span class="o">/</span><span class="n">iFullRange</span><span class="p">);</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="L2SIVacuumLib_L2SIVacuum_epics.html" class="btn btn-neutral float-left" title="Data Types" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, SLAC National Accelerator Laboratory

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>